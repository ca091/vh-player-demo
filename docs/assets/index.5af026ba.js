var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,o=(e,t)=>{for(var i in t||(t={}))r.call(t,i)&&a(e,i,t[i]);if(s)for(var i of s(t))n.call(t,i)&&a(e,i,t[i]);return e},l=(e,s)=>t(e,i(s));import{u as h,e as d,E as u,w as c,a as f,b as m,c as g,l as p,d as _}from"./vendor.bf38ea8d.js";const v=function(){var e,t;let i=(new h.exports.UAParser).getResult(),s=/mqqbrowser|qzone|qqbrowser|qq|micromessenger/i.test(i.ua),r=/android|adr/i.test(i.ua.toLowerCase());return{isTencent:s,browser:null==(e=i.browser.name)?void 0:e.toLowerCase(),browserVersion:i.browser.version,os:null==(t=i.os.name)?void 0:t.toLowerCase(),osVersion:i.os.version,platform:/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i.test(i.ua)?"mobile":"pc",isIOS:/\(i[^;]+;( U;)? CPU.+Mac OS X/.test(i.ua),isAndroid:r,isX5:s&&r,isUC:/ucbrowser/.test(i.ua.toLowerCase()),supportMSE:!(!window.MediaSource&&!window.WebKitMediaSource)}}();const y=document.querySelector.bind(document);function E(e){return"string"==typeof e?y(e):e}function S(e,t){return new Promise(((i,s)=>{if(document.getElementById(e))i(!0);else{let r=document.createElement("script");r.setAttribute("id",e),r.setAttribute("src",t),document.head.appendChild(r),r.onload=()=>i(!0),r.onerror=()=>s(Error("network error")),setTimeout((()=>{s(Error("timeout"))}),1e4)}}))}document.querySelectorAll.bind(document);class T extends class{constructor(){this.autoplay=!0,this.controls=!0,this.poster="",this.debug=!1}merge(e){if(!e)return this;for(let t in e)this[t]=e[t];return this}}{constructor(){super(),this.language="en",this.scheduleOption={enable:!0,playerData:{dispatch_server:"",log_info:{uid:""},default_server:{uri:""},app_type:0,live_type:0,live_subtitle:0,live_delay:0,live_duration:0}},this.switchOption={enable:!0},this.barrageOption={enable:!0,positionRange:[0,.25],direction:"right",speed:1e4,style:{fontSize:12,fontFamily:"Microsoft Yahei",color:"#FFF",border:"none",textShadow:null,borderWidth:0,padding:"0",opacity:80,backgroundColor:"none"}},this.peer5Option={enable:!1,customerId:"",fallback:!0};let e={bufferPursue:20,bufferSeek:40,bufferStop:10,pursueSpeed:1.2,mode:"pursue"};this.pursueOption={enable:!0,flv:e,hls:{bufferPursue:40,bufferSeek:80,bufferStop:20,pursueSpeed:1.2,mode:"pursue"},native:e}}}Date.now();const L="app_id",b="third_party_user_id",A="client",R="access_token",D="package_check";var w,k,C,I,x,O,P,M,F,B;(k=w||(w={})).Flv="flv",k.Hls="hls",k.Flash="flash",k.Native="native",(I=C||(C={})).P360="360p",I.P480="480p",I.P720="720p",I.Pa="a",I.PSame="same",(O=x||(x={})).TX="tx",O.ALI="ali",O.HW="hw",O.CY="cy",(M=P||(P={})).Error="error",M.Waiting="waiting",M.Ended="ended",M.Loaded="loadeddata",M.Play="play",M.Pause="pause",M.Ratechange="ratechange",M.Stalled="stalled",function(e){e.DEFINITION_CHANGE="definitionchange",e.OPEN_SUBTITLE="openSubtitle",e.CLOSE_SUBTITLE="closeSubtitle",e.SUBTITLE_CHANGED="subtitleChanged",e.LIVESUBTITLE_OPENED="liveSubtitleOpened",e.LIVESUBTITLE_CLOSED="liveSubtitleClosed",e.AUTOPLAY_FAILED="autoplayFailed",e.FULLSCREEN_CHANGE="fullscreenchanged",e.LAG_REPORT="lagreport",e.LAG_RECOVER="lagrecover",e.OPEN_BARRAGE="openbarrage",e.CLOSE_BARRAGE="closebarrage",e.CLEAR_BARRAGE="clearbarrage",e.SCHEDULER_COMPLETE="schedulercompleted",e.READY="ready",e.PLAYBACKRATE_LIST_CHANGED="playbackratelistchange",e.LINE_RELOADING="lineReloading",e.LINE_CHANGING="lineChanging",e.LINE_CHANGED="lineChanged",e.LIVE_TIMESHIFT="liveTimeshift",e.TOUCH_PLAY="touchPlay"}(P||(P={}));(B=F||(F={})).Trace="trace",B.Debug="debug",B.Log="log",B.Warn="warn",B.Info="info",B.Error="error";const N=function(){},U={trace:N,debug:N,log:N,warn:N,info:N,error:N};let G=U;function $(e,...t){!1!==e&&t.forEach((function(t){G[t]="object"==typeof e&&e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):N}(t)}))}const V=G;class H{constructor(e,t){this.playedTime=0,this.playBackRate=1,this.isPaused=!0,this.url="",this.cacheUrl="",this.options=e,this.context=t,this.video=this.initVideo(e,E("#"+e.videoNode)),this.registerListeners()}initVideo(e,t=document.body){let i={playsinline:!0,"webkit-playsinline":!0,"x5-playsinline":!0,"mtt-playsinline":!0},s=function(e="div",t={},i={}){const s=document.createElement(e);return Object.getOwnPropertyNames(t).forEach((e=>{s[e]=t[e]})),Object.getOwnPropertyNames(i).forEach((e=>{s.setAttribute(e,i[e])})),s}("video",{autoplay:e.autoplay,controls:e.controls},o(o({width:"100%",height:"100%",crossOrigin:"anonymous","z-index":0},i),e.poster?{poster:e.poster}:{}));return t.appendChild(s),s}checkUrl(e,t=!1){return e?this.url!==e||t?(this.cacheUrl||(this.cacheUrl=e),!0):(V.warn(`[vlog-${this.constructor.name}]`,"url 未改变"),!1):(V.warn(`[vlog-${this.constructor.name}]`,"url 未提供"),!1)}setUrl(e){var t;null==(t=this.context)||t.emit(P.LINE_CHANGED,{old:this.url,new:e}),this.url=e,this.cacheUrl=""}recordPlayStatus(e){V.info(`[vlog-${this.constructor.name}]`,"change line old => ",this.url),V.info(`[vlog-${this.constructor.name}]`,"change line new => ",e),this.playedTime=this.video.currentTime,this.playBackRate=this.video.playbackRate,this.isPaused=this.video.paused}recoverPlayStatus(){V.info(`[vlog-${this.constructor.name}]`,"还原切线前播放状态:"),V.info(`[vlog-${this.constructor.name}]`,"playedTime:",this.playedTime),V.info(`[vlog-${this.constructor.name}]`,"playBackRate:",this.playBackRate),this.video.currentTime=this.playedTime,this.video.playbackRate=this.playBackRate,this.isPaused||this.video.play()}registerListeners(){this.video.addEventListener("play",(e=>{var t;null==(t=this.context)||t.emit(P.Play,e)})),this.video.addEventListener("pause",(e=>{var t;null==(t=this.context)||t.emit(P.Pause,e)})),this.video.addEventListener("waiting",(e=>{var t;null==(t=this.context)||t.emit(P.Waiting,e)})),this.video.addEventListener("ended",(e=>{var t;null==(t=this.context)||t.emit(P.Ended,e)})),this.video.addEventListener("error",(e=>{var t;null==(t=this.context)||t.emit(P.Error,e),V.error(`[vlog video error] => type: ${e.type}; details: ${e.details}`);let i=e.target&&e.target.error;i&&V.error(`[vlog video error] => code: ${i.code}; details: ${i.message}`)})),this.video.addEventListener("stalled",(e=>{var t;null==(t=this.context)||t.emit(P.Stalled,e)})),this.video.addEventListener("loadeddata",(e=>{var t;null==(t=this.context)||t.emit(P.Loaded,e)})),this.video.addEventListener("ratechange",(e=>{var t;null==(t=this.context)||t.emit(P.Ratechange,e)}))}}class K{static install(){Object.setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Object.assign=Object.assign||function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");let t=Object(e);for(let i=1;i<arguments.length;i++){let e=arguments[i];if(null!=e)for(let i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}return t},"function"!=typeof self.Promise&&require("es6-promise").polyfill()}}K.install();class z{static e(e,t){e&&!z.FORCE_GLOBAL_TAG||(e=z.GLOBAL_TAG);let i=`[${e}] > ${t}`;z.ENABLE_CALLBACK&&z.emitter.emit("log","error",i),z.ENABLE_ERROR&&(console.error?console.error(i):console.warn?console.warn(i):console.log(i))}static i(e,t){e&&!z.FORCE_GLOBAL_TAG||(e=z.GLOBAL_TAG);let i=`[${e}] > ${t}`;z.ENABLE_CALLBACK&&z.emitter.emit("log","info",i),z.ENABLE_INFO&&(console.info?console.info(i):console.log(i))}static w(e,t){e&&!z.FORCE_GLOBAL_TAG||(e=z.GLOBAL_TAG);let i=`[${e}] > ${t}`;z.ENABLE_CALLBACK&&z.emitter.emit("log","warn",i),z.ENABLE_WARN&&(console.warn?console.warn(i):console.log(i))}static d(e,t){e&&!z.FORCE_GLOBAL_TAG||(e=z.GLOBAL_TAG);let i=`[${e}] > ${t}`;z.ENABLE_CALLBACK&&z.emitter.emit("log","debug",i),z.ENABLE_DEBUG&&(console.debug?console.debug(i):console.log(i))}static v(e,t){e&&!z.FORCE_GLOBAL_TAG||(e=z.GLOBAL_TAG);let i=`[${e}] > ${t}`;z.ENABLE_CALLBACK&&z.emitter.emit("log","verbose",i),z.ENABLE_VERBOSE&&console.log(i)}}z.GLOBAL_TAG="flv.js",z.FORCE_GLOBAL_TAG=!1,z.ENABLE_ERROR=!0,z.ENABLE_INFO=!0,z.ENABLE_WARN=!0,z.ENABLE_DEBUG=!0,z.ENABLE_VERBOSE=!0,z.ENABLE_CALLBACK=!1,z.emitter=new u;class W{constructor(){this._firstCheckpoint=0,this._lastCheckpoint=0,this._intervalBytes=0,this._totalBytes=0,this._lastSecondBytes=0,self.performance&&self.performance.now?this._now=self.performance.now.bind(self.performance):this._now=Date.now}reset(){this._firstCheckpoint=this._lastCheckpoint=0,this._totalBytes=this._intervalBytes=0,this._lastSecondBytes=0}addBytes(e){0===this._firstCheckpoint?(this._firstCheckpoint=this._now(),this._lastCheckpoint=this._firstCheckpoint,this._intervalBytes+=e,this._totalBytes+=e):this._now()-this._lastCheckpoint<1e3?(this._intervalBytes+=e,this._totalBytes+=e):(this._lastSecondBytes=this._intervalBytes,this._intervalBytes=e,this._totalBytes+=e,this._lastCheckpoint=this._now())}get currentKBps(){this.addBytes(0);let e=(this._now()-this._lastCheckpoint)/1e3;return 0==e&&(e=1),this._intervalBytes/e/1024}get lastSecondKBps(){return this.addBytes(0),0!==this._lastSecondBytes?this._lastSecondBytes/1024:this._now()-this._lastCheckpoint>=500?this.currentKBps:0}get averageKBps(){let e=(this._now()-this._firstCheckpoint)/1e3;return this._totalBytes/e/1024}}class j{constructor(e){this._message=e}get name(){return"RuntimeException"}get message(){return this._message}toString(){return this.name+": "+this.message}}class q extends j{constructor(e){super(e)}get name(){return"IllegalStateException"}}class X extends j{constructor(e){super(e)}get name(){return"InvalidArgumentException"}}class Y extends j{constructor(e){super(e)}get name(){return"NotImplementedException"}}const Q={kIdle:0,kConnecting:1,kBuffering:2,kError:3,kComplete:4},Z={OK:"OK",EXCEPTION:"Exception",HTTP_STATUS_CODE_INVALID:"HttpStatusCodeInvalid",CONNECTING_TIMEOUT:"ConnectingTimeout",EARLY_EOF:"EarlyEof",UNRECOVERABLE_EARLY_EOF:"UnrecoverableEarlyEof"};class J{constructor(e){this._type=e||"undefined",this._status=Q.kIdle,this._needStash=!1,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null}destroy(){this._status=Q.kIdle,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null}isWorking(){return this._status===Q.kConnecting||this._status===Q.kBuffering}get type(){return this._type}get status(){return this._status}get needStashBuffer(){return this._needStash}get onContentLengthKnown(){return this._onContentLengthKnown}set onContentLengthKnown(e){this._onContentLengthKnown=e}get onURLRedirect(){return this._onURLRedirect}set onURLRedirect(e){this._onURLRedirect=e}get onDataArrival(){return this._onDataArrival}set onDataArrival(e){this._onDataArrival=e}get onError(){return this._onError}set onError(e){this._onError=e}get onComplete(){return this._onComplete}set onComplete(e){this._onComplete=e}open(e,t){throw new Y("Unimplemented abstract function!")}abort(){throw new Y("Unimplemented abstract function!")}}let ee={};!function(){let e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],i=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],s={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",majorVersion:t[4]||t[2]||"0",platform:i[0]||""},r={};if(s.browser){r[s.browser]=!0;let e=s.majorVersion.split(".");r.version={major:parseInt(s.majorVersion,10),string:s.version},e.length>1&&(r.version.minor=parseInt(e[1],10)),e.length>2&&(r.version.build=parseInt(e[2],10))}if(s.platform&&(r[s.platform]=!0),(r.chrome||r.opr||r.safari)&&(r.webkit=!0),r.rv||r.iemobile){r.rv&&delete r.rv;let e="msie";s.browser=e,r[e]=!0}if(r.edge){delete r.edge;let e="msedge";s.browser=e,r[e]=!0}if(r.opr){let e="opera";s.browser=e,r[e]=!0}if(r.safari&&r.android){let e="android";s.browser=e,r[e]=!0}r.name=s.browser,r.platform=s.platform;for(let n in ee)ee.hasOwnProperty(n)&&delete ee[n];Object.assign(ee,r)}();class te extends J{static isSupported(){try{let e=ee.msedge&&ee.version.minor>=15048,t=!ee.msedge||e;return self.fetch&&self.ReadableStream&&t}catch(e){return!1}}constructor(e,t){super("fetch-stream-loader"),this.TAG="FetchStreamLoader",this._seekHandler=e,this._config=t,this._needStash=!0,this._requestAbort=!1,this._contentLength=null,this._receivedLength=0}destroy(){this.isWorking()&&this.abort(),super.destroy()}open(e,t){this._dataSource=e,this._range=t;let i=e.url;this._config.reuseRedirectedURL&&null!=e.redirectedURL&&(i=e.redirectedURL);let s=this._seekHandler.getConfig(i,t),r=new self.Headers;if("object"==typeof s.headers){let e=s.headers;for(let t in e)e.hasOwnProperty(t)&&r.append(t,e[t])}let n={method:"GET",headers:r,mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade"};if("object"==typeof this._config.headers)for(let a in this._config.headers)r.append(a,this._config.headers[a]);!1===e.cors&&(n.mode="same-origin"),e.withCredentials&&(n.credentials="include"),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),self.AbortController&&(this._abortController=new self.AbortController,n.signal=this._abortController.signal),this._status=Q.kConnecting,self.fetch(s.url,n).then((e=>{if(this._requestAbort)return this._status=Q.kIdle,void e.body.cancel();if(e.ok&&e.status>=200&&e.status<=299){if(e.url!==s.url&&this._onURLRedirect){let t=this._seekHandler.removeURLParameters(e.url);this._onURLRedirect(t)}let t=e.headers.get("Content-Length");return null!=t&&(this._contentLength=parseInt(t),0!==this._contentLength&&this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength)),this._pump.call(this,e.body.getReader())}if(console.info("ana - fetch not 200"),this._status=Q.kError,!this._onError)throw new j("FetchStreamLoader: Http code invalid, "+e.status+" "+e.statusText);this._onError(Z.HTTP_STATUS_CODE_INVALID,{code:e.status,msg:e.statusText})})).catch((e=>{if(console.info("ana - fetch error"),!this._abortController||!this._abortController.signal.aborted){if(this._status=Q.kError,!this._onError)throw e;this._onError(Z.EXCEPTION,{code:-1,msg:e.message})}}))}abort(){if(this._requestAbort=!0,(this._status!==Q.kBuffering||!ee.chrome)&&this._abortController)try{this._abortController.abort()}catch(e){}}_pump(e){return e.read().then((t=>{if(t.done)if(null!==this._contentLength&&this._receivedLength<this._contentLength){this._status=Q.kError;let e=Z.EARLY_EOF,t={code:-1,msg:"Fetch stream meet Early-EOF"};if(!this._onError)throw new j(t.msg);this._onError(e,t)}else console.info("ana - reader complete"),this._status=Q.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1);else{if(this._abortController&&this._abortController.signal.aborted)return void(this._status=Q.kComplete);if(!0===this._requestAbort)return this._status=Q.kComplete,e.cancel();this._status=Q.kBuffering;let i=t.value.buffer,s=this._range.from+this._receivedLength;this._receivedLength+=i.byteLength,this._onDataArrival&&this._onDataArrival(i,s,this._receivedLength),this._pump(e)}})).catch((e=>{if(console.info("ana - reader error"),this._abortController&&this._abortController.signal.aborted)return void(this._status=Q.kComplete);if(11===e.code&&ee.msedge)return;this._status=Q.kError;let t=0,i=null;if(19!==e.code&&"network error"!==e.message||!(null===this._contentLength||null!==this._contentLength&&this._receivedLength<this._contentLength)?(t=Z.EXCEPTION,i={code:e.code,msg:e.message}):(t=Z.EARLY_EOF,i={code:e.code,msg:"Fetch stream meet Early-EOF"}),!this._onError)throw new j(i.msg);this._onError(t,i)}))}}class ie extends J{static isSupported(){try{let e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),e.responseType="moz-chunked-arraybuffer","moz-chunked-arraybuffer"===e.responseType}catch(e){return z.w("MozChunkedLoader",e.message),!1}}constructor(e,t){super("xhr-moz-chunked-loader"),this.TAG="MozChunkedLoader",this._seekHandler=e,this._config=t,this._needStash=!0,this._xhr=null,this._requestAbort=!1,this._contentLength=null,this._receivedLength=0}destroy(){this.isWorking()&&this.abort(),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onloadend=null,this._xhr.onerror=null,this._xhr=null),super.destroy()}open(e,t){this._dataSource=e,this._range=t;let i=e.url;this._config.reuseRedirectedURL&&null!=e.redirectedURL&&(i=e.redirectedURL);let s=this._seekHandler.getConfig(i,t);this._requestURL=s.url;let r=this._xhr=new XMLHttpRequest;if(r.open("GET",s.url,!0),r.responseType="moz-chunked-arraybuffer",r.onreadystatechange=this._onReadyStateChange.bind(this),r.onprogress=this._onProgress.bind(this),r.onloadend=this._onLoadEnd.bind(this),r.onerror=this._onXhrError.bind(this),e.withCredentials&&(r.withCredentials=!0),"object"==typeof s.headers){let e=s.headers;for(let t in e)e.hasOwnProperty(t)&&r.setRequestHeader(t,e[t])}if("object"==typeof this._config.headers){let e=this._config.headers;for(let t in e)e.hasOwnProperty(t)&&r.setRequestHeader(t,e[t])}this._status=Q.kConnecting,r.send()}abort(){this._requestAbort=!0,this._xhr&&this._xhr.abort(),this._status=Q.kComplete}_onReadyStateChange(e){let t=e.target;if(2===t.readyState){if(null!=t.responseURL&&t.responseURL!==this._requestURL&&this._onURLRedirect){let e=this._seekHandler.removeURLParameters(t.responseURL);this._onURLRedirect(e)}if(0!==t.status&&(t.status<200||t.status>299)){if(this._status=Q.kError,!this._onError)throw new j("MozChunkedLoader: Http code invalid, "+t.status+" "+t.statusText);this._onError(Z.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}else this._status=Q.kBuffering}}_onProgress(e){if(this._status===Q.kError)return;null===this._contentLength&&null!==e.total&&0!==e.total&&(this._contentLength=e.total,this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength));let t=e.target.response,i=this._range.from+this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,i,this._receivedLength)}_onLoadEnd(e){!0!==this._requestAbort?this._status!==Q.kError&&(this._status=Q.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1)):this._requestAbort=!1}_onXhrError(e){this._status=Q.kError;let t=0,i=null;if(this._contentLength&&e.loaded<this._contentLength?(t=Z.EARLY_EOF,i={code:-1,msg:"Moz-Chunked stream meet Early-Eof"}):(t=Z.EXCEPTION,i={code:-1,msg:e.constructor.name+" "+e.type}),!this._onError)throw new j(i.msg);this._onError(t,i)}}class se extends J{static isSupported(){try{let e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),e.responseType="arraybuffer","arraybuffer"===e.responseType}catch(e){return z.w("RangeLoader",e.message),!1}}constructor(e,t){super("xhr-range-loader"),this.TAG="RangeLoader",this._seekHandler=e,this._config=t,this._needStash=!1,this._chunkSizeKBList=[128,256,384,512,768,1024,1536,2048,3072,4096,5120,6144,7168,8192],this._currentChunkSizeKB=384,this._currentSpeedNormalized=0,this._zeroSpeedChunkCount=0,this._xhr=null,this._speedSampler=new W,this._requestAbort=!1,this._waitForTotalLength=!1,this._totalLengthReceived=!1,this._currentRequestURL=null,this._currentRedirectedURL=null,this._currentRequestRange=null,this._totalLength=null,this._contentLength=null,this._receivedLength=0,this._lastTimeLoaded=0}destroy(){this.isWorking()&&this.abort(),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr=null),super.destroy()}get currentSpeed(){return this._speedSampler.lastSecondKBps}open(e,t){this._dataSource=e,this._range=t,this._status=Q.kConnecting;let i=!1;null!=this._dataSource.filesize&&0!==this._dataSource.filesize&&(i=!0,this._totalLength=this._dataSource.filesize),this._totalLengthReceived||i?this._openSubRange():(this._waitForTotalLength=!0,this._internalOpen(this._dataSource,{from:0,to:-1}))}_openSubRange(){let e=1024*this._currentChunkSizeKB,t=this._range.from+this._receivedLength,i=t+e;null!=this._contentLength&&i-this._range.from>=this._contentLength&&(i=this._range.from+this._contentLength-1),this._currentRequestRange={from:t,to:i},this._internalOpen(this._dataSource,this._currentRequestRange)}_internalOpen(e,t){this._lastTimeLoaded=0;let i=e.url;this._config.reuseRedirectedURL&&(null!=this._currentRedirectedURL?i=this._currentRedirectedURL:null!=e.redirectedURL&&(i=e.redirectedURL));let s=this._seekHandler.getConfig(i,t);this._currentRequestURL=s.url;let r=this._xhr=new XMLHttpRequest;if(r.open("GET",s.url,!0),r.responseType="arraybuffer",r.onreadystatechange=this._onReadyStateChange.bind(this),r.onprogress=this._onProgress.bind(this),r.onload=this._onLoad.bind(this),r.onerror=this._onXhrError.bind(this),e.withCredentials&&(r.withCredentials=!0),"object"==typeof s.headers){let e=s.headers;for(let t in e)e.hasOwnProperty(t)&&r.setRequestHeader(t,e[t])}if("object"==typeof this._config.headers){let e=this._config.headers;for(let t in e)e.hasOwnProperty(t)&&r.setRequestHeader(t,e[t])}r.send()}abort(){this._requestAbort=!0,this._internalAbort(),this._status=Q.kComplete}_internalAbort(){this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr.abort(),this._xhr=null)}_onReadyStateChange(e){let t=e.target;if(2===t.readyState){if(null!=t.responseURL){let e=this._seekHandler.removeURLParameters(t.responseURL);t.responseURL!==this._currentRequestURL&&e!==this._currentRedirectedURL&&(this._currentRedirectedURL=e,this._onURLRedirect&&this._onURLRedirect(e))}if(t.status>=200&&t.status<=299){if(this._waitForTotalLength)return;this._status=Q.kBuffering}else{if(this._status=Q.kError,!this._onError)throw new j("RangeLoader: Http code invalid, "+t.status+" "+t.statusText);this._onError(Z.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}}}_onProgress(e){if(this._status===Q.kError)return;if(null===this._contentLength){let t=!1;if(this._waitForTotalLength){this._waitForTotalLength=!1,this._totalLengthReceived=!0,t=!0;let i=e.total;this._internalAbort(),null!=i&0!==i&&(this._totalLength=i)}if(-1===this._range.to?this._contentLength=this._totalLength-this._range.from:this._contentLength=this._range.to-this._range.from+1,t)return void this._openSubRange();this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength)}let t=e.loaded-this._lastTimeLoaded;this._lastTimeLoaded=e.loaded,this._speedSampler.addBytes(t)}_normalizeSpeed(e){let t=this._chunkSizeKBList,i=t.length-1,s=0,r=0,n=i;if(e<t[0])return t[0];for(;r<=n;){if(s=r+Math.floor((n-r)/2),s===i||e>=t[s]&&e<t[s+1])return t[s];t[s]<e?r=s+1:n=s-1}}_onLoad(e){if(this._status===Q.kError)return;if(this._waitForTotalLength)return void(this._waitForTotalLength=!1);this._lastTimeLoaded=0;let t=this._speedSampler.lastSecondKBps;if(0===t&&(this._zeroSpeedChunkCount++,this._zeroSpeedChunkCount>=3&&(t=this._speedSampler.currentKBps)),0!==t){let e=this._normalizeSpeed(t);this._currentSpeedNormalized!==e&&(this._currentSpeedNormalized=e,this._currentChunkSizeKB=e)}let i=e.target.response,s=this._range.from+this._receivedLength;this._receivedLength+=i.byteLength;let r=!1;null!=this._contentLength&&this._receivedLength<this._contentLength?this._openSubRange():r=!0,this._onDataArrival&&this._onDataArrival(i,s,this._receivedLength),r&&(this._status=Q.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1))}_onXhrError(e){this._status=Q.kError;let t=0,i=null;if(this._contentLength&&this._receivedLength>0&&this._receivedLength<this._contentLength?(t=Z.EARLY_EOF,i={code:-1,msg:"RangeLoader meet Early-Eof"}):(t=Z.EXCEPTION,i={code:-1,msg:e.constructor.name+" "+e.type}),!this._onError)throw new j(i.msg);this._onError(t,i)}}class re extends J{static isSupported(){try{return void 0!==self.WebSocket}catch(e){return!1}}constructor(){super("websocket-loader"),this.TAG="WebSocketLoader",this._needStash=!0,this._ws=null,this._requestAbort=!1,this._receivedLength=0}destroy(){this._ws&&this.abort(),super.destroy()}open(e){try{let t=this._ws=new self.WebSocket(e.url);t.binaryType="arraybuffer",t.onopen=this._onWebSocketOpen.bind(this),t.onclose=this._onWebSocketClose.bind(this),t.onmessage=this._onWebSocketMessage.bind(this),t.onerror=this._onWebSocketError.bind(this),this._status=Q.kConnecting}catch(t){this._status=Q.kError;let e={code:t.code,msg:t.message};if(!this._onError)throw new j(e.msg);this._onError(Z.EXCEPTION,e)}}abort(){let e=this._ws;!e||0!==e.readyState&&1!==e.readyState||(this._requestAbort=!0,e.close()),this._ws=null,this._status=Q.kComplete}_onWebSocketOpen(e){this._status=Q.kBuffering}_onWebSocketClose(e){!0!==this._requestAbort?(this._status=Q.kComplete,this._onComplete&&this._onComplete(0,this._receivedLength-1)):this._requestAbort=!1}_onWebSocketMessage(e){if(e.data instanceof ArrayBuffer)this._dispatchArrayBuffer(e.data);else if(e.data instanceof Blob){let t=new FileReader;t.onload=()=>{this._dispatchArrayBuffer(t.result)},t.readAsArrayBuffer(e.data)}else{this._status=Q.kError;let t={code:-1,msg:"Unsupported WebSocket message type: "+e.data.constructor.name};if(!this._onError)throw new j(t.msg);this._onError(Z.EXCEPTION,t)}}_dispatchArrayBuffer(e){let t=e,i=this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,i,this._receivedLength)}_onWebSocketError(e){this._status=Q.kError;let t={code:e.code,msg:e.message};if(!this._onError)throw new j(t.msg);this._onError(Z.EXCEPTION,t)}}class ne{constructor(e){this._zeroStart=e||!1}getConfig(e,t){let i={};if(0!==t.from||-1!==t.to){let e;e=-1!==t.to?`bytes=${t.from.toString()}-${t.to.toString()}`:`bytes=${t.from.toString()}-`,i.Range=e}else this._zeroStart&&(i.Range="bytes=0-");return{url:e,headers:i}}removeURLParameters(e){return e}}class ae{constructor(e,t){this._startName=e,this._endName=t}getConfig(e,t){let i=e;if(0!==t.from||-1!==t.to){let e=!0;-1===i.indexOf("?")&&(i+="?",e=!1),e&&(i+="&"),i+=`${this._startName}=${t.from.toString()}`,-1!==t.to&&(i+=`&${this._endName}=${t.to.toString()}`)}return{url:i,headers:{}}}removeURLParameters(e){let t,i=e.split("?")[0],s=e.indexOf("?");-1!==s&&(t=e.substring(s+1));let r="";if(null!=t&&t.length>0){let e=t.split("&");for(let t=0;t<e.length;t++){let i=e[t].split("="),s=t>0;i[0]!==this._startName&&i[0]!==this._endName&&(s&&(r+="&"),r+=e[t])}}return 0===r.length?i:i+"?"+r}}class oe{constructor(e,t,i){this.TAG="IOController",this._config=t,this._extraData=i,this._stashInitialSize=393216,null!=t.stashInitialSize&&t.stashInitialSize>0&&(this._stashInitialSize=t.stashInitialSize),this._stashUsed=0,this._stashSize=this._stashInitialSize,this._bufferSize=3145728,this._stashBuffer=new ArrayBuffer(this._bufferSize),this._stashByteStart=0,this._enableStash=!0,!1===t.enableStashBuffer&&(this._enableStash=!1),this._loader=null,this._loaderClass=null,this._seekHandler=null,this._dataSource=e,this._isWebSocketURL=/wss?:\/\/(.+?)/.test(e.url),this._refTotalLength=e.filesize?e.filesize:null,this._totalLength=this._refTotalLength,this._fullRequestFlag=!1,this._currentRange=null,this._redirectedURL=null,this._speedNormalized=0,this._speedSampler=new W,this._speedNormalizeList=[64,128,256,384,512,768,1024,1536,2048,3072,4096],this._isEarlyEofReconnecting=!1,this._paused=!1,this._resumeFrom=0,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._selectSeekHandler(),this._selectLoader(),this._createLoader()}destroy(){this._loader.isWorking()&&this._loader.abort(),this._loader.destroy(),this._loader=null,this._loaderClass=null,this._dataSource=null,this._stashBuffer=null,this._stashUsed=this._stashSize=this._bufferSize=this._stashByteStart=0,this._currentRange=null,this._speedSampler=null,this._isEarlyEofReconnecting=!1,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._extraData=null}isWorking(){return this._loader&&this._loader.isWorking()&&!this._paused}isPaused(){return this._paused}get status(){return this._loader.status}get extraData(){return this._extraData}set extraData(e){this._extraData=e}get onDataArrival(){return this._onDataArrival}set onDataArrival(e){this._onDataArrival=e}get onSeeked(){return this._onSeeked}set onSeeked(e){this._onSeeked=e}get onError(){return this._onError}set onError(e){this._onError=e}get onComplete(){return this._onComplete}set onComplete(e){this._onComplete=e}get onRedirect(){return this._onRedirect}set onRedirect(e){this._onRedirect=e}get onRecoveredEarlyEof(){return this._onRecoveredEarlyEof}set onRecoveredEarlyEof(e){this._onRecoveredEarlyEof=e}get currentURL(){return this._dataSource.url}get hasRedirect(){return null!=this._redirectedURL||null!=this._dataSource.redirectedURL}get currentRedirectedURL(){return this._redirectedURL||this._dataSource.redirectedURL}get currentSpeed(){return this._loaderClass===se?this._loader.currentSpeed:this._speedSampler.lastSecondKBps}get loaderType(){return this._loader.type}_selectSeekHandler(){let e=this._config;if("range"===e.seekType)this._seekHandler=new ne(this._config.rangeLoadZeroStart);else if("param"===e.seekType){let t=e.seekParamStart||"bstart",i=e.seekParamEnd||"bend";this._seekHandler=new ae(t,i)}else{if("custom"!==e.seekType)throw new X(`Invalid seekType in config: ${e.seekType}`);if("function"!=typeof e.customSeekHandler)throw new X("Custom seekType specified in config but invalid customSeekHandler!");this._seekHandler=new e.customSeekHandler}}_selectLoader(){if(null!=this._config.customLoader)this._loaderClass=this._config.customLoader;else if(this._isWebSocketURL)this._loaderClass=re;else if(te.isSupported())this._loaderClass=te;else if(ie.isSupported())this._loaderClass=ie;else{if(!se.isSupported())throw new j("Your browser doesn't support xhr with arraybuffer responseType!");this._loaderClass=se}}_createLoader(){this._loader=new this._loaderClass(this._seekHandler,this._config),!1===this._loader.needStashBuffer&&(this._enableStash=!1),this._loader.onContentLengthKnown=this._onContentLengthKnown.bind(this),this._loader.onURLRedirect=this._onURLRedirect.bind(this),this._loader.onDataArrival=this._onLoaderChunkArrival.bind(this),this._loader.onComplete=this._onLoaderComplete.bind(this),this._loader.onError=this._onLoaderError.bind(this)}open(e){this._currentRange={from:0,to:-1},e&&(this._currentRange.from=e),this._speedSampler.reset(),e||(this._fullRequestFlag=!0),this._loader.open(this._dataSource,Object.assign({},this._currentRange))}abort(){this._loader.abort(),this._paused&&(this._paused=!1,this._resumeFrom=0)}pause(){this.isWorking()&&(this._loader.abort(),0!==this._stashUsed?(this._resumeFrom=this._stashByteStart,this._currentRange.to=this._stashByteStart-1):this._resumeFrom=this._currentRange.to+1,this._stashUsed=0,this._stashByteStart=0,this._paused=!0)}resume(){if(this._paused){this._paused=!1;let e=this._resumeFrom;this._resumeFrom=0,this._internalSeek(e,!0)}}seek(e){this._paused=!1,this._stashUsed=0,this._stashByteStart=0,this._internalSeek(e,!0)}_internalSeek(e,t){this._loader.isWorking()&&this._loader.abort(),this._flushStashBuffer(t),this._loader.destroy(),this._loader=null;let i={from:e,to:-1};this._currentRange={from:i.from,to:-1},this._speedSampler.reset(),this._stashSize=this._stashInitialSize,this._createLoader(),this._loader.open(this._dataSource,i),this._onSeeked&&this._onSeeked()}updateUrl(e){if(!e||"string"!=typeof e||0===e.length)throw new X("Url must be a non-empty string!");this._dataSource.url=e}_expandBuffer(e){let t=this._stashSize;for(;t+1048576<e;)t*=2;if(t+=1048576,t===this._bufferSize)return;let i=new ArrayBuffer(t);if(this._stashUsed>0){let e=new Uint8Array(this._stashBuffer,0,this._stashUsed);new Uint8Array(i,0,t).set(e,0)}this._stashBuffer=i,this._bufferSize=t}_normalizeSpeed(e){let t=this._speedNormalizeList,i=t.length-1,s=0,r=0,n=i;if(e<t[0])return t[0];for(;r<=n;){if(s=r+Math.floor((n-r)/2),s===i||e>=t[s]&&e<t[s+1])return t[s];t[s]<e?r=s+1:n=s-1}}_adjustStashSize(e){let t=0;t=this._config.isLive||e<512?e:e>=512&&e<=1024?Math.floor(1.5*e):2*e,t>8192&&(t=8192);let i=1024*t+1048576;this._bufferSize<i&&this._expandBuffer(i),this._stashSize=1024*t}_dispatchChunks(e,t){return this._currentRange.to=t+e.byteLength-1,this._onDataArrival(e,t)}_onURLRedirect(e){this._redirectedURL=e,this._onRedirect&&this._onRedirect(e)}_onContentLengthKnown(e){e&&this._fullRequestFlag&&(this._totalLength=e,this._fullRequestFlag=!1)}_onLoaderChunkArrival(e,t,i){if(!this._onDataArrival)throw new q("IOController: No existing consumer (onDataArrival) callback!");if(this._paused)return;this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,this._onRecoveredEarlyEof&&this._onRecoveredEarlyEof()),this._speedSampler.addBytes(e.byteLength);let s=this._speedSampler.lastSecondKBps;if(0!==s){let e=this._normalizeSpeed(s);this._speedNormalized!==e&&(this._speedNormalized=e,this._adjustStashSize(e))}if(this._enableStash)if(0===this._stashUsed&&0===this._stashByteStart&&(this._stashByteStart=t),this._stashUsed+e.byteLength<=this._stashSize){new Uint8Array(this._stashBuffer,0,this._stashSize).set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength}else{let i=new Uint8Array(this._stashBuffer,0,this._bufferSize);if(this._stashUsed>0){let t=this._stashBuffer.slice(0,this._stashUsed),s=this._dispatchChunks(t,this._stashByteStart);if(s<t.byteLength){if(s>0){let e=new Uint8Array(t,s);i.set(e,0),this._stashUsed=e.byteLength,this._stashByteStart+=s}}else this._stashUsed=0,this._stashByteStart+=s;this._stashUsed+e.byteLength>this._bufferSize&&(this._expandBuffer(this._stashUsed+e.byteLength),i=new Uint8Array(this._stashBuffer,0,this._bufferSize)),i.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength}else{let s=this._dispatchChunks(e,t);if(s<e.byteLength){let r=e.byteLength-s;r>this._bufferSize&&(this._expandBuffer(r),i=new Uint8Array(this._stashBuffer,0,this._bufferSize)),i.set(new Uint8Array(e,s),0),this._stashUsed+=r,this._stashByteStart=t+s}}}else if(0===this._stashUsed){let i=this._dispatchChunks(e,t);if(i<e.byteLength){let s=e.byteLength-i;s>this._bufferSize&&this._expandBuffer(s),new Uint8Array(this._stashBuffer,0,this._bufferSize).set(new Uint8Array(e,i),0),this._stashUsed+=s,this._stashByteStart=t+i}}else{this._stashUsed+e.byteLength>this._bufferSize&&this._expandBuffer(this._stashUsed+e.byteLength);let t=new Uint8Array(this._stashBuffer,0,this._bufferSize);t.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength;let i=this._dispatchChunks(this._stashBuffer.slice(0,this._stashUsed),this._stashByteStart);if(i<this._stashUsed&&i>0){let e=new Uint8Array(this._stashBuffer,i);t.set(e,0)}this._stashUsed-=i,this._stashByteStart+=i}}_flushStashBuffer(e){if(this._stashUsed>0){let t=this._stashBuffer.slice(0,this._stashUsed),i=this._dispatchChunks(t,this._stashByteStart),s=t.byteLength-i;if(i<t.byteLength){if(!e){if(i>0){let e=new Uint8Array(this._stashBuffer,0,this._bufferSize),s=new Uint8Array(t,i);e.set(s,0),this._stashUsed=s.byteLength,this._stashByteStart+=i}return 0}z.w(this.TAG,`${s} bytes unconsumed data remain when flush buffer, dropped`)}return this._stashUsed=0,this._stashByteStart=0,s}return 0}_onLoaderComplete(e,t){this._flushStashBuffer(!0),this._onComplete&&this._onComplete(this._extraData)}_onLoaderError(e,t){switch(z.e(this.TAG,`Loader error, code = ${t.code}, msg = ${t.msg}`),this._flushStashBuffer(!1),this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,e=Z.UNRECOVERABLE_EARLY_EOF),e){case Z.EARLY_EOF:if(!this._config.isLive&&this._totalLength){let e=this._currentRange.to+1;return void(e<this._totalLength&&(z.w(this.TAG,"Connection lost, trying reconnect..."),this._isEarlyEofReconnecting=!0,this._internalSeek(e,!1)))}e=Z.UNRECOVERABLE_EARLY_EOF}if(!this._onError)throw new j("IOException: "+t.msg);this._onError(e,t)}}const le={enableWorker:!1,enableStashBuffer:!0,stashInitialSize:void 0,isLive:!1,lazyLoad:!0,lazyLoadMaxDuration:180,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,accurateSeek:!1,seekType:"range",seekParamStart:"bstart",seekParamEnd:"bend",rangeLoadZeroStart:!1,customSeekHandler:void 0,reuseRedirectedURL:!1,headers:void 0,customLoader:void 0};function he(){return Object.assign({},le)}class de{static supportMSEH264Playback(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}static supportNetworkStreamIO(){let e=new oe({},he()),t=e.loaderType;return e.destroy(),"fetch-stream-loader"==t||"xhr-moz-chunked-loader"==t}static getNetworkLoaderTypeName(){let e=new oe({},he()),t=e.loaderType;return e.destroy(),t}static supportNativeMediaPlayback(e){null==de.videoElement&&(de.videoElement=window.document.createElement("video"));let t=de.videoElement.canPlayType(e);return"probably"===t||"maybe"==t}static getFeatureList(){let e={mseFlvPlayback:!1,mseLiveFlvPlayback:!1,networkStreamIO:!1,networkLoaderName:"",nativeMP4H264Playback:!1,nativeWebmVP8Playback:!1,nativeWebmVP9Playback:!1};return e.mseFlvPlayback=de.supportMSEH264Playback(),e.networkStreamIO=de.supportNetworkStreamIO(),e.networkLoaderName=de.getNetworkLoaderTypeName(),e.mseLiveFlvPlayback=e.mseFlvPlayback&&e.networkStreamIO,e.nativeMP4H264Playback=de.supportNativeMediaPlayback('video/mp4; codecs="avc1.42001E, mp4a.40.2"'),e.nativeWebmVP8Playback=de.supportNativeMediaPlayback('video/webm; codecs="vp8.0, vorbis"'),e.nativeWebmVP9Playback=de.supportNativeMediaPlayback('video/webm; codecs="vp9"'),e}}const ue={ERROR:"error",LOADING_COMPLETE:"loading_complete",RECOVERED_EARLY_EOF:"recovered_early_eof",MEDIA_INFO:"media_info",METADATA_ARRIVED:"metadata_arrived",SCRIPTDATA_ARRIVED:"scriptdata_arrived",STATISTICS_INFO:"statistics_info"};class ce{static get forceGlobalTag(){return z.FORCE_GLOBAL_TAG}static set forceGlobalTag(e){z.FORCE_GLOBAL_TAG=e,ce._notifyChange()}static get globalTag(){return z.GLOBAL_TAG}static set globalTag(e){z.GLOBAL_TAG=e,ce._notifyChange()}static get enableAll(){return z.ENABLE_VERBOSE&&z.ENABLE_DEBUG&&z.ENABLE_INFO&&z.ENABLE_WARN&&z.ENABLE_ERROR}static set enableAll(e){z.ENABLE_VERBOSE=e,z.ENABLE_DEBUG=e,z.ENABLE_INFO=e,z.ENABLE_WARN=e,z.ENABLE_ERROR=e,ce._notifyChange()}static get enableDebug(){return z.ENABLE_DEBUG}static set enableDebug(e){z.ENABLE_DEBUG=e,ce._notifyChange()}static get enableVerbose(){return z.ENABLE_VERBOSE}static set enableVerbose(e){z.ENABLE_VERBOSE=e,ce._notifyChange()}static get enableInfo(){return z.ENABLE_INFO}static set enableInfo(e){z.ENABLE_INFO=e,ce._notifyChange()}static get enableWarn(){return z.ENABLE_WARN}static set enableWarn(e){z.ENABLE_WARN=e,ce._notifyChange()}static get enableError(){return z.ENABLE_ERROR}static set enableError(e){z.ENABLE_ERROR=e,ce._notifyChange()}static getConfig(){return{globalTag:z.GLOBAL_TAG,forceGlobalTag:z.FORCE_GLOBAL_TAG,enableVerbose:z.ENABLE_VERBOSE,enableDebug:z.ENABLE_DEBUG,enableInfo:z.ENABLE_INFO,enableWarn:z.ENABLE_WARN,enableError:z.ENABLE_ERROR,enableCallback:z.ENABLE_CALLBACK}}static applyConfig(e){z.GLOBAL_TAG=e.globalTag,z.FORCE_GLOBAL_TAG=e.forceGlobalTag,z.ENABLE_VERBOSE=e.enableVerbose,z.ENABLE_DEBUG=e.enableDebug,z.ENABLE_INFO=e.enableInfo,z.ENABLE_WARN=e.enableWarn,z.ENABLE_ERROR=e.enableError,z.ENABLE_CALLBACK=e.enableCallback}static _notifyChange(){let e=ce.emitter;if(e.listenerCount("change")>0){let t=ce.getConfig();e.emit("change",t)}}static registerListener(e){ce.emitter.addListener("change",e)}static removeListener(e){ce.emitter.removeListener("change",e)}static addLogListener(e){z.emitter.addListener("log",e),z.emitter.listenerCount("log")>0&&(z.ENABLE_CALLBACK=!0,ce._notifyChange())}static removeLogListener(e){z.emitter.removeListener("log",e),0===z.emitter.listenerCount("log")&&(z.ENABLE_CALLBACK=!1,ce._notifyChange())}}ce.emitter=new u;class fe{constructor(){this.mimeType=null,this.duration=null,this.hasAudio=null,this.hasVideo=null,this.audioCodec=null,this.videoCodec=null,this.audioDataRate=null,this.videoDataRate=null,this.audioSampleRate=null,this.audioChannelCount=null,this.width=null,this.height=null,this.fps=null,this.profile=null,this.level=null,this.refFrames=null,this.chromaFormat=null,this.sarNum=null,this.sarDen=null,this.metadata=null,this.segments=null,this.segmentCount=null,this.hasKeyframesIndex=null,this.keyframesIndex=null}isComplete(){let e=!1===this.hasAudio||!0===this.hasAudio&&null!=this.audioCodec&&null!=this.audioSampleRate&&null!=this.audioChannelCount,t=!1===this.hasVideo||!0===this.hasVideo&&null!=this.videoCodec&&null!=this.width&&null!=this.height&&null!=this.fps&&null!=this.profile&&null!=this.level&&null!=this.refFrames&&null!=this.chromaFormat&&null!=this.sarNum&&null!=this.sarDen;return null!=this.mimeType&&null!=this.duration&&null!=this.metadata&&null!=this.hasKeyframesIndex&&e&&t}isSeekable(){return!0===this.hasKeyframesIndex}getNearestKeyframe(e){if(null==this.keyframesIndex)return null;let t=this.keyframesIndex,i=this._search(t.times,e);return{index:i,milliseconds:t.times[i],fileposition:t.filepositions[i]}}_search(e,t){let i=0,s=e.length-1,r=0,n=0,a=s;for(t<e[0]&&(i=0,n=a+1);n<=a;){if(r=n+Math.floor((a-n)/2),r===s||t>=e[r]&&t<e[r+1]){i=r;break}e[r]<t?n=r+1:a=r-1}return i}}function me(e,t,i){let s=e;if(t+i<s.length){for(;i--;)if(128!=(192&s[++t]))return!1;return!0}return!1}function ge(e){let t=[],i=e,s=0,r=e.length;for(;s<r;)if(i[s]<128)t.push(String.fromCharCode(i[s])),++s;else{if(i[s]<192);else if(i[s]<224){if(me(i,s,1)){let e=(31&i[s])<<6|63&i[s+1];if(e>=128){t.push(String.fromCharCode(65535&e)),s+=2;continue}}}else if(i[s]<240){if(me(i,s,2)){let e=(15&i[s])<<12|(63&i[s+1])<<6|63&i[s+2];if(e>=2048&&55296!=(63488&e)){t.push(String.fromCharCode(65535&e)),s+=3;continue}}}else if(i[s]<248&&me(i,s,3)){let e=(7&i[s])<<18|(63&i[s+1])<<12|(63&i[s+2])<<6|63&i[s+3];if(e>65536&&e<1114112){e-=65536,t.push(String.fromCharCode(e>>>10|55296)),t.push(String.fromCharCode(1023&e|56320)),s+=4;continue}}t.push(String.fromCharCode(65533)),++s}return t.join("")}let pe=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}();class _e{static parseScriptData(e,t,i){let s={};try{let r=_e.parseValue(e,t,i),n=_e.parseValue(e,t+r.size,i-r.size);s[r.data]=n.data}catch(r){z.e("AMF",r.toString())}return s}static parseObject(e,t,i){if(i<3)throw new q("Data not enough when parse ScriptDataObject");let s=_e.parseString(e,t,i),r=_e.parseValue(e,t+s.size,i-s.size),n=r.objectEnd;return{data:{name:s.data,value:r.data},size:s.size+r.size,objectEnd:n}}static parseVariable(e,t,i){return _e.parseObject(e,t,i)}static parseString(e,t,i){if(i<2)throw new q("Data not enough when parse String");let s,r=new DataView(e,t,i).getUint16(0,!pe);return s=r>0?ge(new Uint8Array(e,t+2,r)):"",{data:s,size:2+r}}static parseLongString(e,t,i){if(i<4)throw new q("Data not enough when parse LongString");let s,r=new DataView(e,t,i).getUint32(0,!pe);return s=r>0?ge(new Uint8Array(e,t+4,r)):"",{data:s,size:4+r}}static parseDate(e,t,i){if(i<10)throw new q("Data size invalid when parse Date");let s=new DataView(e,t,i),r=s.getFloat64(0,!pe);return r+=60*s.getInt16(8,!pe)*1e3,{data:new Date(r),size:10}}static parseValue(e,t,i){if(i<1)throw new q("Data not enough when parse Value");let s,r=new DataView(e,t,i),n=1,a=r.getUint8(0),o=!1;try{switch(a){case 0:s=r.getFloat64(1,!pe),n+=8;break;case 1:s=!!r.getUint8(1),n+=1;break;case 2:{let r=_e.parseString(e,t+1,i-1);s=r.data,n+=r.size;break}case 3:{s={};let a=0;for(9==(16777215&r.getUint32(i-4,!pe))&&(a=3);n<i-4;){let r=_e.parseObject(e,t+n,i-n-a);if(r.objectEnd)break;s[r.data.name]=r.data.value,n+=r.size}if(n<=i-3){9===(16777215&r.getUint32(n-1,!pe))&&(n+=3)}break}case 8:{s={},n+=4;let a=0;for(9==(16777215&r.getUint32(i-4,!pe))&&(a=3);n<i-8;){let r=_e.parseVariable(e,t+n,i-n-a);if(r.objectEnd)break;s[r.data.name]=r.data.value,n+=r.size}if(n<=i-3){9===(16777215&r.getUint32(n-1,!pe))&&(n+=3)}break}case 9:s=void 0,n=1,o=!0;break;case 10:{s=[];let a=r.getUint32(1,!pe);n+=4;for(let r=0;r<a;r++){let r=_e.parseValue(e,t+n,i-n);s.push(r.data),n+=r.size}break}case 11:{let r=_e.parseDate(e,t+1,i-1);s=r.data,n+=r.size;break}case 12:{let r=_e.parseString(e,t+1,i-1);s=r.data,n+=r.size;break}default:n=i,z.w("AMF","Unsupported AMF value type "+a)}}catch(l){z.e("AMF",l.toString())}return{data:s,size:n,objectEnd:o}}}class ve{constructor(e){this.TAG="ExpGolomb",this._buffer=e,this._buffer_index=0,this._total_bytes=e.byteLength,this._total_bits=8*e.byteLength,this._current_word=0,this._current_word_bits_left=0}destroy(){this._buffer=null}_fillCurrentWord(){let e=this._total_bytes-this._buffer_index;if(e<=0)throw new q("ExpGolomb: _fillCurrentWord() but no bytes available");let t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(i.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t}readBits(e){if(e>32)throw new X("ExpGolomb: readBits() bits exceeded max 32bits!");if(e<=this._current_word_bits_left){let t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}let t=this._current_word_bits_left?this._current_word:0;t>>>=32-this._current_word_bits_left;let i=e-this._current_word_bits_left;this._fillCurrentWord();let s=Math.min(i,this._current_word_bits_left),r=this._current_word>>>32-s;return this._current_word<<=s,this._current_word_bits_left-=s,t=t<<s|r,t}readBool(){return 1===this.readBits(1)}readByte(){return this.readBits(8)}_skipLeadingZero(){let e;for(e=0;e<this._current_word_bits_left;e++)if(0!=(this._current_word&2147483648>>>e))return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}readUEG(){let e=this._skipLeadingZero();return this.readBits(e+1)-1}readSEG(){let e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}class ye{static _ebsp2rbsp(e){let t=e,i=t.byteLength,s=new Uint8Array(i),r=0;for(let n=0;n<i;n++)n>=2&&3===t[n]&&0===t[n-1]&&0===t[n-2]||(s[r]=t[n],r++);return new Uint8Array(s.buffer,0,r)}static parseSPS(e){let t=ye._ebsp2rbsp(e),i=new ve(t);i.readByte();let s=i.readByte();i.readByte();let r=i.readByte();i.readUEG();let n=ye.getProfileString(s),a=ye.getLevelString(r),o=1,l=420,h=[0,420,422,444],d=8;if((100===s||110===s||122===s||244===s||44===s||83===s||86===s||118===s||128===s||138===s||144===s)&&(o=i.readUEG(),3===o&&i.readBits(1),o<=3&&(l=h[o]),d=i.readUEG()+8,i.readUEG(),i.readBits(1),i.readBool())){let e=3!==o?8:12;for(let t=0;t<e;t++)i.readBool()&&(t<6?ye._skipScalingList(i,16):ye._skipScalingList(i,64))}i.readUEG();let u=i.readUEG();if(0===u)i.readUEG();else if(1===u){i.readBits(1),i.readSEG(),i.readSEG();let e=i.readUEG();for(let t=0;t<e;t++)i.readSEG()}let c=i.readUEG();i.readBits(1);let f=i.readUEG(),m=i.readUEG(),g=i.readBits(1);0===g&&i.readBits(1),i.readBits(1);let p=0,_=0,v=0,y=0;i.readBool()&&(p=i.readUEG(),_=i.readUEG(),v=i.readUEG(),y=i.readUEG());let E=1,S=1,T=0,L=!0,b=0,A=0;if(i.readBool()){if(i.readBool()){let e=i.readByte(),t=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],s=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];e>0&&e<16?(E=t[e-1],S=s[e-1]):255===e&&(E=i.readByte()<<8|i.readByte(),S=i.readByte()<<8|i.readByte())}if(i.readBool()&&i.readBool(),i.readBool()&&(i.readBits(4),i.readBool()&&i.readBits(24)),i.readBool()&&(i.readUEG(),i.readUEG()),i.readBool()){let e=i.readBits(32),t=i.readBits(32);L=i.readBool(),b=t,A=2*e,T=b/A}}let R=1;1===E&&1===S||(R=E/S);let D=0,w=0;if(0===o)D=1,w=2-g;else{D=3===o?1:2,w=(1===o?2:1)*(2-g)}let k=16*(f+1),C=16*(m+1)*(2-g);k-=(p+_)*D,C-=(v+y)*w;let I=Math.ceil(k*R);return i.destroy(),i=null,{profile_string:n,level_string:a,bit_depth:d,ref_frames:c,chroma_format:l,chroma_format_string:ye.getChromaFormatString(l),frame_rate:{fixed:L,fps:T,fps_den:A,fps_num:b},sar_ratio:{width:E,height:S},codec_size:{width:k,height:C},present_size:{width:I,height:C}}}static _skipScalingList(e,t){let i=8,s=8,r=0;for(let n=0;n<t;n++)0!==s&&(r=e.readSEG(),s=(i+r+256)%256),i=0===s?i:s}static getProfileString(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}static getLevelString(e){return(e/10).toFixed(1)}static getChromaFormatString(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}const Ee="FormatError",Se="FormatUnsupported",Te="CodecUnsupported";class Le{constructor(e,t){this.TAG="FLVDemuxer",this._config=t,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onTrackMetadata=null,this._onDataAvailable=null,this._dataOffset=e.dataOffset,this._firstParse=!0,this._dispatch=!1,this._hasAudio=e.hasAudioTrack,this._hasVideo=e.hasVideoTrack,this._hasAudioFlagOverrided=!1,this._hasVideoFlagOverrided=!1,this._audioInitialMetadataDispatched=!1,this._videoInitialMetadataDispatched=!1,this._mediaInfo=new fe,this._mediaInfo.hasAudio=this._hasAudio,this._mediaInfo.hasVideo=this._hasVideo,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._naluLengthSize=4,this._timestampBase=0,this._timescale=1e3,this._duration=0,this._durationOverrided=!1,this._referenceFrameRate={fixed:!0,fps:23.976,fps_num:23976,fps_den:1e3},this._flvSoundRateTable=[5500,11025,22050,44100,48e3],this._mpegSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],this._mpegAudioV10SampleRateTable=[44100,48e3,32e3,0],this._mpegAudioV20SampleRateTable=[22050,24e3,16e3,0],this._mpegAudioV25SampleRateTable=[11025,12e3,8e3,0],this._mpegAudioL1BitRateTable=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],this._mpegAudioL2BitRateTable=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],this._mpegAudioL3BitRateTable=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],this._videoTrack={type:"video",id:1,sequenceNumber:0,samples:[],length:0},this._audioTrack={type:"audio",id:2,sequenceNumber:0,samples:[],length:0},this._littleEndian=function(){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}()}destroy(){this._mediaInfo=null,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._videoTrack=null,this._audioTrack=null,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onTrackMetadata=null,this._onDataAvailable=null}static probe(e){let t=new Uint8Array(e),i={match:!1};if(70!==t[0]||76!==t[1]||86!==t[2]||1!==t[3])return i;let s=(4&t[4])>>>2!=0,r=0!=(1&t[4]),n=(a=t)[o=5]<<24|a[o+1]<<16|a[o+2]<<8|a[o+3];var a,o;return n<9?i:{match:!0,consumed:n,dataOffset:n,hasAudioTrack:s,hasVideoTrack:r}}bindDataSource(e){return e.onDataArrival=this.parseChunks.bind(this),this}get onTrackMetadata(){return this._onTrackMetadata}set onTrackMetadata(e){this._onTrackMetadata=e}get onMediaInfo(){return this._onMediaInfo}set onMediaInfo(e){this._onMediaInfo=e}get onMetaDataArrived(){return this._onMetaDataArrived}set onMetaDataArrived(e){this._onMetaDataArrived=e}get onScriptDataArrived(){return this._onScriptDataArrived}set onScriptDataArrived(e){this._onScriptDataArrived=e}get onError(){return this._onError}set onError(e){this._onError=e}get onDataAvailable(){return this._onDataAvailable}set onDataAvailable(e){this._onDataAvailable=e}get timestampBase(){return this._timestampBase}set timestampBase(e){this._timestampBase=e}get overridedDuration(){return this._duration}set overridedDuration(e){this._durationOverrided=!0,this._duration=e,this._mediaInfo.duration=e}set overridedHasAudio(e){this._hasAudioFlagOverrided=!0,this._hasAudio=e,this._mediaInfo.hasAudio=e}set overridedHasVideo(e){this._hasVideoFlagOverrided=!0,this._hasVideo=e,this._mediaInfo.hasVideo=e}resetMediaInfo(){this._mediaInfo=new fe}_isInitialMetadataDispatched(){return this._hasAudio&&this._hasVideo?this._audioInitialMetadataDispatched&&this._videoInitialMetadataDispatched:this._hasAudio&&!this._hasVideo?this._audioInitialMetadataDispatched:!(this._hasAudio||!this._hasVideo)&&this._videoInitialMetadataDispatched}parseChunks(e,t){if(!(this._onError&&this._onMediaInfo&&this._onTrackMetadata&&this._onDataAvailable))throw new q("Flv: onError & onMediaInfo & onTrackMetadata & onDataAvailable callback must be specified");let i=0,s=this._littleEndian;if(0===t){if(!(e.byteLength>13))return 0;i=Le.probe(e).dataOffset}if(this._firstParse){this._firstParse=!1,t+i!==this._dataOffset&&z.w(this.TAG,"First time parsing but chunk byteStart invalid!"),0!==new DataView(e,i).getUint32(0,!s)&&z.w(this.TAG,"PrevTagSize0 !== 0 !!!"),i+=4}for(;i<e.byteLength;){this._dispatch=!0;let r=new DataView(e,i);if(i+11+4>e.byteLength)break;let n=r.getUint8(0),a=16777215&r.getUint32(0,!s);if(i+11+a+4>e.byteLength)break;if(8!==n&&9!==n&&18!==n){z.w(this.TAG,`Unsupported tag type ${n}, skipped`),i+=11+a+4;continue}let o=r.getUint8(4),l=r.getUint8(5),h=r.getUint8(6)|l<<8|o<<16|r.getUint8(7)<<24;0!==(16777215&r.getUint32(7,!s))&&z.w(this.TAG,"Meet tag which has StreamID != 0!");let d=i+11;switch(n){case 8:this._parseAudioData(e,d,a,h);break;case 9:this._parseVideoData(e,d,a,h,t+i);break;case 18:this._parseScriptData(e,d,a)}let u=r.getUint32(11+a,!s);u!==11+a&&z.w(this.TAG,`Invalid PrevTagSize ${u}`),i+=11+a+4}return this._isInitialMetadataDispatched()&&this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack),i}_parseScriptData(e,t,i){let s=_e.parseScriptData(e,t,i);if(s.hasOwnProperty("onMetaData")){if(null==s.onMetaData||"object"!=typeof s.onMetaData)return void z.w(this.TAG,"Invalid onMetaData structure!");this._metadata&&z.w(this.TAG,"Found another onMetaData tag!"),this._metadata=s;let e=this._metadata.onMetaData;if(this._onMetaDataArrived&&this._onMetaDataArrived(Object.assign({},e)),"boolean"==typeof e.hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=e.hasAudio,this._mediaInfo.hasAudio=this._hasAudio),"boolean"==typeof e.hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=e.hasVideo,this._mediaInfo.hasVideo=this._hasVideo),"number"==typeof e.audiodatarate&&(this._mediaInfo.audioDataRate=e.audiodatarate),"number"==typeof e.videodatarate&&(this._mediaInfo.videoDataRate=e.videodatarate),"number"==typeof e.width&&(this._mediaInfo.width=e.width),"number"==typeof e.height&&(this._mediaInfo.height=e.height),"number"==typeof e.duration){if(!this._durationOverrided){let t=Math.floor(e.duration*this._timescale);this._duration=t,this._mediaInfo.duration=t}}else this._mediaInfo.duration=0;if("number"==typeof e.framerate){let t=Math.floor(1e3*e.framerate);if(t>0){let e=t/1e3;this._referenceFrameRate.fixed=!0,this._referenceFrameRate.fps=e,this._referenceFrameRate.fps_num=t,this._referenceFrameRate.fps_den=1e3,this._mediaInfo.fps=e}}if("object"==typeof e.keyframes){this._mediaInfo.hasKeyframesIndex=!0;let t=e.keyframes;this._mediaInfo.keyframesIndex=this._parseKeyframesIndex(t),e.keyframes=null}else this._mediaInfo.hasKeyframesIndex=!1;this._dispatch=!1,this._mediaInfo.metadata=e,z.v(this.TAG,"Parsed onMetaData"),this._mediaInfo.isComplete()&&this._onMediaInfo(this._mediaInfo)}Object.keys(s).length>0&&this._onScriptDataArrived&&this._onScriptDataArrived(Object.assign({},s))}_parseKeyframesIndex(e){let t=[],i=[];for(let s=1;s<e.times.length;s++){let r=this._timestampBase+Math.floor(1e3*e.times[s]);t.push(r),i.push(e.filepositions[s])}return{times:t,filepositions:i}}_parseAudioData(e,t,i,s){if(i<=1)return void z.w(this.TAG,"Flv: Invalid audio packet, missing SoundData payload!");if(!0===this._hasAudioFlagOverrided&&!1===this._hasAudio)return;this._littleEndian;let r=new DataView(e,t,i).getUint8(0),n=r>>>4;if(2!==n&&10!==n)return void this._onError(Te,"Flv: Unsupported audio codec idx: "+n);let a=0,o=(12&r)>>>2;if(!(o>=0&&o<=4))return void this._onError(Ee,"Flv: Invalid audio sample rate idx: "+o);a=this._flvSoundRateTable[o];let l=1&r,h=this._audioMetadata,d=this._audioTrack;if(h||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),h=this._audioMetadata={},h.type="audio",h.id=d.id,h.timescale=this._timescale,h.duration=this._duration,h.audioSampleRate=a,h.channelCount=0===l?1:2),10===n){let r=this._parseAACAudioData(e,t+1,i-1);if(null==r)return;if(0===r.packetType){h.config&&z.w(this.TAG,"Found another AudioSpecificConfig!");let e=r.data;h.audioSampleRate=e.samplingRate,h.channelCount=e.channelCount,h.codec=e.codec,h.originalCodec=e.originalCodec,h.config=e.config,h.refSampleDuration=1024/h.audioSampleRate*h.timescale,z.v(this.TAG,"Parsed AudioSpecificConfig"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata("audio",h);let t=this._mediaInfo;t.audioCodec=h.originalCodec,t.audioSampleRate=h.audioSampleRate,t.audioChannelCount=h.channelCount,t.hasVideo?null!=t.videoCodec&&(t.mimeType='video/x-flv; codecs="'+t.videoCodec+","+t.audioCodec+'"'):t.mimeType='video/x-flv; codecs="'+t.audioCodec+'"',t.isComplete()&&this._onMediaInfo(t)}else if(1===r.packetType){let e=this._timestampBase+s,t={unit:r.data,length:r.data.byteLength,dts:e,pts:e};d.samples.push(t),d.length+=r.data.length}else z.e(this.TAG,`Flv: Unsupported AAC data type ${r.packetType}`)}else if(2===n){if(!h.codec){let s=this._parseMP3AudioData(e,t+1,i-1,!0);if(null==s)return;h.audioSampleRate=s.samplingRate,h.channelCount=s.channelCount,h.codec=s.codec,h.originalCodec=s.originalCodec,h.refSampleDuration=1152/h.audioSampleRate*h.timescale,z.v(this.TAG,"Parsed MPEG Audio Frame Header"),this._audioInitialMetadataDispatched=!0,this._onTrackMetadata("audio",h);let r=this._mediaInfo;r.audioCodec=h.codec,r.audioSampleRate=h.audioSampleRate,r.audioChannelCount=h.channelCount,r.audioDataRate=s.bitRate,r.hasVideo?null!=r.videoCodec&&(r.mimeType='video/x-flv; codecs="'+r.videoCodec+","+r.audioCodec+'"'):r.mimeType='video/x-flv; codecs="'+r.audioCodec+'"',r.isComplete()&&this._onMediaInfo(r)}let r=this._parseMP3AudioData(e,t+1,i-1,!1);if(null==r)return;let n=this._timestampBase+s,a={unit:r,length:r.byteLength,dts:n,pts:n};d.samples.push(a),d.length+=r.length}}_parseAACAudioData(e,t,i){if(i<=1)return void z.w(this.TAG,"Flv: Invalid AAC packet, missing AACPacketType or/and Data!");let s={},r=new Uint8Array(e,t,i);return s.packetType=r[0],0===r[0]?s.data=this._parseAACAudioSpecificConfig(e,t+1,i-1):s.data=r.subarray(1),s}_parseAACAudioSpecificConfig(e,t,i){let s=new Uint8Array(e,t,i),r=null,n=0,a=0,o=0,l=null;if(n=a=s[0]>>>3,o=(7&s[0])<<1|s[1]>>>7,o<0||o>=this._mpegSamplingRates.length)return void this._onError(Ee,"Flv: AAC invalid sampling frequency index!");let h=this._mpegSamplingRates[o],d=(120&s[1])>>>3;if(d<0||d>=8)return void this._onError(Ee,"Flv: AAC invalid channel configuration");5===n&&(l=(7&s[1])<<1|s[2]>>>7,s[2]);let u=self.navigator.userAgent.toLowerCase();return-1!==u.indexOf("firefox")?o>=6?(n=5,r=new Array(4),l=o-3):(n=2,r=new Array(2),l=o):-1!==u.indexOf("android")?(n=2,r=new Array(2),l=o):(n=5,l=o,r=new Array(4),o>=6?l=o-3:1===d&&(n=2,r=new Array(2),l=o)),r[0]=n<<3,r[0]|=(15&o)>>>1,r[1]=(15&o)<<7,r[1]|=(15&d)<<3,5===n&&(r[1]|=(15&l)>>>1,r[2]=(1&l)<<7,r[2]|=8,r[3]=0),{config:r,samplingRate:h,channelCount:d,codec:"mp4a.40."+n,originalCodec:"mp4a.40."+a}}_parseMP3AudioData(e,t,i,s){if(i<4)return void z.w(this.TAG,"Flv: Invalid MP3 packet, header missing!");this._littleEndian;let r=new Uint8Array(e,t,i),n=null;if(s){if(255!==r[0])return;let e=r[1]>>>3&3,t=(6&r[1])>>1,i=(240&r[2])>>>4,s=(12&r[2])>>>2,a=3!==(r[3]>>>6&3)?2:1,o=0,l=0,h="mp3";switch(e){case 0:o=this._mpegAudioV25SampleRateTable[s];break;case 2:o=this._mpegAudioV20SampleRateTable[s];break;case 3:o=this._mpegAudioV10SampleRateTable[s]}switch(t){case 1:i<this._mpegAudioL3BitRateTable.length&&(l=this._mpegAudioL3BitRateTable[i]);break;case 2:i<this._mpegAudioL2BitRateTable.length&&(l=this._mpegAudioL2BitRateTable[i]);break;case 3:i<this._mpegAudioL1BitRateTable.length&&(l=this._mpegAudioL1BitRateTable[i])}n={bitRate:l,samplingRate:o,channelCount:a,codec:h,originalCodec:h}}else n=r;return n}_parseVideoData(e,t,i,s,r){if(i<=1)return void z.w(this.TAG,"Flv: Invalid video packet, missing VideoData payload!");if(!0===this._hasVideoFlagOverrided&&!1===this._hasVideo)return;let n=new Uint8Array(e,t,i)[0],a=(240&n)>>>4,o=15&n;7===o?this._parseAVCVideoPacket(e,t+1,i-1,s,r,a):this._onError(Te,`Flv: Unsupported codec in video frame: ${o}`)}_parseAVCVideoPacket(e,t,i,s,r,n){if(i<4)return void z.w(this.TAG,"Flv: Invalid AVC packet, missing AVCPacketType or/and CompositionTime");let a=this._littleEndian,o=new DataView(e,t,i),l=o.getUint8(0),h=(16777215&o.getUint32(0,!a))<<8>>8;if(0===l)this._parseAVCDecoderConfigurationRecord(e,t+4,i-4);else if(1===l)this._parseAVCVideoData(e,t+4,i-4,s,r,n,h);else if(2!==l)return void this._onError(Ee,`Flv: Invalid video packet type ${l}`)}_parseAVCDecoderConfigurationRecord(e,t,i){if(i<7)return void z.w(this.TAG,"Flv: Invalid AVCDecoderConfigurationRecord, lack of data!");let s=this._videoMetadata,r=this._videoTrack,n=this._littleEndian,a=new DataView(e,t,i);s?void 0!==s.avcc&&z.w(this.TAG,"Found another AVCDecoderConfigurationRecord!"):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),s=this._videoMetadata={},s.type="video",s.id=r.id,s.timescale=this._timescale,s.duration=this._duration);let o=a.getUint8(0),l=a.getUint8(1);if(a.getUint8(2),a.getUint8(3),1!==o||0===l)return void this._onError(Ee,"Flv: Invalid AVCDecoderConfigurationRecord");if(this._naluLengthSize=1+(3&a.getUint8(4)),3!==this._naluLengthSize&&4!==this._naluLengthSize)return void this._onError(Ee,"Flv: Strange NaluLengthSizeMinusOne: "+(this._naluLengthSize-1));let h=31&a.getUint8(5);if(0===h)return void this._onError(Ee,"Flv: Invalid AVCDecoderConfigurationRecord: No SPS");h>1&&z.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: SPS Count = ${h}`);let d=6;for(let c=0;c<h;c++){let i=a.getUint16(d,!n);if(d+=2,0===i)continue;let r=new Uint8Array(e,t+d,i);d+=i;let o=ye.parseSPS(r);if(0!==c)continue;s.codecWidth=o.codec_size.width,s.codecHeight=o.codec_size.height,s.presentWidth=o.present_size.width,s.presentHeight=o.present_size.height,s.profile=o.profile_string,s.level=o.level_string,s.bitDepth=o.bit_depth,s.chromaFormat=o.chroma_format,s.sarRatio=o.sar_ratio,s.frameRate=o.frame_rate,!1!==o.frame_rate.fixed&&0!==o.frame_rate.fps_num&&0!==o.frame_rate.fps_den||(s.frameRate=this._referenceFrameRate);let l=s.frameRate.fps_den,h=s.frameRate.fps_num;s.refSampleDuration=s.timescale*(l/h);let u=r.subarray(1,4),f="avc1.";for(let e=0;e<3;e++){let t=u[e].toString(16);t.length<2&&(t="0"+t),f+=t}s.codec=f;let m=this._mediaInfo;m.width=s.codecWidth,m.height=s.codecHeight,m.fps=s.frameRate.fps,m.profile=s.profile,m.level=s.level,m.refFrames=o.ref_frames,m.chromaFormat=o.chroma_format_string,m.sarNum=s.sarRatio.width,m.sarDen=s.sarRatio.height,m.videoCodec=f,m.hasAudio?null!=m.audioCodec&&(m.mimeType='video/x-flv; codecs="'+m.videoCodec+","+m.audioCodec+'"'):m.mimeType='video/x-flv; codecs="'+m.videoCodec+'"',m.isComplete()&&this._onMediaInfo(m)}let u=a.getUint8(d);if(0!==u){u>1&&z.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: PPS Count = ${u}`),d++;for(let e=0;e<u;e++){let e=a.getUint16(d,!n);d+=2,0!==e&&(d+=e)}s.avcc=new Uint8Array(i),s.avcc.set(new Uint8Array(e,t,i),0),z.v(this.TAG,"Parsed AVCDecoderConfigurationRecord"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata("video",s)}else this._onError(Ee,"Flv: Invalid AVCDecoderConfigurationRecord: No PPS")}_parseAVCVideoData(e,t,i,s,r,n,a){let o=this._littleEndian,l=new DataView(e,t,i),h=[],d=0,u=0;const c=this._naluLengthSize;let f=this._timestampBase+s,m=1===n;for(;u<i;){if(u+4>=i){z.w(this.TAG,`Malformed Nalu near timestamp ${f}, offset = ${u}, dataSize = ${i}`);break}let s=l.getUint32(u,!o);if(3===c&&(s>>>=8),s>i-c)return void z.w(this.TAG,`Malformed Nalus near timestamp ${f}, NaluSize > DataSize!`);let r=31&l.getUint8(u+c);5===r&&(m=!0);let n=new Uint8Array(e,t+u,c+s),a={type:r,data:n};h.push(a),d+=n.byteLength,u+=c+s}if(h.length){let e=this._videoTrack,t={units:h,length:d,isKeyframe:m,dts:f,cts:a,pts:f+a};m&&(t.fileposition=r),e.samples.push(t),e.length+=d}}}class be{static init(){be.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],".mp3":[]};for(let t in be.types)be.types.hasOwnProperty(t)&&(be.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);let e=be.constants={};e.FTYP=new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),e.STSD_PREFIX=new Uint8Array([0,0,0,0,0,0,0,1]),e.STTS=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSC=e.STCO=e.STTS,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.HDLR_VIDEO=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),e.HDLR_AUDIO=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),e.DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}static box(e){let t=8,i=null,s=Array.prototype.slice.call(arguments,1),r=s.length;for(let a=0;a<r;a++)t+=s[a].byteLength;i=new Uint8Array(t),i[0]=t>>>24&255,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i.set(e,4);let n=8;for(let a=0;a<r;a++)i.set(s[a],n),n+=s[a].byteLength;return i}static generateInitSegment(e){let t=be.box(be.types.ftyp,be.constants.FTYP),i=be.moov(e),s=new Uint8Array(t.byteLength+i.byteLength);return s.set(t,0),s.set(i,t.byteLength),s}static moov(e){let t=be.mvhd(e.timescale,e.duration),i=be.trak(e),s=be.mvex(e);return be.box(be.types.moov,t,i,s)}static mvhd(e,t){return be.box(be.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}static trak(e){return be.box(be.types.trak,be.tkhd(e),be.mdia(e))}static tkhd(e){let t=e.id,i=e.duration,s=e.presentWidth,r=e.presentHeight;return be.box(be.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>>8&255,255&s,0,0,r>>>8&255,255&r,0,0]))}static mdia(e){return be.box(be.types.mdia,be.mdhd(e),be.hdlr(e),be.minf(e))}static mdhd(e){let t=e.timescale,i=e.duration;return be.box(be.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]))}static hdlr(e){let t=null;return t="audio"===e.type?be.constants.HDLR_AUDIO:be.constants.HDLR_VIDEO,be.box(be.types.hdlr,t)}static minf(e){let t=null;return t="audio"===e.type?be.box(be.types.smhd,be.constants.SMHD):be.box(be.types.vmhd,be.constants.VMHD),be.box(be.types.minf,t,be.dinf(),be.stbl(e))}static dinf(){return be.box(be.types.dinf,be.box(be.types.dref,be.constants.DREF))}static stbl(e){return be.box(be.types.stbl,be.stsd(e),be.box(be.types.stts,be.constants.STTS),be.box(be.types.stsc,be.constants.STSC),be.box(be.types.stsz,be.constants.STSZ),be.box(be.types.stco,be.constants.STCO))}static stsd(e){return"audio"===e.type?"mp3"===e.codec?be.box(be.types.stsd,be.constants.STSD_PREFIX,be.mp3(e)):be.box(be.types.stsd,be.constants.STSD_PREFIX,be.mp4a(e)):be.box(be.types.stsd,be.constants.STSD_PREFIX,be.avc1(e))}static mp3(e){let t=e.channelCount,i=e.audioSampleRate,s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,i>>>8&255,255&i,0,0]);return be.box(be.types[".mp3"],s)}static mp4a(e){let t=e.channelCount,i=e.audioSampleRate,s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t,0,16,0,0,0,0,i>>>8&255,255&i,0,0]);return be.box(be.types.mp4a,s,be.esds(e))}static esds(e){let t=e.config||[],i=t.length,s=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return be.box(be.types.esds,s)}static avc1(e){let t=e.avcc,i=e.codecWidth,s=e.codecHeight,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>>8&255,255&i,s>>>8&255,255&s,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return be.box(be.types.avc1,r,be.box(be.types.avcC,t))}static mvex(e){return be.box(be.types.mvex,be.trex(e))}static trex(e){let t=e.id,i=new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return be.box(be.types.trex,i)}static moof(e,t){return be.box(be.types.moof,be.mfhd(e.sequenceNumber),be.traf(e,t))}static mfhd(e){let t=new Uint8Array([0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e]);return be.box(be.types.mfhd,t)}static traf(e,t){let i=e.id,s=be.box(be.types.tfhd,new Uint8Array([0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i])),r=be.box(be.types.tfdt,new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t])),n=be.sdtp(e),a=be.trun(e,n.byteLength+16+16+8+16+8+8);return be.box(be.types.traf,s,r,a,n)}static sdtp(e){let t=e.samples||[],i=t.length,s=new Uint8Array(4+i);for(let r=0;r<i;r++){let e=t[r].flags;s[r+4]=e.isLeading<<6|e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy}return be.box(be.types.sdtp,s)}static trun(e,t){let i=e.samples||[],s=i.length,r=12+16*s,n=new Uint8Array(r);t+=8+r,n.set([0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,255&s,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0);for(let a=0;a<s;a++){let e=i[a].duration,t=i[a].size,s=i[a].flags,r=i[a].cts;n.set([e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,s.isLeading<<2|s.dependsOn,s.isDependedOn<<6|s.hasRedundancy<<4|s.isNonSync,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r],12+16*a)}return be.box(be.types.trun,n)}static mdat(e){return be.box(be.types.mdat,e)}}be.init();class Ae{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}class Re{constructor(e,t,i,s,r){this.dts=e,this.pts=t,this.duration=i,this.originalDts=s,this.isSyncPoint=r,this.fileposition=null}}class De{constructor(){this.beginDts=0,this.endDts=0,this.beginPts=0,this.endPts=0,this.originalBeginDts=0,this.originalEndDts=0,this.syncPoints=[],this.firstSample=null,this.lastSample=null}appendSyncPoint(e){e.isSyncPoint=!0,this.syncPoints.push(e)}}class we{constructor(){this._list=[]}clear(){this._list=[]}appendArray(e){let t=this._list;0!==e.length&&(t.length>0&&e[0].originalDts<t[t.length-1].originalDts&&this.clear(),Array.prototype.push.apply(t,e))}getLastSyncPointBeforeDts(e){if(0==this._list.length)return null;let t=this._list,i=0,s=t.length-1,r=0,n=0,a=s;for(e<t[0].dts&&(i=0,n=a+1);n<=a;){if(r=n+Math.floor((a-n)/2),r===s||e>=t[r].dts&&e<t[r+1].dts){i=r;break}t[r].dts<e?n=r+1:a=r-1}return this._list[i]}}class ke{constructor(e){this._type=e,this._list=[],this._lastAppendLocation=-1}get type(){return this._type}get length(){return this._list.length}isEmpty(){return 0===this._list.length}clear(){this._list=[],this._lastAppendLocation=-1}_searchNearestSegmentBefore(e){let t=this._list;if(0===t.length)return-2;let i=t.length-1,s=0,r=0,n=i,a=0;if(e<t[0].originalBeginDts)return a=-1,a;for(;r<=n;){if(s=r+Math.floor((n-r)/2),s===i||e>t[s].lastSample.originalDts&&e<t[s+1].originalBeginDts){a=s;break}t[s].originalBeginDts<e?r=s+1:n=s-1}return a}_searchNearestSegmentAfter(e){return this._searchNearestSegmentBefore(e)+1}append(e){let t=this._list,i=e,s=this._lastAppendLocation,r=0;-1!==s&&s<t.length&&i.originalBeginDts>=t[s].lastSample.originalDts&&(s===t.length-1||s<t.length-1&&i.originalBeginDts<t[s+1].originalBeginDts)?r=s+1:t.length>0&&(r=this._searchNearestSegmentBefore(i.originalBeginDts)+1),this._lastAppendLocation=r,this._list.splice(r,0,i)}getLastSegmentBefore(e){let t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}getLastSampleBefore(e){let t=this.getLastSegmentBefore(e);return null!=t?t.lastSample:null}getLastSyncPointBefore(e){let t=this._searchNearestSegmentBefore(e),i=this._list[t].syncPoints;for(;0===i.length&&t>0;)t--,i=this._list[t].syncPoints;return i.length>0?i[i.length-1]:null}}class Ce{constructor(e){this.TAG="MP4Remuxer",this._config=e,this._isLive=!0===e.isLive,this._dtsBase=-1,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList=new ke("audio"),this._videoSegmentInfoList=new ke("video"),this._onInitSegment=null,this._onMediaSegment=null,this._forceFirstIDR=!(!ee.chrome||!(ee.version.major<50||50===ee.version.major&&ee.version.build<2661)),this._fillSilentAfterSeek=ee.msedge||ee.msie,this._mp3UseMpegAudio=!ee.firefox,this._fillAudioTimestampGap=this._config.fixAudioTimestampGap}destroy(){this._dtsBase=-1,this._dtsBaseInited=!1,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList.clear(),this._audioSegmentInfoList=null,this._videoSegmentInfoList.clear(),this._videoSegmentInfoList=null,this._onInitSegment=null,this._onMediaSegment=null}bindDataSource(e){return e.onDataAvailable=this.remux.bind(this),e.onTrackMetadata=this._onTrackMetadataReceived.bind(this),this}get onInitSegment(){return this._onInitSegment}set onInitSegment(e){this._onInitSegment=e}get onMediaSegment(){return this._onMediaSegment}set onMediaSegment(e){this._onMediaSegment=e}insertDiscontinuity(){this._audioNextDts=this._videoNextDts=void 0}seek(e){this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._videoSegmentInfoList.clear(),this._audioSegmentInfoList.clear()}remux(e,t){if(!this._onMediaSegment)throw new q("MP4Remuxer: onMediaSegment callback must be specificed!");this._dtsBaseInited||this._calculateDtsBase(e,t),this._remuxVideo(t),this._remuxAudio(e)}_onTrackMetadataReceived(e,t){let i=null,s="mp4",r=t.codec;if("audio"===e)this._audioMeta=t,"mp3"===t.codec&&this._mp3UseMpegAudio?(s="mpeg",r="",i=new Uint8Array):i=be.generateInitSegment(t);else{if("video"!==e)return;this._videoMeta=t,i=be.generateInitSegment(t)}if(!this._onInitSegment)throw new q("MP4Remuxer: onInitSegment callback must be specified!");this._onInitSegment(e,{type:e,data:i.buffer,codec:r,container:`${e}/${s}`,mediaDuration:t.duration})}_calculateDtsBase(e,t){this._dtsBaseInited||(e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].dts),t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].dts),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),this._dtsBaseInited=!0)}flushStashedSamples(){let e=this._videoStashedLastSample,t=this._audioStashedLastSample,i={type:"video",id:1,sequenceNumber:0,samples:[],length:0};null!=e&&(i.samples.push(e),i.length=e.length);let s={type:"audio",id:2,sequenceNumber:0,samples:[],length:0};null!=t&&(s.samples.push(t),s.length=t.length),this._videoStashedLastSample=null,this._audioStashedLastSample=null,this._remuxVideo(i,!0),this._remuxAudio(s,!0)}_remuxAudio(e,t){if(null==this._audioMeta)return;let i,s=e,r=s.samples,n=-1,a=-1,o=this._audioMeta.refSampleDuration,l="mp3"===this._audioMeta.codec&&this._mp3UseMpegAudio,h=this._dtsBaseInited&&void 0===this._audioNextDts,d=!1;if(!r||0===r.length)return;if(1===r.length&&!t)return;let u=0,c=null,f=0;l?(u=0,f=s.length):(u=8,f=8+s.length);let m=null;if(r.length>1&&(m=r.pop(),f-=m.length),null!=this._audioStashedLastSample){let e=this._audioStashedLastSample;this._audioStashedLastSample=null,r.unshift(e),f+=e.length}null!=m&&(this._audioStashedLastSample=m);let g=r[0].dts-this._dtsBase;if(this._audioNextDts)i=g-this._audioNextDts;else if(this._audioSegmentInfoList.isEmpty())i=0,this._fillSilentAfterSeek&&!this._videoSegmentInfoList.isEmpty()&&"mp3"!==this._audioMeta.originalCodec&&(d=!0);else{let e=this._audioSegmentInfoList.getLastSampleBefore(g);if(null!=e){let t=g-(e.originalDts+e.duration);t<=3&&(t=0),i=g-(e.dts+e.duration+t)}else i=0}if(d){let e=g-i,t=this._videoSegmentInfoList.getLastSegmentBefore(g);if(null!=t&&t.beginDts<e){let i=Ae.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);if(i){let s=t.beginDts,n=e-t.beginDts;z.v(this.TAG,`InsertPrefixSilentAudio: dts: ${s}, duration: ${n}`),r.unshift({unit:i,dts:s,pts:s}),f+=i.byteLength}}else d=!1}let p=[];for(let S=0;S<r.length;S++){let e=r[S],t=e.unit,s=e.dts-this._dtsBase,a=s,l=!1,h=null,d=0;if(!(s<-.001)){if("mp3"!==this._audioMeta.codec){let e=s;const r=3;if(this._audioNextDts&&(e=this._audioNextDts),i=s-e,i<=-r*o){z.w(this.TAG,`Dropping 1 audio frame (originalDts: ${s} ms ,curRefDts: ${e} ms)  due to dtsCorrection: ${i} ms overlap.`);continue}if(i>=r*o&&this._fillAudioTimestampGap&&!ee.safari){l=!0;let r=Math.floor(i/o);z.w(this.TAG,`Large audio timestamp gap detected, may cause AV sync to drift. Silent frames will be generated to avoid unsync.\noriginalDts: ${s} ms, curRefDts: ${e} ms, dtsCorrection: ${Math.round(i)} ms, generate: ${r} frames`),a=Math.floor(e),d=Math.floor(e+o)-a;let n=Ae.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);null==n&&(z.w(this.TAG,`Unable to generate silent frame for ${this._audioMeta.originalCodec} with ${this._audioMeta.channelCount} channels, repeat last frame`),n=t),h=[];for(let t=0;t<r;t++){e+=o;let t=Math.floor(e),i=Math.floor(e+o)-t,r={dts:t,pts:t,cts:0,unit:n,size:n.byteLength,duration:i,originalDts:s,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};h.push(r),f+=r.size}this._audioNextDts=e+o}else a=Math.floor(e),d=Math.floor(e+o)-a,this._audioNextDts=e+o}else{if(a=s-i,S!==r.length-1){d=r[S+1].dts-this._dtsBase-i-a}else if(null!=m){d=m.dts-this._dtsBase-i-a}else d=p.length>=1?p[p.length-1].duration:Math.floor(o);this._audioNextDts=a+d}-1===n&&(n=a),p.push({dts:a,pts:a,cts:0,unit:e.unit,size:e.unit.byteLength,duration:d,originalDts:s,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}}),l&&p.push.apply(p,h)}}if(0===p.length)return s.samples=[],void(s.length=0);l?c=new Uint8Array(f):(c=new Uint8Array(f),c[0]=f>>>24&255,c[1]=f>>>16&255,c[2]=f>>>8&255,c[3]=255&f,c.set(be.types.mdat,4));for(let S=0;S<p.length;S++){let e=p[S].unit;c.set(e,u),u+=e.byteLength}let _=p[p.length-1];a=_.dts+_.duration;let v=new De;v.beginDts=n,v.endDts=a,v.beginPts=n,v.endPts=a,v.originalBeginDts=p[0].originalDts,v.originalEndDts=_.originalDts+_.duration,v.firstSample=new Re(p[0].dts,p[0].pts,p[0].duration,p[0].originalDts,!1),v.lastSample=new Re(_.dts,_.pts,_.duration,_.originalDts,!1),this._isLive||this._audioSegmentInfoList.append(v),s.samples=p,s.sequenceNumber++;let y=null;y=l?new Uint8Array:be.moof(s,n),s.samples=[],s.length=0;let E={type:"audio",data:this._mergeBoxes(y,c).buffer,sampleCount:p.length,info:v};l&&h&&(E.timestampOffset=n),this._onMediaSegment("audio",E)}_remuxVideo(e,t){if(null==this._videoMeta)return;let i,s=e,r=s.samples,n=-1,a=-1,o=-1,l=-1;if(!r||0===r.length)return;if(1===r.length&&!t)return;let h=8,d=null,u=8+e.length,c=null;if(r.length>1&&(c=r.pop(),u-=c.length),null!=this._videoStashedLastSample){let e=this._videoStashedLastSample;this._videoStashedLastSample=null,r.unshift(e),u+=e.length}null!=c&&(this._videoStashedLastSample=c);let f=r[0].dts-this._dtsBase;if(this._videoNextDts)i=f-this._videoNextDts;else if(this._videoSegmentInfoList.isEmpty())i=0;else{let e=this._videoSegmentInfoList.getLastSampleBefore(f);if(null!=e){let t=f-(e.originalDts+e.duration);t<=3&&(t=0),i=f-(e.dts+e.duration+t)}else i=0}let m=new De,g=[];for(let v=0;v<r.length;v++){let e=r[v],t=e.dts-this._dtsBase,s=e.isKeyframe,a=t-i,l=e.cts,h=a+l;-1===n&&(n=a,o=h);let d=0;if(v!==r.length-1){d=r[v+1].dts-this._dtsBase-i-a}else if(null!=c){d=c.dts-this._dtsBase-i-a}else d=g.length>=1?g[g.length-1].duration:Math.floor(this._videoMeta.refSampleDuration);if(s){let t=new Re(a,h,d,e.dts,!0);t.fileposition=e.fileposition,m.appendSyncPoint(t)}g.push({dts:a,pts:h,cts:l,units:e.units,size:e.length,isKeyframe:s,duration:d,originalDts:t,flags:{isLeading:0,dependsOn:s?2:1,isDependedOn:s?1:0,hasRedundancy:0,isNonSync:s?0:1}})}d=new Uint8Array(u),d[0]=u>>>24&255,d[1]=u>>>16&255,d[2]=u>>>8&255,d[3]=255&u,d.set(be.types.mdat,4);for(let v=0;v<g.length;v++){let e=g[v].units;for(;e.length;){let t=e.shift().data;d.set(t,h),h+=t.byteLength}}let p=g[g.length-1];if(a=p.dts+p.duration,l=p.pts+p.duration,this._videoNextDts=a,m.beginDts=n,m.endDts=a,m.beginPts=o,m.endPts=l,m.originalBeginDts=g[0].originalDts,m.originalEndDts=p.originalDts+p.duration,m.firstSample=new Re(g[0].dts,g[0].pts,g[0].duration,g[0].originalDts,g[0].isKeyframe),m.lastSample=new Re(p.dts,p.pts,p.duration,p.originalDts,p.isKeyframe),this._isLive||this._videoSegmentInfoList.append(m),s.samples=g,s.sequenceNumber++,this._forceFirstIDR){let e=g[0].flags;e.dependsOn=2,e.isNonSync=0}let _=be.moof(s,n);s.samples=[],s.length=0,this._onMediaSegment("video",{type:"video",data:this._mergeBoxes(_,d).buffer,sampleCount:g.length,info:m})}_mergeBoxes(e,t){let i=new Uint8Array(e.byteLength+t.byteLength);return i.set(e,0),i.set(t,e.byteLength),i}}const Ie="io_error",xe="demux_error",Oe="init_segment",Pe="media_segment",Me="loading_complete",Fe="recovered_early_eof",Be="media_info",Ne="metadata_arrived",Ue="scriptdata_arrived",Ge="statistics_info",$e="recommend_seekpoint";class Ve{constructor(e,t){this.TAG="TransmuxingController",this._emitter=new u,this._config=t,e.segments||(e.segments=[{duration:e.duration,filesize:e.filesize,url:e.url}]),"boolean"!=typeof e.cors&&(e.cors=!0),"boolean"!=typeof e.withCredentials&&(e.withCredentials=!1),this._mediaDataSource=e,this._currentSegmentIndex=0;let i=0;this._mediaDataSource.segments.forEach((s=>{s.timestampBase=i,i+=s.duration,s.cors=e.cors,s.withCredentials=e.withCredentials,t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy)})),isNaN(i)||this._mediaDataSource.duration===i||(this._mediaDataSource.duration=i),this._mediaInfo=null,this._demuxer=null,this._remuxer=null,this._ioctl=null,this._pendingSeekTime=null,this._pendingResolveSeekPoint=null,this._statisticsReporter=null}destroy(){this._mediaInfo=null,this._mediaDataSource=null,this._statisticsReporter&&this._disableStatisticsReporter(),this._ioctl&&(this._ioctl.destroy(),this._ioctl=null),this._demuxer&&(this._demuxer.destroy(),this._demuxer=null),this._remuxer&&(this._remuxer.destroy(),this._remuxer=null),this._emitter.removeAllListeners(),this._emitter=null}on(e,t){this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}start(){this._loadSegment(0),this._enableStatisticsReporter()}_loadSegment(e,t){this._currentSegmentIndex=e;let i=this._mediaDataSource.segments[e],s=this._ioctl=new oe(i,this._config,e);s.onError=this._onIOException.bind(this),s.onSeeked=this._onIOSeeked.bind(this),s.onComplete=this._onIOComplete.bind(this),s.onRedirect=this._onIORedirect.bind(this),s.onRecoveredEarlyEof=this._onIORecoveredEarlyEof.bind(this),t?this._demuxer.bindDataSource(this._ioctl):s.onDataArrival=this._onInitChunkArrival.bind(this),s.open(t)}stop(){this._internalAbort(),this._disableStatisticsReporter()}_internalAbort(){this._ioctl&&(this._ioctl.destroy(),this._ioctl=null)}pause(){this._ioctl&&this._ioctl.isWorking()&&(this._ioctl.pause(),this._disableStatisticsReporter())}resume(){this._ioctl&&this._ioctl.isPaused()&&(this._ioctl.resume(),this._enableStatisticsReporter())}seek(e){if(null==this._mediaInfo||!this._mediaInfo.isSeekable())return;let t=this._searchSegmentIndexContains(e);if(t===this._currentSegmentIndex){let i=this._mediaInfo.segments[t];if(null==i)this._pendingSeekTime=e;else{let t=i.getNearestKeyframe(e);this._remuxer.seek(t.milliseconds),this._ioctl.seek(t.fileposition),this._pendingResolveSeekPoint=t.milliseconds}}else{let i=this._mediaInfo.segments[t];if(null==i)this._pendingSeekTime=e,this._internalAbort(),this._remuxer.seek(),this._remuxer.insertDiscontinuity(),this._loadSegment(t);else{let s=i.getNearestKeyframe(e);this._internalAbort(),this._remuxer.seek(e),this._remuxer.insertDiscontinuity(),this._demuxer.resetMediaInfo(),this._demuxer.timestampBase=this._mediaDataSource.segments[t].timestampBase,this._loadSegment(t,s.fileposition),this._pendingResolveSeekPoint=s.milliseconds,this._reportSegmentMediaInfo(t)}}this._enableStatisticsReporter()}_searchSegmentIndexContains(e){let t=this._mediaDataSource.segments,i=t.length-1;for(let s=0;s<t.length;s++)if(e<t[s].timestampBase){i=s-1;break}return i}_onInitChunkArrival(e,t){let i=null,s=0;if(t>0)this._demuxer.bindDataSource(this._ioctl),this._demuxer.timestampBase=this._mediaDataSource.segments[this._currentSegmentIndex].timestampBase,s=this._demuxer.parseChunks(e,t);else if((i=Le.probe(e)).match){this._demuxer=new Le(i,this._config),this._remuxer||(this._remuxer=new Ce(this._config));let r=this._mediaDataSource;null==r.duration||isNaN(r.duration)||(this._demuxer.overridedDuration=r.duration),"boolean"==typeof r.hasAudio&&(this._demuxer.overridedHasAudio=r.hasAudio),"boolean"==typeof r.hasVideo&&(this._demuxer.overridedHasVideo=r.hasVideo),this._demuxer.timestampBase=r.segments[this._currentSegmentIndex].timestampBase,this._demuxer.onError=this._onDemuxException.bind(this),this._demuxer.onMediaInfo=this._onMediaInfo.bind(this),this._demuxer.onMetaDataArrived=this._onMetaDataArrived.bind(this),this._demuxer.onScriptDataArrived=this._onScriptDataArrived.bind(this),this._remuxer.bindDataSource(this._demuxer.bindDataSource(this._ioctl)),this._remuxer.onInitSegment=this._onRemuxerInitSegmentArrival.bind(this),this._remuxer.onMediaSegment=this._onRemuxerMediaSegmentArrival.bind(this),s=this._demuxer.parseChunks(e,t)}else i=null,z.e(this.TAG,"Non-FLV, Unsupported media type!"),Promise.resolve().then((()=>{this._internalAbort()})),this._emitter.emit(xe,Se,"Non-FLV, Unsupported media type"),s=0;return s}_onMediaInfo(e){null==this._mediaInfo&&(this._mediaInfo=Object.assign({},e),this._mediaInfo.keyframesIndex=null,this._mediaInfo.segments=[],this._mediaInfo.segmentCount=this._mediaDataSource.segments.length,Object.setPrototypeOf(this._mediaInfo,fe.prototype));let t=Object.assign({},e);Object.setPrototypeOf(t,fe.prototype),this._mediaInfo.segments[this._currentSegmentIndex]=t,this._reportSegmentMediaInfo(this._currentSegmentIndex),null!=this._pendingSeekTime&&Promise.resolve().then((()=>{let e=this._pendingSeekTime;this._pendingSeekTime=null,this.seek(e)}))}_onMetaDataArrived(e){this._emitter.emit(Ne,e)}_onScriptDataArrived(e){this._emitter.emit(Ue,e)}_onIOSeeked(){this._remuxer.insertDiscontinuity()}_onIOComplete(e){let t=e+1;t<this._mediaDataSource.segments.length?(this._internalAbort(),this._remuxer.flushStashedSamples(),this._loadSegment(t)):(this._remuxer.flushStashedSamples(),this._emitter.emit(Me),this._disableStatisticsReporter())}_onIORedirect(e){let t=this._ioctl.extraData;this._mediaDataSource.segments[t].redirectedURL=e}_onIORecoveredEarlyEof(){this._emitter.emit(Fe)}_onIOException(e,t){z.e(this.TAG,`IOException: type = ${e}, code = ${t.code}, msg = ${t.msg}`),this._emitter.emit(Ie,e,t),this._disableStatisticsReporter()}_onDemuxException(e,t){z.e(this.TAG,`DemuxException: type = ${e}, info = ${t}`),this._emitter.emit(xe,e,t)}_onRemuxerInitSegmentArrival(e,t){this._emitter.emit(Oe,e,t)}_onRemuxerMediaSegmentArrival(e,t){if(null==this._pendingSeekTime&&(this._emitter.emit(Pe,e,t),null!=this._pendingResolveSeekPoint&&"video"===e)){let e=t.info.syncPoints,i=this._pendingResolveSeekPoint;this._pendingResolveSeekPoint=null,ee.safari&&e.length>0&&e[0].originalDts===i&&(i=e[0].pts),this._emitter.emit($e,i)}}_enableStatisticsReporter(){null==this._statisticsReporter&&(this._statisticsReporter=self.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval))}_disableStatisticsReporter(){this._statisticsReporter&&(self.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}_reportSegmentMediaInfo(e){let t=this._mediaInfo.segments[e],i=Object.assign({},t);i.duration=this._mediaInfo.duration,i.segmentCount=this._mediaInfo.segmentCount,delete i.segments,delete i.keyframesIndex,this._emitter.emit(Be,i)}_reportStatisticsInfo(){let e={};e.url=this._ioctl.currentURL,e.hasRedirect=this._ioctl.hasRedirect,e.hasRedirect&&(e.redirectedURL=this._ioctl.currentRedirectedURL),e.speed=this._ioctl.currentSpeed,e.loaderType=this._ioctl.loaderType,e.currentSegmentIndex=this._currentSegmentIndex,e.totalSegmentCount=this._mediaDataSource.segments.length,this._emitter.emit(Ge,e)}}class He{constructor(e,t){if(this.TAG="Transmuxer",this._emitter=new u,t.enableWorker&&"undefined"!=typeof Worker)try{this._worker=c(require.resolve("./transmuxing-worker")),this._workerDestroying=!1,this._worker.addEventListener("message",this._onWorkerMessage.bind(this)),this._worker.postMessage({cmd:"init",param:[e,t]}),this.e={onLoggingConfigChanged:this._onLoggingConfigChanged.bind(this)},ce.registerListener(this.e.onLoggingConfigChanged),this._worker.postMessage({cmd:"logging_config",param:ce.getConfig()})}catch(i){z.e(this.TAG,"Error while initialize transmuxing worker, fallback to inline transmuxing"),this._worker=null,this._controller=new Ve(e,t)}else this._controller=new Ve(e,t);if(this._controller){let e=this._controller;e.on(Ie,this._onIOError.bind(this)),e.on(xe,this._onDemuxError.bind(this)),e.on(Oe,this._onInitSegment.bind(this)),e.on(Pe,this._onMediaSegment.bind(this)),e.on(Me,this._onLoadingComplete.bind(this)),e.on(Fe,this._onRecoveredEarlyEof.bind(this)),e.on(Be,this._onMediaInfo.bind(this)),e.on(Ne,this._onMetaDataArrived.bind(this)),e.on(Ue,this._onScriptDataArrived.bind(this)),e.on(Ge,this._onStatisticsInfo.bind(this)),e.on($e,this._onRecommendSeekpoint.bind(this))}}destroy(){this._worker?this._workerDestroying||(this._workerDestroying=!0,this._worker.postMessage({cmd:"destroy"}),ce.removeListener(this.e.onLoggingConfigChanged),this.e=null):(this._controller.destroy(),this._controller=null),this._emitter.removeAllListeners(),this._emitter=null}on(e,t){this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}hasWorker(){return null!=this._worker}open(){this._worker?this._worker.postMessage({cmd:"start"}):this._controller.start()}close(){this._worker?this._worker.postMessage({cmd:"stop"}):this._controller.stop()}seek(e){this._worker?this._worker.postMessage({cmd:"seek",param:e}):this._controller.seek(e)}pause(){this._worker?this._worker.postMessage({cmd:"pause"}):this._controller.pause()}resume(){this._worker?this._worker.postMessage({cmd:"resume"}):this._controller.resume()}_onInitSegment(e,t){Promise.resolve().then((()=>{this._emitter.emit(Oe,e,t)}))}_onMediaSegment(e,t){Promise.resolve().then((()=>{this._emitter.emit(Pe,e,t)}))}_onLoadingComplete(){Promise.resolve().then((()=>{this._emitter.emit(Me)}))}_onRecoveredEarlyEof(){Promise.resolve().then((()=>{this._emitter.emit(Fe)}))}_onMediaInfo(e){Promise.resolve().then((()=>{this._emitter.emit(Be,e)}))}_onMetaDataArrived(e){Promise.resolve().then((()=>{this._emitter.emit(Ne,e)}))}_onScriptDataArrived(e){Promise.resolve().then((()=>{this._emitter.emit(Ue,e)}))}_onStatisticsInfo(e){Promise.resolve().then((()=>{this._emitter.emit(Ge,e)}))}_onIOError(e,t){Promise.resolve().then((()=>{this._emitter.emit(Ie,e,t)}))}_onDemuxError(e,t){Promise.resolve().then((()=>{this._emitter.emit(xe,e,t)}))}_onRecommendSeekpoint(e){Promise.resolve().then((()=>{this._emitter.emit($e,e)}))}_onLoggingConfigChanged(e){this._worker&&this._worker.postMessage({cmd:"logging_config",param:e})}_onWorkerMessage(e){let t=e.data,i=t.data;if("destroyed"===t.msg||this._workerDestroying)return this._workerDestroying=!1,this._worker.terminate(),void(this._worker=null);switch(t.msg){case Oe:case Pe:this._emitter.emit(t.msg,i.type,i.data);break;case Me:case Fe:this._emitter.emit(t.msg);break;case Be:Object.setPrototypeOf(i,fe.prototype),this._emitter.emit(t.msg,i);break;case Ne:case Ue:case Ge:this._emitter.emit(t.msg,i);break;case Ie:case xe:this._emitter.emit(t.msg,i.type,i.info);break;case $e:this._emitter.emit(t.msg,i);break;case"logcat_callback":z.emitter.emit("log",i.type,i.logcat)}}}const Ke="error",ze="source_open",We="update_end",je="buffer_full";class qe{constructor(e){this.TAG="MSEController",this._config=e,this._emitter=new u,this._config.isLive&&null==this._config.autoCleanupSourceBuffer&&(this._config.autoCleanupSourceBuffer=!0),this.e={onSourceOpen:this._onSourceOpen.bind(this),onSourceEnded:this._onSourceEnded.bind(this),onSourceClose:this._onSourceClose.bind(this),onSourceBufferError:this._onSourceBufferError.bind(this),onSourceBufferUpdateEnd:this._onSourceBufferUpdateEnd.bind(this)},this._mediaSource=null,this._mediaSourceObjectURL=null,this._mediaElement=null,this._isBufferFull=!1,this._hasPendingEos=!1,this._requireSetMediaDuration=!1,this._pendingMediaDuration=0,this._pendingSourceBufferInit=[],this._mimeTypes={video:null,audio:null},this._sourceBuffers={video:null,audio:null},this._lastInitSegments={video:null,audio:null},this._pendingSegments={video:[],audio:[]},this._pendingRemoveRanges={video:[],audio:[]},this._idrList=new we}destroy(){(this._mediaElement||this._mediaSource)&&this.detachMediaElement(),this.e=null,this._emitter.removeAllListeners(),this._emitter=null}on(e,t){this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}attachMediaElement(e){if(this._mediaSource)throw new q("MediaSource has been attached to an HTMLMediaElement!");let t=this._mediaSource=new window.MediaSource;t.addEventListener("sourceopen",this.e.onSourceOpen),t.addEventListener("sourceended",this.e.onSourceEnded),t.addEventListener("sourceclose",this.e.onSourceClose),this._mediaElement=e,this._mediaSourceObjectURL=window.URL.createObjectURL(this._mediaSource),e.src=this._mediaSourceObjectURL}detachMediaElement(){if(this._mediaSource){let t=this._mediaSource;for(let i in this._sourceBuffers){let s=this._pendingSegments[i];s.splice(0,s.length),this._pendingSegments[i]=null,this._pendingRemoveRanges[i]=null,this._lastInitSegments[i]=null;let r=this._sourceBuffers[i];if(r){if("closed"!==t.readyState){try{t.removeSourceBuffer(r)}catch(e){z.e(this.TAG,e.message)}r.removeEventListener("error",this.e.onSourceBufferError),r.removeEventListener("updateend",this.e.onSourceBufferUpdateEnd)}this._mimeTypes[i]=null,this._sourceBuffers[i]=null}}if("open"===t.readyState)try{t.endOfStream()}catch(e){z.e(this.TAG,e.message)}t.removeEventListener("sourceopen",this.e.onSourceOpen),t.removeEventListener("sourceended",this.e.onSourceEnded),t.removeEventListener("sourceclose",this.e.onSourceClose),this._pendingSourceBufferInit=[],this._isBufferFull=!1,this._idrList.clear(),this._mediaSource=null}this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement=null),this._mediaSourceObjectURL&&(window.URL.revokeObjectURL(this._mediaSourceObjectURL),this._mediaSourceObjectURL=null)}appendInitSegment(e,t){if(!this._mediaSource||"open"!==this._mediaSource.readyState)return this._pendingSourceBufferInit.push(e),void this._pendingSegments[e.type].push(e);let i=e,s=`${i.container}`;i.codec&&i.codec.length>0&&(s+=`;codecs=${i.codec}`);let r=!1;if(z.v(this.TAG,"Received Initialization Segment, mimeType: "+s),this._lastInitSegments[i.type]=i,s!==this._mimeTypes[i.type]){if(this._mimeTypes[i.type])z.v(this.TAG,`Notice: ${i.type} mimeType changed, origin: ${this._mimeTypes[i.type]}, target: ${s}`);else{r=!0;try{let e=this._sourceBuffers[i.type]=this._mediaSource.addSourceBuffer(s);e.addEventListener("error",this.e.onSourceBufferError),e.addEventListener("updateend",this.e.onSourceBufferUpdateEnd)}catch(n){return z.e(this.TAG,n.message),void this._emitter.emit(Ke,{code:n.code,msg:n.message})}}this._mimeTypes[i.type]=s}t||this._pendingSegments[i.type].push(i),r||this._sourceBuffers[i.type]&&!this._sourceBuffers[i.type].updating&&this._doAppendSegments(),ee.safari&&"audio/mpeg"===i.container&&i.mediaDuration>0&&(this._requireSetMediaDuration=!0,this._pendingMediaDuration=i.mediaDuration/1e3,this._updateMediaSourceDuration())}appendMediaSegment(e){let t=e;this._pendingSegments[t.type].push(t),this._config.autoCleanupSourceBuffer&&this._needCleanupSourceBuffer()&&this._doCleanupSourceBuffer();let i=this._sourceBuffers[t.type];!i||i.updating||this._hasPendingRemoveRanges()||this._doAppendSegments()}seek(e){for(let i in this._sourceBuffers){if(!this._sourceBuffers[i])continue;let e=this._sourceBuffers[i];if("open"===this._mediaSource.readyState)try{e.abort()}catch(t){z.e(this.TAG,t.message)}this._idrList.clear();let s=this._pendingSegments[i];if(s.splice(0,s.length),"closed"!==this._mediaSource.readyState){for(let t=0;t<e.buffered.length;t++){let s=e.buffered.start(t),r=e.buffered.end(t);this._pendingRemoveRanges[i].push({start:s,end:r})}if(e.updating||this._doRemoveRanges(),ee.safari){let t=this._lastInitSegments[i];t&&(this._pendingSegments[i].push(t),e.updating||this._doAppendSegments())}}}}endOfStream(){let e=this._mediaSource,t=this._sourceBuffers;e&&"open"===e.readyState?t.video&&t.video.updating||t.audio&&t.audio.updating?this._hasPendingEos=!0:(this._hasPendingEos=!1,e.endOfStream()):e&&"closed"===e.readyState&&this._hasPendingSegments()&&(this._hasPendingEos=!0)}getNearestKeyframe(e){return this._idrList.getLastSyncPointBeforeDts(e)}_needCleanupSourceBuffer(){if(!this._config.autoCleanupSourceBuffer)return!1;let e=this._mediaElement.currentTime;for(let t in this._sourceBuffers){let i=this._sourceBuffers[t];if(i){let t=i.buffered;if(t.length>=1&&e-t.start(0)>=this._config.autoCleanupMaxBackwardDuration)return!0}}return!1}_doCleanupSourceBuffer(){let e=this._mediaElement.currentTime;for(let t in this._sourceBuffers){let i=this._sourceBuffers[t];if(i){let s=i.buffered,r=!1;for(let i=0;i<s.length;i++){let n=s.start(i),a=s.end(i);if(n<=e&&e<a+3){if(e-n>=this._config.autoCleanupMaxBackwardDuration){r=!0;let i=e-this._config.autoCleanupMinBackwardDuration;this._pendingRemoveRanges[t].push({start:n,end:i})}}else a<e&&(r=!0,this._pendingRemoveRanges[t].push({start:n,end:a}))}r&&!i.updating&&this._doRemoveRanges()}}}_updateMediaSourceDuration(){let e=this._sourceBuffers;if(0===this._mediaElement.readyState||"open"!==this._mediaSource.readyState)return;if(e.video&&e.video.updating||e.audio&&e.audio.updating)return;let t=this._mediaSource.duration,i=this._pendingMediaDuration;i>0&&(isNaN(t)||i>t)&&(z.v(this.TAG,`Update MediaSource duration from ${t} to ${i}`),this._mediaSource.duration=i),this._requireSetMediaDuration=!1,this._pendingMediaDuration=0}_doRemoveRanges(){for(let e in this._pendingRemoveRanges){if(!this._sourceBuffers[e]||this._sourceBuffers[e].updating)continue;let t=this._sourceBuffers[e],i=this._pendingRemoveRanges[e];for(;i.length&&!t.updating;){let e=i.shift();t.remove(e.start,e.end)}}}_doAppendSegments(){let e=this._pendingSegments;for(let i in e)if(this._sourceBuffers[i]&&!this._sourceBuffers[i].updating&&e[i].length>0){let s=e[i].shift();if(s.timestampOffset){let e=this._sourceBuffers[i].timestampOffset,t=s.timestampOffset/1e3;Math.abs(e-t)>.1&&(z.v(this.TAG,`Update MPEG audio timestampOffset from ${e} to ${t}`),this._sourceBuffers[i].timestampOffset=t),delete s.timestampOffset}if(!s.data||0===s.data.byteLength)continue;try{this._sourceBuffers[i].appendBuffer(s.data),this._isBufferFull=!1,"video"===i&&s.hasOwnProperty("info")&&this._idrList.appendArray(s.info.syncPoints)}catch(t){this._pendingSegments[i].unshift(s),22===t.code?(this._isBufferFull||this._emitter.emit(je),this._isBufferFull=!0):(z.e(this.TAG,t.message),this._emitter.emit(Ke,{code:t.code,msg:t.message}))}}}_onSourceOpen(){if(z.v(this.TAG,"MediaSource onSourceOpen"),this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._pendingSourceBufferInit.length>0){let e=this._pendingSourceBufferInit;for(;e.length;){let t=e.shift();this.appendInitSegment(t,!0)}}this._hasPendingSegments()&&this._doAppendSegments(),this._emitter.emit(ze)}_onSourceEnded(){z.v(this.TAG,"MediaSource onSourceEnded")}_onSourceClose(){z.v(this.TAG,"MediaSource onSourceClose"),this._mediaSource&&null!=this.e&&(this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._mediaSource.removeEventListener("sourceended",this.e.onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this.e.onSourceClose))}_hasPendingSegments(){let e=this._pendingSegments;return e.video.length>0||e.audio.length>0}_hasPendingRemoveRanges(){let e=this._pendingRemoveRanges;return e.video.length>0||e.audio.length>0}_onSourceBufferUpdateEnd(){this._requireSetMediaDuration?this._updateMediaSourceDuration():this._hasPendingRemoveRanges()?this._doRemoveRanges():this._hasPendingSegments()?this._doAppendSegments():this._hasPendingEos&&this.endOfStream(),this._emitter.emit(We)}_onSourceBufferError(e){z.e(this.TAG,`SourceBuffer Error: ${e}`)}}const Xe={NETWORK_ERROR:"NetworkError",MEDIA_ERROR:"MediaError",OTHER_ERROR:"OtherError"},Ye={NETWORK_EXCEPTION:Z.EXCEPTION,NETWORK_STATUS_CODE_INVALID:Z.HTTP_STATUS_CODE_INVALID,NETWORK_TIMEOUT:Z.CONNECTING_TIMEOUT,NETWORK_UNRECOVERABLE_EARLY_EOF:Z.UNRECOVERABLE_EARLY_EOF,MEDIA_MSE_ERROR:"MediaMSEError",MEDIA_FORMAT_ERROR:Ee,MEDIA_FORMAT_UNSUPPORTED:Se,MEDIA_CODEC_UNSUPPORTED:Te};class Qe{constructor(e,t){if(this.TAG="FlvPlayer",this._type="FlvPlayer",this._emitter=new u,this._config=he(),"object"==typeof t&&Object.assign(this._config,t),"flv"!==e.type.toLowerCase())throw new X("FlvPlayer requires an flv MediaDataSource input!");!0===e.isLive&&(this._config.isLive=!0),this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this),onvSeeking:this._onvSeeking.bind(this),onvCanPlay:this._onvCanPlay.bind(this),onvStalled:this._onvStalled.bind(this),onvProgress:this._onvProgress.bind(this)},self.performance&&self.performance.now?this._now=self.performance.now.bind(self.performance):this._now=Date.now,this._pendingSeekTime=null,this._requestSetTime=!1,this._seekpointRecord=null,this._progressChecker=null,this._mediaDataSource=e,this._mediaElement=null,this._msectl=null,this._transmuxer=null,this._mseSourceOpened=!1,this._hasPendingLoad=!1,this._receivedCanPlay=!1,this._mediaInfo=null,this._statisticsInfo=null;let i=ee.chrome&&(ee.version.major<50||50===ee.version.major&&ee.version.build<2661);this._alwaysSeekKeyframe=!!(i||ee.msedge||ee.msie),this._alwaysSeekKeyframe&&(this._config.accurateSeek=!1)}destroy(){null!=this._progressChecker&&(window.clearInterval(this._progressChecker),this._progressChecker=null),this._transmuxer&&this.unload(),this._mediaElement&&this.detachMediaElement(),this.e=null,this._mediaDataSource=null,this._emitter.removeAllListeners(),this._emitter=null}on(e,t){e===ue.MEDIA_INFO?null!=this._mediaInfo&&Promise.resolve().then((()=>{this._emitter.emit(ue.MEDIA_INFO,this.mediaInfo)})):e===ue.STATISTICS_INFO&&null!=this._statisticsInfo&&Promise.resolve().then((()=>{this._emitter.emit(ue.STATISTICS_INFO,this.statisticsInfo)})),this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}attachMediaElement(e){if(this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("seeking",this.e.onvSeeking),e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("stalled",this.e.onvStalled),e.addEventListener("progress",this.e.onvProgress),this._msectl=new qe(this._config),this._msectl.on(We,this._onmseUpdateEnd.bind(this)),this._msectl.on(je,this._onmseBufferFull.bind(this)),this._msectl.on(ze,(()=>{this._mseSourceOpened=!0,this._hasPendingLoad&&(this._hasPendingLoad=!1,this.load())})),this._msectl.on(Ke,(e=>{this._emitter.emit(ue.ERROR,Xe.MEDIA_ERROR,Ye.MEDIA_MSE_ERROR,e)})),this._msectl.attachMediaElement(e),null!=this._pendingSeekTime)try{e.currentTime=this._pendingSeekTime,this._pendingSeekTime=null}catch(t){}}detachMediaElement(){this._mediaElement&&(this._msectl.detachMediaElement(),this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement.removeEventListener("seeking",this.e.onvSeeking),this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay),this._mediaElement.removeEventListener("stalled",this.e.onvStalled),this._mediaElement.removeEventListener("progress",this.e.onvProgress),this._mediaElement=null),this._msectl&&(this._msectl.destroy(),this._msectl=null)}load(){if(!this._mediaElement)throw new q("HTMLMediaElement must be attached before load()!");if(this._transmuxer)throw new q("FlvPlayer.load() has been called, please call unload() first!");this._hasPendingLoad||(this._config.deferLoadAfterSourceOpen&&!1===this._mseSourceOpened?this._hasPendingLoad=!0:(this._mediaElement.readyState>0&&(this._requestSetTime=!0,this._mediaElement.currentTime=0),this._transmuxer=new He(this._mediaDataSource,this._config),this._transmuxer.on(Oe,((e,t)=>{this._msectl.appendInitSegment(t)})),this._transmuxer.on(Pe,((e,t)=>{if(this._msectl.appendMediaSegment(t),this._config.lazyLoad&&!this._config.isLive){let e=this._mediaElement.currentTime;t.info.endDts>=1e3*(e+this._config.lazyLoadMaxDuration)&&null==this._progressChecker&&(z.v(this.TAG,"Maximum buffering duration exceeded, suspend transmuxing task"),this._suspendTransmuxer())}})),this._transmuxer.on(Me,(()=>{this._msectl.endOfStream(),this._emitter.emit(ue.LOADING_COMPLETE)})),this._transmuxer.on(Fe,(()=>{this._emitter.emit(ue.RECOVERED_EARLY_EOF)})),this._transmuxer.on(Ie,((e,t)=>{this._emitter.emit(ue.ERROR,Xe.NETWORK_ERROR,e,t)})),this._transmuxer.on(xe,((e,t)=>{this._emitter.emit(ue.ERROR,Xe.MEDIA_ERROR,e,{code:-1,msg:t})})),this._transmuxer.on(Be,(e=>{this._mediaInfo=e,this._emitter.emit(ue.MEDIA_INFO,Object.assign({},e))})),this._transmuxer.on(Ne,(e=>{this._emitter.emit(ue.METADATA_ARRIVED,e)})),this._transmuxer.on(Ue,(e=>{this._emitter.emit(ue.SCRIPTDATA_ARRIVED,e)})),this._transmuxer.on(Ge,(e=>{this._statisticsInfo=this._fillStatisticsInfo(e),this._emitter.emit(ue.STATISTICS_INFO,Object.assign({},this._statisticsInfo))})),this._transmuxer.on($e,(e=>{this._mediaElement&&!this._config.accurateSeek&&(this._requestSetTime=!0,this._mediaElement.currentTime=e/1e3)})),this._transmuxer.open()))}unload(){this._mediaElement&&this._mediaElement.pause(),this._msectl&&this._msectl.seek(0),this._transmuxer&&(this._transmuxer.close(),this._transmuxer.destroy(),this._transmuxer=null)}play(){return this._mediaElement.play()}pause(){this._mediaElement.pause()}get type(){return this._type}get buffered(){return this._mediaElement.buffered}get duration(){return this._mediaElement.duration}get volume(){return this._mediaElement.volume}set volume(e){this._mediaElement.volume=e}get muted(){return this._mediaElement.muted}set muted(e){this._mediaElement.muted=e}get currentTime(){return this._mediaElement?this._mediaElement.currentTime:0}set currentTime(e){this._mediaElement?this._internalSeek(e):this._pendingSeekTime=e}get mediaInfo(){return Object.assign({},this._mediaInfo)}get statisticsInfo(){return null==this._statisticsInfo&&(this._statisticsInfo={}),this._statisticsInfo=this._fillStatisticsInfo(this._statisticsInfo),Object.assign({},this._statisticsInfo)}_fillStatisticsInfo(e){if(e.playerType=this._type,!(this._mediaElement instanceof HTMLVideoElement))return e;let t=!0,i=0,s=0;if(this._mediaElement.getVideoPlaybackQuality){let e=this._mediaElement.getVideoPlaybackQuality();i=e.totalVideoFrames,s=e.droppedVideoFrames}else null!=this._mediaElement.webkitDecodedFrameCount?(i=this._mediaElement.webkitDecodedFrameCount,s=this._mediaElement.webkitDroppedFrameCount):t=!1;return t&&(e.decodedFrames=i,e.droppedFrames=s),e}_onmseUpdateEnd(){if(!this._config.lazyLoad||this._config.isLive)return;let e=this._mediaElement.buffered,t=this._mediaElement.currentTime,i=0;for(let s=0;s<e.length;s++){let r=e.start(s),n=e.end(s);if(r<=t&&t<n){i=n;break}}i>=t+this._config.lazyLoadMaxDuration&&null==this._progressChecker&&(z.v(this.TAG,"Maximum buffering duration exceeded, suspend transmuxing task"),this._suspendTransmuxer())}_onmseBufferFull(){z.v(this.TAG,"MSE SourceBuffer is full, suspend transmuxing task"),null==this._progressChecker&&this._suspendTransmuxer()}_suspendTransmuxer(){this._transmuxer&&(this._transmuxer.pause(),null==this._progressChecker&&(this._progressChecker=window.setInterval(this._checkProgressAndResume.bind(this),1e3)))}_checkProgressAndResume(){let e=this._mediaElement.currentTime,t=this._mediaElement.buffered,i=!1;for(let s=0;s<t.length;s++){let r=t.start(s),n=t.end(s);if(e>=r&&e<n){e>=n-this._config.lazyLoadRecoverDuration&&(i=!0);break}}i&&(window.clearInterval(this._progressChecker),this._progressChecker=null,i&&(z.v(this.TAG,"Continue loading from paused position"),this._transmuxer.resume()))}_isTimepointBuffered(e){let t=this._mediaElement.buffered;for(let i=0;i<t.length;i++){let s=t.start(i),r=t.end(i);if(e>=s&&e<r)return!0}return!1}_internalSeek(e){let t=this._isTimepointBuffered(e),i=!1,s=0;if(e<1&&this._mediaElement.buffered.length>0){let t=this._mediaElement.buffered.start(0);(t<1&&e<t||ee.safari)&&(i=!0,s=ee.safari?.1:t)}if(i)this._requestSetTime=!0,this._mediaElement.currentTime=s;else if(t){if(this._alwaysSeekKeyframe){let t=this._msectl.getNearestKeyframe(Math.floor(1e3*e));this._requestSetTime=!0,this._mediaElement.currentTime=null!=t?t.dts/1e3:e}else this._requestSetTime=!0,this._mediaElement.currentTime=e;null!=this._progressChecker&&this._checkProgressAndResume()}else null!=this._progressChecker&&(window.clearInterval(this._progressChecker),this._progressChecker=null),this._msectl.seek(e),this._transmuxer.seek(Math.floor(1e3*e)),this._config.accurateSeek&&(this._requestSetTime=!0,this._mediaElement.currentTime=e)}_checkAndApplyUnbufferedSeekpoint(){if(this._seekpointRecord)if(this._seekpointRecord.recordTime<=this._now()-100){let e=this._mediaElement.currentTime;this._seekpointRecord=null,this._isTimepointBuffered(e)||(null!=this._progressChecker&&(window.clearTimeout(this._progressChecker),this._progressChecker=null),this._msectl.seek(e),this._transmuxer.seek(Math.floor(1e3*e)),this._config.accurateSeek&&(this._requestSetTime=!0,this._mediaElement.currentTime=e))}else window.setTimeout(this._checkAndApplyUnbufferedSeekpoint.bind(this),50)}_checkAndResumeStuckPlayback(e){let t=this._mediaElement;if(e||!this._receivedCanPlay||t.readyState<2){let e=t.buffered;e.length>0&&t.currentTime<e.start(0)&&(z.w(this.TAG,`Playback seems stuck at ${t.currentTime}, seek to ${e.start(0)}`),this._requestSetTime=!0,this._mediaElement.currentTime=e.start(0),this._mediaElement.removeEventListener("progress",this.e.onvProgress))}else this._mediaElement.removeEventListener("progress",this.e.onvProgress)}_onvLoadedMetadata(e){null!=this._pendingSeekTime&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null)}_onvSeeking(e){let t=this._mediaElement.currentTime,i=this._mediaElement.buffered;if(this._requestSetTime)this._requestSetTime=!1;else{if(t<1&&i.length>0){let e=i.start(0);if(e<1&&t<e||ee.safari)return this._requestSetTime=!0,void(this._mediaElement.currentTime=ee.safari?.1:e)}if(this._isTimepointBuffered(t)){if(this._alwaysSeekKeyframe){let e=this._msectl.getNearestKeyframe(Math.floor(1e3*t));null!=e&&(this._requestSetTime=!0,this._mediaElement.currentTime=e.dts/1e3)}null!=this._progressChecker&&this._checkProgressAndResume()}else this._seekpointRecord={seekPoint:t,recordTime:this._now()},window.setTimeout(this._checkAndApplyUnbufferedSeekpoint.bind(this),50)}}_onvCanPlay(e){this._receivedCanPlay=!0,this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay)}_onvStalled(e){this._checkAndResumeStuckPlayback(!0)}_onvProgress(e){this._checkAndResumeStuckPlayback()}}class Ze{constructor(e,t){if(this.TAG="NativePlayer",this._type="NativePlayer",this._emitter=new u,this._config=he(),"object"==typeof t&&Object.assign(this._config,t),"flv"===e.type.toLowerCase())throw new X("NativePlayer does't support flv MediaDataSource input!");if(e.hasOwnProperty("segments"))throw new X(`NativePlayer(${e.type}) doesn't support multipart playback!`);this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this)},this._pendingSeekTime=null,this._statisticsReporter=null,this._mediaDataSource=e,this._mediaElement=null}destroy(){this._mediaElement&&(this.unload(),this.detachMediaElement()),this.e=null,this._mediaDataSource=null,this._emitter.removeAllListeners(),this._emitter=null}on(e,t){e===ue.MEDIA_INFO?null!=this._mediaElement&&0!==this._mediaElement.readyState&&Promise.resolve().then((()=>{this._emitter.emit(ue.MEDIA_INFO,this.mediaInfo)})):e===ue.STATISTICS_INFO&&null!=this._mediaElement&&0!==this._mediaElement.readyState&&Promise.resolve().then((()=>{this._emitter.emit(ue.STATISTICS_INFO,this.statisticsInfo)})),this._emitter.addListener(e,t)}off(e,t){this._emitter.removeListener(e,t)}attachMediaElement(e){if(this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),null!=this._pendingSeekTime)try{e.currentTime=this._pendingSeekTime,this._pendingSeekTime=null}catch(t){}}detachMediaElement(){this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement=null),null!=this._statisticsReporter&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}load(){if(!this._mediaElement)throw new q("HTMLMediaElement must be attached before load()!");this._mediaElement.src=this._mediaDataSource.url,this._mediaElement.readyState>0&&(this._mediaElement.currentTime=0),this._mediaElement.preload="auto",this._mediaElement.load(),this._statisticsReporter=window.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval)}unload(){this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src")),null!=this._statisticsReporter&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}play(){return this._mediaElement.play()}pause(){this._mediaElement.pause()}get type(){return this._type}get buffered(){return this._mediaElement.buffered}get duration(){return this._mediaElement.duration}get volume(){return this._mediaElement.volume}set volume(e){this._mediaElement.volume=e}get muted(){return this._mediaElement.muted}set muted(e){this._mediaElement.muted=e}get currentTime(){return this._mediaElement?this._mediaElement.currentTime:0}set currentTime(e){this._mediaElement?this._mediaElement.currentTime=e:this._pendingSeekTime=e}get mediaInfo(){let e={mimeType:(this._mediaElement instanceof HTMLAudioElement?"audio/":"video/")+this._mediaDataSource.type};return this._mediaElement&&(e.duration=Math.floor(1e3*this._mediaElement.duration),this._mediaElement instanceof HTMLVideoElement&&(e.width=this._mediaElement.videoWidth,e.height=this._mediaElement.videoHeight)),e}get statisticsInfo(){let e={playerType:this._type,url:this._mediaDataSource.url};if(!(this._mediaElement instanceof HTMLVideoElement))return e;let t=!0,i=0,s=0;if(this._mediaElement.getVideoPlaybackQuality){let e=this._mediaElement.getVideoPlaybackQuality();i=e.totalVideoFrames,s=e.droppedVideoFrames}else null!=this._mediaElement.webkitDecodedFrameCount?(i=this._mediaElement.webkitDecodedFrameCount,s=this._mediaElement.webkitDroppedFrameCount):t=!1;return t&&(e.decodedFrames=i,e.droppedFrames=s),e}_onvLoadedMetadata(e){null!=this._pendingSeekTime&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null),this._emitter.emit(ue.MEDIA_INFO,this.mediaInfo)}_reportStatisticsInfo(){this._emitter.emit(ue.STATISTICS_INFO,this.statisticsInfo)}}K.install();let Je={};var et,tt,it,st,rt,nt;Je.createPlayer=function(e,t){let i=e;if(null==i||"object"!=typeof i)throw new X("MediaDataSource must be an javascript object!");if(!i.hasOwnProperty("type"))throw new X("MediaDataSource must has type field to indicate video file type!");switch(i.type){case"flv":return new Qe(i,t);default:return new Ze(i,t)}},Je.isSupported=function(){return de.supportMSEH264Playback()},Je.getFeatureList=function(){return de.getFeatureList()},Je.BaseLoader=J,Je.LoaderStatus=Q,Je.LoaderErrors=Z,Je.Events=ue,Je.ErrorTypes=Xe,Je.ErrorDetails=Ye,Je.FlvPlayer=Qe,Je.NativePlayer=Ze,Je.LoggingControl=ce,Object.defineProperty(Je,"version",{enumerable:!0,get:function(){return 0}}),(tt=et||(et={})).MEDIA_ATTACHING="hlsMediaAttaching",tt.MEDIA_ATTACHED="hlsMediaAttached",tt.MEDIA_DETACHING="hlsMediaDetaching",tt.MEDIA_DETACHED="hlsMediaDetached",tt.BUFFER_RESET="hlsBufferReset",tt.BUFFER_CODECS="hlsBufferCodecs",tt.BUFFER_CREATED="hlsBufferCreated",tt.BUFFER_APPENDING="hlsBufferAppending",tt.BUFFER_APPENDED="hlsBufferAppended",tt.BUFFER_EOS="hlsBufferEos",tt.BUFFER_FLUSHING="hlsBufferFlushing",tt.BUFFER_FLUSHED="hlsBufferFlushed",tt.MANIFEST_LOADING="hlsManifestLoading",tt.MANIFEST_LOADED="hlsManifestLoaded",tt.MANIFEST_PARSED="hlsManifestParsed",tt.LEVEL_SWITCHING="hlsLevelSwitching",tt.LEVEL_SWITCHED="hlsLevelSwitched",tt.LEVEL_LOADING="hlsLevelLoading",tt.LEVEL_LOADED="hlsLevelLoaded",tt.LEVEL_UPDATED="hlsLevelUpdated",tt.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",tt.LEVELS_UPDATED="hlsLevelsUpdated",tt.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",tt.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",tt.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",tt.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",tt.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",tt.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",tt.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",tt.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",tt.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",tt.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",tt.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",tt.CUES_PARSED="hlsCuesParsed",tt.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",tt.INIT_PTS_FOUND="hlsInitPtsFound",tt.FRAG_LOADING="hlsFragLoading",tt.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",tt.FRAG_LOADED="hlsFragLoaded",tt.FRAG_DECRYPTED="hlsFragDecrypted",tt.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",tt.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",tt.FRAG_PARSING_METADATA="hlsFragParsingMetadata",tt.FRAG_PARSED="hlsFragParsed",tt.FRAG_BUFFERED="hlsFragBuffered",tt.FRAG_CHANGED="hlsFragChanged",tt.FPS_DROP="hlsFpsDrop",tt.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",tt.ERROR="hlsError",tt.DESTROYING="hlsDestroying",tt.KEY_LOADING="hlsKeyLoading",tt.KEY_LOADED="hlsKeyLoaded",tt.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",tt.BACK_BUFFER_REACHED="hlsBackBufferReached",(st=it||(it={})).NETWORK_ERROR="networkError",st.MEDIA_ERROR="mediaError",st.KEY_SYSTEM_ERROR="keySystemError",st.MUX_ERROR="muxError",st.OTHER_ERROR="otherError",(nt=rt||(rt={})).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",nt.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",nt.KEY_SYSTEM_NO_SESSION="keySystemNoSession",nt.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",nt.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",nt.MANIFEST_LOAD_ERROR="manifestLoadError",nt.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",nt.MANIFEST_PARSING_ERROR="manifestParsingError",nt.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",nt.LEVEL_EMPTY_ERROR="levelEmptyError",nt.LEVEL_LOAD_ERROR="levelLoadError",nt.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",nt.LEVEL_SWITCH_ERROR="levelSwitchError",nt.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",nt.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",nt.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",nt.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",nt.FRAG_LOAD_ERROR="fragLoadError",nt.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",nt.FRAG_DECRYPT_ERROR="fragDecryptError",nt.FRAG_PARSING_ERROR="fragParsingError",nt.REMUX_ALLOC_ERROR="remuxAllocError",nt.KEY_LOAD_ERROR="keyLoadError",nt.KEY_LOAD_TIMEOUT="keyLoadTimeOut",nt.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",nt.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",nt.BUFFER_APPEND_ERROR="bufferAppendError",nt.BUFFER_APPENDING_ERROR="bufferAppendingError",nt.BUFFER_STALLED_ERROR="bufferStalledError",nt.BUFFER_FULL_ERROR="bufferFullError",nt.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",nt.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",nt.INTERNAL_EXCEPTION="internalException",nt.INTERNAL_ABORTED="aborted",nt.UNKNOWN="unknown";const at=function(){},ot={trace:at,debug:at,log:at,warn:at,info:at,error:at};let lt=ot;function ht(e,...t){t.forEach((function(t){lt[t]=e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):at}(t)}))}const dt=lt;function ut(e,t,i){return Uint8Array.prototype.slice?e.slice(t,i):new Uint8Array(Array.prototype.slice.call(e,t,i))}class ct{constructor(e,t){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,this._uri=t?f.exports.buildAbsoluteURL(e,t,{alwaysNormalize:!0}):e}static fromURL(e,t){return new ct(e,t)}static fromURI(e){return new ct(e)}get uri(){return this._uri}}class ft{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var mt,gt;(gt=mt||(mt={})).AUDIO="audio",gt.VIDEO="video",gt.AUDIOVIDEO="audiovideo";class pt{constructor(e){this._byteRange=null,this._url=null,this.elementaryStreams={[mt.AUDIO]:null,[mt.VIDEO]:null,[mt.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2),s=[];1===i.length?s[0]=t?t.byteRangeEndOffset:0:s[0]=parseInt(i[1]),s[1]=parseInt(i[0])+s[0],this._byteRange=s}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=f.exports.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class _t extends pt{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.loader=null,this.level=-1,this.cc=0,this.start=0,this.stats=new ft,this.urlId=0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.type=e}get decryptdata(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){let e=this.sn;"number"!=typeof e&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&dt.warn(`missing IV for initialization segment with method="${this.levelkey.method}" - compliance issue`),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!Number.isFinite(this.programDateTime))return null;const e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;return!(!(null==(e=this.decryptdata)?void 0:e.keyFormat)||!this.decryptdata.uri)}createInitializationVector(e){const t=new Uint8Array(16);for(let i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}setDecryptDataFromLevelKey(e,t){let i=e;return"AES-128"===(null==e?void 0:e.method)&&e.uri&&!e.iv&&(i=ct.fromURI(e.uri),i.method=e.method,i.iv=this.createInitializationVector(t),i.keyFormat="identity"),i}setElementaryStreamInfo(e,t,i,s,r,n=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,i),o.startDTS=Math.min(o.startDTS,s),o.endDTS=Math.max(o.endDTS,r)):a[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:n}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[mt.AUDIO]=null,e[mt.VIDEO]=null,e[mt.AUDIOVIDEO]=null}}class vt extends pt{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.stats=new ft,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const n=e.enumeratedString("BYTERANGE");n&&this.setByteRange(n,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const yt=Math.pow(2,32)-1,Et=[].push;function St(e){return String.fromCharCode.apply(null,e)}function Tt(e,t){"data"in e&&(t+=e.start,e=e.data);const i=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return i<0?4294967296+i:i}function Lt(e,t,i){"data"in e&&(t+=e.start,e=e.data),e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i}function bt(e,t){const i=[];if(!t.length)return i;let s,r,n;"data"in e?(s=e.data,r=e.start,n=e.end):(s=e,r=0,n=s.byteLength);for(let a=r;a<n;){const e=Tt(s,a),r=e>1?a+e:n;if(St(s.subarray(a+4,a+8))===t[0])if(1===t.length)i.push({data:s,start:a+8,end:r});else{const e=bt({data:s,start:a+8,end:r},t.slice(1));e.length&&Et.apply(i,e)}a=r}return i}function At(e){const t=bt(e,["moov"])[0],i=t?t.end:null,s=bt(e,["sidx"]);if(!s||!s[0])return null;const r=[],n=s[0],a=n.data[0];let o=0===a?8:16;const l=Tt(n,o);o+=4;o+=0===a?8:16,o+=2;let h=n.end+0;const d=function(e,t){"data"in e&&(t+=e.start,e=e.data);const i=e[t]<<8|e[t+1];return i<0?65536+i:i}(n,o);o+=2;for(let u=0;u<d;u++){let e=o;const t=Tt(n,e);e+=4;const i=2147483647&t;if(1===(2147483648&t)>>>31)return console.warn("SIDX has hierarchical references (not supported)"),null;const s=Tt(n,e);e+=4,r.push({referenceSize:i,subsegmentDuration:s,info:{duration:s/l,start:h,end:h+i-1}}),h+=i,e+=4,o=e}return{earliestPresentationTime:0,timescale:l,version:a,referencesCount:d,references:r,moovEndOffset:i}}function Rt(e){const t=Tt(e,0);let i=8;1&t&&(i+=4),4&t&&(i+=4);let s=0;const r=Tt(e,4);for(let n=0;n<r;n++){if(256&t){s+=Tt(e,i),i+=4}512&t&&(i+=4),1024&t&&(i+=4),2048&t&&(i+=4)}return s}function Dt(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}class wt{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.endCC=0,this.endSN=0,this.partList=null,this.live=!0,this.ageHeader=0,this.updated=!0,this.advanced=!0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.tuneInGoal=0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t,this.advanced=this.endSN>e.endSN||t>0||0===t&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&Number.isFinite(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(null==(e=this.partList)?void 0:e.length)?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(null==(e=this.fragments)?void 0:e.length)?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(null==(e=this.partList)?void 0:e.length)?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return(null==(e=this.partList)?void 0:e.length)?this.partList[this.partList.length-1].fragment.sn:this.endSN}}const kt=/^(\d+)x(\d+)$/,Ct=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class It{constructor(e){"string"==typeof e&&(e=It.parseAttrList(e));for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)i[e]=parseInt(t.slice(2*e,2*e+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=kt.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={};for(Ct.lastIndex=0;null!==(t=Ct.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1)),i[t[1]]=e}return i}}const xt={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function Ot(e,t){return MediaSource.isTypeSupported(`${t||"video"}/mp4;codecs="${e}"`)}const Pt=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,Mt=/#EXT-X-MEDIA:(.*)/g,Ft=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Bt=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(PLAYLIST-TYPE):(.+)/.source,/#EXT-X-(MEDIA-SEQUENCE): *(\d+)/.source,/#EXT-X-(SKIP):(.+)/.source,/#EXT-X-(TARGETDURATION): *(\d+)/.source,/#EXT-X-(KEY):(.+)/.source,/#EXT-X-(START):(.+)/.source,/#EXT-X-(ENDLIST)/.source,/#EXT-X-(DISCONTINUITY-SEQ)UENCE: *(\d+)/.source,/#EXT-X-(DIS)CONTINUITY/.source,/#EXT-X-(VERSION):(\d+)/.source,/#EXT-X-(MAP):(.+)/.source,/#EXT-X-(SERVER-CONTROL):(.+)/.source,/#EXT-X-(PART-INF):(.+)/.source,/#EXT-X-(GAP)/.source,/#EXT-X-(BITRATE):\s*(\d+)/.source,/#EXT-X-(PART):(.+)/.source,/#EXT-X-(PRELOAD-HINT):(.+)/.source,/#EXT-X-(RENDITION-REPORT):(.+)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),Nt=/\.(mp4|m4s|m4v|m4a)$/i;class Ut{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static convertAVC1ToAVCOTI(e){const t=e.split(".");if(t.length>2){let e=t.shift()+".";return e+=parseInt(t.shift()).toString(16),e+=("000"+parseInt(t.shift()).toString(16)).substr(-4),e}return e}static resolve(e,t){return f.exports.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static parseMasterPlaylist(e,t){const i=[],s={};let r,n=!1;for(Pt.lastIndex=0;null!=(r=Pt.exec(e));)if(r[1]){const e=new It(r[1]),s={attrs:e,bitrate:e.decimalInteger("AVERAGE-BANDWIDTH")||e.decimalInteger("BANDWIDTH"),name:e.NAME,url:Ut.resolve(r[2],t)},n=e.decimalResolution("RESOLUTION");n&&(s.width=n.width,s.height=n.height),Gt((e.CODECS||"").split(/[ ,]+/).filter((e=>e)),s),s.videoCodec&&-1!==s.videoCodec.indexOf("avc1")&&(s.videoCodec=Ut.convertAVC1ToAVCOTI(s.videoCodec)),i.push(s)}else if(r[3]){const e=new It(r[3]);e["DATA-ID"]&&(n=!0,s[e["DATA-ID"]]=e)}return{levels:i,sessionData:n?s:null}}static parseMasterPlaylistMedia(e,t,i,s=[]){let r;const n=[];let a=0;for(Mt.lastIndex=0;null!==(r=Mt.exec(e));){const e=new It(r[1]);if(e.TYPE===i){const r={attrs:e,bitrate:0,id:a++,groupId:e["GROUP-ID"],instreamId:e["INSTREAM-ID"],name:e.NAME||e.LANGUAGE||"",type:i,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:e.LANGUAGE,url:e.URI?Ut.resolve(e.URI,t):""};if(s.length){const e=Ut.findGroup(s,r.groupId)||s[0];$t(r,e,"audioCodec"),$t(r,e,"textCodec")}n.push(r)}}return n}static parseLevelPlaylist(e,t,i,s,r){var n;const a=new wt(t),o=a.fragments;let l,h,d,u=null,c=0,m=0,g=0,p=0,_=null,v=new _t(s,t),y=-1,E=!1;for(Ft.lastIndex=0,a.m3u8=e;null!==(l=Ft.exec(e));){E&&(E=!1,v=new _t(s,t),v.start=g,v.sn=c,v.cc=p,v.level=i,u&&(v.initSegment=u,v.rawProgramDateTime=u.rawProgramDateTime));const e=l[1];if(e){v.duration=parseFloat(e);const t=(" "+l[2]).slice(1);v.title=t||null,v.tagList.push(t?["INF",e,t]:["INF",e])}else if(l[3])Number.isFinite(v.duration)&&(v.start=g,d&&(v.levelkey=d),v.sn=c,v.level=i,v.cc=p,v.urlId=r,o.push(v),v.relurl=(" "+l[3]).slice(1),Vt(v,_),_=v,g+=v.duration,c++,m=0,E=!0);else if(l[4]){const e=(" "+l[4]).slice(1);_?v.setByteRange(e,_):v.setByteRange(e)}else if(l[5])v.rawProgramDateTime=(" "+l[5]).slice(1),v.tagList.push(["PROGRAM-DATE-TIME",v.rawProgramDateTime]),-1===y&&(y=o.length);else{if(l=l[0].match(Bt),!l){dt.warn("No matches on slow regex match for level playlist!");continue}for(h=1;h<l.length&&void 0===l[h];h++);const e=(" "+l[h]).slice(1),s=(" "+l[h+1]).slice(1),r=l[h+2]?(" "+l[h+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":a.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":c=a.startSN=parseInt(s);break;case"SKIP":{const e=new It(s),t=e.decimalInteger("SKIPPED-SEGMENTS");if(Number.isFinite(t)){a.skippedSegments=t;for(let e=t;e--;)o.unshift(null);c+=t}const i=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(a.recentlyRemovedDateranges=i.split("\t"));break}case"TARGETDURATION":a.targetduration=parseFloat(s);break;case"VERSION":a.version=parseInt(s);break;case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(s||r)&&v.tagList.push(r?[s,r]:[s]);break;case"DIS":p++;case"GAP":v.tagList.push([e]);break;case"BITRATE":v.tagList.push([e,s]);break;case"DISCONTINUITY-SEQ":p=parseInt(s);break;case"KEY":{const e=new It(s),i=e.enumeratedString("METHOD"),r=e.URI,a=e.hexadecimalInteger("IV"),o=e.enumeratedString("KEYFORMATVERSIONS"),l=e.enumeratedString("KEYID"),h=null!=(n=e.enumeratedString("KEYFORMAT"))?n:"identity";if(["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"].indexOf(h)>-1){dt.warn(`Keyformat ${h} is not supported from the manifest`);continue}if("identity"!==h)continue;i&&(d=ct.fromURL(t,r),r&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(i)>=0&&(d.method=i,d.keyFormat=h,l&&(d.keyID=l),o&&(d.keyFormatVersions=o),d.iv=a));break}case"START":{const e=new It(s).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(e)&&(a.startTimeOffset=e);break}case"MAP":{const e=new It(s);v.relurl=e.URI,e.BYTERANGE&&v.setByteRange(e.BYTERANGE),v.level=i,v.sn="initSegment",d&&(v.levelkey=d),v.initSegment=null,u=v,E=!0;break}case"SERVER-CONTROL":{const e=new It(s);a.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),a.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new It(s);a.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=a.partList;e||(e=a.partList=[]);const i=m>0?e[e.length-1]:void 0,r=m++,n=new vt(new It(s),v,t,r,i);e.push(n),v.duration+=n.duration;break}case"PRELOAD-HINT":{const e=new It(s);a.preloadHint=e;break}case"RENDITION-REPORT":{const e=new It(s);a.renditionReports=a.renditionReports||[],a.renditionReports.push(e);break}default:dt.warn(`line parsed but not handled: ${l}`)}}}_&&!_.relurl?(o.pop(),g-=_.duration,a.partList&&(a.fragmentHint=_)):a.partList&&(Vt(v,_),v.cc=p,a.fragmentHint=v);const S=o.length,T=o[0],L=o[S-1];if(g+=a.skippedSegments*a.targetduration,g>0&&S&&L){a.averagetargetduration=g/S;const e=L.sn;a.endSN="initSegment"!==e?e:0,T&&(a.startCC=T.cc,T.initSegment||a.fragments.every((e=>e.relurl&&function(e){var t,i;return Nt.test(null!=(i=null==(t=f.exports.parseURL(e))?void 0:t.path)?i:"")}(e.relurl)))&&(dt.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),v=new _t(s,t),v.relurl=L.relurl,v.level=i,v.sn="initSegment",T.initSegment=v,a.needSidxRanges=!0))}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(g+=a.fragmentHint.duration),a.totalduration=g,a.endCC=p,y>0&&function(e,t){let i=e[t];for(let s=t;s--;){const t=e[s];if(!t)return;t.programDateTime=i.programDateTime-1e3*t.duration,i=t}}(o,y),a}}function Gt(e,t){["video","audio","text"].forEach((i=>{const s=e.filter((e=>function(e,t){const i=xt[t];return!!i&&!0===i[e.slice(0,4)]}(e,i)));if(s.length){const r=s.filter((e=>0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)));t[`${i}Codec`]=r.length>0?r[0]:s[0],e=e.filter((e=>-1===s.indexOf(e)))}})),t.unknownCodecs=e}function $t(e,t,i){const s=t[i];s&&(e[i]=s)}function Vt(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):(null==t?void 0:t.programDateTime)&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}var Ht,Kt,zt,Wt;function jt(e,t){let i=e.url;return void 0!==i&&0!==i.indexOf("data:")||(i=t.url),i}(Kt=Ht||(Ht={})).MANIFEST="manifest",Kt.LEVEL="level",Kt.AUDIO_TRACK="audioTrack",Kt.SUBTITLE_TRACK="subtitleTrack",(Wt=zt||(zt={})).MAIN="main",Wt.AUDIO="audio",Wt.SUBTITLE="subtitle";class qt{constructor(e){this.loaders=Object.create(null),this.hls=e,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(et.MANIFEST_LOADING,this.onManifestLoading,this),e.on(et.LEVEL_LOADING,this.onLevelLoading,this),e.on(et.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(et.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(et.MANIFEST_LOADING,this.onManifestLoading,this),e.off(et.LEVEL_LOADING,this.onLevelLoading,this),e.off(et.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(et.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=new(i||s)(t);return e.loader=r,this.loaders[e.type]=r,r}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.load({id:null,groupId:null,level:0,responseType:"text",type:Ht.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:s,url:r,deliveryDirectives:n}=t;this.load({id:i,groupId:null,level:s,responseType:"text",type:Ht.LEVEL,url:r,deliveryDirectives:n})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:n}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Ht.AUDIO_TRACK,url:r,deliveryDirectives:n})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:n}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Ht.SUBTITLE_TRACK,url:r,deliveryDirectives:n})}load(e){var t;const i=this.hls.config;let s,r,n,a,o=this.getInternalLoader(e);if(o){const t=o.context;if(t&&t.url===e.url)return void dt.trace("[playlist-loader]: playlist request ongoing");dt.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),o.abort()}switch(e.type){case Ht.MANIFEST:s=i.manifestLoadingMaxRetry,r=i.manifestLoadingTimeOut,n=i.manifestLoadingRetryDelay,a=i.manifestLoadingMaxRetryTimeout;break;case Ht.LEVEL:case Ht.AUDIO_TRACK:case Ht.SUBTITLE_TRACK:s=0,r=i.levelLoadingTimeOut;break;default:s=i.levelLoadingMaxRetry,r=i.levelLoadingTimeOut,n=i.levelLoadingRetryDelay,a=i.levelLoadingMaxRetryTimeout}if(o=this.createInternalLoader(e),null==(t=e.deliveryDirectives)?void 0:t.part){let t;if(e.type===Ht.LEVEL&&null!==e.level?t=this.hls.levels[e.level].details:e.type===Ht.AUDIO_TRACK&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===Ht.SUBTITLE_TRACK&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,i=t.targetduration;e&&i&&(r=Math.min(1e3*Math.max(3*e,.8*i),r))}}const l={timeout:r,maxRetry:s,retryDelay:n,maxRetryDelay:a,highWaterMark:0},h={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};o.load(e,l,h)}loadsuccess(e,t,i,s=null){if(i.isSidxRequest)return this.handleSidxRequest(e,i),void this.handlePlaylistLoaded(e,t,i,s);this.resetInternalLoader(i.type);const r=e.data;0===r.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),r.indexOf("#EXTINF:")>0||r.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(e,t,i,s):this.handleMasterPlaylist(e,t,i,s)):this.handleManifestParsingError(e,i,"no EXTM3U delimiter",s)}loaderror(e,t,i=null){this.handleNetworkError(t,i,!1,e)}loadtimeout(e,t,i=null){this.handleNetworkError(t,i,!0)}handleMasterPlaylist(e,t,i,s){const r=this.hls,n=e.data,a=jt(e,i),{levels:o,sessionData:l}=Ut.parseMasterPlaylist(n,a);if(!o.length)return void this.handleManifestParsingError(e,i,"no level found in manifest",s);const h=o.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),d=o.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),u=Ut.parseMasterPlaylistMedia(n,a,"AUDIO",h),c=Ut.parseMasterPlaylistMedia(n,a,"SUBTITLES",d),f=Ut.parseMasterPlaylistMedia(n,a,"CLOSED-CAPTIONS");if(u.length){u.some((e=>!e.url))||!o[0].audioCodec||o[0].attrs.AUDIO||(dt.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),u.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new It({}),bitrate:0,url:""}))}r.trigger(et.MANIFEST_LOADED,{levels:o,audioTracks:u,subtitles:c,captions:f,url:a,stats:t,networkDetails:s,sessionData:l})}handleTrackOrLevelPlaylist(e,t,i,s){var r;const n=this.hls,{id:a,level:o,type:l}=i,h=jt(e,i),d=Number.isFinite(a)?a:0,u=Number.isFinite(o)?o:d,c=function(e){const{type:t}=e;switch(t){case Ht.AUDIO_TRACK:return zt.AUDIO;case Ht.SUBTITLE_TRACK:return zt.SUBTITLE;default:return zt.MAIN}}(i),f=Ut.parseLevelPlaylist(e.data,h,u,c,d);if(console.info("ana handleTrackOrLevelPlaylist",f),f.fragments.length){if(l===Ht.MANIFEST){const e={attrs:new It({}),bitrate:0,details:f,name:"",url:h};n.trigger(et.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:h,stats:t,networkDetails:s,sessionData:null})}if(t.parsing.end=performance.now(),f.needSidxRanges){const e=null==(r=f.fragments[0].initSegment)?void 0:r.url;this.load({url:e,isSidxRequest:!0,type:l,level:o,levelDetails:f,id:a,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null})}else i.levelDetails=f,this.handlePlaylistLoaded(e,t,i,s)}else n.trigger(et.ERROR,{type:it.NETWORK_ERROR,details:rt.LEVEL_EMPTY_ERROR,fatal:!1,url:h,reason:"no fragments found in level",level:"number"==typeof i.level?i.level:void 0})}handleSidxRequest(e,t){const i=At(new Uint8Array(e.data));if(!i)return;const s=i.references,r=t.levelDetails;s.forEach(((e,t)=>{const s=e.info,n=r.fragments[t];0===n.byteRange.length&&n.setByteRange(String(1+s.end-s.start)+"@"+String(s.start)),n.initSegment&&n.initSegment.setByteRange(String(i.moovEndOffset)+"@0")}))}handleManifestParsingError(e,t,i,s){this.hls.trigger(et.ERROR,{type:it.NETWORK_ERROR,details:rt.MANIFEST_PARSING_ERROR,fatal:t.type===Ht.MANIFEST,url:e.url,reason:i,response:e,context:t,networkDetails:s})}handleNetworkError(e,t,i=!1,s){dt.warn(`[playlist-loader]: A network ${i?"timeout":"error"} occurred while loading ${e.type} level: ${e.level} id: ${e.id} group-id: "${e.groupId}"`);let r=rt.UNKNOWN,n=!1;const a=this.getInternalLoader(e);switch(e.type){case Ht.MANIFEST:r=i?rt.MANIFEST_LOAD_TIMEOUT:rt.MANIFEST_LOAD_ERROR,n=!0;break;case Ht.LEVEL:r=i?rt.LEVEL_LOAD_TIMEOUT:rt.LEVEL_LOAD_ERROR,n=!1;break;case Ht.AUDIO_TRACK:r=i?rt.AUDIO_TRACK_LOAD_TIMEOUT:rt.AUDIO_TRACK_LOAD_ERROR,n=!1;break;case Ht.SUBTITLE_TRACK:r=i?rt.SUBTITLE_TRACK_LOAD_TIMEOUT:rt.SUBTITLE_LOAD_ERROR,n=!1}a&&this.resetInternalLoader(e.type);const o={type:it.NETWORK_ERROR,details:r,fatal:n,url:e.url,loader:a,context:e,networkDetails:t};s&&(o.response=s),this.hls.trigger(et.ERROR,o)}handlePlaylistLoaded(e,t,i,s){const{type:r,level:n,id:a,groupId:o,loader:l,levelDetails:h,deliveryDirectives:d}=i;if(null==h?void 0:h.targetduration){if(l)switch(h.live&&(l.getCacheAge&&(h.ageHeader=l.getCacheAge()||0),l.getCacheAge&&!isNaN(h.ageHeader)||(h.ageHeader=0)),r){case Ht.MANIFEST:case Ht.LEVEL:this.hls.trigger(et.LEVEL_LOADED,{details:h,level:n||0,id:a||0,stats:t,networkDetails:s,deliveryDirectives:d});break;case Ht.AUDIO_TRACK:this.hls.trigger(et.AUDIO_TRACK_LOADED,{details:h,id:a||0,groupId:o||"",stats:t,networkDetails:s,deliveryDirectives:d});break;case Ht.SUBTITLE_TRACK:this.hls.trigger(et.SUBTITLE_TRACK_LOADED,{details:h,id:a||0,groupId:o||"",stats:t,networkDetails:s,deliveryDirectives:d})}}else this.handleManifestParsingError(e,i,"invalid target duration",s)}}class Xt{constructor(e){this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=e,this._registerListeners()}_registerListeners(){this.hls.on(et.KEY_LOADING,this.onKeyLoading,this)}_unregisterListeners(){this.hls.off(et.KEY_LOADING,this.onKeyLoading)}destroy(){this._unregisterListeners();for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy()}this.loaders={}}onKeyLoading(e,t){const{frag:i}=t,s=i.type,r=this.loaders[s];if(!i.decryptdata)return void dt.warn("Missing decryption data on fragment in onKeyLoading");const n=i.decryptdata.uri;if(n!==this.decrypturl||null===this.decryptkey){const e=this.hls.config;if(r&&(dt.warn(`abort previous key loader for type:${s}`),r.abort()),!n)return void dt.warn("key uri is falsy");const t=e.loader,a=i.loader=this.loaders[s]=new t(e);this.decrypturl=n,this.decryptkey=null;const o={url:n,frag:i,responseType:"arraybuffer"},l={timeout:e.fragLoadingTimeOut,maxRetry:0,retryDelay:e.fragLoadingRetryDelay,maxRetryDelay:e.fragLoadingMaxRetryTimeout,highWaterMark:0},h={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};a.load(o,l,h)}else this.decryptkey&&(i.decryptdata.key=this.decryptkey,this.hls.trigger(et.KEY_LOADED,{frag:i}))}loadsuccess(e,t,i){const s=i.frag;s.decryptdata?(this.decryptkey=s.decryptdata.key=new Uint8Array(e.data),s.loader=null,delete this.loaders[s.type],this.hls.trigger(et.KEY_LOADED,{frag:s})):dt.error("after key load, decryptdata unset")}loaderror(e,t){const i=t.frag,s=i.loader;s&&s.abort(),delete this.loaders[i.type],this.hls.trigger(et.ERROR,{type:it.NETWORK_ERROR,details:rt.KEY_LOAD_ERROR,fatal:!1,frag:i,response:e})}loadtimeout(e,t){const i=t.frag,s=i.loader;s&&s.abort(),delete this.loaders[i.type],this.hls.trigger(et.ERROR,{type:it.NETWORK_ERROR,details:rt.KEY_LOAD_TIMEOUT,fatal:!1,frag:i})}}function Yt(e,t){let i;try{i=new Event("addtrack")}catch(s){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}function Qt(e,t,i){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues&&e.cues.length>0){const s=function(e,t,i){const s=[],r=function(e,t){if(t<e[0].startTime)return 0;const i=e.length-1;if(t>e[i].endTime)return-1;let s=0,r=i;for(;s<=r;){const n=Math.floor((r+s)/2);if(t<e[n].startTime)r=n-1;else{if(!(t>e[n].startTime&&s<i))return n;s=n+1}}return e[s].startTime-t<t-e[r].startTime?s:r}(e,t);if(r>-1)for(let n=r,a=e.length;n<a;n++){const r=e[n];if(r.startTime>=t&&r.endTime<=i)s.push(r);else if(r.startTime>i)return s}return s}(e.cues,t,i);for(let t=0;t<s.length;t++)e.removeCue(s[t])}"disabled"===s&&(e.mode=s)}const Zt=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,Jt=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,ei=(e,t)=>{const i=t;let s=0;for(;Zt(e,t);){s+=10;s+=ti(e,t+6),Jt(e,t+10)&&(s+=10),t+=s}if(s>0)return e.subarray(i,i+s)},ti=(e,t)=>{let i=0;return i=(127&e[t])<<21,i|=(127&e[t+1])<<14,i|=(127&e[t+2])<<7,i|=127&e[t+3],i},ii=(e,t)=>Zt(e,t)&&ti(e,t+6)+10<=e.length-t,si=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,ri=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),i=ti(e,4);return{type:t,size:i,data:e.subarray(10,10+i)}},ni=e=>{let t=0;const i=[];for(;Zt(e,t);){const s=ti(e,t+6);t+=10;const r=t+s;for(;t+8<r;){const s=ri(e.subarray(t)),r=ai(s);r&&i.push(r),t+=s.size+10}Jt(e,t)&&(t+=10)}return i},ai=e=>"PRIV"===e.type?oi(e):"W"===e.type[0]?hi(e):li(e),oi=e=>{if(e.size<2)return;const t=ui(e.data,!0),i=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:i.buffer}},li=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const i=ui(e.data.subarray(t),!0);t+=i.length+1;const s=ui(e.data.subarray(t));return{key:e.type,info:i,data:s}}const t=ui(e.data.subarray(1));return{key:e.type,data:t}},hi=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const i=ui(e.data.subarray(t),!0);t+=i.length+1;const s=ui(e.data.subarray(t));return{key:e.type,info:i,data:s}}const t=ui(e.data);return{key:e.type,data:t}},di=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),i=1&t[3];let s=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return s/=45,i&&(s+=47721858.84),Math.round(s)}},ui=(e,t=!1)=>{const i=function(){ci||void 0===self.TextDecoder||(ci=new self.TextDecoder("utf-8"));return ci}();if(i){const s=i.decode(e);if(t){const e=s.indexOf("\0");return-1!==e?s.substring(0,e):s}return s.replace(/\0/g,"")}const s=e.length;let r,n,a,o="",l=0;for(;l<s;){if(r=e[l++],0===r&&t)return o;if(0!==r&&3!==r)switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(r);break;case 12:case 13:n=e[l++],o+=String.fromCharCode((31&r)<<6|63&n);break;case 14:n=e[l++],a=e[l++],o+=String.fromCharCode((15&r)<<12|(63&n)<<6|(63&a)<<0)}}return o};let ci;class fi{constructor(e){this.id3Track=null,this.media=null,this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners()}_registerListeners(){const{hls:e}=this;e.on(et.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(et.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(et.BUFFER_FLUSHING,this.onBufferFlushing,this)}_unregisterListeners(){const{hls:e}=this;e.off(et.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(et.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(et.BUFFER_FLUSHING,this.onBufferFlushing,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(!function(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let i=e.cues.length;i--;)e.removeCue(e.cues[i]);"disabled"===t&&(e.mode=t)}(this.id3Track),this.id3Track=null,this.media=null)}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if("metadata"===i.kind&&"id3"===i.label)return Yt(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const i=t.frag,s=t.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode="hidden");const r=self.WebKitDataCue||self.VTTCue||self.TextTrackCue;for(let n=0;n<s.length;n++){const e=ni(s[n].data);if(e){const t=s[n].pts;let a=n<s.length-1?s[n+1].pts:i.end;a-t<=0&&(a=t+.25);for(let i=0;i<e.length;i++){const s=e[i];if(!si(s)){const e=new r(t,a,"");e.value=s,this.id3Track.addCue(e)}}}}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){if(!s||"audio"===s){const{id3Track:e}=this;e&&Qt(e,t,i)}}}class mi{constructor(e){this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:n,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&i||t;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==r?r:n*s);const h=s;return l+Math.min(1*this.stallCount,h)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(null===e||null===t||null===i)return null;const s=i.edge,r=e-t-this.edgeStalled,n=s-i.totalduration,a=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(n,r),a)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return i?e.buffered.end(i-1):t.edge-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(et.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(et.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(et.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(et.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(et.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(et.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(et.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(et.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(et.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(et.ERROR,this.onError)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){t.details===rt.BUFFER_STALLED_ERROR&&(this.stallCount++,dt.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||1===r)return;const n=this.targetLatency;if(null===n)return;const a=i-n,o=a<Math.min(this.maxLatency,n+t.targetduration);if(t.live&&o&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,r)),i=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,i))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}var gi,pi;(pi=gi||(gi={})).No="",pi.Yes="YES",pi.v2="v2";class _i{constructor(e,t,i){this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.toString()}}class vi{constructor(e){this.fragmentError=0,this.loadError=0,this.realBitrate=0,this._urlId=0,this.url=[e.url],this.attrs=e.attrs,this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>e)).join(",").replace(/\.[^.,]+/g,"")}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get uri(){return this.url[this._urlId]||""}get urlId(){return this._urlId}set urlId(e){const t=e%this.url.length;this._urlId!==t&&(this.details=void 0,this._urlId=t)}}function yi(e,t,i){switch(t){case"audio":e.audioGroupIds||(e.audioGroupIds=[]),e.audioGroupIds.push(i);break;case"text":e.textGroupIds||(e.textGroupIds=[]),e.textGroupIds.push(i)}}function Ei(e){const t={};e.forEach((e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++}))}function Si(e,t){const i=t.startPTS;if(Number.isFinite(i)){let s,r=0;t.sn>e.sn?(r=i-e.start,s=e):(r=e.start-i,s=t),s.duration!==r&&(s.duration=r)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function Ti(e,t,i,s,r,n){s-i<=0&&(dt.warn("Fragment should have a positive duration",t),s=i+t.duration,n=r+t.duration);let a=i,o=s;const l=t.startPTS,h=t.endPTS;if(Number.isFinite(l)){const e=Math.abs(l-i);Number.isFinite(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,a=Math.max(i,l),i=Math.min(i,l),r=Math.min(r,t.startDTS),o=Math.min(s,h),s=Math.max(s,h),n=Math.max(n,t.endDTS)}t.duration=s-i;const d=i-t.start;t.appendedPTS=s,t.start=t.startPTS=i,t.maxStartPTS=a,t.startDTS=r,t.endPTS=s,t.minEndPTS=o,t.endDTS=n;const u=t.sn;if(!e||u<e.startSN||u>e.endSN)return 0;let c;const f=u-e.startSN,m=e.fragments;for(m[f]=t,c=f;c>0;c--)Si(m[c],m[c-1]);for(c=f;c<m.length-1;c++)Si(m[c],m[c+1]);return e.fragmentHint&&Si(m[m.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,d}function Li(e,t){let i=null;const s=e.fragments;for(let l=s.length-1;l>=0;l--){const e=s[l].initSegment;if(e){i=e;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;let r,n=0;if(function(e,t,i){const s=t.skippedSegments,r=Math.max(e.startSN,t.startSN)-t.startSN,n=(e.fragmentHint?1:0)+(s?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let h=r;h<=n;h++){const e=l[a+h];let r=o[h];s&&!r&&h<s&&(r=t.fragments[h]=e),e&&r&&i(e,r)}}(e,t,((e,s)=>{e.relurl&&(n=e.cc-s.cc),Number.isFinite(e.startPTS)&&Number.isFinite(e.endPTS)&&(s.start=s.startPTS=e.startPTS,s.startDTS=e.startDTS,s.appendedPTS=e.appendedPTS,s.maxStartPTS=e.maxStartPTS,s.endPTS=e.endPTS,s.endDTS=e.endDTS,s.minEndPTS=e.minEndPTS,s.duration=e.endPTS-e.startPTS,s.duration&&(r=s),t.PTSKnown=t.alignedSliding=!0),s.elementaryStreams=e.elementaryStreams,s.loader=e.loader,s.stats=e.stats,s.urlId=e.urlId,e.initSegment?(s.initSegment=e.initSegment,i=e.initSegment):s.initSegment&&s.initSegment.relurl!=(null==i?void 0:i.relurl)||(s.initSegment=i)})),t.skippedSegments&&(t.deltaUpdateFailed=t.fragments.some((e=>!e)),t.deltaUpdateFailed)){dt.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}const a=t.fragments;if(n){dt.warn("discontinuity sliding from playlist, take drift into account");for(let e=0;e<a.length;e++)a[e].cc+=n}t.skippedSegments&&(t.startCC=t.fragments[0].cc),function(e,t,i){if(e&&t){let s=0;for(let r=0,n=e.length;r<=n;r++){const n=e[r],a=t[r+s];n&&a&&n.index===a.index&&n.fragment.sn===a.fragment.sn?i(n,a):s--}}}(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),r?Ti(t,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):bi(e,t),a.length&&(t.totalduration=t.edge-a[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const o=t.advancedDateTime;if(t.advanced&&o){const e=t.edge;t.driftStart||(t.driftStartTime=o,t.driftStart=e),t.driftEndTime=o,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function bi(e,t){const i=t.startSN+t.skippedSegments-e.startSN,s=e.fragments;i<0||i>=s.length||function(e,t){if(t){const i=e.fragments;for(let s=e.skippedSegments;s<i.length;s++)i[s].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}(t,s[i].start)}const Ai=/chrome|firefox/.test(navigator.userAgent.toLowerCase());class Ri extends class{constructor(e,t){this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=dt.log.bind(dt,`${t}:`),this.warn=dt.warn.bind(dt,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}onError(e,t){t.fatal&&t.type===it.NETWORK_ERROR&&this.clearTimer()}clearTimer(){clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=null==t?void 0:t.renditionReports;if(i)for(let s=0;s<i.length;s++){const r=i[s],n=""+r.URI;if(n===e.substr(-n.length)){const e=parseInt(r["LAST-MSN"]);let i=parseInt(r["LAST-PART"]);if(t&&this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);void 0!==i&&e>t.partTarget&&(i+=1)}if(Number.isFinite(e))return new _i(e,Number.isFinite(i)?i:void 0,gi.No)}}}loadPlaylist(e){}shouldLoadTrack(e){return this.canLoad&&e&&!!e.url&&(!e.details||e.details.live)}playlistLoaded(e,t,i){const{details:s,stats:r}=t,n=r.loading.end?Math.max(0,self.performance.now()-r.loading.end):0;if(s.advancedDateTime=Date.now()-n,s.live||(null==i?void 0:i.live)){if(s.reloaded(i),i&&this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:"MISSED"}`),i&&s.fragments.length>0&&Li(i,s),!this.canLoad||!s.live)return;let n,a,o;if(s.canBlockReload&&s.endSN&&s.advanced){const e=this.hls.config.lowLatencyMode,r=s.lastPartSn,l=s.endSN,h=s.lastPartIndex,d=r===l,u=e?0:h;-1!==h?(a=d?l+1:r,o=d?u:h+1):a=l+1;const c=s.age,f=c+s.ageHeader;let m=Math.min(f-s.partTarget,1.5*s.targetduration);if(m>0){if(i&&m>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${m} with playlist age: ${s.age}`),m=0;else{const e=Math.floor(m/s.targetduration);if(a+=e,void 0!==o){o+=Math.round(m%s.targetduration/s.partTarget)}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${c.toFixed(2)}s goal: ${m} skip sn ${e} to part ${o}`)}s.tuneInGoal=m}if(n=this.getDeliveryDirectives(s,t.deliveryDirectives,a,o),e||!d)return void this.loadPlaylist(n)}else n=this.getDeliveryDirectives(s,t.deliveryDirectives,a,o);let l=function(e,t){const i=1e3*e.levelTargetDuration,s=i/2,r=e.age,n=r>0&&r<3*i,a=t.loading.end-t.loading.start;let o,l=e.availabilityDelay;if(!1===e.updated)if(n){const t=333*e.misses;o=Math.max(Math.min(s,2*a),t),e.availabilityDelay=(e.availabilityDelay||0)+o}else o=s;else n?(l=Math.min(l||i/2,r),e.availabilityDelay=l,o=l+i-r):o=i-a;return Math.round(o)}(s,r);void 0!==a&&s.canBlockReload&&(l-=s.partTarget||1),this.log(`reload live playlist ${e} in ${Math.round(l)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(n)),l)}else this.clearTimer()}getDeliveryDirectives(e,t,i,s){let r=function(e,t){const{canSkipUntil:i,canSkipDateRanges:s,endSN:r}=e;return i&&(void 0!==t?t-r:0)<i?s?gi.v2:gi.Yes:gi.No}(e,i);return(null==t?void 0:t.skip)&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=gi.No),new _i(i,s,r)}retryLoadingOrFail(e){var t;const{config:i}=this.hls,s=this.retryCount<i.levelLoadingMaxRetry;if(s)if(this.retryCount++,e.details.indexOf("LoadTimeOut")>-1&&(null==(t=e.context)?void 0:t.deliveryDirectives))this.warn(`retry playlist loading #${this.retryCount} after "${e.details}"`),this.loadPlaylist();else{const t=Math.min(Math.pow(2,this.retryCount)*i.levelLoadingRetryDelay,i.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout((()=>this.loadPlaylist()),t),this.warn(`retry playlist loading #${this.retryCount} in ${t} ms after "${e.details}"`)}else this.warn(`cannot recover from error "${e.details}"`),this.clearTimer(),e.fatal=!0;return s}}{constructor(e){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(et.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(et.LEVEL_LOADED,this.onLevelLoaded,this),e.on(et.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(et.FRAG_LOADED,this.onFragLoaded,this),e.on(et.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(et.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(et.LEVEL_LOADED,this.onLevelLoaded,this),e.off(et.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(et.FRAG_LOADED,this.onFragLoaded,this),e.off(et.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,super.destroy()}startLoad(){this._levels.forEach((e=>{e.loadError=0})),super.startLoad()}onManifestLoaded(e,t){console.info("ana onManifestLoaded",t);let i,s=[],r=[],n=[];const a={};let o,l=!1,h=!1,d=!1;if(t.levels.forEach((e=>{const t=e.attrs;l=l||!(!e.width||!e.height),h=h||!!e.videoCodec,d=d||!!e.audioCodec,Ai&&e.audioCodec&&-1!==e.audioCodec.indexOf("mp4a.40.34")&&(e.audioCodec=void 0);const i=`${e.bitrate}-${e.attrs.RESOLUTION}-${e.attrs.CODECS}`;o=a[i],o?o.url.push(e.url):(o=new vi(e),a[i]=o,s.push(o)),t&&(t.AUDIO&&yi(o,"audio",t.AUDIO),t.SUBTITLES&&yi(o,"text",t.SUBTITLES))})),(l||h)&&d&&(s=s.filter((({videoCodec:e,width:t,height:i})=>!!e||!(!t||!i)))),s=s.filter((({audioCodec:e,videoCodec:t})=>(!e||Ot(e,"audio"))&&(!t||Ot(t,"video")))),t.audioTracks&&(r=t.audioTracks.filter((e=>!e.audioCodec||Ot(e.audioCodec,"audio"))),Ei(r)),t.subtitles&&(n=t.subtitles,Ei(n)),s.length>0){i=s[0].bitrate,s.sort(((e,t)=>e.bitrate-t.bitrate)),this._levels=s;for(let t=0;t<s.length;t++)if(s[t].bitrate===i){this._firstLevel=t,this.log(`manifest loaded, ${s.length} level(s) found, first bitrate: ${i}`);break}const e=d&&!h,a={levels:s,audioTracks:r,subtitleTracks:n,firstLevel:this._firstLevel,stats:t.stats,audio:d,video:h,altAudio:!e&&r.some((e=>!!e.url))};this.hls.trigger(et.MANIFEST_PARSED,a),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,reason:"no level with compatible codecs found in manifest"})}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){var t;const i=this._levels;if(0===i.length)return;if(this.currentLevelIndex===e&&(null==(t=i[e])?void 0:t.details))return;if(e<0||e>=i.length){const t=e<0;if(this.hls.trigger(et.ERROR,{type:it.OTHER_ERROR,details:rt.LEVEL_SWITCH_ERROR,level:e,fatal:t,reason:"invalid level idx"}),t)return;e=Math.min(e,i.length-1)}this.clearTimer();const s=this.currentLevelIndex,r=i[s],n=i[e];this.log(`switching to level ${e} from ${s}`),this.currentLevelIndex=e;const a=Object.assign({},n,{level:e,maxBitrate:n.maxBitrate,uri:n.uri,urlId:n.urlId});delete a._urlId,this.hls.trigger(et.LEVEL_SWITCHING,a);const o=n.details;if(!o||o.live){const e=this.switchParams(n.uri,null==r?void 0:r.details);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this._firstLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){if(super.onError(e,t),t.fatal)return;const i=t.context,s=this._levels[this.currentLevelIndex];if(i&&(i.type===Ht.AUDIO_TRACK&&s.audioGroupIds&&i.groupId===s.audioGroupIds[s.urlId]||i.type===Ht.SUBTITLE_TRACK&&s.textGroupIds&&i.groupId===s.textGroupIds[s.urlId]))return void this.redundantFailover(this.currentLevelIndex);let r,n=!1,a=!0;switch(t.details){case rt.FRAG_LOAD_ERROR:case rt.FRAG_LOAD_TIMEOUT:case rt.KEY_LOAD_ERROR:case rt.KEY_LOAD_TIMEOUT:if(t.frag){const e=this._levels[t.frag.level];e?(e.fragmentError++,e.fragmentError>this.hls.config.fragLoadingMaxRetry&&(r=t.frag.level)):r=t.frag.level}break;case rt.LEVEL_LOAD_ERROR:case rt.LEVEL_LOAD_TIMEOUT:i&&(i.deliveryDirectives&&(a=!1),r=i.level),n=!0;break;case rt.REMUX_ALLOC_ERROR:r=t.level,n=!0}void 0!==r&&this.recoverLevel(t,r,n,a)}recoverLevel(e,t,i,s){const{details:r}=e,n=this._levels[t];if(n.loadError++,i){if(!this.retryLoadingOrFail(e))return void(this.currentLevelIndex=-1);e.levelRetry=!0}if(s){const i=n.url.length;if(i>1&&n.loadError<i)e.levelRetry=!0,this.redundantFailover(t);else if(-1===this.manualLevelIndex){const i=0===t?this._levels.length-1:t-1;this.currentLevelIndex!==i&&0===this._levels[i].loadError&&(this.warn(`${r}: switch to ${i}`),e.levelRetry=!0,this.hls.nextAutoLevel=i)}}}redundantFailover(e){const t=this._levels[e],i=t.url.length;if(i>1){const s=(t.urlId+1)%i;this.warn(`Switching to redundant URL-id ${s}`),this._levels.forEach((e=>{e.urlId=s})),this.level=e}}onFragLoaded(e,{frag:t}){if(void 0!==t&&t.type===zt.MAIN){const e=this._levels[t.level];void 0!==e&&(e.fragmentError=0,e.loadError=0)}}onLevelLoaded(e,t){var i,s;const{level:r,details:n}=t,a=this._levels[r];if(!a)return this.warn(`Invalid level index ${r}`),void((null==(i=t.deliveryDirectives)?void 0:i.skip)&&(n.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===a.fragmentError&&(a.loadError=0,this.retryCount=0),this.playlistLoaded(r,t,a.details)):(null==(s=t.deliveryDirectives)?void 0:s.skip)&&(n.deltaUpdateFailed=!0)}onAudioTrackSwitched(e,t){const i=this.hls.levels[this.currentLevelIndex];if(i&&i.audioGroupIds){let e=-1;const s=this.hls.audioTracks[t.id].groupId;for(let t=0;t<i.audioGroupIds.length;t++)if(i.audioGroupIds[t]===s){e=t;break}e!==i.urlId&&(i.urlId=e,this.startLoad())}}loadPlaylist(e){const t=this.currentLevelIndex,i=this._levels[t];if(this.canLoad&&i&&i.url.length>0){const r=i.urlId;let n=i.url[r];if(e)try{n=e.addDirectives(n)}catch(s){this.warn(`Could not construct new URL with HLS Delivery Directives: ${s}`)}this.log(`Attempt loading level index ${t}${e?" at sn "+e.msn+" part "+e.part:""} with URL-id ${r} ${n}`),this.clearTimer(),this.hls.trigger(et.LEVEL_LOADING,{url:n,level:t,id:r,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e,t){const i=(e,i)=>i!==t,s=this._levels.filter(((s,r)=>r!==e||s.url.length>1&&void 0!==t&&(s.url=s.url.filter(i),s.audioGroupIds&&(s.audioGroupIds=s.audioGroupIds.filter(i)),s.textGroupIds&&(s.textGroupIds=s.textGroupIds.filter(i)),s.urlId=0,!0))).map(((e,t)=>{const{details:i}=e;return(null==i?void 0:i.fragments)&&i.fragments.forEach((e=>{e.level=t})),e}));this._levels=s,this.hls.trigger(et.LEVELS_UPDATED,{levels:s})}}var Di,wi;(wi=Di||(Di={})).NOT_LOADED="NOT_LOADED",wi.BACKTRACKED="BACKTRACKED",wi.APPENDING="APPENDING",wi.PARTIAL="PARTIAL",wi.OK="OK";class ki{constructor(e){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(et.BUFFER_APPENDED,this.onBufferAppended,this),e.on(et.FRAG_BUFFERED,this.onFragBuffered,this),e.on(et.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(et.BUFFER_APPENDED,this.onBufferAppended,this),e.off(et.FRAG_BUFFERED,this.onFragBuffered,this),e.off(et.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.timeRanges=null}getAppendedFrag(e,t){if(t===zt.MAIN){const{activeFragment:t,activeParts:i}=this;if(!t)return null;if(i)for(let s=i.length;s--;){const r=i[s],n=r?r.end:t.appendedPTS;if(r.start<=e&&void 0!==n&&e<=n)return s>9&&(this.activeParts=i.slice(s-9)),r}else if(t.start<=e&&void 0!==t.appendedPTS&&e<=t.appendedPTS)return t}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const n=i[s[r]];if((null==n?void 0:n.body.type)===t&&n.buffered){const t=n.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,i){Object.keys(this.fragments).forEach((s=>{const r=this.fragments[s];if(!r)return;if(!r.buffered)return void(r.body.type===i&&this.removeFragment(r.body));const n=r.range[e];n&&n.time.some((e=>{const i=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return i&&this.removeFragment(r.body),i}))}))}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:s}=e;if(!t||"initSegment"===i.sn)return;const r=Ii(i),n=this.fragments[r];n&&(Object.keys(t).forEach((e=>{const r=i.elementaryStreams[e];if(!r)return;const a=t[e],o=null!==s||!0===r.partial;n.range[e]=this.getBufferedTimes(i,s,o,a)})),n.backtrack=n.loaded=null,Object.keys(n.range).length?n.buffered=!0:this.removeFragment(n.body))}fragBuffered(e){const t=Ii(e),i=this.fragments[t];i&&(i.backtrack=i.loaded=null,i.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},n=t?t.start:e.start,a=t?t.end:e.end,o=e.minEndPTS||a,l=e.maxStartPTS||n;for(let h=0;h<s.length;h++){const e=s.start(h)-this.bufferPadding,t=s.end(h)+this.bufferPadding;if(l>=e&&o<=t){r.time.push({startPTS:Math.max(n,s.start(h)),endPTS:Math.min(a,s.end(h))});break}if(n<t&&a>e)r.partial=!0,r.time.push({startPTS:Math.max(n,s.start(h)),endPTS:Math.min(a,s.end(h))});else if(a<=e)break}return r}getPartialFragment(e){let t,i,s,r=null,n=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach((l=>{const h=o[l];h&&Ci(h)&&(i=h.body.start-a,s=h.body.end+a,e>=i&&e<=s&&(t=Math.min(e-i,s-e),n<=t&&(r=h.body,n=t)))})),r}getState(e){const t=Ii(e),i=this.fragments[t];return i?i.buffered?Ci(i)?Di.PARTIAL:Di.OK:i.backtrack?Di.BACKTRACKED:Di.APPENDING:Di.NOT_LOADED}backtrack(e,t){const i=Ii(e),s=this.fragments[i];if(!s||s.backtrack)return null;const r=s.backtrack=t||s.loaded;return s.loaded=null,r}getBacktrackData(e){var t;const i=Ii(e),s=this.fragments[i];if(s){const{backtrack:i}=s;if(null==(t=null==i?void 0:i.payload)?void 0:t.byteLength)return i;this.removeFragment(e)}return null}isTimeBuffered(e,t,i){let s,r;for(let n=0;n<i.length;n++){if(s=i.start(n)-this.bufferPadding,r=i.end(n)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:s}=t;if("initSegment"===i.sn||i.bitrateTest||s)return;const r=Ii(i);this.fragments[r]={body:i,loaded:t,backtrack:null,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r}=t;if(i.type===zt.MAIN)if(this.activeFragment=i,s){let e=this.activeParts;e||(this.activeParts=e=[]),e.push(s)}else this.activeParts=null;this.timeRanges=r,Object.keys(r).forEach((e=>{const t=r[e];if(this.detectEvictedFragments(e,t),!s)for(let s=0;s<t.length;s++)i.appendedPTS=Math.max(t.end(s),i.appendedPTS||0)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Ii(e);return!!this.fragments[t]}removeFragmentsInRange(e,t,i){Object.keys(this.fragments).forEach((s=>{const r=this.fragments[s];if(r&&r.buffered){const s=r.body;s.type===i&&s.start<t&&s.end>e&&this.removeFragment(s)}}))}removeFragment(e){const t=Ii(e);e.stats.loaded=0,e.clearElementaryStreamInfo(),delete this.fragments[t]}removeAllFragments(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null}}function Ci(e){var t,i;return e.buffered&&((null==(t=e.range.video)?void 0:t.partial)||(null==(i=e.range.audio)?void 0:i.partial))}function Ii(e){return`${e.type}_${e.level}_${e.urlId}_${e.sn}`}const xi={length:0,start:()=>0,end:()=>0};class Oi{static isBuffered(e,t){try{if(e){const i=Oi.getBuffered(e);for(let e=0;e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}}catch(i){}return!1}static bufferInfo(e,t,i){try{if(e){const s=Oi.getBuffered(e),r=[];let n;for(n=0;n<s.length;n++)r.push({start:s.start(n),end:s.end(n)});return this.bufferedInfo(r,t,i)}}catch(s){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort((function(e,t){const i=e.start-t.start;return i||t.end-e.end}));let s=[];if(i)for(let l=0;l<e.length;l++){const t=s.length;if(t){const r=s[t-1].end;e[l].start-r<i?e[l].end>r&&(s[t-1].end=e[l].end):s.push(e[l])}else s.push(e[l])}else s=e;let r,n=0,a=t,o=t;for(let l=0;l<s.length;l++){const e=s[l].start,h=s[l].end;if(t+i>=e&&t<h)a=e,o=h,n=o-t;else if(t+i<e){r=e;break}}return{len:n,start:a||0,end:o||0,nextStart:r}}static getBuffered(e){try{return e.buffered}catch(t){return dt.log("failed to get media.buffered",t),xi}}}class Pi{constructor(e,t,i,s=0,r=-1,n=!1){this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=n}}function Mi(e,t){if(e){const i=e.start+t;e.start=e.startPTS=i,e.endPTS=i+e.duration}}function Fi(e,t){const i=t.fragments;for(let s=0,r=i.length;s<r;s++)Mi(i[s],e);t.fragmentHint&&Mi(t.fragmentHint,e),t.alignedSliding=!0}function Bi(e,t,i){t&&(!function(e,t,i){if(function(e,t,i){return!(!t.details||!(i.endCC>i.startCC||e&&e.cc<i.startCC))}(e,i,t)){const e=function(e,t){const i=e.fragments,s=t.fragments;if(!s.length||!i.length)return void dt.log("No fragments to align");const r=function(e,t){let i=null;for(let s=0,r=e.length;s<r;s++){const r=e[s];if(r&&r.cc===t){i=r;break}}return i}(i,s[0].cc);if(r&&(!r||r.startPTS))return r;dt.log("No frag in previous level to align on")}(i.details,t);e&&Number.isFinite(e.start)&&(dt.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),Fi(e.start,t))}}(e,i,t),!i.alignedSliding&&t.details&&function(e,t){if(!t.fragments.length||!e.hasProgramDateTime||!t.hasProgramDateTime)return;const i=t.fragments[0].programDateTime,s=e.fragments[0].programDateTime,r=(s-i)/1e3+t.fragments[0].start;r&&Number.isFinite(r)&&(dt.log(`Adjusting PTS using programDateTime delta ${s-i}ms, sliding:${r.toFixed(3)} ${e.url} `),Fi(r,e))}(i,t.details),i.alignedSliding||!t.details||i.skippedSegments||bi(t.details,i))}const Ni=function(e,t){let i=0,s=e.length-1,r=null,n=null;for(;i<=s;){r=(i+s)/2|0,n=e[r];const a=t(n);if(a>0)i=r+1;else{if(!(a<0))return n;s=r-1}}return null};function Ui(e=0,t=0,i){const s=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-s<=e?1:i.start-s>e&&i.start?-1:0}function Gi(e,t,i){const s=1e3*Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-s>e}const $i=Math.pow(2,17);class Vi{constructor(e){this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Ki({type:it.NETWORK_ERROR,details:rt.FRAG_LOAD_ERROR,fatal:!1,frag:e,networkDetails:null},"Fragment does not have a "+(i?"part list":"url")));this.abort();const s=this.config,r=s.fLoader,n=s.loader;return new Promise(((i,a)=>{this.loader&&this.loader.destroy();const o=this.loader=e.loader=r?new r(s):new n(s),l=Hi(e),h={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:$i};e.stats=o.stats,o.load(l,h,{onSuccess:(t,s,r,n)=>{this.resetLoader(e,o),i({frag:e,part:null,payload:t.data,networkDetails:n})},onError:(t,i,s)=>{this.resetLoader(e,o),a(new Ki({type:it.NETWORK_ERROR,details:rt.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:t,networkDetails:s}))},onAbort:(t,i,s)=>{this.resetLoader(e,o),a(new Ki({type:it.NETWORK_ERROR,details:rt.INTERNAL_ABORTED,fatal:!1,frag:e,networkDetails:s}))},onTimeout:(t,i,s)=>{this.resetLoader(e,o),a(new Ki({type:it.NETWORK_ERROR,details:rt.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,networkDetails:s}))},onProgress:(i,s,r,n)=>{t&&t({frag:e,part:null,payload:r,networkDetails:n})}})}))}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,n=s.loader;return new Promise(((a,o)=>{this.loader&&this.loader.destroy();const l=this.loader=e.loader=r?new r(s):new n(s),h=Hi(e,t),d={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:$i};t.stats=l.stats,l.load(h,d,{onSuccess:(s,r,n,o)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const h={frag:e,part:t,payload:s.data,networkDetails:o};i(h),a(h)},onError:(i,s,r)=>{this.resetLoader(e,l),o(new Ki({type:it.NETWORK_ERROR,details:rt.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:i,networkDetails:r}))},onAbort:(i,s,r)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),o(new Ki({type:it.NETWORK_ERROR,details:rt.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,networkDetails:r}))},onTimeout:(i,s,r)=>{this.resetLoader(e,l),o(new Ki({type:it.NETWORK_ERROR,details:rt.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,networkDetails:r}))}})}))}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const s=Math.round(e.duration/t.duration),n=Math.min(Math.round(i.loaded/r),s),a=(s-n)*Math.round(i.loaded/n);i.total=i.loaded+a}else i.total=Math.max(i.loaded,i.total);const n=i.loading,a=s.loading;n.start?n.first+=a.first-a.start:(n.start=a.start,n.first=a.first),n.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Hi(e,t=null){const i=t||e,s={frag:e,part:t,responseType:"arraybuffer",url:i.url,rangeStart:0,rangeEnd:0},r=i.byteRangeStartOffset,n=i.byteRangeEndOffset;return Number.isFinite(r)&&Number.isFinite(n)&&(s.rangeStart=r,s.rangeEnd=n),s}class Ki extends Error{constructor(e,...t){super(...t),this.data=e}}class zi{constructor(e,t){this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class Wi{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class ji{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(4*s);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],n=i[2],a=i[3],o=this.invSubMix,l=o[0],h=o[1],d=o[2],u=o[3],c=new Uint32Array(256);let f=0,m=0,g=0;for(g=0;g<256;g++)c[g]=g<128?g<<1:g<<1^283;for(g=0;g<256;g++){let i=m^m<<1^m<<2^m<<3^m<<4;i=i>>>8^255&i^99,e[f]=i,t[i]=f;const o=c[f],g=c[o],p=c[g];let _=257*c[i]^16843008*i;s[f]=_<<24|_>>>8,r[f]=_<<16|_>>>16,n[f]=_<<8|_>>>24,a[f]=_,_=16843009*p^65537*g^257*o^16843008*f,l[i]=_<<24|_>>>8,h[i]=_<<16|_>>>16,d[i]=_<<8|_>>>24,u[i]=_,f?(f=o^c[c[c[p^o]]],m^=c[c[m]]):f=m=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(4!==r&&6!==r&&8!==r)throw new Error("Invalid aes key size="+r);const n=this.ksRows=4*(r+6+1);let a,o;const l=this.keySchedule=new Uint32Array(n),h=this.invKeySchedule=new Uint32Array(n),d=this.sBox,u=this.rcon,c=this.invSubMix,f=c[0],m=c[1],g=c[2],p=c[3];let _,v;for(a=0;a<n;a++)a<r?_=l[a]=t[a]:(v=_,a%r==0?(v=v<<8|v>>>24,v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v],v^=u[a/r|0]<<24):r>6&&a%r==4&&(v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v]),l[a]=_=(l[a-r]^v)>>>0);for(o=0;o<n;o++)a=n-o,v=3&o?l[a]:l[a-4],h[o]=o<4||a<=4?v:f[d[v>>>24]]^m[d[v>>>16&255]]^g[d[v>>>8&255]]^p[d[255&v]],h[o]=h[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,n=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],h=a[2],d=a[3],u=this.uint8ArrayToUint32Array_(i);let c=u[0],f=u[1],m=u[2],g=u[3];const p=new Int32Array(e),_=new Int32Array(p.length);let v,y,E,S,T,L,b,A,R,D,w,k,C,I;const x=this.networkToHostOrderSwap;for(;t<p.length;){for(R=x(p[t]),D=x(p[t+1]),w=x(p[t+2]),k=x(p[t+3]),T=R^r[0],L=k^r[1],b=w^r[2],A=D^r[3],C=4,I=1;I<s;I++)v=o[T>>>24]^l[L>>16&255]^h[b>>8&255]^d[255&A]^r[C],y=o[L>>>24]^l[b>>16&255]^h[A>>8&255]^d[255&T]^r[C+1],E=o[b>>>24]^l[A>>16&255]^h[T>>8&255]^d[255&L]^r[C+2],S=o[A>>>24]^l[T>>16&255]^h[L>>8&255]^d[255&b]^r[C+3],T=v,L=y,b=E,A=S,C+=4;v=n[T>>>24]<<24^n[L>>16&255]<<16^n[b>>8&255]<<8^n[255&A]^r[C],y=n[L>>>24]<<24^n[b>>16&255]<<16^n[A>>8&255]<<8^n[255&T]^r[C+1],E=n[b>>>24]<<24^n[A>>16&255]<<16^n[T>>8&255]<<8^n[255&L]^r[C+2],S=n[A>>>24]<<24^n[T>>16&255]<<16^n[L>>8&255]<<8^n[255&b]^r[C+3],_[t]=x(v^c),_[t+1]=x(S^f),_[t+2]=x(E^m),_[t+3]=x(y^g),c=R,f=D,m=w,g=k,t+=4}return _.buffer}}class qi{constructor(e,t,{removePKCS7Padding:i=!0}={}){if(this.logEnabled=!0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=e,this.config=t,this.removePKCS7Padding=i,i)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(s){}null===this.subtle&&(this.config.enableSoftwareAES=!0)}destroy(){this.observer=null}isSync(){return this.config.enableSoftwareAES}flush(){const{currentResult:e}=this;if(!e)return void this.reset();const t=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,i=t&&new DataView(e.buffer).getUint8(t-1);return i?ut(e,0,t-i):e}(t):t}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,s){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(e),t,i);const r=this.flush();r&&s(r.buffer)}else this.webCryptoDecrypt(new Uint8Array(e),t,i).then(s)}softwareDecrypt(e,t,i){const{currentIV:s,currentResult:r,remainderData:n}=this;this.logOnce("JS AES decrypt"),n&&(e=Dt(n,e),this.remainderData=null);const a=this.getValidChunk(e);if(!a.length)return null;s&&(i=s);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new ji),o.expandKey(t);const l=r;return this.currentResult=o.decrypt(a.buffer,0,i),this.currentIV=ut(a,-16).buffer,l||null}webCryptoDecrypt(e,t,i){const s=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new Wi(s,t)),this.fastAesKey.expandKey().then((t=>{if(!s)return Promise.reject(new Error("web crypto not initialized"));return new zi(s,i).decrypt(e.buffer,t)})).catch((s=>this.onWebCryptoError(s,e,t,i)))}onWebCryptoError(e,t,i,s){return dt.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",e),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(t,i,s)}getValidChunk(e){let t=e;const i=e.length-e.length%16;return i!==e.length&&(t=ut(e,0,i),this.remainderData=ut(e,i)),t}logOnce(e){this.logEnabled&&(dt.log(`[decrypter.ts]: ${e}`),this.logEnabled=!1)}}const Xi=function(e){let t="";const i=e.length;for(let s=0;s<i;s++)t+="["+e.start(s).toFixed(3)+","+e.end(s).toFixed(3)+"]";return t},Yi="STOPPED",Qi="IDLE",Zi="KEY_LOADING",Ji="FRAG_LOADING",es="FRAG_LOADING_WAITING_RETRY",ts="PARSING",is="PARSED",ss="BACKTRACKING",rs="ENDED",ns="ERROR",as="WAITING_LEVEL";function os(){return self.MediaSource||self.WebKitMediaSource}function ls(){return self.SourceBuffer||self.WebKitSourceBuffer}class hs{constructor(){this.frameIndex=0,this.cachedData=null,this.initPTS=null}resetInitSegment(e,t,i){this._id3Track={type:"id3",id:0,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(){}resetContiguity(){}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Dt(this.cachedData,e),this.cachedData=null);let i,s,r=ei(e,0),n=r?r.length:0;const a=this._audioTrack,o=this._id3Track,l=r?(e=>{const t=ni(e);for(let i=0;i<t.length;i++){const e=t[i];if(si(e))return di(e)}})(r):void 0,h=e.length;for(0!==this.frameIndex&&null!==this.initPTS||(this.initPTS=ds(l,t)),r&&r.length>0&&o.samples.push({pts:this.initPTS,dts:this.initPTS,data:r}),s=this.initPTS;n<h;){if(this.canParse(e,n)){const t=this.appendFrame(a,e,n);t?(this.frameIndex++,s=t.sample.pts,n+=t.length,i=n):n=h}else ii(e,n)?(r=ei(e,n),o.samples.push({pts:s,dts:s,data:r}),n+=r.length,i=n):n++;if(n===h&&i!==h){const t=ut(e,i);this.cachedData?this.cachedData=Dt(this.cachedData,t):this.cachedData=t}}return{audioTrack:a,avcTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},id3Track:o,textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),this.frameIndex=0,{audioTrack:this._audioTrack,avcTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},id3Track:this._id3Track,textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}destroy(){}}const ds=(e,t)=>Number.isFinite(e)?90*e:9e4*t;function us(e,t){return 255===e[t]&&240==(246&e[t+1])}function cs(e,t){return 1&e[t+1]?7:9}function fs(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function ms(e,t){return t+1<e.length&&us(e,t)}function gs(e,t){if(ms(e,t)){const i=cs(e,t);if(t+i>=e.length)return!1;const s=fs(e,t);if(s<=i)return!1;const r=t+s;return r===e.length||ms(e,r)}return!1}function ps(e,t,i,s,r){if(!e.samplerate){const n=function(e,t,i,s){let r,n,a,o;const l=navigator.userAgent.toLowerCase(),h=s,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r=1+((192&t[i+2])>>>6);const u=(60&t[i+2])>>>2;if(!(u>d.length-1))return a=(1&t[i+2])<<2,a|=(192&t[i+3])>>>6,dt.log(`manifest codec:${s}, ADTS type:${r}, samplingIndex:${u}`),/firefox/i.test(l)?u>=6?(r=5,o=new Array(4),n=u-3):(r=2,o=new Array(2),n=u):-1!==l.indexOf("android")?(r=2,o=new Array(2),n=u):(r=5,o=new Array(4),s&&(-1!==s.indexOf("mp4a.40.29")||-1!==s.indexOf("mp4a.40.5"))||!s&&u>=6?n=u-3:((s&&-1!==s.indexOf("mp4a.40.2")&&(u>=6&&1===a||/vivaldi/i.test(l))||!s&&1===a)&&(r=2,o=new Array(2)),n=u)),o[0]=r<<3,o[0]|=(14&u)>>1,o[1]|=(1&u)<<7,o[1]|=a<<3,5===r&&(o[1]|=(14&n)>>1,o[2]=(1&n)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:d[u],channelCount:a,codec:"mp4a.40."+r,manifestCodec:h};e.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${u}`})}(t,i,s,r);if(!n)return;e.config=n.config,e.samplerate=n.samplerate,e.channelCount=n.channelCount,e.codec=n.codec,e.manifestCodec=n.manifestCodec,dt.log(`parsed codec:${e.codec}, rate:${n.samplerate}, channels:${n.channelCount}`)}}function _s(e){return 9216e4/e}function vs(e,t,i,s,r){const n=function(e,t,i,s,r){const n=cs(e,t);let a=fs(e,t);if(a-=n,a>0)return{headerLength:n,frameLength:a,stamp:i+s*r}}(t,i,s,r,_s(e.samplerate));if(n){const{frameLength:s,headerLength:r,stamp:a}=n,o=r+s,l=Math.max(0,i+o-t.length);let h;l?(h=new Uint8Array(o-r),h.set(t.subarray(i+r,t.length),0)):h=t.subarray(i+r,i+o);const d={unit:h,pts:a};return l||e.samples.push(d),{sample:d,length:o,missing:l}}}class ys extends hs{constructor(e,t){super(),this.observer=e,this.config=t}resetInitSegment(e,t,i){super.resetInitSegment(e,t,i),this._audioTrack={container:"audio/adts",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!0,samples:[],manifestCodec:e,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=(ei(e,0)||[]).length;for(let i=e.length;t<i;t++)if(gs(e,t))return dt.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&us(e,t)&&fs(e,t)<=e.length-t}(e,t)}appendFrame(e,t,i){ps(e,this.observer,t,i,e.manifestCodec);const s=vs(e,t,i,this.initPTS,this.frameIndex);if(s&&0===s.missing)return s}}ys.minProbeByteLength=9;class Es{constructor(e,t){this.remainderData=null,this.config=t}resetTimeStamp(){}resetInitSegment(){}resetContiguity(){}static probe(e){return bt({data:e,start:0,end:Math.min(e.length,16384)},["moof"]).length>0}demux(e){let t=e;const i={type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0};if(this.config.progressive){this.remainderData&&(t=Dt(this.remainderData,e));const s=function(e){const t={valid:null,remainder:null},i=bt(e,["moof"]);if(!i)return t;if(i.length<2)return t.remainder=e,t;const s=i[i.length-1];return t.valid=ut(e,0,s.start-8),t.remainder=ut(e,s.start-8),t}(t);this.remainderData=s.remainder,i.samples=s.valid||new Uint8Array}else i.samples=t;return{audioTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},avcTrack:i,id3Track:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}flush(){const e={type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0};return e.samples=this.remainderData||new Uint8Array,this.remainderData=null,{audioTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},avcTrack:e,id3Track:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0},textTrack:{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}Es.minProbeByteLength=1024;let Ss=null;const Ts=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Ls=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],bs=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],As=[0,1,1,4];function Rs(e,t,i,s,r){if(i+24>t.length)return;const n=Ds(t,i);if(n&&i+n.frameLength<=t.length){const a=s+r*(9e4*n.samplesPerFrame/n.sampleRate),o={unit:t.subarray(i,i+n.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=n.channelCount,e.samplerate=n.sampleRate,e.samples.push(o),{sample:o,length:n.frameLength,missing:0}}}function Ds(e,t){const i=e[t+1]>>3&3,s=e[t+1]>>1&3,r=e[t+2]>>4&15,n=e[t+2]>>2&3;if(1!==i&&0!==r&&15!==r&&3!==n){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*Ts[14*(3===i?3-s:3===s?3:4)+r-1],h=Ls[3*(3===i?0:2===i?1:2)+n],d=3===o?1:2,u=bs[i][s],c=As[s],f=8*u*c,m=Math.floor(u*l/h+a)*c;if(null===Ss){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ss=e?parseInt(e[1]):0}return!!Ss&&Ss<=87&&2===s&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:h,channelCount:d,frameLength:m,samplesPerFrame:f}}}function ws(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function ks(e,t){return t+1<e.length&&ws(e,t)}function Cs(e,t){if(t+1<e.length&&ws(e,t)){const i=4,s=Ds(e,t);let r=i;(null==s?void 0:s.frameLength)&&(r=s.frameLength);const n=t+r;return n===e.length||ks(e,n)}return!1}class Is{constructor(e){this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(0===r)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=8*r,this.bytesAvailable-=r}skipBits(e){let t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;return e>32&&dt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i=8,s=8;for(let r=0;r<e;r++)0!==s&&(t=this.readEG(),s=(i+t+256)%256),i=0===s?i:s}readSPS(){let e,t,i,s=0,r=0,n=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),h=this.readUEG.bind(this),d=this.readBoolean.bind(this),u=this.skipBits.bind(this),c=this.skipEG.bind(this),f=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);o();const g=o();if(l(5),u(3),o(),f(),100===g||110===g||122===g||244===g||44===g||83===g||86===g||118===g||128===g){const e=h();if(3===e&&u(1),f(),f(),u(1),d())for(t=3!==e?8:12,i=0;i<t;i++)d()&&m(i<6?16:64)}f();const p=h();if(0===p)h();else if(1===p)for(u(1),c(),c(),e=h(),i=0;i<e;i++)c();f(),u(1);const _=h(),v=h(),y=l(1);0===y&&u(1),u(1),d()&&(s=h(),r=h(),n=h(),a=h());let E=[1,1];if(d()&&d()){switch(o()){case 1:E=[1,1];break;case 2:E=[12,11];break;case 3:E=[10,11];break;case 4:E=[16,11];break;case 5:E=[40,33];break;case 6:E=[24,11];break;case 7:E=[20,11];break;case 8:E=[32,11];break;case 9:E=[80,33];break;case 10:E=[18,11];break;case 11:E=[15,11];break;case 12:E=[64,33];break;case 13:E=[160,99];break;case 14:E=[4,3];break;case 15:E=[3,2];break;case 16:E=[2,1];break;case 255:E=[o()<<8|o(),o()<<8|o()]}}return{width:Math.ceil(16*(_+1)-2*s-2*r),height:(2-y)*(v+1)*16-(y?2:4)*(n+a),pixelRatio:E}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class xs{constructor(e,t,i){this.keyData=i,this.decrypter=new qi(e,t,{removePKCS7Padding:!1})}decryptBuffer(e,t){this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,t)}decryptAacSample(e,t,i,s){const r=e[t].unit,n=r.subarray(16,r.length-r.length%16),a=n.buffer.slice(n.byteOffset,n.byteOffset+n.length),o=this;this.decryptBuffer(a,(n=>{const a=new Uint8Array(n);r.set(a,16),s||o.decryptAacSamples(e,t+1,i)}))}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length)return void i();if(e[t].unit.length<32)continue;const s=this.decrypter.isSync();if(this.decryptAacSample(e,t,i,s),!s)return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,i=new Int8Array(t);let s=0;for(let r=32;r<=e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<=e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r,n){const a=Vs(r.data),o=this.getAvcEncryptedData(a),l=this;this.decryptBuffer(o.buffer,(function(o){r.data=l.getAvcDecryptedUnit(a,o),n||l.decryptAvcSamples(e,t,i+1,s)}))}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length)return void s();const r=e[t].units;for(;!(i>=r.length);i++){const n=r[i];if(n.data.length<=48||1!==n.type&&5!==n.type)continue;const a=this.decrypter.isSync();if(this.decryptAvcSample(e,t,i,s,n,a),!a)return}}}}const Os={video:1,audio:2,id3:3,text:4},Ps=class{constructor(e,t,i){this.sampleAes=null,this.pmtParsed=!1,this._duration=0,this.aacLastPTS=null,this._initPTS=null,this._initDTS=null,this._pmtId=-1,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=i}static probe(e){const t=Ps.syncOffset(e);return!(t<0)&&(t&&dt.warn(`MPEG2-TS detected but first sync word found @ offset ${t}, junk ahead ?`),!0)}static syncOffset(e){const t=Math.min(1e3,e.length-564);let i=0;for(;i<t;){if(71===e[i]&&71===e[i+188]&&71===e[i+376])return i;i++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Os[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,i){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=Ps.createTrack("video",i),this._audioTrack=Ps.createTrack("audio",i),this._id3Track=Ps.createTrack("id3",i),this._txtTrack=Ps.createTrack("text",i),this._audioTrack.isAAC=!0,this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=e,this.videoCodec=t,this._duration=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_avcTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.aacLastPTS=null}demux(e,t,i=!1,s=!1){let r;i||(this.sampleAes=null);const n=this._avcTrack,a=this._audioTrack,o=this._id3Track;let l=n.pid,h=n.pesData,d=a.pid,u=o.pid,c=a.pesData,f=o.pesData,m=!1,g=this.pmtParsed,p=this._pmtId,_=e.length;if(this.remainderData&&(_=(e=Dt(this.remainderData,e)).length,this.remainderData=null),_<188&&!s)return this.remainderData=e,{audioTrack:a,avcTrack:n,id3Track:o,textTrack:this._txtTrack};const v=Math.max(0,Ps.syncOffset(e));_-=(_+v)%188,_<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,_,e.buffer.byteLength-_));for(let E=v;E<_;E+=188)if(71===e[E]){const t=!!(64&e[E+1]),s=((31&e[E+1])<<8)+e[E+2];let _;if((48&e[E+3])>>4>1){if(_=E+5+e[E+4],_===E+188)continue}else _=E+4;switch(s){case l:t&&(h&&(r=Us(h))&&this.parseAVCPES(r,!1),h={data:[],size:0}),h&&(h.data.push(e.subarray(_,E+188)),h.size+=E+188-_);break;case d:t&&(c&&(r=Us(c))&&(a.isAAC?this.parseAACPES(r):this.parseMPEGPES(r)),c={data:[],size:0}),c&&(c.data.push(e.subarray(_,E+188)),c.size+=E+188-_);break;case u:t&&(f&&(r=Us(f))&&this.parseID3PES(r),f={data:[],size:0}),f&&(f.data.push(e.subarray(_,E+188)),f.size+=E+188-_);break;case 0:t&&(_+=e[_]+1),p=this._pmtId=Bs(e,_);break;case p:{t&&(_+=e[_]+1);const s=Ns(e,_,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,i);l=s.avc,l>0&&(n.pid=l),d=s.audio,d>0&&(a.pid=d,a.isAAC=s.isAAC),u=s.id3,u>0&&(o.pid=u),m&&!g&&(dt.log("reparse from beginning"),m=!1,E=v-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=!0}}else this.observer.emit(et.ERROR,et.ERROR,{type:it.MEDIA_ERROR,details:rt.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});n.pesData=h,a.pesData=c,o.pesData=f;const y={audioTrack:a,avcTrack:n,id3Track:o,textTrack:this._txtTrack};return s&&this.extractRemainingSamples(y),y}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{audioTrack:this._audioTrack,avcTrack:this._avcTrack,textTrack:this._txtTrack,id3Track:this._id3Track},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,avcTrack:i,id3Track:s}=e,r=i.pesData,n=t.pesData,a=s.pesData;let o;r&&(o=Us(r))?(this.parseAVCPES(o,!0),i.pesData=null):i.pesData=r,n&&(o=Us(n))?(t.isAAC?this.parseAACPES(o):this.parseMPEGPES(o),t.pesData=null):((null==n?void 0:n.size)&&dt.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=n),a&&(o=Us(a))?(this.parseID3PES(o),s.pesData=null):s.pesData=a}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new xs(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise((i=>{const{audioTrack:s,avcTrack:r}=e;s.samples&&s.isAAC?t.decryptAacSamples(s.samples,0,(()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,(()=>{i(e)})):i(e)})):r.samples&&t.decryptAvcSamples(r.samples,0,0,(()=>{i(e)}))}))}destroy(){this._initPTS=this._initDTS=null,this._duration=0}parseAVCPES(e,t){const i=this._avcTrack,s=this.parseAVCNALu(e.data);let r,n=this.avcSample,a=!1;e.data=null,n&&s.length&&!i.audFound&&(Gs(n,i),n=this.avcSample=Fs(!1,e.pts,e.dts,"")),s.forEach((t=>{switch(t.type){case 1:{r=!0,n||(n=this.avcSample=Fs(!0,e.pts,e.dts,"")),n.frame=!0;const i=t.data;if(a&&i.length>4){const e=new Is(i).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(n.key=!0)}break}case 5:r=!0,n||(n=this.avcSample=Fs(!0,e.pts,e.dts,"")),n.key=!0,n.frame=!0;break;case 6:{r=!0;const i=new Is(Vs(t.data));i.readUByte();let s=0,n=0,a=!1,o=0;for(;!a&&i.bytesAvailable>1;){s=0;do{o=i.readUByte(),s+=o}while(255===o);n=0;do{o=i.readUByte(),n+=o}while(255===o);if(4===s&&0!==i.bytesAvailable){a=!0;if(181===i.readUByte()){if(49===i.readUShort()){if(1195456820===i.readUInt()){if(3===i.readUByte()){const t=i.readUByte(),s=31&t,r=[t,i.readUByte()];for(let e=0;e<s;e++)r.push(i.readUByte()),r.push(i.readUByte()),r.push(i.readUByte());$s(this._txtTrack.samples,{type:3,pts:e.pts,bytes:r})}}}}}else if(5===s&&0!==i.bytesAvailable){if(a=!0,n>16){const t=[];for(let e=0;e<16;e++)t.push(i.readUByte().toString(16)),3!==e&&5!==e&&7!==e&&9!==e||t.push("-");const r=n-16,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=i.readUByte();$s(this._txtTrack.samples,{pts:e.pts,payloadType:s,uuid:t.join(""),userData:ui(a),userDataBytes:a})}}else if(n<i.bytesAvailable)for(let e=0;e<n;e++)i.readUByte()}break}case 7:if(r=!0,a=!0,!i.sps){const e=new Is(t.data).readSPS();i.width=e.width,i.height=e.height,i.pixelRatio=e.pixelRatio,i.sps=[t.data],i.duration=this._duration;const s=t.data.subarray(1,4);let r="avc1.";for(let t=0;t<3;t++){let e=s[t].toString(16);e.length<2&&(e="0"+e),r+=e}i.codec=r}break;case 8:r=!0,i.pps||(i.pps=[t.data]);break;case 9:r=!1,i.audFound=!0,n&&Gs(n,i),n=this.avcSample=Fs(!1,e.pts,e.dts,"");break;case 12:r=!1;break;default:r=!1,n&&(n.debug+="unknown NAL "+t.type+" ")}if(n&&r){n.units.push(t)}})),t&&n&&(Gs(n,i),this.avcSample=null)}getLastNalUnit(){let e,t=this.avcSample;if(!t||0===t.units.length){const e=this._avcTrack.samples;t=e[e.length-1]}if(null==t?void 0:t.units){const i=t.units;e=i[i.length-1]}return e}parseAVCNALu(e){const t=e.byteLength,i=this._avcTrack;let s=i.naluState||0;const r=s,n=[];let a,o,l,h=0,d=-1,u=0;for(-1===s&&(d=0,u=31&e[0],s=0,h=1);h<t;)if(a=e[h++],s)if(1!==s)if(a)if(1===a){if(d>=0){const t={data:e.subarray(d,h-s-1),type:u};n.push(t)}else{const t=this.getLastNalUnit();if(t&&(r&&h<=4-r&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-r)),o=h-s-1,o>0)){const i=new Uint8Array(t.data.byteLength+o);i.set(t.data,0),i.set(e.subarray(0,o),t.data.byteLength),t.data=i}}h<t?(l=31&e[h],d=h,u=l,s=0):s=-1}else s=0;else s=3;else s=a?0:2;else s=a?0:1;if(d>=0&&s>=0){const i={data:e.subarray(d,t),type:u,state:s};n.push(i)}if(0===n.length){const t=this.getLastNalUnit();if(t){const i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return i.naluState=s,n}parseAACPES(e){let t=0;const i=this._audioTrack,s=this.aacOverFlow,r=e.data;if(s){this.aacOverFlow=null;const e=s.sample.unit.byteLength,n=Math.min(s.missing,e),a=e-n;s.sample.unit.set(r.subarray(0,n),a),i.samples.push(s.sample),t=s.missing}let n,a,o;for(n=t,a=r.length;n<a-1&&!ms(r,n);n++);if(n!==t){let e,t;if(n<a-1?(e=`AAC PES did not start with ADTS header,offset:${n}`,t=!1):(e="no ADTS header found in AAC PES",t=!0),dt.warn(`parsing error:${e}`),this.observer.emit(et.ERROR,et.ERROR,{type:it.MEDIA_ERROR,details:rt.FRAG_PARSING_ERROR,fatal:t,reason:e}),t)return}if(ps(i,this.observer,r,n,this.audioCodec),void 0!==e.pts)o=e.pts;else{if(!s)return void dt.warn("[tsdemuxer]: AAC PES unknown PTS");{const e=_s(i.samplerate);o=s.sample.pts+e}}let l=0;for(;n<a;){if(ms(r,n)){if(n+5<a){const e=vs(i,r,n,o,l);if(e){if(!e.missing){n+=e.length,l++;continue}this.aacOverFlow=e}}break}n++}}parseMPEGPES(e){const t=e.data,i=t.length;let s=0,r=0;const n=e.pts;if(void 0!==n)for(;r<i;)if(ks(t,r)){const e=Rs(this._audioTrack,t,r,n,s);if(!e)break;r+=e.length,s++}else r++;else dt.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseID3PES(e){void 0!==e.pts?this._id3Track.samples.push(e):dt.warn("[tsdemuxer]: ID3 PES unknown PTS")}};let Ms=Ps;function Fs(e,t,i,s){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:s,length:0}}function Bs(e,t){return(31&e[t+10])<<8|e[t+11]}function Ns(e,t,i,s){const r={audio:-1,avc:-1,id3:-1,isAAC:!0},n=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<n;){const n=(31&e[t+1])<<8|e[t+2];switch(e[t]){case 207:if(!s){dt.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===r.audio&&(r.audio=n);break;case 21:-1===r.id3&&(r.id3=n);break;case 219:if(!s){dt.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===r.avc&&(r.avc=n);break;case 3:case 4:i?-1===r.audio&&(r.audio=n,r.isAAC=!1):dt.log("MPEG audio found, not supported in this browser");break;case 36:dt.warn("Unsupported HEVC stream type found")}t+=5+((15&e[t+3])<<8|e[t+4])}return r}function Us(e){let t,i,s,r,n,a=0;const o=e.data;if(!e||0===e.size)return null;for(;o[0].length<19&&o.length>1;){const e=new Uint8Array(o[0].length+o[1].length);e.set(o[0]),e.set(o[1],o[0].length),o[0]=e,o.splice(1,1)}t=o[0];if(1===(t[0]<<16)+(t[1]<<8)+t[2]){if(i=(t[4]<<8)+t[5],i&&i>e.size-6)return null;const l=t[7];192&l&&(r=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&l?(n=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,r-n>54e5&&(dt.warn(`${Math.round((r-n)/9e4)}s delta between PTS and DTS, align them`),r=n)):n=r),s=t[8];let h=s+9;if(e.size<=h)return null;e.size-=h;const d=new Uint8Array(e.size);for(let e=0,i=o.length;e<i;e++){t=o[e];let i=t.byteLength;if(h){if(h>i){h-=i;continue}t=t.subarray(h),i-=h,h=0}d.set(t,a),a+=i}return i&&(i-=s+3),{data:d,pts:r,dts:n,len:i}}return null}function Gs(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const i=t.samples,s=i.length;if(!s)return void t.dropped++;{const t=i[s-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&dt.log(e.pts+"/"+e.dts+":"+e.debug)}function $s(e,t){const i=e.length;if(i>0){if(t.pts>=e[i-1].pts)e.push(t);else for(let s=i-1;s>=0;s--)if(t.pts<e[s].pts){e.splice(s,0,t);break}}else e.push(t)}function Vs(e){const t=e.byteLength,i=[];let s=1;for(;s<t-2;)0===e[s]&&0===e[s+1]&&3===e[s+2]?(i.push(s+2),s+=2):s++;if(0===i.length)return e;const r=t-i.length,n=new Uint8Array(r);let a=0;for(s=0;s<r;a++,s++)a===i[0]&&(a++,i.shift()),n[s]=e[a];return n}Ms.minProbeByteLength=188;class Hs extends hs{resetInitSegment(e,t,i){super.resetInitSegment(e,t,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!1,samples:[],manifestCodec:e,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=(ei(e,0)||[]).length;for(let i=e.length;t<i;t++)if(Cs(e,t))return dt.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return ws(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,i){if(null!==this.initPTS)return Rs(e,t,i,this.initPTS,this.frameIndex)}}Hs.minProbeByteLength=4;class Ks{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const zs=Math.pow(2,32)-1;class Ws{static init(){let e;for(e in Ws.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},Ws.types)Ws.types.hasOwnProperty(e)&&(Ws.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);Ws.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);Ws.STTS=Ws.STSC=Ws.STCO=r,Ws.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Ws.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),Ws.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),Ws.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const n=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);Ws.FTYP=Ws.box(Ws.types.ftyp,n,o,n,a),Ws.DINF=Ws.box(Ws.types.dinf,Ws.box(Ws.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=255&i,n.set(e,4),s=0,i=8;s<r;s++)n.set(t[s],i),i+=t[s].byteLength;return n}static hdlr(e){return Ws.box(Ws.types.hdlr,Ws.HDLR_TYPES[e])}static mdat(e){return Ws.box(Ws.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(zs+1)),s=Math.floor(t%(zs+1));return Ws.box(Ws.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,85,196,0,0]))}static mdia(e){return Ws.box(Ws.types.mdia,Ws.mdhd(e.timescale,e.duration),Ws.hdlr(e.type),Ws.minf(e))}static mfhd(e){return Ws.box(Ws.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?Ws.box(Ws.types.minf,Ws.box(Ws.types.smhd,Ws.SMHD),Ws.DINF,Ws.stbl(e)):Ws.box(Ws.types.minf,Ws.box(Ws.types.vmhd,Ws.VMHD),Ws.DINF,Ws.stbl(e))}static moof(e,t,i){return Ws.box(Ws.types.moof,Ws.mfhd(e),Ws.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=Ws.trak(e[t]);return Ws.box.apply(null,[Ws.types.moov,Ws.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(Ws.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=Ws.trex(e[t]);return Ws.box.apply(null,[Ws.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(zs+1)),s=Math.floor(t%(zs+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return Ws.box(Ws.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return Ws.box(Ws.types.sdtp,i)}static stbl(e){return Ws.box(Ws.types.stbl,Ws.stsd(e),Ws.box(Ws.types.stts,Ws.STTS),Ws.box(Ws.types.stsc,Ws.STSC),Ws.box(Ws.types.stsz,Ws.STSZ),Ws.box(Ws.types.stco,Ws.STCO))}static avc1(e){let t,i,s,r=[],n=[];for(t=0;t<e.sps.length;t++)i=e.sps[t],s=i.byteLength,r.push(s>>>8&255),r.push(255&s),r=r.concat(Array.prototype.slice.call(i));for(t=0;t<e.pps.length;t++)i=e.pps[t],s=i.byteLength,n.push(s>>>8&255),n.push(255&s),n=n.concat(Array.prototype.slice.call(i));const a=Ws.box(Ws.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|e.sps.length].concat(r).concat([e.pps.length]).concat(n))),o=e.width,l=e.height,h=e.pixelRatio[0],d=e.pixelRatio[1];return Ws.box(Ws.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,Ws.box(Ws.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),Ws.box(Ws.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){const t=e.samplerate;return Ws.box(Ws.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]),Ws.box(Ws.types.esds,Ws.esds(e)))}static mp3(e){const t=e.samplerate;return Ws.box(Ws.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]))}static stsd(e){return"audio"===e.type?e.isAAC||"mp3"!==e.codec?Ws.box(Ws.types.stsd,Ws.STSD,Ws.mp4a(e)):Ws.box(Ws.types.stsd,Ws.STSD,Ws.mp3(e)):Ws.box(Ws.types.stsd,Ws.STSD,Ws.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,s=e.width,r=e.height,n=Math.floor(i/(zs+1)),a=Math.floor(i%(zs+1));return Ws.box(Ws.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,255&s,0,0,r>>8&255,255&r,0,0]))}static traf(e,t){const i=Ws.sdtp(e),s=e.id,r=Math.floor(t/(zs+1)),n=Math.floor(t%(zs+1));return Ws.box(Ws.types.traf,Ws.box(Ws.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s])),Ws.box(Ws.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,n>>24,n>>16&255,n>>8&255,255&n])),Ws.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,Ws.box(Ws.types.trak,Ws.tkhd(e),Ws.mdia(e))}static trex(e){const t=e.id;return Ws.box(Ws.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,n=new Uint8Array(r);let a,o,l,h,d,u;for(t+=8+r,n.set([0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,255&s,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<s;a++)o=i[a],l=o.duration,h=o.size,d=o.flags,u=o.cts,n.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,h>>>24&255,h>>>16&255,h>>>8&255,255&h,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*a);return Ws.box(Ws.types.trun,n)}static initSegment(e){Ws.types||Ws.init();const t=Ws.moov(e),i=new Uint8Array(Ws.FTYP.byteLength+t.byteLength);return i.set(Ws.FTYP),i.set(t,Ws.FTYP.byteLength),i}}function js(e,t=!1){return function(e,t,i=1,s=!1){const r=e*t*i;return s?Math.round(r):r}(e,1e3,1/9e4,t)}let qs=null,Xs=null,Ys=!1;class Qs{constructor(e,t,i,s=""){if(this.ISGenerated=!1,this.nextAvcDts=null,this.nextAudioPts=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,null===qs){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);qs=e?parseInt(e[1]):0}if(null===Xs){const e=navigator.userAgent.match(/Safari\/(\d+)/i);Xs=e?parseInt(e[1]):0}Ys=!!qs&&qs<75||!!Xs&&Xs<600}destroy(){}resetTimeStamp(e){dt.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){dt.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){dt.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1}getVideoStartPts(e){let t=!1;const i=e.reduce(((e,i)=>{const s=i.pts-e;return s<-4294967296?(t=!0,Zs(e,i.pts)):s>0?e:i.pts}),e[0].pts);return t&&dt.debug("PTS rollover detected"),i}remux(e,t,i,s,r,n,a,o){let l,h,d,u,c,f,m=r,g=r;const p=e.pid>-1,_=t.pid>-1,v=t.samples.length,y=e.samples.length>0,E=v>1;if((!p||y)&&(!_||E)||this.ISGenerated||a){this.ISGenerated||(d=this.generateIS(e,t,r));const i=this.isVideoContiguous;let s=-1;if(E&&(s=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,s>0){dt.warn(`[mp4-remuxer]: Dropped ${s} out of ${v} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(s),t.dropped+=s,g+=(t.samples[0].pts-e)/(t.timescale||9e4)}else-1===s&&(dt.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(y&&E){const i=this.getVideoStartPts(t.samples),s=(Zs(e.samples[0].pts,i)-i)/t.inputTimeScale;m+=Math.max(0,s),g+=Math.max(0,-s)}if(y){if(e.samplerate||(dt.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,r)),h=this.remuxAudio(e,m,this.isAudioContiguous,n,_||E||o===zt.AUDIO?g:void 0),E){const s=h?h.endPTS-h.startPTS:0;t.inputTimeScale||(dt.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,r)),l=this.remuxVideo(t,g,i,s)}}else E&&(l=this.remuxVideo(t,g,i,0));l&&(l.firstKeyFrame=s,l.independent=-1!==s)}}return this.ISGenerated&&(i.samples.length&&(c=this.remuxID3(i,r)),s.samples.length&&(u=this.remuxText(s,r))),{audio:h,video:l,initSegment:d,independent:f,text:u,id3:c}}generateIS(e,t,i){const s=e.samples,r=t.samples,n=this.typeSupported,a={},o=!Number.isFinite(this._initPTS);let l,h,d,u="audio/mp4";if(o&&(l=h=1/0),e.config&&s.length&&(e.timescale=e.samplerate,e.isAAC||(n.mpeg?(u="audio/mpeg",e.codec=""):n.mp3&&(e.codec="mp3")),a.audio={id:"audio",container:u,codec:e.codec,initSegment:!e.isAAC&&n.mpeg?new Uint8Array(0):Ws.initSegment([e]),metadata:{channelCount:e.channelCount}},o&&(d=e.inputTimeScale,l=h=s[0].pts-Math.round(d*i))),t.sps&&t.pps&&r.length&&(t.timescale=t.inputTimeScale,a.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:Ws.initSegment([t]),metadata:{width:t.width,height:t.height}},o)){d=t.inputTimeScale;const e=this.getVideoStartPts(r),s=Math.round(d*i);h=Math.min(h,Zs(r[0].dts,e)-s),l=Math.min(l,e-s)}if(Object.keys(a).length)return this.ISGenerated=!0,o&&(this._initPTS=l,this._initDTS=h),{tracks:a,initPTS:l,timescale:d}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,n=e.samples,a=[],o=n.length,l=this._initPTS;let h,d,u,c=this.nextAvcDts,f=8,m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,p=0,_=!1;if(!i||null===c){c=t*r-(n[0].pts-Zs(n[0].dts,n[0].pts))}for(let R=0;R<o;R++){const e=n[R];if(e.pts=Zs(e.pts-l,c),e.dts=Zs(e.dts-l,c),e.dts>e.pts){const t=18e3;p=Math.max(Math.min(p,e.pts-e.dts),-1*t)}e.dts<n[R>0?R-1:R].dts&&(_=!0)}_&&n.sort((function(e,t){const i=e.dts-t.dts,s=e.pts-t.pts;return i||s})),d=n[0].dts,u=n[n.length-1].dts;const v=Math.round((u-d)/(o-1));if(p<0){if(p<-2*v){dt.warn(`PTS < DTS detected in video samples, offsetting DTS from PTS by ${js(-v,!0)} ms`);let e=p;for(let t=0;t<o;t++)n[t].dts=e=Math.max(e,n[t].pts-v),n[t].pts=Math.max(e,n[t].pts)}else{dt.warn(`PTS < DTS detected in video samples, shifting DTS by ${js(p,!0)} ms to overcome this issue`);for(let e=0;e<o;e++)n[e].dts=n[e].dts+p}d=n[0].dts}if(i){const e=d-c,t=e>v,i=e<-1;if(t||i){t?dt.warn(`AVC: ${js(e,!0)} ms (${e}dts) hole between fragments detected, filling it`):dt.warn(`AVC: ${js(-e,!0)} ms (${e}dts) overlapping between fragments detected`),d=c;const i=n[0].pts-e;n[0].dts=d,n[0].pts=i,dt.log(`Video: First PTS/DTS adjusted: ${js(i,!0)}/${js(d,!0)}, delta: ${js(e,!0)} ms`)}}Ys&&(d=Math.max(0,d));let y=0,E=0;for(let R=0;R<o;R++){const e=n[R],t=e.units,i=t.length;let s=0;for(let r=0;r<i;r++)s+=t[r].data.length;E+=s,y+=i,e.length=s,e.dts=Math.max(e.dts,d),e.pts=Math.max(e.pts,e.dts,0),m=Math.min(e.pts,m),g=Math.max(e.pts,g)}u=n[o-1].dts;const S=E+4*y+8;let T;try{T=new Uint8Array(S)}catch(A){return void this.observer.emit(et.ERROR,et.ERROR,{type:it.MUX_ERROR,details:rt.REMUX_ALLOC_ERROR,fatal:!1,bytes:S,reason:`fail allocating video mdat ${S}`})}const L=new DataView(T.buffer);L.setUint32(0,S),T.set(Ws.types.mdat,4);for(let R=0;R<o;R++){const e=n[R],t=e.units;let i=0;for(let s=0,r=t.length;s<r;s++){const e=t[s],r=e.data,n=e.data.byteLength;L.setUint32(f,n),f+=4,T.set(r,f),f+=n,i+=4+n}if(R<o-1)h=n[R+1].dts-e.dts;else{const t=this.config,i=e.dts-n[R>0?R-1:R].dts;if(t.stretchShortVideoTrack&&null!==this.nextAudioPts){const n=Math.floor(t.maxBufferHole*r),a=(s?m+s*r:this.nextAudioPts)-e.pts;a>n?(h=a-i,h<0&&(h=i),dt.log(`[mp4-remuxer]: It is approximately ${a/90} ms to the next segment; using duration ${h/90} ms for the last video frame.`)):h=i}else h=i}const l=Math.round(e.pts-e.dts);a.push(new Js(e.key,h,i,l))}if(a.length&&qs&&qs<70){const e=a[0].flags;e.dependsOn=2,e.isNonSync=0}console.assert(void 0!==h,"mp4SampleDuration must be computed"),this.nextAvcDts=c=u+h,this.isVideoContiguous=!0;const b={data1:Ws.moof(e.sequenceNumber++,d,Object.assign({},e,{samples:a})),data2:T,startPTS:m/r,endPTS:(g+h)/r,startDTS:d/r,endDTS:c/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,console.assert(T.length,"MDAT length must not be zero"),b}remuxAudio(e,t,i,s,r){const n=e.inputTimeScale,a=n/(e.samplerate?e.samplerate:n),o=e.isAAC?1024:1152,l=o*a,h=this._initPTS,d=!e.isAAC&&this.typeSupported.mpeg,u=[];let c=e.samples,f=d?0:8,m=this.nextAudioPts||-1;const g=t*n;if(this.isAudioContiguous=i=i||c.length&&m>0&&(s&&Math.abs(g-m)<9e3||Math.abs(Zs(c[0].pts-h,g)-m)<20*l),c.forEach((function(e){e.pts=Zs(e.pts-h,g)})),!i||m<0){if(c=c.filter((e=>e.pts>=0)),!c.length)return;m=0===r?0:s?Math.max(0,g):c[0].pts}if(e.isAAC){const t=void 0!==r,i=this.config.maxAudioFramesDrift;for(let s=0,r=m;s<c.length;s++){const a=c[s],o=a.pts,h=o-r,d=Math.abs(1e3*h/n);if(h<=-i*l&&t)0===s&&(dt.warn(`Audio frame @ ${(o/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*h/n)} ms.`),this.nextAudioPts=m=r=o);else if(h>=i*l&&d<1e4&&t){let t=Math.round(h/l);r=o-t*l,r<0&&(t--,r+=l),0===s&&(this.nextAudioPts=m=r),dt.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(r/n).toFixed(3)}s due to ${Math.round(1e3*h/n)} ms gap.`);for(let i=0;i<t;i++){const t=Math.max(r,0);let i=Ks.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);i||(dt.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),i=a.unit.subarray()),c.splice(s,0,{unit:i,pts:t}),r+=l,s++}}a.pts=r,r+=l}}let p,_=null,v=null,y=0,E=c.length;for(;E--;)y+=c[E].unit.byteLength;for(let w=0,k=c.length;w<k;w++){const t=c[w],s=t.unit;let r=t.pts;if(null!==v){u[w-1].duration=Math.round((r-v)/a)}else{if(i&&e.isAAC&&(r=m),_=r,!(y>0))return;y+=f;try{p=new Uint8Array(y)}catch(D){return void this.observer.emit(et.ERROR,et.ERROR,{type:it.MUX_ERROR,details:rt.REMUX_ALLOC_ERROR,fatal:!1,bytes:y,reason:`fail allocating audio mdat ${y}`})}if(!d){new DataView(p.buffer).setUint32(0,y),p.set(Ws.types.mdat,4)}}p.set(s,f);const n=s.byteLength;f+=n,u.push(new Js(!0,o,n,0)),v=r}const S=u.length;if(!S)return;const T=u[u.length-1];this.nextAudioPts=m=v+a*T.duration;const L=d?new Uint8Array(0):Ws.moof(e.sequenceNumber++,_/a,Object.assign({},e,{samples:u}));e.samples=[];const b=_/n,A=m/n,R={data1:L,data2:p,startPTS:b,endPTS:A,startDTS:b,endDTS:A,type:"audio",hasAudio:!0,hasVideo:!1,nb:S};return this.isAudioContiguous=!0,console.assert(p.length,"MDAT length must not be zero"),R}remuxEmptyAudio(e,t,i,s){const r=e.inputTimeScale,n=r/(e.samplerate?e.samplerate:r),a=this.nextAudioPts,o=(null!==a?a:s.startDTS*r)+this._initDTS,l=s.endDTS*r+this._initDTS,h=1024*n,d=Math.ceil((l-o)/h),u=Ks.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(dt.warn("[mp4-remuxer]: remux empty Audio"),!u)return void dt.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const c=[];for(let f=0;f<d;f++){const e=o+f*h;c.push({unit:u,pts:e,dts:e})}return e.samples=c,this.remuxAudio(e,t,i,!1)}remuxID3(e,t){const i=e.samples.length;if(!i)return;const s=e.inputTimeScale,r=this._initPTS,n=this._initDTS;for(let o=0;o<i;o++){const i=e.samples[o];i.pts=Zs(i.pts-r,t*s)/s,i.dts=Zs(i.dts-n,t*s)/s}const a=e.samples;return e.samples=[],{samples:a}}remuxText(e,t){const i=e.samples.length;if(!i)return;const s=e.inputTimeScale,r=this._initPTS;for(let a=0;a<i;a++){const i=e.samples[a];i.pts=Zs(i.pts-r,t*s)/s}e.samples.sort(((e,t)=>e.pts-t.pts));const n=e.samples;return e.samples=[],{samples:n}}}function Zs(e,t){let i;if(null===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}class Js{constructor(e,t,i,s){this.duration=t,this.size=i,this.cts=s,this.flags=new er(e)}}class er{constructor(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}}class tr{constructor(){this.emitInitSegment=!1,this.lastEndDTS=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndDTS=null}resetNextTimestamp(){this.lastEndDTS=null}resetInitSegment(e,t,i){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(e),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const s=this.initData=function(e){const t=[],i=bt(e,["moov","trak"]);for(let s=0;s<i.length;s++){const e=i[s],r=bt(e,["tkhd"])[0];if(r){let i=r.data[r.start],s=0===i?12:20;const n=Tt(r,s),a=bt(e,["mdia","mdhd"])[0];if(a){i=a.data[a.start],s=0===i?12:20;const r=Tt(a,s),o=bt(e,["mdia","hdlr"])[0];if(o){const i=St(o.data.subarray(o.start+8,o.start+12)),s={soun:mt.AUDIO,vide:mt.VIDEO}[i];if(s){const i=bt(e,["mdia","minf","stbl","stsd"])[0];let a;i&&(a=St(i.data.subarray(i.start+12,i.start+16))),t[n]={timescale:r,type:s},t[s]={timescale:r,id:n,codec:a}}}}}}return bt(e,["moov","mvex","trex"]).forEach((e=>{const i=Tt(e,4),s=t[i];s&&(s.default={duration:Tt(e,12),flags:Tt(e,20)})})),t}(e);t||(t=sr(s.audio,mt.AUDIO)),i||(i=sr(s.video,mt.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:dt.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r){let{initPTS:n,lastEndDTS:a}=this;const o={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};Number.isFinite(a)||(a=this.lastEndDTS=r||0);const l=t.samples;if(!l||!l.length)return o;const h={initPTS:void 0,timescale:1};let d=this.initData;if(d&&d.length||(this.generateInitSegment(l),d=this.initData),!d||!d.length)return dt.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),o;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1),Number.isFinite(n)||(this.initPTS=h.initPTS=n=ir(d,l,a));const u=function(e,t){let i=0,s=0,r=0;const n=bt(e,["moof","traf"]);for(let a=0;a<n.length;a++){const e=n[a],o=bt(e,["tfhd"])[0],l=t[Tt(o,4)];if(!l)continue;const h=l.default,d=Tt(o,0)|(null==h?void 0:h.flags);let u=null==h?void 0:h.duration;8&d&&(u=Tt(o,2&d?12:8));const c=l.timescale||9e4,f=bt(e,["trun"]);for(let t=0;t<f.length;t++)i=u?u*Tt(f[t],4):Rt(f[t]),l.type===mt.VIDEO?s+=i/c:l.type===mt.AUDIO&&(r+=i/c)}if(0===s&&0===r){const t=At(e);if(null==t?void 0:t.references)return t.references.reduce(((e,t)=>e+t.info.duration||0),0)}return s||r}(l,d),c=a,f=u+c;!function(e,t,i){bt(t,["moof","traf"]).forEach((function(t){bt(t,["tfhd"]).forEach((function(s){const r=Tt(s,4),n=e[r];if(!n)return;const a=n.timescale||9e4;bt(t,["tfdt"]).forEach((function(e){const t=e.data[e.start];let s=Tt(e,4);if(0===t)Lt(e,4,s-i*a);else{s*=Math.pow(2,32),s+=Tt(e,8),s-=i*a,s=Math.max(s,0);const t=Math.floor(s/(yt+1)),r=Math.floor(s%(yt+1));Lt(e,4,t),Lt(e,8,r)}}))}))}))}(d,l,n),u>0?this.lastEndDTS=f:(dt.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const m=!!d.audio,g=!!d.video;let p="";m&&(p+="audio"),g&&(p+="video");const _={data1:l,startPTS:c,startDTS:c,endPTS:f,endDTS:f,type:p,hasAudio:m,hasVideo:g,nb:1,dropped:0};return o.audio="audio"===_.type?_:void 0,o.video="audio"!==_.type?_:void 0,o.text=s,o.id3=i,o.initSegment=h,o}}const ir=(e,t,i)=>function(e,t){return bt(t,["moof","traf"]).reduce(((t,i)=>{const s=bt(i,["tfdt"])[0],r=s.data[s.start],n=bt(i,["tfhd"]).reduce(((t,i)=>{const n=Tt(i,4),a=e[n];if(a){let e=Tt(s,4);1===r&&(e*=Math.pow(2,32),e+=Tt(s,8));const i=e/(a.timescale||9e4);if(isFinite(i)&&(null===t||i<t))return i}return t}),null);return null!==n&&isFinite(n)&&(null===t||n<t)?n:t}),null)||0}(e,t)-i;function sr(e,t){const i=null==e?void 0:e.codec;return i&&i.length>4?i:"hvc1"===i?"hvc1.1.c.L120.90":"av01"===i?"av01.0.04M.08":"avc1"===i||t===mt.VIDEO?"avc1.42e01e":"mp4a.40.5"}class rr{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;return e.length?(i=1===e.length?e[0]:function(e,t){const i=new Uint8Array(t);let s=0;for(let r=0;r<e.length;r++){const t=e[r];i.set(t,s),s+=t.length}return i}(e,t),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}let nr;try{nr=self.performance.now.bind(self.performance)}catch(bn){dt.debug("Unable to use Performance API on this environment"),nr=self.Date.now}const ar=[{demux:Ms,remux:Qs},{demux:Es,remux:tr},{demux:ys,remux:Qs},{demux:Hs,remux:Qs}];let or=1024;ar.forEach((({demux:e})=>{or=Math.max(or,e.minProbeByteLength)}));class lr{constructor(e,t,i,s,r){this.decryptionPromise=null,this.cache=new rr,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.id=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=nr();let n=new Uint8Array(e);const{cache:a,config:o,currentTransmuxState:l,transmuxConfig:h}=this;s&&(this.currentTransmuxState=s);const d=function(e,t){let i=null;e.byteLength>0&&null!=t&&null!=t.key&&null!==t.iv&&null!=t.method&&(i=t);return i}(n,t);if(d&&"AES-128"===d.method){const e=this.getDecrypter();if(!o.enableSoftwareAES)return this.decryptionPromise=e.webCryptoDecrypt(n,d.key.buffer,d.iv.buffer).then((e=>{const t=this.push(e,null,i);return this.decryptionPromise=null,t})),this.decryptionPromise;{const t=e.softwareDecrypt(n,d.key.buffer,d.iv.buffer);if(!t)return r.executeEnd=nr(),hr(i);n=new Uint8Array(t)}}const{contiguous:u,discontinuity:c,trackSwitch:f,accurateTimeOffset:m,timeOffset:g}=s||l,{audioCodec:p,videoCodec:_,defaultInitPts:v,duration:y,initSegmentData:E}=h;if((c||f)&&this.resetInitSegment(E,p,_,y),c&&this.resetInitialTimestamp(v),u||this.resetContiguity(),this.needsProbing(n,c,f)){if(a.dataLength){n=Dt(a.flush(),n)}this.configureTransmuxer(n,h)}const S=this.transmux(n,d,g,m,i),T=this.currentTransmuxState;return T.contiguous=!0,T.discontinuity=!1,T.trackSwitch=!1,r.executeEnd=nr(),S}flush(e){const t=e.transmuxing;t.executeStart=nr();const{decrypter:i,cache:s,currentTransmuxState:r,decryptionPromise:n}=this;if(n)return n.then((()=>this.flush(e)));const a=[],{timeOffset:o}=r;if(i){const t=i.flush();t&&a.push(this.push(t,null,e))}const l=s.dataLength;s.reset();const{demuxer:h,remuxer:d}=this;if(!h||!d)return l>=or&&this.observer.emit(et.ERROR,et.ERROR,{type:it.MEDIA_ERROR,details:rt.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),t.executeEnd=nr(),[hr(e)];const u=h.flush(o);return dr(u)?u.then((t=>(this.flushRemux(a,t,e),a))):(this.flushRemux(a,u,e),a)}flushRemux(e,t,i){const{audioTrack:s,avcTrack:r,id3Track:n,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;dt.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const h=this.remuxer.remux(s,r,n,a,l,o,!0,this.id);e.push({remuxResult:h,chunkMeta:i}),i.transmuxing.executeEnd=nr()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;t&&i&&(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s){const{demuxer:r,remuxer:n}=this;r&&n&&(r.resetInitSegment(t,i,s),n.resetInitSegment(e,t,i))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let n;return n=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,i,s,r):this.transmuxUnencrypted(e,i,s,r),n}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,avcTrack:n,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,n,a,o,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.avcTrack,e.id3Track,e.textTrack,i,s,!1,this.id),chunkMeta:r})))}configureTransmuxer(e,t){const{config:i,observer:s,typeSupported:r,vendor:n}=this,{audioCodec:a,defaultInitPts:o,duration:l,initSegmentData:h,videoCodec:d}=t;let u;for(let p=0,_=ar.length;p<_;p++)if(ar[p].demux.probe(e)){u=ar[p];break}u||(dt.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),u={demux:Es,remux:tr});const c=this.demuxer,f=this.remuxer,m=u.remux,g=u.demux;f&&f instanceof m||(this.remuxer=new m(s,i,r,n)),c&&c instanceof g||(this.demuxer=new g(s,i,r),this.probe=g.probe),this.resetInitSegment(h,a,d,l),this.resetInitialTimestamp(o)}needsProbing(e,t,i){return!this.demuxer||!this.remuxer||t||i}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new qi(this.observer,this.config)),e}}const hr=e=>({remuxResult:{},chunkMeta:e});function dr(e){return"then"in e&&e.then instanceof Function}class ur{constructor(e,t,i,s,r){this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r}}class cr{constructor(e,t,i,s,r){this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r}}const fr=os()||{isTypeSupported:()=>!1};class mr{constructor(e,t,i,s){this.frag=null,this.part=null,this.transmuxer=null,this.hls=e,this.id=t,this.onTransmuxComplete=i,this.onFlush=s;const r=e.config,n=(t,i)=>{(i=i||{}).frag=this.frag,i.id=this.id,e.trigger(t,i)};this.observer=new m.exports.EventEmitter,this.observer.on(et.FRAG_DECRYPTED,n),this.observer.on(et.ERROR,n);const a={mp4:fr.isTypeSupported("video/mp4"),mpeg:fr.isTypeSupported("audio/mpeg"),mp3:fr.isTypeSupported('audio/mp4; codecs="mp3"')},o=navigator.vendor;if(r.enableWorker&&"undefined"!=typeof Worker){let i;dt.log("demuxing in webworker");try{i=this.worker=g(require.resolve("../demux/transmuxer-worker.ts")),this.onwmsg=this.onWorkerMessage.bind(this),i.addEventListener("message",this.onwmsg),i.onerror=t=>{e.trigger(et.ERROR,{type:it.OTHER_ERROR,details:rt.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",error:new Error(`${t.message}  (${t.filename}:${t.lineno})`)})},i.postMessage({cmd:"init",typeSupported:a,vendor:o,id:t,config:JSON.stringify(r)})}catch(bn){dt.warn("Error in worker:",bn),dt.error("Error while initializing DemuxerWorker, fallback to inline"),i&&self.URL.revokeObjectURL(i.objectURL),this.transmuxer=new lr(this.observer,a,r,o,t),this.worker=null}}else this.transmuxer=new lr(this.observer,a,r,o,t)}destroy(){const e=this.worker;if(e)e.removeEventListener("message",this.onwmsg),e.terminate(),this.worker=null;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.observer=null}push(e,t,i,s,r,n,a,o,l,h){l.transmuxing.start=self.performance.now();const{transmuxer:d,worker:u}=this,c=n?n.start:r.start,f=r.decryptdata,m=this.frag,g=!(m&&r.cc===m.cc),p=!(m&&l.level===m.level),_=m?l.sn-m.sn:-1,v=this.part?l.part-this.part.index:1,y=!p&&(1===_||0===_&&1===v),E=self.performance.now();(p||_||0===r.stats.parsing.start)&&(r.stats.parsing.start=E),!n||!v&&y||(n.stats.parsing.start=E);const S=new cr(g,y,o,p,c);if(!y||g){dt.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${g}\n        trackSwitch: ${p}\n        contiguous: ${y}\n        accurateTimeOffset: ${o}\n        timeOffset: ${c}`);const e=new ur(i,s,t,a,h);this.configureTransmuxer(e)}if(this.frag=r,this.part=n,u)u.postMessage({cmd:"demux",data:e,decryptdata:f,chunkMeta:l,state:S},e instanceof ArrayBuffer?[e]:[]);else if(d){const t=d.push(e,f,l,S);dr(t)?t.then((e=>{this.handleTransmuxComplete(e)})):this.handleTransmuxComplete(t)}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t,worker:i}=this;if(i)i.postMessage({cmd:"flush",chunkMeta:e});else if(t){const i=t.flush(e);dr(i)?i.then((t=>{this.handleFlushResult(t,e)})):this.handleFlushResult(i,e)}}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":self.URL.revokeObjectURL(this.worker.objectURL);break;case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data)}}configureTransmuxer(e){const{worker:t,transmuxer:i}=this;t?t.postMessage({cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class gr{constructor(e,t,i,s){this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=s}destroy(){this.hls=this.fragmentTracker=this.media=null}poll(e){var t;const{config:i,media:s,stalled:r}=this,{currentTime:n,seeking:a}=s,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,n!==e){if(this.moved=!0,null!==r){if(this.stallReported){const e=self.performance.now()-r;dt.warn(`playback not stuck anymore @${n}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((l||o)&&(this.stalled=null),s.paused||s.ended||0===s.playbackRate||!Oi.getBuffered(s).length)return;const h=Oi.bufferInfo(s,n,0),d=h.len>0,u=h.nextStart||0;if(!d&&!u)return;if(a){const e=h.len>2,t=!u||u-n>2&&!this.fragmentTracker.getPartialFragment(n);if(e||t)return;this.moved=!1}if(!this.moved&&null!==this.stalled){const e=Math.max(u,h.start||0)-n,i=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,s=(null==(t=null==i?void 0:i.details)?void 0:t.live)?2*i.details.targetduration:2;if(e>0&&e<=s)return void this._trySkipBufferHole(null)}const c=self.performance.now();if(null===r)return void(this.stalled=c);const f=c-r;!a&&f>=250&&this._reportStall(h.len);const m=Oi.bufferInfo(s,n,i.maxBufferHole);this._tryFixBufferStall(m,f)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:s,media:r}=this,n=r.currentTime,a=s.getPartialFragment(n);if(a){if(this._trySkipBufferHole(a))return}e.len>i.maxBufferHole&&t>1e3*i.highBufferWatchdogPeriod&&(dt.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:s}=this;s||(this.stallReported=!0,dt.warn(`Playback stalling at @${i.currentTime} due to low buffer (buffer=${e})`),t.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_STALLED_ERROR,fatal:!1,buffer:e}))}_trySkipBufferHole(e){const{config:t,hls:i,media:s}=this,r=s.currentTime;let n=0;const a=Oi.getBuffered(s);for(let o=0;o<a.length;o++){const l=a.start(o);if(r+t.maxBufferHole>=n&&r<l){const t=Math.max(l+.05,s.currentTime+.1);return dt.warn(`skipping hole, adjusting currentTime from ${r} to ${t}`),this.moved=!0,this.stalled=null,s.currentTime=t,e&&i.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:`fragment loaded with buffer holes, seeking from ${r} to ${t}`,frag:e}),t}n=a.end(o)}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i}=this,s=i.currentTime,r=(this.nudgeRetry||0)+1;if(this.nudgeRetry=r,r<e.nudgeMaxRetry){const n=s+r*e.nudgeOffset;dt.warn(`Nudging 'currentTime' from ${s} to ${n}`),i.currentTime=n,t.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_NUDGE_ON_STALL,fatal:!1})}else dt.error(`Playhead still not moving while enough data buffered @${s} after ${e.nudgeMaxRetry} nudges`),t.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_STALLED_ERROR,fatal:!0})}}class pr extends class extends class{constructor(){this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}{constructor(e,t,i){super(),this.fragPrevious=null,this.fragCurrent=null,this.transmuxer=null,this._state=Yi,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.loadedmetadata=!1,this.fragLoadError=0,this.retryDate=0,this.levels=null,this.levelLastLoaded=null,this.startFragRequested=!1,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.logPrefix=i,this.log=dt.log.bind(dt,`${i}:`),this.warn=dt.warn.bind(dt,`${i}:`),this.hls=e,this.fragmentLoader=new Vi(e.config),this.fragmentTracker=t,this.config=e.config,this.decrypter=new qi(e,e.config),e.on(et.KEY_LOADED,this.onKeyLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort();const e=this.fragCurrent;e&&this.fragmentTracker.removeFragment(e),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=Yi}_streamEnded(e,t){const{fragCurrent:i,fragmentTracker:s}=this;if(!t.live&&i&&i.sn===t.endSN&&!e.nextStart){const e=s.getState(i);return e===Di.PARTIAL||e===Di.OK}return!1}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===Yi&&this.startLoad(s.startPosition)}onMediaDetaching(){const e=this.media;(null==e?void 0:e.ended)&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:s,state:r}=this,n=i?i.currentTime:0,a=Oi.bufferInfo(s||i,n,e.maxBufferHole);if(this.log(`media seeking to ${Number.isFinite(n)?n.toFixed(3):n}, state: ${r}`),r===rs)this.resetLoadingState();else if(t&&!a.len){const i=e.maxFragLookUpTolerance,s=t.start-i,r=n>t.start+t.duration+i;(n<s||r)&&(r&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.loader.abort()),this.resetLoadingState())}i&&(this.lastCurrentTime=n),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=n),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onKeyLoaded(e,t){if(this.state!==Zi||t.frag!==this.fragCurrent||!this.levels)return;this.state=Qi;const i=this.levels[t.frag.level].details;i&&this.loadFragment(t.frag,i,t.frag.start)}onHandlerDestroying(){this.stopLoad(),super.onHandlerDestroying()}onHandlerDestroyed(){this.state=Yi,this.hls.off(et.KEY_LOADED,this.onKeyLoaded,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadKey(e,t){this.log(`Loading key for ${e.sn} of [${t.startSN}-${t.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state=Zi,this.fragCurrent=e,this.hls.trigger(et.KEY_LOADING,{frag:e})}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){this._doFragLoad(e,t,i,(t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(!t)return;this.fragLoadError=0;const i=this.state;if(!this.fragContextChanged(e))return"payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(et.FRAG_LOADED,t),this.state===ss)?(this.fragmentTracker.backtrack(e,t),void this.resetFragmentLoading(e)):void this._handleFragmentLoadComplete(t);(i===Ji||i===ss||!this.fragCurrent&&i===ts)&&(this.fragmentTracker.removeFragment(e),this.state=Qi)})).catch((t=>{this.warn(t),this.resetFragmentLoading(e)}))}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.fragLoadError=0,this.hls.trigger(et.BUFFER_FLUSHING,s)}_loadInitSegment(e){this._doFragLoad(e).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{const{hls:i}=this,{payload:s}=t,r=e.decryptdata;if(s&&s.byteLength>0&&r&&r.key&&r.iv&&"AES-128"===r.method){const n=self.performance.now();return this.decrypter.webCryptoDecrypt(new Uint8Array(s),r.key.buffer,r.iv.buffer).then((s=>{const r=self.performance.now();return i.trigger(et.FRAG_DECRYPTED,{frag:e,payload:s,stats:{tstart:n,tdecrypt:r}}),t.payload=s,t}))}return t})).then((t=>{const{fragCurrent:i,hls:s,levels:r}=this;if(!r)throw new Error("init load aborted, missing levels");const n=r[e.level].details;console.assert(n,"Level details are defined when init segment is loaded");const a=e.stats;this.state=Qi,this.fragLoadError=0,e.data=new Uint8Array(t.payload),a.parsing.start=a.buffering.start=self.performance.now(),a.parsing.end=a.buffering.end=self.performance.now(),t.frag===i&&s.trigger(et.FRAG_BUFFERED,{stats:a,frag:i,part:null,id:e.type}),this.tick()})).catch((t=>{this.warn(t),this.resetFragmentLoading(e)}))}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.level!==t.level||e.sn!==t.sn||e.urlId!==t.urlId}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level} ${Xi(Oi.getBuffered(i))}`),this.state=Qi,this.tick()}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,n=!r||0===r.length||r.some((e=>!e)),a=new Pi(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!n);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){if(!this.levels)throw new Error("frag load aborted, missing levels");if(i=Math.max(e.start,i||0),this.config.lowLatencyMode&&t){const r=t.partList;if(r&&s){i>e.end&&t.fragmentHint&&(e=t.fragmentHint);const n=this.getNextPart(r,e,i);if(n>-1){const a=r[n];return this.log(`Loading part sn: ${e.sn} p: ${a.index} cc: ${e.cc} of playlist [${t.startSN}-${t.endSN}] parts [0-${n}-${r.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=a.start+a.duration,this.state=Ji,this.hls.trigger(et.FRAG_LOADING,{frag:e,part:r[n],targetBufferTime:i}),this.doFragPartsLoad(e,r,n,s).catch((e=>this.handleFragLoadError(e)))}if(!e.url||this.loadedEndOfParts(r,i))return Promise.resolve(null)}}return this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${t?"of ["+t.startSN+"-"+t.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),Number.isFinite(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Ji,this.hls.trigger(et.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragmentLoader.load(e,s).catch((e=>this.handleFragLoadError(e)))}doFragPartsLoad(e,t,i,s){return new Promise(((r,n)=>{const a=[],o=i=>{const l=t[i];this.fragmentLoader.loadPart(e,l,s).then((s=>{a[l.index]=s;const n=s.part;this.hls.trigger(et.FRAG_LOADED,s);const h=t[i+1];if(!h||h.fragment!==e)return r({frag:e,part:n,partsLoaded:a});o(i+1)})).catch(n)};o(i)}))}handleFragLoadError({data:e}){return e&&e.details===rt.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(et.ERROR,e),null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==ts)return void(this.fragCurrent||(this.state=Qi));const{frag:i,part:s,level:r}=t,n=self.performance.now();i.stats.parsing.end=n,s&&(s.stats.parsing.end=n),this.updateLevelTiming(i,s,r,e.partial)}getCurrentContext(e){const{levels:t}=this,{level:i,sn:s,part:r}=e;if(!t||!t[i])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${i}. The current chunk will not be buffered.`),null;const n=t[i],a=r>-1?function(e,t,i){if(!e||!e.details)return null;const s=e.details.partList;if(s)for(let r=s.length;r--;){const e=s[r];if(e.index===i&&e.fragment.sn===t)return e}return null}(n,s,r):null,o=a?a.fragment:function(e,t,i){if(!e||!e.details)return null;const s=e.details;let r=s.fragments[t-s.startSN];return r||(r=s.fragmentHint,r&&r.sn===t?r:t<s.startSN&&i&&i.sn===t?i:null)}(n,s,this.fragCurrent);return o?{frag:o,part:a,level:n}:null}bufferFragmentData(e,t,i,s){if(!e||this.state!==ts)return;const{data1:r,data2:n}=e;let a=r;if(r&&n&&(a=Dt(r,n)),!a||!a.length)return;const o={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:a};this.hls.trigger(et.BUFFER_APPENDING,o),e.dropped&&e.independent&&!i&&this.flushBufferGap(t)}flushBufferGap(e){const t=this.media;if(!t)return;if(!Oi.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const i=t.currentTime,s=Oi.bufferInfo(t,i,0),r=e.duration,n=Math.min(2*this.config.maxFragLookUpTolerance,.25*r),a=Math.max(Math.min(e.start-n,s.end-n),i+n);e.start-a>n&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){const{config:i}=this,s=this.getLoadPosition();if(!Number.isFinite(s))return null;const r=Oi.bufferInfo(e,s,i.maxBufferHole);if(0===r.len&&void 0!==r.nextStart){const n=this.fragmentTracker.getBufferedFrag(s,t);if(n&&r.nextStart<n.end)return Oi.bufferInfo(e,s,Math.max(r.nextStart,i.maxBufferHole))}return r}getMaxBufferLength(e){const{config:t}=this;let i;return i=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i&&(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0)}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,n=i[0].start;let a;if(t.live){const n=r.initialLiveManifestSize;if(s<n)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${n})`),null;t.PTSKnown||this.startFragRequested||-1!==this.startPosition||(a=this.getInitialLiveFragment(t,i),this.startPosition=a?this.hls.liveSyncPosition||a.start:e)}else e<=n&&(a=i[0]);if(!a){const i=r.lowLatencyMode?t.partEnd:t.fragmentEnd;a=this.getFragmentAtPosition(e,i,t)}return!(null==a?void 0:a.initSegment)||(null==a?void 0:a.initSegment.data)||this.bitrateTest||(a=a.initSegment),a}getNextPart(e,t,i){let s=-1,r=!1,n=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(n=n&&!o.independent,s>-1&&i<o.start)break;const l=o.loaded;!l&&(r||o.independent||n)&&o.fragment===t&&(s=a),r=l}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=function(e,t,i){if(null===t||!Array.isArray(e)||!e.length||!Number.isFinite(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;i=i||0;for(let s=0;s<e.length;++s){const r=e[s];if(Gi(t,i,r))return r}return null}(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const n=t[r-e.startSN];i.cc===n.cc&&(s=n,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=function(e,t){return Ni(e,(e=>e.cc<t?1:e.cc>t?-1:0))}(t,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(s=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s,fragPrevious:r}=this;let{fragments:n,endSN:a}=i;const{fragmentHint:o}=i,l=s.maxFragLookUpTolerance,h=!!(s.lowLatencyMode&&i.partList&&o);let d;if(h&&o&&!this.bitrateTest&&(n=n.concat(o),a=o.sn),e<t){d=function(e,t,i=0,s=0){let r=null;if(e?r=t[e.sn-t[0].sn+1]||null:0===i&&0===t[0].start&&(r=t[0]),r&&0===Ui(i,s,r))return r;return Ni(t,Ui.bind(null,i,s))||r}(r,n,e,e>t-l?0:l)}else d=n[n.length-1];if(d){const e=d.sn-i.startSN,t=r&&d.level===r.level,s=n[e+1];if(this.fragmentTracker.getState(d)===Di.BACKTRACKED){d=null;let t=e;for(;n[t]&&this.fragmentTracker.getState(n[t])===Di.BACKTRACKED;)d=r?n[t--]:n[--t];d||(d=s)}else r&&d.sn===r.sn&&!h&&t&&(d.sn<a&&this.fragmentTracker.getState(s)!==Di.OK?(this.log(`SN ${d.sn} just loaded, load next one: ${s.sn}`),d=s):d=null)}return d}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,n=e.fragments[0].start,a=e.edge,o=r>=n-t.maxFragLookUpTolerance&&r<=a;if(null!==s&&i.duration>s&&(r<s||!o)){const n=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!o&&i.readyState<4||r<a-n)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(e,t){const{levels:i,levelLastLoaded:s,fragPrevious:r}=this,n=null!==s?i[s]:null,a=e.fragments.length;if(!a)return this.warn("No fragments in live playlist"),0;const o=e.fragments[0].start,l=!t,h=e.alignedSliding&&Number.isFinite(o);if(l||!h&&!o){Bi(r,n,e);const i=e.fragments[0].start;return this.log(`Live playlist sliding: ${i.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${r?r.sn:"na"} fragments: ${a}`),i}return o}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),-1===i||-1===this.lastCurrentTime){const s=e.startTimeOffset;Number.isFinite(s)?(i=t+s,s<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${s} found in playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part"+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&this.fragContextChanged(e)||(this.state=Qi)}onFragmentOrKeyLoadError(e,t){if(t.fatal)return;const i=t.frag;if(!i||i.type!==e)return;const s=this.fragCurrent;console.assert(s&&i.sn===s.sn&&i.level===s.level&&i.urlId===s.urlId,"Frag load error must match current frag to retry");const r=this.config;if(this.fragLoadError+1<=r.fragLoadingMaxRetry){if(this.resetLiveStartWhenNotLoaded(i.level))return;const t=Math.min(Math.pow(2,this.fragLoadError)*r.fragLoadingRetryDelay,r.fragLoadingMaxRetryTimeout);this.warn(`Fragment ${i.sn} of ${e} ${i.level} failed to load, retrying in ${t}ms`),this.retryDate=self.performance.now()+t,this.fragLoadError++,this.state=es}else t.levelRetry?(e===zt.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=Qi):(dt.error(`${t.details} reaches max retry, redispatch as fatal ...`),t.fatal=!0,this.hls.stopLoad(),this.state=ns)}afterBufferFlushed(e,t,i){if(!e)return;const s=Oi.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===rs&&this.resetLoadingState()}resetLoadingState(){this.fragCurrent=null,this.fragPrevious=null,this.state=Qi}resetLiveStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=this.levels?this.levels[e].details:null;if(null==t?void 0:t.live)return this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState(),!0;this.nextLoadPosition=this.startPosition}return!1}updateLevelTiming(e,t,i,s){const r=i.details;console.assert(!!r,"level.details must be defined");Object.keys(e.elementaryStreams).reduce(((t,n)=>{const a=e.elementaryStreams[n];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${n} duration reliably (${o}) resetting transmuxer to fallback to playlist timing`),this.resetTransmuxer(),t||!1;const l=s?0:Ti(r,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(et.LEVEL_PTS_UPDATED,{details:r,level:i,drift:l,type:n,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t}),!1)?(this.state=is,this.hls.trigger(et.FRAG_PARSED,{frag:e,part:t})):this.resetLoadingState()}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}{constructor(e,t){super(e,t,"[stream-controller]"),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.stalled=!1,this.couldBacktrack=!1,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(et.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(et.MANIFEST_LOADING,this.onManifestLoading,this),e.on(et.MANIFEST_PARSED,this.onManifestParsed,this),e.on(et.LEVEL_LOADING,this.onLevelLoading,this),e.on(et.LEVEL_LOADED,this.onLevelLoaded,this),e.on(et.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(et.ERROR,this.onError,this),e.on(et.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(et.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(et.BUFFER_CREATED,this.onBufferCreated,this),e.on(et.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(et.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(et.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(et.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(et.MANIFEST_LOADING,this.onManifestLoading,this),e.off(et.MANIFEST_PARSED,this.onManifestParsed,this),e.off(et.LEVEL_LOADED,this.onLevelLoaded,this),e.off(et.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(et.ERROR,this.onError,this),e.off(et.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(et.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(et.BUFFER_CREATED,this.onBufferCreated,this),e.off(et.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(et.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(et.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),this.onMediaDetaching()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){let e=i.startLevel;console.info("ana startLevel",e),-1===e&&(i.config.testBandwidth?(e=0,this.bitrateTest=!0):e=i.nextAutoLevel),this.level=i.nextLoadLevel=e,this.loadedmetadata=!1}t>0&&-1===e&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=Qi,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=Yi}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){var e,t;switch(this.state){case Qi:this.doTickIdle();break;case as:{const{levels:t,level:i}=this,s=null==(e=null==t?void 0:t[i])?void 0:e.details;if(s&&(!s.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(s))break;this.state=Qi;break}break}case es:{const e=self.performance.now(),i=this.retryDate;(!i||e>=i||(null==(t=this.media)?void 0:t.seeking))&&(this.log("retryDate reached, switch back to IDLE state"),this.state=Qi)}}this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){var e,t;const{hls:i,levelLastLoaded:s,levels:r,media:n}=this,{config:a,nextLoadLevel:o}=i;if(null===s||!n&&(this.startFragRequested||!a.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;if(!r||!r[o])return;const l=r[o];this.level=i.nextLoadLevel=o;const h=l.details;if(!h||this.state===as||h.live&&this.levelLastLoaded!==o)return void(this.state=as);const d=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:n,zt.MAIN);if(null===d)return;if(d.len>=this.getMaxBufferLength(l.maxBitrate))return;if(this._streamEnded(d,h)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(et.BUFFER_EOS,e),void(this.state=rs)}const u=d.end;let c=this.getNextFragment(u,h);if(this.couldBacktrack&&!this.fragPrevious&&c&&"initSegment"!==c.sn){const e=c.sn-h.startSN;e>1&&(c=h.fragments[e-1],this.fragmentTracker.removeFragment(c))}if(c&&this.fragmentTracker.getState(c)===Di.OK&&this.nextLoadPosition>u){const e=this.audioOnly&&!this.altAudio?mt.AUDIO:mt.VIDEO;this.afterBufferFlushed(n,e,zt.MAIN),c=this.getNextFragment(this.nextLoadPosition,h)}c&&(!c.initSegment||c.initSegment.data||this.bitrateTest||(c=c.initSegment),"identity"!==(null==(e=c.decryptdata)?void 0:e.keyFormat)||(null==(t=c.decryptdata)?void 0:t.key)?this.loadFragment(c,h,u):this.loadKey(c,h))}loadFragment(e,t,i){var s;let r=this.fragmentTracker.getState(e);if(this.fragCurrent=e,r===Di.BACKTRACKED){const t=this.fragmentTracker.getBacktrackData(e);if(t)return this._handleFragmentLoadProgress(t),void this._handleFragmentLoadComplete(t);r=Di.NOT_LOADED}r===Di.NOT_LOADED||r===Di.PARTIAL?"initSegment"===e.sn?this._loadInitSegment(e):this.bitrateTest?(e.bitrateTest=!0,this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):r===Di.APPENDING?this.reduceMaxBufferLength(e.duration)&&this.fragmentTracker.removeFragment(e):0===(null==(s=this.media)?void 0:s.buffered.length)&&this.fragmentTracker.removeAllFragments()}getAppendedFrag(e){const t=this.fragmentTracker.getAppendedFrag(e,zt.MAIN);return t&&"fragment"in t?t.fragment:t}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,zt.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null==t?void 0:t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);if(s&&s.start>1&&this.flushMainBuffer(0,s.start-1),!t.paused&&e){const t=e[this.hls.nextLoadLevel],s=this.fragLastKbps;i=s&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*s)+1:0}else i=0;const r=this.getBufferedFrag(t.currentTime+i);if(r){const e=this.followingBufferedFrag(r);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,i=e.duration,s=Math.max(r.end,t+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,.5*i),.75*i));this.flushMainBuffer(s,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;this.fragCurrent=null,(null==e?void 0:e.loader)&&e.loader.abort(),this.state===Zi&&(this.state=Qi),this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new gr(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;Number.isFinite(t)&&this.log(`Media seeked to ${t.toFixed(3)}`),this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(et.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=this.stalled=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null}onManifestParsed(e,t){console.info("ana onManifestParsed",t);let i,s=!1,r=!1;t.levels.forEach((e=>{i=e.audioCodec,i&&(-1!==i.indexOf("mp4a.40.2")&&(s=!0),-1!==i.indexOf("mp4a.40.5")&&(r=!0))})),this.audioCodecSwitch=s&&r&&!function(){var e;const t=ls();return"function"==typeof(null==(e=null==t?void 0:t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==Qi)return;const s=i[t.level];(!s.details||s.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(s.details))&&(this.state=as)}onLevelLoaded(e,t){var i;const{levels:s}=this,r=t.level,n=t.details,a=n.totalduration;if(!s)return void this.warn(`Levels were reset while loading level ${r}`);this.log(`Level ${r} loaded [${n.startSN},${n.endSN}], cc [${n.startCC}, ${n.endCC}] duration:${a}`);const o=this.fragCurrent;!o||this.state!==Ji&&this.state!==es||o.level!==t.level&&o.loader&&(this.state=Qi,o.loader.abort());const l=s[r];let h=0;if(n.live||(null==(i=l.details)?void 0:i.live)){if(n.fragments[0]||(n.deltaUpdateFailed=!0),n.deltaUpdateFailed)return;h=this.alignPlaylists(n,l.details)}if(l.details=n,this.levelLastLoaded=r,this.hls.trigger(et.LEVEL_UPDATED,{details:n,level:r}),this.state===as){if(this.waitForCdnTuneIn(n))return;this.state=Qi}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,h),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{levels:n}=this;if(!n)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const a=n[i.level],o=a.details;if(!o)return void this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`);const l=a.videoCodec,h=o.PTSKnown||!o.live,d=null==(t=i.initSegment)?void 0:t.data,u=this._getAudioCodec(a),c=this.transmuxer=this.transmuxer||new mr(this.hls,zt.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=s?s.index:-1,m=-1!==f,g=new Pi(i.level,i.sn,i.stats.chunkCount,r.byteLength,f,m),p=this.initPTS[i.cc];c.push(r,d,u,l,i,s,o.totalduration,h,g,p)}onAudioTrackSwitching(e,t){const i=this.altAudio,s=!!t.url,r=t.id;if(!s){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;(null==e?void 0:e.loader)&&(this.log("Switching to main audio track, cancel main fragment load"),e.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;i&&e.trigger(et.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),e.trigger(et.AUDIO_TRACK_SWITCHED,{id:r})}}onAudioTrackSwitched(e,t){const i=t.id,s=!!this.hls.audioTracks[i].url;if(s){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=s,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,n=!1;for(const a in i){const e=i[a];if("main"===e.id){if(r=a,s=e,"video"===a){const e=i[a];e&&(this.videoBuffer=e.buffer)}}else n=!0}n&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i&&i.type!==zt.MAIN)return;if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===is&&(this.state=Qi));const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(e,t){switch(t.details){case rt.FRAG_LOAD_ERROR:case rt.FRAG_LOAD_TIMEOUT:case rt.KEY_LOAD_ERROR:case rt.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(zt.MAIN,t);break;case rt.LEVEL_LOAD_ERROR:case rt.LEVEL_LOAD_TIMEOUT:this.state!==ns&&(t.fatal?(this.warn(`${t.details}`),this.state=ns):t.levelRetry||this.state!==as||(this.state=Qi));break;case rt.BUFFER_FULL_ERROR:if("main"===t.parent&&(this.state===ts||this.state===is)){let e=!0;const t=this.getFwdBufferInfo(this.media,zt.MAIN);t&&t.len>.5&&(e=!this.reduceMaxBufferLength(t.len)),e&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}}}checkBuffer(){const{media:e,gapController:t}=this;if(!e||!t||!e.readyState)return;const i=Oi.getBuffered(e);!this.loadedmetadata&&i.length?(this.loadedmetadata=!0,this.seekToStartPos()):t.poll(this.lastCurrentTime),this.lastCurrentTime=e.currentTime}onFragLoadEmergencyAborted(){this.state=Qi,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==mt.AUDIO||this.audioOnly&&!this.altAudio){const e=(t===mt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,zt.MAIN)}}onLevelsUpdated(e,t){this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this,t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking)return void dt.log(`could not seek to ${i}, already seeking at ${t}`);const s=Oi.getBuffered(e),r=(s.length?s.start(0):0)-i;r>0&&(r<this.config.maxBufferHole||r<this.config.maxFragLookUpTolerance)&&(dt.log(`adjusting start position by ${r} to match buffer start`),i+=r,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e){this._doFragLoad(e).then((t=>{const{hls:i}=this;if(!t||i.nextLoadLevel||this.fragContextChanged(e))return;this.fragLoadError=0,this.state=Qi,this.startFragRequested=!1,this.bitrateTest=!1;const s=e.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),i.trigger(et.FRAG_LOADED,t)}))}_handleTransmuxComplete(e){var t;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:n}=e,a=this.getCurrentContext(n);if(!a)return this.warn(`The loading context changed while buffering fragment ${n.sn} of level ${n.level}. This chunk will not be buffered.`),void this.resetLiveStartWhenNotLoaded(n.level);const{frag:o,part:l,level:h}=a,{video:d,text:u,id3:c,initSegment:f}=r,m=this.altAudio?void 0:r.audio;if(!this.fragContextChanged(o)){if(this.state=ts,f){f.tracks&&(this._bufferInitSegment(h,f.tracks,o,n),s.trigger(et.FRAG_PARSING_INIT_SEGMENT,{frag:o,id:i,tracks:f.tracks}));const e=f.initPTS,t=f.timescale;Number.isFinite(e)&&(this.initPTS[o.cc]=e,s.trigger(et.INIT_PTS_FOUND,{frag:o,id:i,initPTS:e,timescale:t}))}if(d&&!1!==r.independent){if(h.details){const{startPTS:e,endPTS:t,startDTS:i,endDTS:s}=d;if(l)l.elementaryStreams[d.type]={startPTS:e,endPTS:t,startDTS:i,endDTS:s};else if(d.firstKeyFrame&&d.independent&&(this.couldBacktrack=!0),d.dropped&&d.independent){if(this.getLoadPosition()+this.config.maxBufferHole<e)return void this.backtrack(o);o.setElementaryStreamInfo(d.type,o.start,t,o.start,s,!0)}o.setElementaryStreamInfo(d.type,e,t,i,s),this.bufferFragmentData(d,o,l,n)}}else if(!1===r.independent)return void this.backtrack(o);if(m){const{startPTS:e,endPTS:t,startDTS:i,endDTS:s}=m;l&&(l.elementaryStreams[mt.AUDIO]={startPTS:e,endPTS:t,startDTS:i,endDTS:s}),o.setElementaryStreamInfo(mt.AUDIO,e,t,i,s),this.bufferFragmentData(m,o,l,n)}if(null==(t=null==c?void 0:c.samples)?void 0:t.length){const e={frag:o,id:i,samples:c.samples};s.trigger(et.FRAG_PARSING_METADATA,e)}if(u){const e={frag:o,id:i,samples:u.samples};s.trigger(et.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,i,s){if(this.state!==ts)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:n,audiovideo:a}=t;if(r){let t=e.audioCodec;const i=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==r.metadata.channelCount&&-1===i.indexOf("firefox")&&(t="mp4a.40.5")),-1!==i.indexOf("android")&&"audio/mpeg"!==r.container&&(t="mp4a.40.2",this.log(`Android: force audio codec to ${t}`)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),r.levelCodec=t,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${r.codec}]`)}n&&(n.levelCodec=e.videoCodec,n.id="main",this.log(`Init video buffer, container:${n.container}, codecs[level/parsed]=[${e.videoCodec||""}/${n.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.attrs.CODECS||""}/${a.codec}]`),this.hls.trigger(et.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{const r=t[e].initSegment;(null==r?void 0:r.byteLength)&&this.hls.trigger(et.BUFFER_APPENDING,{type:e,data:r,frag:i,part:null,chunkMeta:s,parent:i.type})})),this.tick()}backtrack(e){this.couldBacktrack=!0,this.resetTransmuxer(),this.flushBufferGap(e);const t=this.fragmentTracker.backtrack(e);this.fragPrevious=null,this.nextLoadPosition=e.start,t?this.resetFragmentLoading(e):this.state=ss}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const i=e.currentTime;if(Oi.isBuffered(e,i)?t=this.getAppendedFrag(i):Oi.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){const e=this.fragPlaying,i=t.level;e&&t.sn===e.sn&&e.level===i&&t.urlId===e.urlId||(this.hls.trigger(et.FRAG_CHANGED,{frag:t}),e&&e.level===i||this.hls.trigger(et.LEVEL_SWITCHED,{level:i}),this.fragPlaying=t)}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentLevel(){const e=this.media;if(e){const t=this.getAppendedFrag(e.currentTime);if(t)return t.level}return-1}get nextBufferedFrag(){const e=this.media;if(e){const t=this.getAppendedFrag(e.currentTime);return this.followingBufferedFrag(t)}return null}get forceStartLoad(){return this._forceStartLoad}}class _r{constructor(e,t=0,i=0){this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class vr{constructor(e,t,i){this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new _r(e),this.fast_=new _r(t)}update(e,t){const{slow_:i,fast_:s}=this;this.slow_.halfLife!==e&&(this.slow_=new _r(e,i.getEstimate(),i.getTotalWeight())),this.fast_.halfLife!==t&&(this.fast_=new _r(t,s.getEstimate(),s.getTotalWeight()))}sample(e,t){const i=(e=Math.max(e,this.minDelayMs_))/1e3,s=8*t/i;this.fast_.sample(i,s),this.slow_.sample(i,s)}canEstimate(){const e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}destroy(){}}class yr{constructor(e){this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t){const i=this.queues[t];i.push(e),1===i.length&&this.buffers[t]&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise((e=>{t=e})),s={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,e),i}executeNext(e){const{buffers:t,queues:i}=this,s=t[e],r=i[e];if(r.length){const t=r[0];try{t.execute()}catch(n){dt.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),t.onError(n),s&&s.updating||(r.shift(),this.executeNext(e))}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const Er=os(),Sr=/([ha]vc.)(?:\.[^.,]+)+/;var Tr,Lr;(Lr=Tr||(Tr={}))[Lr.ERROR=0]="ERROR",Lr[Lr.TEXT=1]="TEXT",Lr[Lr.WARNING=2]="WARNING",Lr[Lr.INFO=2]="INFO",Lr[Lr.DEBUG=3]="DEBUG",Lr[Lr.DATA=3]="DATA";new(function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function i(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const i=t.toLowerCase();return!!~e.indexOf(i)&&i}function s(e){return i(t,e)}function r(e,...t){let i=1;for(;i<arguments.length;i++){const t=arguments[i];for(const i in t)e[i]=t[i]}return e}function n(t,n,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let h="",d=!1,u=t,c=n,f=a,m=null,g="",p=!0,_="auto",v="start",y=50,E="middle",S=50,T="middle";Object.defineProperty(o,"id",r({},l,{get:function(){return h},set:function(e){h=""+e}})),Object.defineProperty(o,"pauseOnExit",r({},l,{get:function(){return d},set:function(e){d=!!e}})),Object.defineProperty(o,"startTime",r({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",r({},l,{get:function(){return c},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");c=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",r({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",r({},l,{get:function(){return m},set:function(e){m=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",r({},l,{get:function(){return g},set:function(t){const s=function(t){return i(e,t)}(t);if(!1===s)throw new SyntaxError("An invalid or illegal string was specified.");g=s,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",r({},l,{get:function(){return p},set:function(e){p=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",r({},l,{get:function(){return _},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");_=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",r({},l,{get:function(){return v},set:function(e){const t=s(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",r({},l,{get:function(){return y},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",r({},l,{get:function(){return E},set:function(e){const t=s(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");E=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",r({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",r({},l,{get:function(){return T},set:function(e){const t=s(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),o.displayState=void 0}return n.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},n}())(0,0,"").align;const br=function(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()};function Ar(e,t,i){return br(e.toString())+br(t.toString())+br(i)}class Rr{constructor(e){this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(et.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(et.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(et.MANIFEST_PARSED,this.onManifestParsed,this),e.on(et.BUFFER_CODECS,this.onBufferCodecs,this),e.on(et.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(et.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(et.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(et.MANIFEST_PARSED,this.onManifestParsed,this),e.off(et.BUFFER_CODECS,this.onBufferCodecs,this),e.off(et.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){Rr.isLevelAllowed(t.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(t.droppedLevel)}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const e=this.hls.levels;if(e.length){const t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter(((t,i)=>Rr.isLevelAllowed(i,this.restrictedLevels)&&i<=e));return this.clientRect=null,Rr.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*Rr.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*Rr.contentScaleFactor}static get contentScaleFactor(){let e=1;try{e=self.devicePixelRatio}catch(t){}return e}static isLevelAllowed(e,t=[]){return-1===t.indexOf(e)}static getMaxLevelByMediaSize(e,t,i){if(!e||!e.length)return-1;let s=e.length-1;for(let a=0;a<e.length;a+=1){const o=e[a];if((o.width>=t||o.height>=i)&&(r=o,!(n=e[a+1])||r.width!==n.width||r.height!==n.height)){s=a;break}}var r,n;return s}}var Dr,wr;(wr=Dr||(Dr={})).WIDEVINE="com.widevine.alpha",wr.PLAYREADY="com.microsoft.playready";const kr="undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null,Cr=/^age:\s*[\d.]+\s*$/m;class Ir{constructor(e){this.config=null,this.callbacks=null,this.loader=null,this.xhrSetup=e?e.xhrSetup:null,this.stats=new ft,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(null==(e=this.callbacks)?void 0:e.onAbort)&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.retryDelay=t.retryDelay,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0;const r=this.xhrSetup;try{if(r)try{r(i,t.url)}catch(n){i.open("GET",t.url,!0),r(i,t.url)}i.readyState||i.open("GET",t.url,!0)}catch(n){return void this.callbacks.onError({code:i.status,text:n.message},t,i)}t.rangeEnd&&i.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),i.onreadystatechange=this.readystatechange.bind(this),i.onprogress=this.loadprogress.bind(this),i.responseType=t.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),e.timeout),i.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2)if(self.clearTimeout(this.requestTimeout),0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start)),4===s){t.onreadystatechange=null,t.onprogress=null;const s=t.status;if(s>=200&&s<300){let s,r;if(i.loading.end=Math.max(self.performance.now(),i.loading.first),"arraybuffer"===e.responseType?(s=t.response,r=s.byteLength):(s=t.responseText,r=s.length),i.loaded=i.total=r,!this.callbacks)return;const n=this.callbacks.onProgress;if(n&&n(i,e,s,t),!this.callbacks)return;const a={url:t.responseURL,data:s};this.callbacks.onSuccess(a,i,e,t)}else i.retry>=r.maxRetry||s>=400&&s<499?(dt.error(`${s} while loading ${e.url}`),this.callbacks.onError({code:s,text:t.statusText},e,t)):(dt.warn(`${s} while loading ${e.url}, retrying in ${this.retryDelay}...`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,r.maxRetryDelay),i.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.timeout)}loadtimeout(){dt.warn(`timeout while loading ${this.context.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Cr.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}}class xr{constructor(e){this.config=null,this.callbacks=null,this.loader=null,this.fetchSetup=e.fetchSetup||Or,this.controller=new self.AbortController,this.stats=new ft}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){const e=this.response;e&&e.ok||(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(null==(e=this.callbacks)?void 0:e.onAbort)&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=function(e,t){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:t};e.rangeEnd&&(i.headers=new self.Headers({Range:"bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)}));return i}(e,this.controller.signal),n=i.onProgress,a="arraybuffer"===e.responseType,o=a?"byteLength":"length";this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(s,e,this.response)}),t.timeout),self.fetch(this.request).then((i=>{if(this.response=this.loader=i,!i.ok){const{status:e,statusText:t}=i;throw new Pr(t||"fetch, bad network response",e,i)}return s.loading.first=Math.max(self.performance.now(),s.loading.start),s.total=parseInt(i.headers.get("Content-Length")||"0"),n&&Number.isFinite(t.highWaterMark)?this.loadProgressively(i,s,e,t.highWaterMark,n):a?i.arrayBuffer():i.text()})).then((r=>{const{response:a}=this;self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first),s.loaded=s.total=r[o];const l={url:a.url,data:r};n&&!Number.isFinite(t.highWaterMark)&&n(s,e,r,a),i.onSuccess(l,s,e,a)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const r=t.code||0;i.onError({code:r,text:t.message},e,t.details)}))}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}loadProgressively(e,t,i,s=0,r){const n=new rr,a=e.body.getReader(),o=()=>a.read().then((a=>{if(a.done)return n.dataLength&&r(t,i,n.flush(),e),Promise.resolve(new ArrayBuffer(0));const l=a.value,h=l.length;return t.loaded+=h,h<s||n.dataLength?(n.push(l),n.dataLength>=s&&r(t,i,n.flush(),e)):r(t,i,l,e),o()})).catch((()=>Promise.reject()));return o()}}function Or(e,t){return new self.Request(e.url,t)}class Pr extends Error{constructor(e,t,i){super(e),this.code=t,this.details=i}}const Mr=/\s/,Fr={newCue(e,t,i,s){const r=[];let n,a,o,l,h;const d=self.VTTCue||self.TextTrackCue;for(let u=0;u<s.rows.length;u++)if(n=s.rows[u],o=!0,l=0,h="",!n.isEmpty()){for(let e=0;e<n.chars.length;e++)Mr.test(n.chars[e].uchar)&&o?l++:(h+=n.chars[e].uchar,o=!1);n.cueStartTime=t,t===i&&(i+=1e-4),l>=16?l--:l++;const s=h.trim().replace(/<br(?: \/)?>/gi,"\n"),c=Ar(t,i,s);e&&e.cues&&e.cues.getCueById(c)||(a=new d(t,i,s),a.id=c,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),r.push(a))}return e&&r.length&&(r.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),r.forEach((t=>function(e,t){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(bn){dt.debug(`[texttrack-utils]: ${bn}`);const s=new self.TextTrackCue(t.startTime,t.endTime,t.text);s.id=t.id,e.addCue(s)}"disabled"===i&&(e.mode=i)}(e,t)))),r}},Br=l(o({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Ir,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(e){this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.hls=e;const t=e.config;this.bwEstimator=new vr(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(et.FRAG_LOADING,this.onFragLoading,this),e.on(et.FRAG_LOADED,this.onFragLoaded,this),e.on(et.FRAG_BUFFERED,this.onFragBuffered,this),e.on(et.LEVEL_LOADED,this.onLevelLoaded,this),e.on(et.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(et.FRAG_LOADING,this.onFragLoading,this),e.off(et.FRAG_LOADED,this.onFragLoaded,this),e.off(et.FRAG_BUFFERED,this.onFragBuffered,this),e.off(et.LEVEL_LOADED,this.onLevelLoaded,this),e.off(et.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null}onFragLoading(e,t){var i;const s=t.frag;s.type===zt.MAIN&&(this.timer||(this.fragCurrent=s,this.partCurrent=null!=(i=t.part)?i:null,this.timer=self.setInterval(this.onCheck,100)))}onLevelLoaded(e,t){const i=this.hls.config;t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}_abandonRulesCheck(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{autoLevelEnabled:s,config:r,media:n}=i;if(!e||!n)return;const a=t?t.stats:e.stats,o=t?t.duration:e.duration;if(a.aborted)return dt.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),void(this._nextAutoLevel=-1);if(!s||n.paused||!n.playbackRate||!n.readyState)return;const l=performance.now()-a.loading.start,h=Math.abs(n.playbackRate);if(l<=500*o/h)return;const{levels:d,minAutoLevel:u}=i,c=d[e.level],f=a.total||Math.max(a.loaded,Math.round(o*c.maxBitrate/8)),m=Math.max(1,a.bwEstimate?a.bwEstimate/8:1e3*a.loaded/l),g=(f-a.loaded)/m,p=n.currentTime,_=(Oi.bufferInfo(n,p,r.maxBufferHole).end-p)/h;if(_>=2*o/h||g<=_)return;let v,y=Number.POSITIVE_INFINITY;for(v=e.level-1;v>u;v--){if(y=o*d[v].maxBitrate/(6.4*m),y<_)break}if(y>=g)return;const E=this.bwEstimator.getEstimate();dt.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly and will cause an underbuffer; aborting and switching to level ${v}\n      Current BW estimate: ${Number.isFinite(E)?(E/1024).toFixed(3):"Unknown"} Kb/s\n      Estimated load time for current fragment: ${g.toFixed(3)} s\n      Estimated load time for the next fragment: ${y.toFixed(3)} s\n      Time to underbuffer: ${_.toFixed(3)} s`),i.nextLoadLevel=v,this.bwEstimator.sample(l,a.loaded),this.clearTimer(),e.loader&&(this.fragCurrent=this.partCurrent=null,e.loader.abort()),i.trigger(et.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:a})}onFragLoaded(e,{frag:t,part:i}){if(t.type===zt.MAIN&&Number.isFinite(t.sn)){const e=i?i.stats:t.stats,s=i?i.duration:t.duration;if(this.clearTimer(),this.lastLoadedFragLevel=t.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const i=this.hls.levels[t.level],r=(i.loaded?i.loaded.bytes:0)+e.loaded,n=(i.loaded?i.loaded.duration:0)+s;i.loaded={bytes:r,duration:n},i.realBitrate=Math.round(8*r/n)}if(t.bitrateTest){const s={stats:e,frag:t,part:i,id:t.type};this.onFragBuffered(et.FRAG_BUFFERED,s),t.bitrateTest=!1}}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s?s.stats:i.stats;if(r.aborted)return;if(i.type!==zt.MAIN||"initSegment"===i.sn)return;const n=r.parsing.end-r.loading.start;this.bwEstimator.sample(n,r.loaded),r.bwEstimate=this.bwEstimator.getEstimate(),i.bitrateTest?this.bitrateTestDelay=n/1e3:this.bitrateTestDelay=0}onError(e,t){switch(t.details){case rt.FRAG_LOAD_ERROR:case rt.FRAG_LOAD_TIMEOUT:this.clearTimer()}}clearTimer(){self.clearInterval(this.timer),this.timer=void 0}get nextAutoLevel(){const e=this._nextAutoLevel,t=this.bwEstimator;if(!(-1===e||t&&t.canEstimate()))return e;let i=this.getNextABRAutoLevel();return-1!==e&&(i=Math.min(e,i)),i}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:n,media:a}=i,o=t?t.duration:e?e.duration:0,l=a?a.currentTime:0,h=a&&0!==a.playbackRate?Math.abs(a.playbackRate):1,d=this.bwEstimator?this.bwEstimator.getEstimate():r.abrEwmaDefaultEstimate,u=(Oi.bufferInfo(a,l,r.maxBufferHole).end-l)/h;let c=this.findBestLevel(d,n,s,u,r.abrBandWidthFactor,r.abrBandWidthUpFactor);if(c>=0)return c;dt.trace((u?"rebuffering expected":"buffer is empty")+", finding optimal quality level");let f=o?Math.min(o,r.maxStarvationDelay):r.maxStarvationDelay,m=r.abrBandWidthFactor,g=r.abrBandWidthUpFactor;if(!u){const e=this.bitrateTestDelay;if(e){f=(o?Math.min(o,r.maxLoadingDelay):r.maxLoadingDelay)-e,dt.trace(`bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),m=g=1}}return c=this.findBestLevel(d,n,s,u+f,m,g),Math.max(c,0)}findBestLevel(e,t,i,s,r,n){var a;const{fragCurrent:o,partCurrent:l,lastLoadedFragLevel:h}=this,{levels:d}=this.hls,u=d[h],c=!!(null==(a=null==u?void 0:u.details)?void 0:a.live),f=null==u?void 0:u.codecSet,m=l?l.duration:o?o.duration:0;for(let g=i;g>=t;g--){const t=d[g];if(!t||f&&t.codecSet!==f)continue;const i=t.details,a=(l?null==i?void 0:i.partTarget:null==i?void 0:i.averagetargetduration)||m;let o;o=g<=h?r*e:n*e;const u=d[g].maxBitrate,p=u*a/o;if(dt.trace(`level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: ${g}/${Math.round(o)}/${u}/${a}/${s}/${p}`),o>u&&(!p||c&&!this.bitrateTestDelay||p<s))return g}return-1}set nextAutoLevel(e){this._nextAutoLevel=e}},bufferController:class{constructor(e){this.details=null,this._objectUrl=null,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this._onMediaSourceOpen=()=>{const{hls:e,media:t,mediaSource:i}=this;dt.log("[buffer-controller]: Media source opened"),t&&(this.updateMediaElementDuration(),e.trigger(et.MEDIA_ATTACHED,{media:t})),i&&i.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{dt.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=()=>{dt.log("[buffer-controller]: Media source ended")},this.hls=e,this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null}registerListeners(){const{hls:e}=this;e.on(et.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(et.MANIFEST_PARSED,this.onManifestParsed,this),e.on(et.BUFFER_RESET,this.onBufferReset,this),e.on(et.BUFFER_APPENDING,this.onBufferAppending,this),e.on(et.BUFFER_CODECS,this.onBufferCodecs,this),e.on(et.BUFFER_EOS,this.onBufferEos,this),e.on(et.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(et.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(et.FRAG_PARSED,this.onFragParsed,this),e.on(et.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(et.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(et.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(et.MANIFEST_PARSED,this.onManifestParsed,this),e.off(et.BUFFER_RESET,this.onBufferReset,this),e.off(et.BUFFER_APPENDING,this.onBufferAppending,this),e.off(et.BUFFER_CODECS,this.onBufferCodecs,this),e.off(et.BUFFER_EOS,this.onBufferEos,this),e.off(et.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(et.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(et.FRAG_PARSED,this.onFragParsed,this),e.off(et.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new yr(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.details=null,dt.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media;if(i&&Er){const e=this.mediaSource=new Er;e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),i.src=self.URL.createObjectURL(e),this._objectUrl=i.src}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(dt.log("[buffer-controller]: media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(bn){dt.warn(`[buffer-controller]: onMediaDetaching: ${bn.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),e&&(i&&self.URL.revokeObjectURL(i),e.src===i?(e.removeAttribute("src"),e.load()):dt.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(et.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];try{t&&(this.removeBufferListeners(e),this.mediaSource&&this.mediaSource.removeSourceBuffer(t),this.sourceBuffer[e]=void 0)}catch(bn){dt.warn(`[buffer-controller]: Failed to reset the ${e} buffer`,bn)}})),this._initSourceBuffer()}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length;Object.keys(t).forEach((e=>{if(i){const i=this.tracks[e];if(i&&"function"==typeof i.buffer.changeType){const{codec:s,levelCodec:r,container:n}=t[e];if((i.levelCodec||i.codec).replace(Sr,"$1")!==(r||s).replace(Sr,"$1")){const t=`${n};codecs=${r||s}`;this.appendChangeType(e,t)}}}else this.pendingTracks[e]=t[e]})),i||(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())}appendChangeType(e,t){const{operationQueue:i}=this,s={execute:()=>{const s=this.sourceBuffer[e];s&&(dt.log(`[buffer-controller]: changing ${e} sourceBuffer type to ${t}`),s.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{dt.warn(`[buffer-controller]: Failed to change ${e} SourceBuffer type`,t)}};i.append(s,e)}onBufferAppending(e,t){const{hls:i,operationQueue:s,tracks:r}=this,{data:n,type:a,frag:o,part:l,chunkMeta:h}=t,d=h.buffering[a],u=self.performance.now();d.start=u;const c=o.stats.buffering,f=l?l.stats.buffering:null;0===c.start&&(c.start=u),f&&0===f.start&&(f.start=u);const m=r.audio,g="audio"===a&&1===h.id&&"audio/mpeg"===(null==m?void 0:m.container),p={execute:()=>{if(d.executeStart=self.performance.now(),g){const e=this.sourceBuffer[a];if(e){const t=o.start-e.timestampOffset;Math.abs(t)>=.1&&(dt.log(`[buffer-controller]: Updating audio SourceBuffer timestampOffset to ${o.start} (delta: ${t}) sn: ${o.sn})`),e.timestampOffset=o.start)}}this.appendExecutor(n,a)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();d.executeEnd=d.end=e,0===c.first&&(c.first=e),f&&0===f.first&&(f.first=e);const{sourceBuffer:t}=this,i={};for(const s in t)i[s]=Oi.getBuffered(t[s]);this.appendError=0,this.hls.trigger(et.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:h,parent:o.type,timeRanges:i})},onError:e=>{dt.error(`[buffer-controller]: Error encountered while trying to append to the ${a} SourceBuffer`,e);const t={type:it.MEDIA_ERROR,parent:o.type,details:rt.BUFFER_APPEND_ERROR,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?t.details=rt.BUFFER_FULL_ERROR:(this.appendError++,t.details=rt.BUFFER_APPEND_ERROR,this.appendError>i.config.appendErrorMaxRetry&&(dt.error(`[buffer-controller]: Failed ${i.config.appendErrorMaxRetry} times to append segment in sourceBuffer`),t.fatal=!0)),i.trigger(et.ERROR,t)}};s.append(p,a)}onBufferFlushing(e,t){const{operationQueue:i}=this,s=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(et.BUFFER_FLUSHED,{type:e})},onError:t=>{dt.warn(`[buffer-controller]: Failed to remove from ${e} SourceBuffer`,t)}});t.type?i.append(s(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{i.append(s(e),e)}))}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],n=s?s.elementaryStreams:i.elementaryStreams;n[mt.AUDIOVIDEO]?r.push("audiovideo"):(n[mt.AUDIO]&&r.push("audio"),n[mt.VIDEO]&&r.push("video"));0===r.length&&dt.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers((()=>{const e=self.performance.now();i.stats.buffering.end=e,s&&(s.stats.buffering.end=e);const t=s?s.stats:i.stats;this.hls.trigger(et.FRAG_BUFFERED,{frag:i,part:s,stats:t,id:i.type})}),r)}onFragChanged(e,t){this.flushBackBuffer()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,i)=>{const s=this.sourceBuffer[i];return t.type&&t.type!==i||s&&!s.ended&&(s.ended=!0,dt.log(`[buffer-controller]: ${i} sourceBuffer now EOS`)),e&&!(s&&!s.ended)}),!0)&&this.blockBuffers((()=>{const{mediaSource:e}=this;e&&"open"===e.readyState&&e.endOfStream()}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}flushBackBuffer(){const{hls:e,details:t,media:i,sourceBuffer:s}=this;if(!i||null===t)return;const r=this.getSourceBufferTypes();if(!r.length)return;const n=t.live&&null!==e.config.liveBackBufferLength?e.config.liveBackBufferLength:e.config.backBufferLength;if(!Number.isFinite(n)||n<0)return;const a=i.currentTime,o=t.levelTargetDuration,l=Math.max(n,o),h=Math.floor(a/o)*o-l;r.forEach((i=>{const r=s[i];if(r){const s=Oi.getBuffered(r);s.length>0&&h>s.start(0)&&(e.trigger(et.BACK_BUFFER_REACHED,{bufferEnd:h}),t.live&&e.trigger(et.LIVE_BACK_BUFFER_REACHED,{bufferEnd:h}),e.trigger(et.BUFFER_FLUSHING,{startOffset:0,endOffset:h,type:i}))}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:i,mediaSource:s}=this,r=e.fragments[0].start+e.totalduration,n=i.duration,a=Number.isFinite(s.duration)?s.duration:0;e.live&&t.config.liveDurationInfinity?(dt.log("[buffer-controller]: Media Source duration is set to Infinity"),s.duration=1/0,this.updateSeekableRange(e)):(r>a&&r>n||!Number.isFinite(n))&&(dt.log(`[buffer-controller]: Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&(null==t?void 0:t.setLiveSeekableRange)){const s=Math.max(0,i[0].start),r=Math.max(s,s+e.totalduration);t.setLiveSeekableRange(s,r)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&!e||2===s){this.createSourceBuffers(i),this.pendingTracks={};const e=this.getSourceBufferTypes();if(0===e.length)return void this.hls.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});e.forEach((e=>{t.executeNext(e)}))}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");let s=0;for(const r in e)if(!t[r]){const n=e[r];if(!n)throw Error(`source buffer exists for track ${r}, however track does not`);const a=n.levelCodec||n.codec,o=`${n.container};codecs=${a}`;dt.log(`[buffer-controller]: creating sourceBuffer(${o})`);try{const e=t[r]=i.addSourceBuffer(o),l=r;this.addBufferListener(l,"updatestart",this._onSBUpdateStart),this.addBufferListener(l,"updateend",this._onSBUpdateEnd),this.addBufferListener(l,"error",this._onSBUpdateError),this.tracks[r]={buffer:e,codec:a,container:n.container,levelCodec:n.levelCodec,id:n.id},s++}catch(bn){dt.error(`[buffer-controller]: error while trying to add sourceBuffer: ${bn.message}`),this.hls.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:bn,mimeType:o})}}s&&this.hls.trigger(et.BUFFER_CREATED,{tracks:this.tracks})}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){const{operationQueue:t}=this;t.current(e).onComplete(),t.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){dt.error(`[buffer-controller]: ${e} SourceBuffer error`,t),this.hls.trigger(et.ERROR,{type:it.MEDIA_ERROR,details:rt.BUFFER_APPENDING_ERROR,fatal:!1});const i=this.operationQueue.current(e);i&&i.onError(t)}removeExecutor(e,t,i){const{media:s,mediaSource:r,operationQueue:n,sourceBuffer:a}=this,o=a[e];if(!s||!r||!o)return dt.warn(`[buffer-controller]: Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void n.shiftAndExecuteNext(e);const l=Number.isFinite(s.duration)?s.duration:1/0,h=Number.isFinite(r.duration)?r.duration:1/0,d=Math.max(0,t),u=Math.min(i,l,h);u>d?(dt.log(`[buffer-controller]: Removing [${d},${u}] from the ${e} SourceBuffer`),console.assert(!o.updating,`${e} sourceBuffer must not be updating`),o.remove(d,u)):n.shiftAndExecuteNext(e)}appendExecutor(e,t){const{operationQueue:i,sourceBuffer:s}=this,r=s[t];if(!r)return dt.warn(`[buffer-controller]: Attempting to append to the ${t} SourceBuffer, but it does not exist`),void i.shiftAndExecuteNext(t);r.ended=!1,console.assert(!r.updating,`${t} sourceBuffer must not be updating`),r.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return dt.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve(e);const{operationQueue:i}=this,s=t.map((e=>i.appendBlocker(e)));Promise.all(s).then((()=>{e(),t.forEach((e=>{const t=this.sourceBuffer[e];t&&t.updating||i.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const s=this.sourceBuffer[e];if(!s)return;const r=i.bind(this,e);this.listeners[e].push({event:t,listener:r}),s.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}},capLevelController:Rr,fpsController:class{constructor(e){this.isVideoPlaybackQualityAvailable=!1,this.media=null,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(et.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(et.MEDIA_ATTACHING,this.onMediaAttaching)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const e=s-this.lastTime,r=i-this.lastDroppedFrames,n=t-this.lastDecodedFrames,a=1e3*r/e,o=this.hls;if(o.trigger(et.FPS_DROP,{currentDropped:r,currentDecoded:n,totalDroppedFrames:i}),a>0&&r>o.config.fpsDroppedMonitoringThreshold*n){let e=o.currentLevel;dt.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(et.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:kr,testBandwidth:!0,progressive:!1,lowLatencyMode:!0},{cueHandler:Fr,enableCEA708Captions:!1,enableWebVTT:!1,enableIMSC1:!1,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{subtitleStreamController:void 0,subtitleTrackController:void 0,timelineController:void 0,audioStreamController:void 0,audioTrackController:void 0,emeController:void 0});function Nr(e){const t=e.loader;if(t!==xr&&t!==Ir)dt.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(e.loader=xr,e.progressive=!0,e.enableSoftwareAES=!0,dt.log("[config]: Progressive streaming enabled, using FetchLoader"))}}class Ur{constructor(e={}){this._emitter=new m.exports.EventEmitter,this._media=null,this.url=null;const t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return Object.assign({},e,t)}(Ur.DefaultConfig,e);this.userConfig=e,function(e){if(self.console&&!0===e||"object"==typeof e){ht(e,"debug","log","info","warn","error");try{lt.log()}catch(t){lt=ot}}else lt=ot}(t.debug),this._autoLevelCapping=-1,t.progressive&&Nr(t);const{abrController:i,bufferController:s,capLevelController:r,fpsController:n}=t,a=this.abrController=new i(this),o=this.bufferController=new s(this),l=this.capLevelController=new r(this),h=new n(this),d=new qt(this),u=new Xt(this),c=new fi(this),f=this.levelController=new Ri(this),g=new ki(this),p=this.streamController=new pr(this,g);l.setStreamController(p),h.setStreamController(p);const _=[f,p];this.networkControllers=_;const v=[d,u,a,o,l,h,c,g];this.audioTrackController=this.createController(t.audioTrackController,null,_),this.createController(t.audioStreamController,g,_),this.subtitleTrackController=this.createController(t.subtitleTrackController,null,_),this.createController(t.subtitleStreamController,g,_),this.createController(t.timelineController,null,v),this.emeController=this.createController(t.emeController,null,v),this.latencyController=this.createController(mi,null,v),this.coreComponents=v}static get version(){return 0}static isSupported(){return function(){const e=os();if(!e)return!1;const t=ls(),i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),s=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!s}()}static get Events(){return et}static get ErrorTypes(){return it}static get ErrorDetails(){return rt}static get DefaultConfig(){return Ur.defaultConfig?Ur.defaultConfig:Br}static set DefaultConfig(e){Ur.defaultConfig=e}createController(e,t,i){if(e){const s=t?new e(this,t):new e(this);return i&&i.push(s),s}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){dt.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),this.trigger(et.ERROR,{type:it.OTHER_ERROR,details:rt.INTERNAL_EXCEPTION,fatal:!1,event:e,error:i})}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){dt.log("destroy"),this.trigger(et.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0}attachMedia(e){dt.log("attachMedia"),this._media=e,this.trigger(et.MEDIA_ATTACHING,{media:e})}detachMedia(){dt.log("detachMedia"),this.trigger(et.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,s=this.url=f.exports.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});dt.log(`loadSource:${s}`),t&&i&&i!==s&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(t)),this.trigger(et.MANIFEST_LOADING,{url:e})}startLoad(e=-1){dt.log(`startLoad(${e})`),this.networkControllers.forEach((t=>{t.startLoad(e)}))}stopLoad(){dt.log("stopLoad"),this.networkControllers.forEach((e=>{e.stopLoad()}))}swapAudioCodec(){dt.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){dt.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e,t=0){this.levelController.removeLevel(e,t)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){dt.log(`set currentLevel:${e}`),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){dt.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){dt.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){dt.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){return this.levelController.startLevel}set startLevel(e){dt.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(dt.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e)}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t}=this;let i;return i=-1===t&&e&&e.length?e.length-1:t,i}get nextAutoLevel(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)}set nextAutoLevel(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}class Gr extends H{constructor(e,t="flv",i){super(e,i),V.info(`[vlog-${this.constructor.name}]`,`创建 ${t} player`),this.type=t}load(e,t=!1){if(!this.checkUrl(e,t))return;this.nPlayer&&this.recordPlayStatus(e),this.createInstance({type:this.type,isLive:"live"===this.options.type,enableWorker:!0,url:e},{})&&this.nPlayer.on(Je.Events.METADATA_ARRIVED,(()=>{this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}})),this.registerFlvListeners(),this.nPlayer.on(Je.Events.METADATA_ARRIVED,(()=>{this.setUrl(e)})),this.nPlayer.attachMediaElement(this.video),this.nPlayer.load()}reload(){this.load(this.cacheUrl||this.url,!0)}createInstance(e,t){var i;if("flv"===this.type&&!Je.isSupported())throw V.error(`[vlog-${this.constructor.name}]`,"flv not supported!"),Error("flv not supported!");const s=!!this.nPlayer;return null==(i=this.nPlayer)||i.destroy(),this.nPlayer=Je.createPlayer(e,t),s}registerFlvListeners(){this.nPlayer.on(Je.Events.ERROR,((e,...t)=>{var i;V.error("[vlog - event ERROR]",e,t),e===Je.ErrorTypes.NETWORK_ERROR&&(t[0]===Je.ErrorDetails.NETWORK_STATUS_CODE_INVALID&&404===t[1].code||t[0]===Je.ErrorDetails.NETWORK_TIMEOUT||void 0===t[1].code)&&(null==(i=this.context)||i.emit(P.LINE_RELOADING,this.url))})),this.nPlayer.on(Je.Events.LOADING_COMPLETE,(e=>{var t;V.info("[vlog - flv.js event LOADING_COMPLETE]",e),null==(t=this.context)||t.emit(P.LINE_RELOADING,this.url)}))}}Gr.Events=Je.Events;class $r extends H{constructor(e,t){super(e,t),V.info(`[vlog-${this.constructor.name}]`,"创建 HlsPlayer")}load(e,t=!1){this.checkUrl(e,t)&&(this.nPlayer&&this.recordPlayStatus(e),this.createHlsInstance().then((t=>{t&&(this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}),this.registerHlsListeners(),this.nPlayer.on(Ur.Events.MANIFEST_LOADED,(()=>{this.setUrl(e)})),this.nPlayer.loadSource(e),this.nPlayer.attachMedia(this.video)})))}reload(){this.load(this.cacheUrl||this.url,!0)}async createHlsInstance(){if(!Ur.isSupported())throw V.error(`[vlog-${this.constructor.name}]`,"hls not supported"),Error("hls not supported");let e=await this.destroyInstance();return this.nPlayer=new Ur({debug:!0,levelLoadingMaxRetry:-1,fLoader:window.peer5&&window.peer5.HlsJsFragmentLoader,pLoader:window.peer5&&window.peer5.HlsJsPlaylistLoader}),e}destroyInstance(){return new Promise((e=>{this.nPlayer?(this.nPlayer.once(Ur.Events.MEDIA_DETACHED,(()=>{e(!0)})),this.nPlayer.destroy()):e(!1)}))}registerHlsListeners(){this.nPlayer.on(Ur.Events.ERROR,((e,t)=>{var i;V.error("[vlog - event ERROR]",e,t);let{details:s,type:r}=t;r===Ur.ErrorTypes.NETWORK_ERROR&&(s!==Ur.ErrorDetails.MANIFEST_LOAD_ERROR&&s!==Ur.ErrorDetails.MANIFEST_LOAD_TIMEOUT&&s!==Ur.ErrorDetails.LEVEL_LOAD_ERROR&&s!==Ur.ErrorDetails.LEVEL_LOAD_TIMEOUT||null==(i=this.context)||i.emit(P.LINE_RELOADING,this.url))}))}}function Vr(e){var t;let{scheduleOption:i,type:s,liveOption:r}=e,{playerData:n}=i;if("live"===s){let e=r.type;if(e&&"auto"!==e)return e;return 1==+n.live_type?w.Hls:Je.isSupported()?w.Flv:w.Hls}return(null==(t=n.default_server)?void 0:t.mp4_domainnames)?w.Native:function(e){let{scheduleOption:t}=e;return!(null==t?void 0:t.enable)&&t.debugUrl&&t.isNativePlayer?w.Native:w.Hls}(e)}$r.Events=Ur.Events;class Hr{constructor(e){this.store=e,this.e={error:this._onError.bind(this),timeout:this._onTimeout.bind(this),load:this._onLoad.bind(this),loadend:this._onLoadend.bind(this)};let t=new XMLHttpRequest;"ie"!==v.browser&&(t.responseType="json",t.timeout=5e3),t.onerror=this.e.error,t.ontimeout=this.e.timeout,t.onload=this.e.load,t.onloadend=this.e.loadend,this.xhr=t}_onError(e){this.onError&&this.onError(e.target),this.onError=null}_onTimeout(e){this.onTimeout&&this.onTimeout(e.target),this.onTimeout=null}_onLoad(e){if(!e.target)return void this._onError(e);let t=e.target.response;if("ie"===v.browser&&t&&"string"==typeof t)try{t=JSON.parse(t)}catch(r){}let{code:i,data:s}=t;200==+i?(this.onLoad&&this.onLoad(s),this.onLoad=null):this._onError(e)}_onLoadend(e){this.onLoadend&&this.onLoadend(e.target),this.onLoadend=null}fire(e,t={},i="POST"){if(!this.xhr)return;v.isIOS&&v.isUC&&(i="GET");let s=new FormData;if(this.store&&(s.set(A,this.store.getKV(A)),s.set(L,this.store.getKV(L)),s.set(b,this.store.getKV(b)),s.set(R,this.store.getKV(R)),s.set(D,this.store.getKV(D))),Object.keys(t).forEach((e=>{s.set(e,t[e])})),"POST"===i)this.xhr.open(i,e),this.xhr.send(s);else if("GET"===i){let t={};s.forEach(((e,i)=>{t[i]=e}));let r=p.stringify(t);r&&(e+=`?${r}`),this.xhr.open(i,e),this.xhr.send()}}destroy(){this.xhr&&(this.xhr.onerror=null,this.xhr.onload=null,this.xhr.onloadend=null,this.xhr.ontimeout=null,this.xhr=null,this.onLoad=null,this.onLoadend=null,this.onTimeout=null,this.onError=null)}}const Kr={timeWait:5e3,timeLazy:15e3,timesReached:6,timesMax:-1,isInterval:!0};class zr{constructor(e=Kr){this.times=0,this.timer=0,this.executing=!1;let t=Object.assign({},Kr,e);V.info("[vlog - config]",t),this.timeWait=t.timeWait,this.timeLazy=t.timeLazy,this.timesReached=t.timesReached,this.timesMax=t.timesMax,this.isInterval=t.isInterval}setCallback(e){return this.fn=e,this}setIsInterval(e){return this.isInterval=e,this}setTimeWait(e){this.isInterval?clearInterval(this.timer):clearTimeout(this.timer),this.timeWait=e}checkTimesReached(){return-1===this.timesMax?(this.timeWait!==this.timeLazy&&this.times>=this.timesReached&&(V.warn("[vlog]","Interval Reach the top, set lazy"),this.setTimeWait(this.timeLazy)),!1):this.times>=this.timesMax&&(this.destroy(),V.warn("[vlog]","Interval Reach the top, stopped"),!0)}execute(){if(this.isInterval)this.timer=window.setInterval((()=>{this.checkTimesReached()||(this.fn(),this.times+=1)}),this.timeWait);else{if(this.checkTimesReached())return;this.timer=window.setTimeout(this.fn,this.timeWait),this.times+=1}this.executing=!0}destroy(){this.isInterval?clearInterval(this.timer):clearTimeout(this.timer),this.times=0,this.executing=!1}}const Wr=class extends class{constructor(){this._emitter=new d.exports.EventEmitter}emit(e,t){return this._emitter.emit(e,t)}listenerCount(e){return this._emitter.listenerCount(e)}listeners(e){return this._emitter.listeners(e)}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}}{constructor(e){super(),this.plugins={},this.isFullscreen=!1,this.enterFullscreen=()=>Promise.resolve(void 0),this.exitFullscreen=()=>Promise.resolve(void 0),this.toggleFullscreen=()=>Promise.resolve(void 0),this.switch=()=>{},this.addBarrage=()=>{},this.options=(new T).merge(e),function(e){if(self.console&&!0===e||"object"==typeof e){$(e,F.Debug,F.Log,F.Info,F.Warn,F.Error);try{G.log()}catch(t){G=U}}else G=U}(this.options.debug),this.root=E("#"+e.videoNode),this.registerListeners(),this.createPlayer(),this.applyPlugins()}static use(e){const t=e.pluginName;return Wr.plugins.some((t=>t.ctor===e))?Wr:null==t?(console.warn(`plugin: ${e.name} - ${t} can not be used`),Wr):(Wr.plugins.push({name:t,ctor:e}),Wr)}registerListeners(){this.on(P.SCHEDULER_COMPLETE,(e=>{V.info(`[vlog-${this.constructor.name}]`,"SCHEDULER COMPLETE"),this.load(e)})),this.on(P.LINE_CHANGING,(e=>{V.info(`[vlog-${this.constructor.name}]`,"LINE CHANGING"),this.load(e)})),this.on(P.LINE_CHANGED,(()=>{V.info(`[vlog-${this.constructor.name}]`,"LINE CHANGED"),this.intervalLoader&&this.intervalLoader.destroy()})),this.on(P.LINE_RELOADING,(e=>{V.info(`[vlog-${this.constructor.name}]`,"LINE RELOADING"),"live"===this.options.type&&this.reload()}))}createPlayer(){switch(this.playerType=Vr(this.options),this.playerType){case"flv":this.vPlayer=new Gr(this.options,"flv",this);break;case"hls":Ur.isSupported()?this.vPlayer=new $r(this.options,this):this.vPlayer=new Gr(this.options,"native",this);break;case"native":this.vPlayer=new Gr(this.options,"native",this);break;default:throw Error("未提供支持的播放器类型")}this.video=this.vPlayer.video}applyPlugins(){Wr.plugins.forEach((e=>{const t=e.ctor;"function"==typeof t&&(this.plugins[e.name]=new t(this))}))}load(e){this.vPlayer.load(e)}reload(){this.intervalLoader||(this.intervalLoader=new zr({isInterval:!1}),this.intervalLoader.setCallback((()=>{this.vPlayer.reload()}))),this.intervalLoader.execute()}play(){return this.video.play()}pause(){this.video.pause()}get isPaused(){return this.video.paused}set autoplay(e){this.video.autoplay=e}get autoplay(){return this.video.autoplay}get buffered(){return this.video.buffered}get bufferedMax(){let e=this.video.buffered;return e.length?e.end(e.length-1):0}get cdnName(){return""}get controls(){return this.video.controls}get crossOrigin(){return this.video.crossOrigin}get currentTime(){return this.video.currentTime}get defaultMuted(){return this.video.defaultMuted}get duration(){return this.video.duration}get isEnded(){return this.video.ended}getEstimateNetSpeed(){return 0}get loop(){return this.video.loop}get muted(){return this.video.muted}get networkState(){return this.video.networkState}get playbackRate(){return this.video.playbackRate}get played(){return this.video.played}get preload(){return this.video.preload}get readyState(){return this.video.readyState}get seekable(){return this.video.seekable}get isSeeking(){return this.video.seeking}get volume(){return this.video.volume}set controls(e){this.video.controls=e}set crossOrigin(e){this.video.crossOrigin=e}set currentTime(e){this.video.currentTime=e}set defaultMuted(e){this.video.defaultMuted=e}set loop(e){this.video.loop=e}set muted(e){this.video.muted=e}set playbackRate(e){this.video.playbackRate=e}set preload(e){this.video.preload=e}set volume(e){this.video.volume=e}static probe(){const e=document.createElement("video"),t=window.MediaSource||window.WebKitMediaSource;function i(i){return t&&!t.isTypeSupported?e.canPlayType(i):t&&t.isTypeSupported(i)}return l(o({},v),{H264:e.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"'),WebM_VP8:e.canPlayType('video/webm; codecs="vp8.0, vorbis"'),MSE_H264:i('video/mp4; codecs="avc1.4d401e"'),MSE_WebM_VP9:i('video/webm; codecs="vp9"'),WebSocket:!!window.WebSocket})}static async createInstance(e,t,i){try{!function(e){const t={appId:["string"],accountId:["string","number"],token:["string"],videoNode:["string"],type:["string"]};for(let i of Object.getOwnPropertyNames(t)){if(!e.hasOwnProperty(i))throw Error(`参数缺失，请确认提供 ${i}`);{let s=t[i],r=typeof e[i];if(!s.includes(r))throw Error(`参数类型错误，${i} 必须是 ${s.join()} 类型`)}}if("live"===e.type){if(!e.liveOption)throw Error("直播需提供参数 liveOption");if(!e.liveOption.roomId)throw Error("直播配置 liveOption 缺少参数 roomId")}else{if(!e.vodOption)throw Error("点播需提供参数 vodOption");if(!e.vodOption.recordId)throw Error("点播配置 vodOption 缺少参数 recordId")}}(e);let{scheduleOption:i}=e;if(Vr(e)===w.Hls&&Ur.isSupported()){let{peer5Option:t}=e,i=(null==t?void 0:t.enable)?t.customerId:"";if(i)try{await S("script-peer5",`https://api.peer5.com/peer5.js?id=${i}`),await S("script-peer5-hls","https://api.peer5.com/peer5.hlsjs.loader.js")}catch(bn){V.error("VhPlayer.createInstance","peer5 sdk load error: "+bn.message)}}let s=new Wr(e);return window.vp=s,t&&t(s),s}catch(bn){i&&i({code:500,message:bn.message})}}};let jr=Wr;jr.plugins=[],jr.Events=P;const qr=jr;class Xr{constructor(e=36e5){this.oldToken="",this.newToken="",this.expireThreshold=e,this.expireTime=0}create(e){this.oldToken=e;let t=e.split("_")[0],i=e.split("_")[1],s=t.split("").reverse().join(""),r=`${(_.str(s)>>>0).toString(16).toUpperCase()}_${i}`;return this.newToken=r,this.expireTime=Date.now()+this.expireThreshold,r}get isExpired(){return Date.now()>this.expireTime}}function Yr(e,t,i){var s,r;let{scheduleOption:n}=t,a="live"===t.type,{live_type:o,live_subtitle:l}=n.playerData,h=a?(null==(s=t.liveOption)?void 0:s.defaultDefinition)||C.PSame:(null==(r=t.vodOption)?void 0:r.defaultDefinition)||C.PSame,d=1===l,u=a?function(e,t,i){var s,r;return t===w.Flv?{key:"httpflv_url",allQuality:e.httpflv_urls,allQualitySubtitles:e.httpflv_subtitle_urls,tokenStr:e.token}:t===w.Hls?i?{key:"hls_url",allQuality:null==(s=e.timeshift)?void 0:s.hls_urls,allQualitySubtitles:null==(r=e.timeshift_subtitle)?void 0:r.hls_urls,tokenStr:e.token}:{key:"hls_url",allQuality:e.hls_urls,allQualitySubtitles:e.hls_subtitle_urls,tokenStr:e.token}:{key:"rtmp_url",allQuality:e.rtmp_urls,allQualitySubtitles:e.rtmp_subtitle_urls,tokenStr:e.token}}(e,i,1===o):function(e,t){return t===w.Hls?{key:"hls_domainname",allQuality:e.hls_domainnames,tokenStr:e.token}:{key:"mp4_domainname",allQuality:e.mp4_domainnames,tokenStr:e.token}}(e,i),c=d?u.allQualitySubtitles:u.allQuality,f=Object.keys(c);if(!f.length)throw Error("无可用清晰度");f.includes(h)||(h=f[0]);let m=c[h],g=function(e,t){let{debugCDN:i}=t;return i&&e.find((e=>e.cdn_name===i))||e[0]}(m,n),p=m.map((e=>e.cdn_name));return{allQuality:u.allQuality,allQualitySubtitles:u.allQualitySubtitles,qualities:f,lines:p,currentQuality:h,currentQualityUrl:g[u.key],currentQualityLine:g.line,currentQualityLines:m,key:u.key,tokenStr:u.tokenStr}}class Qr{constructor(e){this.player=e}fetch(){let e=this.buildURL();const t=new Hr;t.fire(e,{},"GET"),t.onError=e=>V.info(`[vlog-${this.constructor.name}]`,e),t.onLoad=e=>this.resolveData(e)}buildURL(){return""}getRandom(){return 1e8+(899999999*Math.random()>>0)}resolveData(e){let{options:t,playerType:i}=this.player;if(this.def=Yr(e,t,i),V.info(`[vlog-${this.constructor.name}]`,this.def),"live"===t.type){let e=new Xr;this.def.token=e,this.def.tokenStr=e.create(this.def.tokenStr)}this.player.def=this.def,this.player.emit(P.SCHEDULER_COMPLETE,this.def.currentQualityUrl+"?token="+this.def.tokenStr)}}class Zr extends Qr{constructor(e){super(e),this.fetch()}buildURL(){let{scheduleOption:e,vodOption:t}=this.player.options,{dispatch_server:i,default_server:s,safe_server:r,log_info:n}=e.playerData;const a="m3u8"===s.uri.split(".").pop();const o="ie"===v.browser,l=v.supportMSE&&!("android"===v.os&&"qqbrowser"===v.browser),h=!(!(null==r?void 0:r.uri)||!a||o||!l);let d={};d.webinar_id=t.recordId,d.rand=this.getRandom(),d.uid=n.uid,d.uri=this.getUri(h),d.bu=1;let u=this.getQuality(h);return d.quality=0===u.length?'["same"]':`["${u.join('","')}"]`,`${i}/api/dispatch_replay?${p.stringify(d)}`}getUri(e){let{playerType:t}=this.player,{scheduleOption:i}=this.player.options,{dispatch_server:s,default_server:r,safe_server:n}=i.playerData,a=s+r.uri,o=e?s+n.uri:a,l=document.createElement("a");return l.href="hls"===t?o:a,l.pathname}getQuality(e){let{scheduleOption:t}=this.player.options,{safe_definition:i,definition:s}=t.playerData;return(e?i:s)||["same"]}}class Jr extends Qr{constructor(e){super(e),this.fetch()}buildURL(){let{scheduleOption:e,liveOption:t}=this.player.options,{dispatch_server:i,log_info:s,app_type:r,live_subtitle:n,live_delay:a}=e.playerData,o={};return o.webinar_id=t.roomId,o.uid=s.uid,o.bu=1,o.rand=this.getRandom(),o.app_type=r,o.is_subtitle=n,o.is_delay_stream=a,`${i}/api/dispatch_play?${p.stringify(o)}`}}class en{constructor(e){this.player=e;let{scheduleOption:t}=this.player.options;t.enable&&this.init()}init(){V.info(`[vlog-${this.constructor.name}]`,"init"),"live"===this.player.options.type?new Jr(this.player):new Zr(this.player)}destroy(){}}en.pluginName="schedule";const tn=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],sn=(()=>{let e={};for(let t of tn)if(t[1]in document){let i=0,s=t.length;for(;i<s;i++)e[tn[0][i]]=t[i];return e}return e})(),rn={eventNameMap:{change:sn.fullscreenchange,error:sn.fullscreenerror},async request(e,t={navigationUI:"auto"}){e=e||document.documentElement,this.isEnabled&&await e[sn.requestFullscreen](t)},async exit(){await document[sn.exitFullscreen]()},async toggle(e,t={navigationUI:"auto"}){this.isFullscreen?await this.exit():await this.request(e,t)},onchange(e){this.on("change",e)},onerror(e){this.on("error",e)},on(e,t){this.eventNameMap[e]&&document.addEventListener(this.eventNameMap[e],t,!1)},off(e,t){this.eventNameMap[e]&&document.removeEventListener(this.eventNameMap[e],t,!1)},get isFullscreen(){return Boolean(document[sn.fullscreenElement])},get element(){return document[sn.fullscreenElement]},get isEnabled(){return!!document[sn.fullscreenEnabled]}},nn={async request(e){this.isEnabled(e)&&await e.webkitEnterFullscreen()},async exit(e){await e.webkitExitFullscreen()},async toggle(e){this.isFullscreen?await this.exit(e):await this.request(e)},get isFullscreen(){return document.fullScreen||document.webkitIsFullScreen||!1},isEnabled:e=>!!e.webkitEnterFullscreen};class an{constructor(e){this.player=e,this.fsChangeHandler=()=>{this.player.emit(P.FULLSCREEN_CHANGE,null!==rn.element)},this.init()}init(){rn.isEnabled?(this.player.enterFullscreen=rn.request.bind(rn,this.player.root),this.player.exitFullscreen=rn.exit,this.player.isFullscreen=rn.isFullscreen,this.player.toggleFullscreen=rn.toggle.bind(rn,this.player.root)):nn.isEnabled(this.player.video)&&(this.player.enterFullscreen=nn.request.bind(nn,this.player.video),this.player.exitFullscreen=nn.exit.bind(nn,this.player.video),this.player.isFullscreen=nn.isFullscreen,this.player.toggleFullscreen=nn.toggle.bind(nn,this.player.video)),rn.on("change",this.fsChangeHandler)}destroy(){rn.off("change",this.fsChangeHandler)}}an.pluginName="fullscreen";class on{constructor(e){this.player=e,this.lagTimes=0,this.init()}init(){let{switchOption:e}=this.player.options;(null==e?void 0:e.enable)?(this.player.switch=this.switch.bind(this),this.registerListeners()):V.warn(`[vlog-${this.constructor.name}]`,"未开启切线功能")}registerListeners(){this.player.on(P.LAG_REPORT,this.lag,this),this.player.on(P.LAG_RECOVER,this.lagRecover,this)}lag(e){V.warn(`[vlog-${this.constructor.name}]`,"LAG_REPORT",e),this.lagTimes+=1,this.lagTimes>=3&&(V.info(`[vlog-${this.constructor.name}]`,"开始卡顿切线"),this.lagTimes=0,this.switch())}lagRecover(e){V.info(`[vlog-${this.constructor.name}]`,"LAG_RECOVER",e),this.lagTimes=0}switch(){let{def:e,playerType:t}=this.player,i=this.getNextLine(e.currentQualityLines,e.currentQualityLine);if(e.currentQualityUrl=i[e.key],e.currentQualityLine=i.line,!e.token||e.token.isExpired){let t=new Xr;e.token=t,e.tokenStr=t.create(e.tokenStr)}this.player.isFullscreen&&v.isX5&&t!==w.Native?this.player.exitFullscreen().then((()=>{setTimeout((()=>{this.player.emit(P.LINE_CHANGING,e.currentQualityUrl+"?token="+e.tokenStr)}),200)})):this.player.emit(P.LINE_CHANGING,e.currentQualityUrl+"?token="+e.tokenStr)}openLiveSubtitle(){}closeLiveSubtitle(){}getNextLine(e,t){let i=e.findIndex((e=>e.line===t))+1;return i>=e.length&&(i=0),e[i]}destroy(){}}on.pluginName="switcher";class ln{constructor(e){this.player=e,this.isPursuing=!1;let{pursueOption:t}=this.player.options;t.enable&&this.init()}init(){let{playerType:e}=this.player,{scheduleOption:t,pursueOption:i,type:s}=this.player.options;if(!(null==i?void 0:i.enable))return void V.warn(`[vlog-${this.constructor.name}]`,"未开启追播功能");if("vod"===s)return void V.warn(`[vlog-${this.constructor.name}]`,"点播活动不运行追播策略");let{playerData:r}=t;1!=+r.live_type||e!==w.Hls?e!==w.Flash?(this.pursueConfig=i[e],V.info(`[vlog-${this.constructor.name}]`,"开启追播策略 => ",this.pursueConfig),this.registerListeners()):V.warn(`[vlog-${this.constructor.name}]`,"flash不运行追播策略"):V.warn(`[vlog-${this.constructor.name}]`,"时移直播不运行追播策略")}registerListeners(){this._onTimeupdate=function(e,t){let i=Date.now(),s=null;return(...r)=>{s=Date.now(),s-i>t&&(e(...r),i=s)}}(this.onTimeupdate.bind(this),1e3),this.player.video.addEventListener("timeupdate",this._onTimeupdate)}unRegisterListeners(){this.player.video.removeEventListener("timeupdate",this._onTimeupdate)}onTimeupdate(e){let t=this.player.bufferedMax,i=t-this.player.currentTime,{bufferPursue:s,bufferSeek:r,bufferStop:n,pursueSpeed:a,mode:o}=this.pursueConfig;if(i>s||this.isPursuing&&i>n)switch(o){case"pursue":i>r?this.jumpTo(t-n):this.run(a);break;case"seek":this.jumpTo(t-n);break;default:V.warn(`[vlog-${this.constructor.name}]`,`追播类型配置错误，只支持 pursue、seek，配置为 ${o}`)}else this.walk()}jumpTo(e){e<=0||(this.player.currentTime=e,this.player.playbackRate=1,this.isPursuing=!1)}run(e){e<1||(this.player.playbackRate=e,this.isPursuing=!0)}walk(){this.player.playbackRate=1,this.isPursuing=!1}destroy(){this.unRegisterListeners()}}ln.pluginName="pursue";class hn{constructor(e){this.player=e,this.lastCurrentTime=0,this.lagTimes=0,this.lagBeginTime=0,this.detectInterval=0,this.gapDetectTime=500,this.gapEmitTime=3e3,this.init(),this.gapEmitLagTimes=this.gapEmitTime/this.gapDetectTime}init(){this.registerListeners()}registerListeners(){this.player.on(P.Play,this.startDetect,this),this.player.on(P.Pause,this.stopDetect,this),this.player.on(P.Ended,this.stopDetect,this),this.player.on(P.Error,this.onError,this),this.player.on(P.Stalled,this.onError,this),this.player.on(P.LINE_CHANGING,this.stopDetect,this),this.player.on(P.LINE_RELOADING,this.stopDetect,this)}onError(e){("mediaError"!==e.type||"bufferStalledError"!==e.details&&"bufferNudgeOnStall"!==e.details)&&(e&&e.target&&"stalled"===e.type||this.startDetect())}startDetect(){this.detectInterval||(V.info("[vlog]","开始卡顿检测..."),this.detectInterval=window.setInterval((()=>{this.checkLag(this.player.currentTime),this.lagTimes&&this.lagTimes%this.gapEmitLagTimes==0?this.player.emit(P.LAG_REPORT,{times:this.lagTimes,beginTime:this.lagBeginTime}):!this.lagTimes&&this.lagBeginTime&&(this.player.emit(P.LAG_RECOVER,{lastTime:Date.now()-this.lagBeginTime}),this.lagBeginTime=0)}),this.gapDetectTime))}stopDetect(){V.info("[vlog]","停止卡顿检测"),clearInterval(this.detectInterval),this.detectInterval=0,this.lagTimes=0,this.lagBeginTime=0}checkLag(e){this.lastCurrentTime===e?(this.lagTimes+=1,this.lagBeginTime||(this.lagBeginTime=Date.now()-this.gapDetectTime)):(this.lastCurrentTime=e,this.lagTimes=0)}destroy(){clearInterval(this.detectInterval),this.detectInterval=0,this.lagTimes=0,this.lagBeginTime=0,this.lastCurrentTime=0}}hn.pluginName="lag",qr.use(en),qr.use(an),qr.use(on),qr.use(ln),qr.use(hn);const dn=document.querySelector.bind(document);function un(e,t,i="click"){"string"==typeof e&&(e=dn(e)),e&&e.addEventListener(i,t)}function cn(){let e={};return new URL(location.href).searchParams.forEach(((t,i,s)=>{e[i]=t})),e}document.querySelectorAll.bind(document);const fn={dispatch_server:"https://gslb.e.vhall.com",log_info:{uid:"10000127"}},mn=l(o({},fn),{safe_definition:["same","a","360p"],definition:["same","a","360p"],default_server:{uri:"/vhallyun/vhallcoop/02290ce8c85e49463092cb860d455983/58faa1f6/02290ce8c85e49463092cb860d455983.m3u8",mp4_domainnames:""},subtitle_info:{}}),gn=l(o({},fn),{app_type:0,live_type:0,live_subtitle:0,live_delay:0,live_duration:0});let pn=["/out.flv","/qhh.flv"],_n=["/hls1/out.m3u8","/hls2/qhh.m3u8"];function vn(e="flv",t=0){let i=cn();console.log("querystring",i);let s="flv"===e?pn:_n;return i.url&&s.unshift(i.url),{index:t=t>=s.length?0:t,url:s[t]+"?token=alibaba"}}const yn={videoNode:"vh-player",type:"live",autoplay:!0,controls:!0,debug:!0},En=l(o({},yn),{appId:"UNUBw1EB",accountId:405,token:"vhall",liveOption:{roomId:"lss_XeTu8XDD",type:w.Flv},vodOption:{recordId:"58faa1f6"},scheduleOption:{enable:!0,playerData:gn,debugUrl:"",debugCDN:x.ALI,isNativePlayer:!1},peer5Option:{enable:!1,customerId:"",fallback:!0}});function Sn(){let e;const t=function(){let e=cn();console.log("querystring",e);const t=e.type;let i=dn("#url").value;return l(o({},En),{type:t,appId:e.appId,liveOption:{roomId:e.roomId,type:e.playerType||w.Flv},vodOption:{recordId:e.recordId},scheduleOption:{enable:!1,playerData:"live"===t?gn:mn,debugUrl:i?i+"?token=alibaba":"",debugCDN:e.cdn||x.TX,isNativePlayer:!1},peer5Option:{enable:"true"===e.peer5,customerId:e.peer5CustomerId,fallback:!0}})}();function i(){qr.createInstance(t,(i=>{if(e=i,function(e){e.on(qr.Events.FULLSCREEN_CHANGE,(e=>{console.log("Events.FULLSCREEN_CHANGE",e)})),e.on(qr.Events.Loaded,(()=>{e.play()}))}(i),function(e){const t=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","ratechange","seeked","seeking","stalled","suspend","waiting"];for(let i of t)e.video.addEventListener(i,(()=>{console.log(`[vlog - origin event: ${i}]`)}))}(i),!t.scheduleOption.enable)if(t.scheduleOption.debugUrl)e.load(t.scheduleOption.debugUrl);else{const t={flv:"/out.flv",hls:"/hls1/out.m3u8",native:"/hls1/out.m3u8",flash:""};e.load(t[e.playerType])}}),(e=>{console.error(e)}))}un(dn("#btn-init-player"),(()=>{i()})),un(dn("#btn-toggle-play"),(()=>{e.isPaused?e.play():e.pause()})),un(dn("#btn-toggle-fullscreen"),(async()=>{await e.toggleFullscreen()})),un(dn("#btn-switch"),(()=>{e.switch()})),un(dn("#btn-show-stats"),(()=>{window.peer5&&window.peer5.showStats()})),un(dn("#btn-seek"),(()=>{e.currentTime=2250}))}function Tn(){let e,t;un(dn("#btn-flv-init"),(()=>{yn.videoNode="flv-player",console.log("Flv Player Params:",yn),e=new Gr(yn),t=vn("flv"),e.load(t.url),function(e){e.nPlayer.on(Gr.Events.ERROR,((e,t,i)=>{console.log("FlvPlayer.Events.ERROR"),console.log("errorType: ",e),console.log("errorDetail: ",t),console.log("errorInfo: ",i)})),e.nPlayer.on(Gr.Events.LOADING_COMPLETE,(e=>{console.log("FlvPlayer.Events.LOADING_COMPLETE",e)})),e.nPlayer.on(Gr.Events.MEDIA_INFO,(e=>{console.log("FlvPlayer.Events.MEDIA_INFO",e)})),e.nPlayer.on(Gr.Events.METADATA_ARRIVED,(e=>{console.log("FlvPlayer.Events.METADATA_ARRIVED",e)})),e.nPlayer.on(Gr.Events.RECOVERED_EARLY_EOF,(e=>{console.log("FlvPlayer.Events.RECOVERED_EARLY_EOF",e)})),e.nPlayer.on(Gr.Events.SCRIPTDATA_ARRIVED,(e=>{console.log("FlvPlayer.Events.SCRIPTDATA_ARRIVED",e)})),e.nPlayer.on(Gr.Events.STATISTICS_INFO,(e=>{}))}(e)})),un(dn("#btn-flv-toggle-play"),(()=>{e.video.paused?e.video.play():e.video.pause()})),un(dn("#btn-flv-switch"),(()=>{t=vn("flv",t.index+1),e.load(t.url)}))}function Ln(){let e,t;un(dn("#btn-hls-init"),(()=>{yn.videoNode="hls-player",console.log("Hls Player Params:",yn),e=new $r(yn),t=vn("hls"),e.load(t.url)})),un(dn("#btn-hls-toggle-play"),(()=>{e.video.paused?e.video.play():e.video.pause()})),un(dn("#btn-hls-switch"),(()=>{t=vn("hls",t.index+1),e.load(t.url)}))}window.onload=function(){Sn(),Tn(),Ln()};
