var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,o=(e,t)=>{for(var i in t||(t={}))r.call(t,i)&&a(e,i,t[i]);if(s)for(var i of s(t))n.call(t,i)&&a(e,i,t[i]);return e},l=(e,s)=>t(e,i(s));import{u as h,e as d,a as c,P as u,l as p,i as y,c as m}from"./vendor.587d18dd.js";import v from"flv.js";import g from"hls.js";import{MediaPlayer as f,supportsMediaSource as E}from"dashjs";const L=document.querySelector.bind(document);function T(e="div",t={},i={}){const s=document.createElement(e);return Object.getOwnPropertyNames(t).forEach((e=>{s[e]=t[e]})),Object.getOwnPropertyNames(i).forEach((e=>{s.setAttribute(e,i[e])})),s}function S(e){return"string"==typeof e?L(e):e}function b(e,t){return new Promise(((i,s)=>{if(document.getElementById(e))i(!0);else{let r=document.createElement("script");r.setAttribute("id",e),r.setAttribute("src",t),document.head.appendChild(r),r.onload=()=>i(!0),r.onerror=()=>s(Error("network error")),setTimeout((()=>{s(Error("timeout"))}),1e4)}}))}function w(){const e={transition:"transitionend",WebkitTransition:"webkitTransitionEnd"};let t=document.createElement("div"),i=Object.keys(e);for(let s of i)if(void 0!==t.style[s])return{css:s,event:e[s]};return!1}const P=window.WebKitCSSMatrix||window.DOMMatrix||window.MSCSSMatrix;function R(e){const t=window.getComputedStyle(e,null).getPropertyValue("transform");return Number(P?new P(t).m41:t.match(/[+-]?\d+/g)[4])}function C(e,t){let i=void 0!==document.hidden?["hidden","visibilitychange","visibilityState"]:"webkitHidden"in document?["webkitHidden","webkitvisibilitychange","webkitVisibilityState"]:void 0;i&&document.addEventListener(i[1],(function(){"visible"===document[i[2]]?e&&e():t&&t()}),!1)}function k(e,t,i){const s="ontouchend"in document,r={down:{t:"touchstart",f:"mousedown"},move:{t:"touchmove",f:"mousemove"},up:{t:"touchend",f:"mouseup"}};let n=e.getBoundingClientRect(),a=s?r[t].t:r[t].f;e.addEventListener(a,(e=>{s&&function(e,t){t.clientX="touchend"===e?t.changedTouches[0].clientX:t.touches[0].clientX}(a,e),i(e,n.x)}))}const I=function(){var e,t;let i=(new h.exports.UAParser).getResult(),s=/mqqbrowser|qzone|qqbrowser|qq|micromessenger/i.test(i.ua),r=/android|adr/i.test(i.ua.toLowerCase());return{isTencent:s,browser:null==(e=i.browser.name)?void 0:e.toLowerCase(),browserVersion:i.browser.version,os:null==(t=i.os.name)?void 0:t.toLowerCase(),osVersion:i.os.version,platform:/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i.test(i.ua)?"mobile":"pc",isIOS:/\(i[^;]+;( U;)? CPU.+Mac OS X/.test(i.ua),isAndroid:r,isX5:s&&r,isUC:/ucbrowser/.test(i.ua.toLowerCase()),supportMSE:!(!window.MediaSource&&!window.WebKitMediaSource)}}();function _(e,t){let i=Date.now(),s=null;return(...r)=>{s=Date.now(),s-i>t&&(e(...r),i=s)}}class M extends class{constructor(){this.autoplay=!0,this.controls="native",this.poster="",this.debug=!1}merge(e){if(!e)return this;for(let t in e)"object"==typeof e[t]?this[t]=o(o({},this[t]),e[t]):this[t]=e[t];return this}}{constructor(){super(),this.language="en",this.scheduleOption={enable:!0,playerData:{dispatch_server:"",log_info:{uid:""},default_server:{uri:""},app_type:0,live_type:0,live_subtitle:0,live_delay:0,live_duration:0}},this.switchOption={enable:!0},this.marqueeOption={enable:!1},this.watermarkOption={enable:!1},this.barrageOption={enable:!0,positionRange:[0,.5],speed:100,style:{opacity:80,backgroundColor:"transparent"}},this.peer5Option={enable:!1,customerId:"",fallback:!0},this.vttOptions={enable:!1};let e={bufferPursue:20,bufferSeek:30,bufferStop:10,pursueSpeed:1.2,mode:"pursue"},t={bufferPursue:30,bufferSeek:40,bufferStop:20,pursueSpeed:1.2,mode:"pursue"};this.pursueOption={enable:!0,flv:e,hls:t,dash:t,native:e}}}Date.now();const D="app_id",x="third_party_user_id",O="client",A="access_token",N="package_check";var B,U,F,q,H,V,Q,W,$,X;(U=B||(B={})).Flv="flv",U.Hls="hls",U.HlsNative="hlsnative",U.Flash="flash",U.Native="native",U.Dash="dash",(q=F||(F={})).P360="360p",q.P480="480p",q.P720="720p",q.Pa="a",q.PSame="same",(V=H||(H={})).TX="tx",V.ALI="ali",V.HW="hw",V.CY="cy",(W=Q||(Q={})).UISingleDisplay="UISingleDisplay",W.UIResize="UIResize",function(e){e.Error="error",e.Waiting="waiting",e.Ended="ended",e.Loaded="loadeddata",e.Play="play",e.Canplay="canplay",e.Pause="pause",e.Ratechange="ratechange",e.Stalled="stalled",e.Volumechange="volumechange"}(Q||(Q={})),function(e){e.VTT_ADDED="vttAdded",e.VTT_SELECTED="vttSelected",e.VTT_CLOSED="vttClosed",e.DEFINITION_CHANGE="definitionChange",e.LIVESUBTITLE_OPENED="liveSubtitleOpened",e.LIVESUBTITLE_CLOSED="liveSubtitleClosed",e.AUTOPLAY_FAILED="autoplayFailed",e.FULLSCREEN_CHANGED="fullscreenChanged",e.LAG_REPORT="lagReport",e.LAG_RECOVER="lagRecover",e.OPEN_BARRAGE="openBarrage",e.CLOSE_BARRAGE="closeBarrage",e.CLEAR_BARRAGE="clearBarrage",e.SCHEDULER_COMPLETE="scheduleComplete",e.PULL_STREAM_FAILED="PULL_STREAM_FAILED",e.LINE_CHANGE="lineChange",e.LINE_CHANGED="lineChanged",e.LIVE_TIMESHIFT="liveTimeShift",e.TOUCH_PLAY="touchPlay"}(Q||(Q={}));class G{constructor(){this._emitter=new d.exports.EventEmitter}emit(e,t){return this._emitter.emit(e,t)}listenerCount(e){return this._emitter.listenerCount(e)}listeners(e){return this._emitter.listeners(e)}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}}(X=$||($={})).Trace="trace",X.Debug="debug",X.Log="log",X.Warn="warn",X.Info="info",X.Error="error";const j=function(){},z={trace:j,debug:j,log:j,warn:j,info:j,error:j};let Y=z;function K(e,...t){!1!==e&&t.forEach((function(t){Y[t]="object"==typeof e&&e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[vlog ${e}] >`):j}(t)}))}function J(e){if(self.console&&!0===e||"object"==typeof e){K(e,$.Debug,$.Log,$.Info,$.Warn,$.Error);try{Y.log()}catch(t){Y=z}}else Y=z}const Z=Y;class ee{constructor(e,t){this.playedTime=0,this.playBackRate=1,this.isPaused=!0,this.url="",this.cacheUrl="",this.autoPlayed=!1,this.options=e,this.context=t,this.video=this.initVideo(e,S("#"+e.videoNode)),this.registerListeners()}initVideo(e,t=document.body){let i={playsinline:!0,"webkit-playsinline":!0,"x5-playsinline":!0,"mtt-playsinline":!0},s=T("video",{autoplay:!!e.autoplay,controls:"native"===e.controls,muted:!!e.muted},o(o({width:"100%",height:"100%",crossOrigin:"anonymous","z-index":0},i),e.poster?{poster:e.poster}:{}));return t.style.position="relative",t.appendChild(s),s}checkUrl(e,t=!1){return e?this.url!==e||t?(this.cacheUrl||(this.cacheUrl=e),!0):(Z.warn("BasePlayer checkUrl - url 未改变"),!1):(Z.warn("BasePlayer checkUrl - url 未提供"),!1)}setUrl(e){var t;null==(t=this.context)||t.emit(Q.LINE_CHANGED,{old:this.url,new:e}),this.url=e,this.cacheUrl=""}recordPlayStatus(e){Z.info("BasePlayer change line old => ",this.url),Z.info("BasePlayer change line new => ",e),this.playedTime=this.video.currentTime,this.playBackRate=this.video.playbackRate,this.isPaused=this.video.paused}recoverPlayStatus(){Z.info("BasePlayer 还原切线前播放状态:"),"vod"===this.options.type&&(Z.info("BasePlayer playedTime:",this.playedTime),this.video.currentTime=this.playedTime),Z.info("BasePlayer playBackRate:",this.playBackRate),this.video.playbackRate=this.playBackRate,this.isPaused||this.video.play()}registerListeners(){this.video.addEventListener("play",(e=>{var t;null==(t=this.context)||t.emit(Q.Play,e)})),this.video.addEventListener("pause",(e=>{var t;null==(t=this.context)||t.emit(Q.Pause,e)})),this.video.addEventListener("canplay",(e=>{var t;null==(t=this.context)||t.emit(Q.Canplay,e)})),this.video.addEventListener("waiting",(e=>{var t;null==(t=this.context)||t.emit(Q.Waiting,e)})),this.video.addEventListener("ended",(e=>{var t;null==(t=this.context)||t.emit(Q.Ended,e)})),this.video.addEventListener("error",(e=>{var t;null==(t=this.context)||t.emit(Q.Error,e),Z.error(`BasePlayer video error, type: ${e.type}; details: ${e.details}`);let i=e.target&&e.target.error;i&&Z.error(`BasePlayer video error, code: ${i.code}; details: ${i.message}`)})),this.video.addEventListener("stalled",(e=>{var t;null==(t=this.context)||t.emit(Q.Stalled,e)})),this.video.addEventListener("loadeddata",(e=>{var t;null==(t=this.context)||t.emit(Q.Loaded,e)})),this.video.addEventListener("ratechange",(e=>{var t;Z.info("BasePlayer video ratechange",this.video.playbackRate),null==(t=this.context)||t.emit(Q.Ratechange,e)})),this.video.addEventListener("volumechange",(e=>{var t;null==(t=this.context)||t.emit(Q.Volumechange,e)})),this.video.addEventListener("canplaythrough",(e=>{this.options.autoplay&&!this.autoPlayed&&this.video.paused&&(this.autoPlayed=!0,this.video.play().catch((e=>{var t;Z.warn("BasePlayer - not support autoplay"),null==(t=this.context)||t.emit(Q.AUTOPLAY_FAILED,e)})))}))}}class te extends ee{constructor(e,t="flv",i){super(e,i),this.cacheInfo={},Z.info(`FlvPlayer - 创建 ${t} player`),this.type=t}load(e,t=!1){return this.checkUrl(e,t)?(this.nPlayer&&this.recordPlayStatus(e),new Promise((t=>{this.createInstance({type:this.type,isLive:"live"===this.options.type,url:e},{enableWorker:!0,statisticsInfoReportInterval:3e3}).then((i=>{i&&this.nPlayer.on(v.Events.METADATA_ARRIVED,(()=>{this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}})),this.registerFlvListeners(),this.nPlayer.on(v.Events.METADATA_ARRIVED,(()=>{this.setUrl(e)})),this.nPlayer.attachMediaElement(this.video),this.nPlayer.load(),t(!0)}))}))):Promise.reject(!1)}reload(){return this.load(this.cacheUrl||this.url,!0)}async createInstance(e,t){if("flv"===this.type&&!v.isSupported())throw Z.error("FlvPlayer createInstance - flv not supported!"),Error("flv not supported!");const i=!!this.nPlayer;return await this.destroy(),this.nPlayer=v.createPlayer(e,t),i}destroy(){var e;return null==(e=this.nPlayer)||e.destroy(),Promise.resolve(!0)}registerFlvListeners(){this.nPlayer.on(v.Events.ERROR,((e,...t)=>{var i;Z.error("FlvPlayer Events.ERROR",e,t),e===v.ErrorTypes.NETWORK_ERROR&&(t[0]===v.ErrorDetails.NETWORK_STATUS_CODE_INVALID&&404===t[1].code||t[0]===v.ErrorDetails.NETWORK_TIMEOUT||void 0===t[1].code)&&(null==(i=this.context)||i.emit(Q.PULL_STREAM_FAILED,this.url))})),this.nPlayer.on(v.Events.LOADING_COMPLETE,(e=>{var t;Z.info("FlvPlayer Events.LOADING_COMPLETE",e),null==(t=this.context)||t.emit(Q.PULL_STREAM_FAILED,this.url)})),this.nPlayer.on(v.Events.STATISTICS_INFO,(e=>{this.cacheInfo=e}))}getBandwidthEstimate(){return this.cacheInfo.speed||0}}te.Events=v.Events;class ie extends ee{constructor(e,t){super(e,t),Z.info("HlsPlayer - 创建 HlsPlayer")}load(e,t=!1){return this.checkUrl(e,t)?(this.nPlayer&&this.recordPlayStatus(e),new Promise((t=>{this.createHlsInstance().then((i=>{i&&(this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}),this.registerHlsListeners(),this.nPlayer.on(g.Events.MANIFEST_LOADED,(()=>{this.setUrl(e)})),this.nPlayer.loadSource(e),this.nPlayer.attachMedia(this.video),t(!0)}))}))):Promise.reject(!1)}reload(){return this.load(this.cacheUrl||this.url,!0)}async createHlsInstance(){if(!g.isSupported())throw Z.error("HlsPlayer - hls not supported"),Error("hls not supported");let e=await this.destroy();return this.nPlayer=new g({debug:!1,levelLoadingMaxRetry:-1,fLoader:window.peer5&&window.peer5.HlsJsFragmentLoader,pLoader:window.peer5&&window.peer5.HlsJsPlaylistLoader}),e}destroy(){return new Promise((e=>{this.nPlayer?(this.nPlayer.once(g.Events.MEDIA_DETACHED,(()=>{e(!0)})),this.nPlayer.destroy()):e(!1)}))}registerHlsListeners(){this.nPlayer.on(g.Events.ERROR,((e,t)=>{var i;Z.error("HlsPlayer Events.ERROR",e,t);let{details:s,type:r}=t;r===g.ErrorTypes.NETWORK_ERROR&&(s!==g.ErrorDetails.MANIFEST_LOAD_ERROR&&s!==g.ErrorDetails.MANIFEST_LOAD_TIMEOUT&&s!==g.ErrorDetails.LEVEL_LOAD_ERROR&&s!==g.ErrorDetails.LEVEL_LOAD_TIMEOUT||null==(i=this.context)||i.emit(Q.PULL_STREAM_FAILED,this.url))}))}getBandwidthEstimate(){return this.nPlayer.bandwidthEstimate/8192}}ie.Events=g.Events;class se extends ee{constructor(e,t){super(e,t),Z.info("DashPlayer - 创建 DashPlayer")}load(e,t){return this.checkUrl(e,t)?(this.nPlayer&&this.recordPlayStatus(e),new Promise((t=>{this.createHlsInstance().then((i=>{i&&(this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}),this.registerHlsListeners(),this.nPlayer.on(f.events.MANIFEST_LOADED,(()=>{this.setUrl(e)})),this.nPlayer.initialize(this.video,e,!0),t(!0)}))}))):Promise.reject(!1)}async createHlsInstance(){if(!E())throw Z.error("DashPlayer - dash not supported"),Error("dash not supported");let e=await this.destroy();return this.nPlayer=f().create(),e}registerHlsListeners(){}reload(){return this.load(this.cacheUrl||this.url,!0)}destroy(){return new Promise((e=>{this.nPlayer?(this.nPlayer.destroy(),e(!0)):e(!1)}))}getBandwidthEstimate(){return 0}}se.Events=f.events;const re={timeWait:5e3,timeLazy:15e3,timesReached:-1,timesMax:-1,isInterval:!0};class ne{constructor(e=re){this.times=0,this.timer=0,this.executing=!1;let t=Object.assign({},re,e);Z.info("TaskLoop config",t),this.timeWait=t.timeWait,this.timeLazy=t.timeLazy,this.timesReached=t.timesReached,this.timesMax=t.timesMax,this.isInterval=t.isInterval}setCallback(e){return this.fn=e,this}setIsInterval(e){return this.isInterval=e,this}setTimeWait(e){this.isInterval?clearInterval(this.timer):clearTimeout(this.timer),this.timeWait=e}setInterval(){this.timer=window.setInterval((()=>{this.checkTimesReached()||(this.fn(),this.times+=1)}),this.timeWait)}checkTimesReached(){return-1!==this.timesMax&&this.times>=this.timesMax?(this.destroy(),Z.warn("TaskLoop checkTimesReached - Interval Reach the top, stopped"),!0):(-1!==this.timesReached&&this.timeWait!==this.timeLazy&&this.times>=this.timesReached&&(Z.warn("TaskLoop checkTimesReached - Interval Reach the top, set lazy"),this.setTimeWait(this.timeLazy),this.isInterval&&this.setInterval()),!1)}execute(){if(!this.executing){if(this.isInterval)this.setInterval();else{if(this.checkTimesReached())return;this.timer=window.setTimeout(this.fn,this.timeWait),this.times+=1}this.executing=!0}}destroy(){this.isInterval?clearInterval(this.timer):clearTimeout(this.timer),this.times=0,this.executing=!1}}const ae={length:0,start:()=>0,end:()=>0};function oe(e){try{return e.buffered}catch(t){return Z.warn("failed to get media.buffered",t),ae}}function le(e){try{let t=oe(e);return t.length?t.end(t.length-1):0}catch(t){return Z.warn("failed to get last media.buffered",t),0}}var he,de,ce,ue;(de=he||(he={})).ManifestLoading="ManifestLoading",de.ManifestLoaded="ManifestLoaded",de.ManifestParsed="ManifestParsed",de.TsLoading="TsLoading",de.TsLoaded="TsLoaded",de.Muxed="Muxed",de.Play="play",de.Pause="pause",de.Ratechange="ratechange",de.Stalled="stalled",(ue=ce||(ce={})).Idle="Idle",ue.TsLoading="TsLoading",ue.TsLoaded="TsLoaded",ue.Ended="Ended";class pe{constructor(e){this.stats=ce.Idle,this.segmentTracker={},this.isSeeking=!1,this.nextSegmentIndex=0,this.onMediaSourceOpen=()=>{var e;const{ms:t,hls:i}=this;let s=t.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');s.addEventListener("updateend",this.updateEnd),this.sourceBuffer=s,null==(e=i.loader.m3u8Promise)||e.then((e=>{e.endList&&(t.duration=e.totalDuration),this.taskLoop=new ne({timeWait:500}),this.taskLoop.setCallback(this.tick).execute()}))},this.onMediaSourceEnded=()=>{Z.info("onMediaSourceEnded")},this.onMediaSourceClose=()=>{Z.info("onMediaSourceClose")},this.onSeeking=()=>{this.isSeeking=!0;let{video:e}=this,t=le(e);console.log("ana onSeeking",e.currentTime,t),this.nextSegmentIndex=this.findSegmentIndex(e.currentTime)},this.onSeeked=()=>{this.isSeeking=!1;let{video:e}=this,t=oe(e);console.log("ana onSeeked",e.currentTime,t.end(0))},this.tick=()=>{switch(this.stats){case ce.Idle:this.checkFetchNextSegment()}},this.updateEnd=()=>{const{ms:e,hls:t}=this;let{playManifest:i,segmentIndex:s}=t.loader;if(!this.sourceBuffer.updating&&"open"===e.readyState&&s===i.segments.length-1)return this.stats=ce.Ended,this.taskLoop.destroy(),void e.endOfStream();this.stats=ce.Idle},this.hls=e,this.register()}register(){this.hls.on(he.ManifestParsed,(e=>{Z.info("Events.ManifestParsed",e),this.playManifest=e})),this.hls.on(he.TsLoading,(e=>{this.stats=ce.TsLoading})),this.hls.on(he.TsLoaded,(e=>{this.stats=ce.TsLoaded,this.segmentTracker[e.segment.index]=!0})),this.hls.on(he.Muxed,(e=>{Z.info("getBufferedLast",le(this.sourceBuffer)),this.sourceBuffer.appendBuffer(e)}))}attachMedia(e){const t=this.video=e,i=this.ms=new MediaSource;i.addEventListener("sourceopen",this.onMediaSourceOpen),i.addEventListener("sourceended",this.onMediaSourceEnded),i.addEventListener("sourceclose",this.onMediaSourceClose),e.addEventListener("seeking",this.onSeeking),e.addEventListener("seeked",this.onSeeked),t.src=self.URL.createObjectURL(i),this.objectUrl=t.src}checkFetchNextSegment(){let{hls:e,video:t}=this,i=le(t);Z.info("buffered",t.currentTime,i),this.nextSegmentIndex?(this.checkBuffered(this.nextSegmentIndex)||e.loader.getTsData(this.nextSegmentIndex),this.nextSegmentIndex=0):t.currentTime>=i-(t.paused?60:10)&&e.loader.getTsData()}findSegmentIndex(e){let t,{playManifest:i}=this,s=0,r=Math.floor(e/i.avgDuration),n=r<10?0:r-10,a=i.segments.length;for(;n<a;n++)if(t=i.segments[n],s+=t.duration,s>=e)return t.index;return 0}checkBuffered(e){return this.segmentTracker[e]}}class ye{constructor(e){this.remuxedSegments=[],this.remuxedInitSegment=null,this.translate=e=>{this.transmuxer.push(new Uint8Array(e.arrayBuffer)),this.transmuxer.flush()},this.onMuxedData=e=>{let t;this.remuxedSegments.push(e),this.remuxedInitSegment?t=new Uint8Array(e.data):(this.remuxedInitSegment=e.initSegment,t=new Uint8Array(e.initSegment.byteLength+e.data.byteLength),t.set(e.initSegment,0),t.set(e.data,e.initSegment.byteLength)),this.hls.emit(he.Muxed,t)},this.hls=e,this.transmuxer=new c.mp4.Transmuxer,this.transmuxer.on("data",this.onMuxedData),this.register()}register(){this.hls.on(he.TsLoaded,this.translate)}}class me{constructor(e){this.segmentIndex=-1,this.origin="",this.hls=e,this.parser=new u}getM3u8Data(e){if(this.origin=new window.URL(e).origin,!this.origin){let t=`资源地址错误: ${e}`;return Z.warn("Loader getM3u8Data error",t),Promise.reject(t)}let t=new Promise(((t,i)=>{this.hls.emit(he.ManifestLoading),fetch(e,{}).then((e=>{if(e.ok&&200===e.status)return e.text();i("response not 200")})).then((e=>{this.hls.emit(he.ManifestLoaded,e),this.parser.push(e),this.parser.end(),this.playManifest=this.parser.manifest,this.setTotalDuration(),this.hls.emit(he.ManifestParsed,this.parser.manifest),t(this.parser.manifest)}))}));return this.m3u8Promise=t,t}getTsData(e){this.segmentIndex=void 0===e?this.segmentIndex+1:e;let t=this.playManifest.segments[this.segmentIndex],i=this.origin+t.uri;i?(this.hls.emit(he.TsLoading,t),fetch(i,{}).then((e=>{if(e.ok&&200===e.status)return e.arrayBuffer()})).then((e=>{this.hls.emit(he.TsLoaded,{segment:t,arrayBuffer:e})}))):Z.warn(`Loader getTsData - TS Url not found, index: ${this.segmentIndex}`)}setTotalDuration(){let e=0,t=0;for(let i of this.playManifest.segments)e+=i.duration,i.index=t++;this.playManifest.totalDuration=e,this.playManifest.avgDuration=Number((e/t).toFixed(2))}}const ve=class extends G{constructor(){super(),this.mseController=new pe(this),this.loader=new me(this),this.muxer=new ye(this)}loadSource(e){this.loader.getM3u8Data(e)}attachMedia(e){this.mseController.attachMedia(e)}destroy(){}};class ge extends ee{constructor(e,t){super(e,t),Z.info("HlsLitePlayer - 创建 HlsLitePlayer")}load(e,t=!1){return this.checkUrl(e,t)?(this.nPlayer&&this.recordPlayStatus(e),new Promise((t=>{this.createHlsInstance().then((i=>{i&&(this.video.onloadedmetadata=()=>{this.recoverPlayStatus()}),this.setUrl(e),this.nPlayer.loadSource(e),this.nPlayer.attachMedia(this.video),t(!0)}))}))):Promise.reject(!1)}reload(){return this.load(this.cacheUrl||this.url,!0)}async createHlsInstance(){let e=await this.destroy();return this.nPlayer=new ve,e}destroy(){return new Promise((e=>{this.nPlayer?(this.nPlayer.destroy(),e(!0)):e(!1)}))}getBandwidthEstimate(){return 0}}function fe(e){var t;let{scheduleOption:i,type:s,liveOption:r}=e,{playerData:n}=i;if("live"===s){let e=r.type;if(e&&"auto"!==e)return e;return 1==+n.live_type?B.Hls:v.isSupported()?B.Flv:B.Hls}return(null==(t=n.default_server)?void 0:t.mp4_domainnames)?B.Native:function(e){let{scheduleOption:t}=e;return!t.enable&&t.debugPlayer?t.debugPlayer:B.Hls}(e)}class Ee{constructor(e){this.store=e,this.e={error:this._onError.bind(this),timeout:this._onTimeout.bind(this),load:this._onLoad.bind(this),loadend:this._onLoadend.bind(this)};let t=new XMLHttpRequest;"ie"!==I.browser&&(t.responseType="json",t.timeout=5e3),t.onerror=this.e.error,t.ontimeout=this.e.timeout,t.onload=this.e.load,t.onloadend=this.e.loadend,this.xhr=t}_onError(e){this.onError&&this.onError(e.target),this.onError=null}_onTimeout(e){this.onTimeout&&this.onTimeout(e.target),this.onTimeout=null}_onLoad(e){if(!e.target)return void this._onError(e);let t=e.target.response;if("ie"===I.browser&&t&&"string"==typeof t)try{t=JSON.parse(t)}catch(r){}let{code:i,data:s}=t;200==+i?(this.onLoad&&this.onLoad(s),this.onLoad=null):this._onError(e)}_onLoadend(e){this.onLoadend&&this.onLoadend(e.target),this.onLoadend=null}fire(e,t={},i="POST"){if(!this.xhr)return;I.isIOS&&I.isUC&&(i="GET");let s=new FormData;if(this.store&&(s.set(O,this.store.getKV(O)),s.set(D,this.store.getKV(D)),s.set(x,this.store.getKV(x)),s.set(A,this.store.getKV(A)),s.set(N,this.store.getKV(N))),Object.keys(t).forEach((e=>{s.set(e,t[e])})),"POST"===i)this.xhr.open(i,e),this.xhr.send(s);else if("GET"===i){let t={};s.forEach(((e,i)=>{t[i]=e}));let r=p.stringify(t);r&&(e+=`?${r}`),this.xhr.open(i,e),this.xhr.send()}}destroy(){this.xhr&&(this.xhr.onerror=null,this.xhr.onload=null,this.xhr.onloadend=null,this.xhr.ontimeout=null,this.xhr=null,this.onLoad=null,this.onLoadend=null,this.onTimeout=null,this.onError=null)}}const Le=class extends G{constructor(e){super(),this.plugins={},this.isFullscreen=!1,this.enterFullscreen=()=>Promise.resolve(void 0),this.exitFullscreen=()=>Promise.resolve(void 0),this.toggleFullscreen=()=>Promise.resolve(void 0),this.switch=()=>{},this.setQuality=()=>{},this.addBarrage=()=>{},this.clearBarrage=()=>{},this.openBarrage=()=>{},this.closeBarrage=()=>{},this.capture=()=>{},this.selectVtt=()=>{},this.closeVtt=()=>{},this.handleTimeShift=()=>{},this.openUI=()=>{},this.hideUI=()=>{},this.options=(new M).merge(e),this.root=S("#"+e.videoNode),this.registerListeners(),this.createPlayer(),this.applyPlugins()}static use(e){const t=e.pluginName;return Le.plugins.some((t=>t.ctor===e))?Le:null==t?(Z.warn(`VhPlayer use plugin error，plugin: ${e.name} - ${t} can not be used`),Le):(Le.plugins.push({name:t,ctor:e}),Le)}registerListeners(){this.on(Q.SCHEDULER_COMPLETE,(e=>{Z.info("VhPlayer PlayerEvents.SCHEDULER_COMPLETE",e),e.timeShift||this.load(e.url)})),this.on(Q.DEFINITION_CHANGE,(e=>{Z.info("VhPlayer PlayerEvents.DEFINITION_CHANGE",e),this.load(e.url)})),this.on(Q.LINE_CHANGE,(e=>{Z.info("VhPlayer PlayerEvents.LINE_CHANGE",e),e.isReload?this.reload():this.load(e.url)})),this.on(Q.LINE_CHANGED,(()=>{Z.info("VhPlayer PlayerEvents.LINE_CHANGED"),this.intervalLoader&&this.intervalLoader.destroy()})),this.on(Q.PULL_STREAM_FAILED,(e=>{Z.info("VhPlayer PlayerEvents.PULL_STREAM_FAILED",e)})),window.ResizeObserver||y();new ResizeObserver((()=>{this.emit(Q.UIResize)})).observe(this.root)}createPlayer(){switch(this.playerType=fe(this.options),this.playerType){case B.Flv:this.vPlayer=new te(this.options,"flv",this);break;case B.Hls:g.isSupported()?this.vPlayer=new ie(this.options,this):this.vPlayer=new te(this.options,"native",this);break;case B.Native:case B.HlsNative:this.vPlayer=new te(this.options,"native",this);break;case B.Dash:this.vPlayer=new se(this.options,this);break;default:throw Error("未提供支持的播放器类型")}this.video=this.vPlayer.video}applyPlugins(){Le.plugins.forEach((e=>{const t=e.ctor;"function"==typeof t&&(this.plugins[e.name]=new t(this))}))}load(e){this.vPlayer.load(e)}reload(){this.vPlayer.reload()}async destroy(){Z.warn("VhPlayer destroy，plugins：",Object.values(this.plugins));for(let e of Object.values(this.plugins))e.destroy&&e.destroy();await this.vPlayer.destroy(),this.video.remove()}play(){return this.video.play()}pause(){this.video.pause()}get isPaused(){return this.video.paused}get autoplay(){return this.video.autoplay}set autoplay(e){this.video.autoplay=e}get buffered(){return this.video.buffered}get bufferedMax(){let e=this.video.buffered;return e.length?e.end(e.length-1):0}get cdnName(){var e,t;return(null==(e=this.def)?void 0:e.currentQualityCdnName)||(null==(t=this.def)?void 0:t.currentQualityLineName)}get quality(){var e;return null==(e=this.def)?void 0:e.currentQuality}get qualities(){var e;return null==(e=this.def)?void 0:e.qualities}get controls(){return this.video.controls}set controls(e){this.video.controls=e}get crossOrigin(){return this.video.crossOrigin}set crossOrigin(e){this.video.crossOrigin=e}get currentTime(){return this.video.currentTime}set currentTime(e){this.video.currentTime=e}get defaultMuted(){return this.video.defaultMuted}set defaultMuted(e){this.video.defaultMuted=e}get duration(){return this.video.duration}get isEnded(){return this.video.ended}getEstimateNetSpeed(){return+this.vPlayer.getBandwidthEstimate().toFixed(3)}get loop(){return this.video.loop}set loop(e){this.video.loop=e}get muted(){return this.video.muted}set muted(e){this.video.muted=e}get networkState(){return this.video.networkState}get playbackRate(){return this.video.playbackRate}set playbackRate(e){this.video.playbackRate=e}get played(){return this.video.played}get preload(){return this.video.preload}set preload(e){this.video.preload=e}get readyState(){return this.video.readyState}get seekable(){return this.video.seekable}get isSeeking(){return this.video.seeking}get volume(){return this.video.volume}set volume(e){this.video.volume=e}static probe(){const e=document.createElement("video"),t=window.MediaSource||window.WebKitMediaSource;function i(i){return t&&t.isTypeSupported?t.isTypeSupported(i):e.canPlayType(i)}return l(o({},I),{H264:e.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"'),H265:e.canPlayType('video/mp4; codecs="hevc"'),WebM_VP8:e.canPlayType('video/webm; codecs="vp8, vorbis"'),WebM_VP9:e.canPlayType('video/webm; codecs="vp9"'),MSE_H264:i('video/mp4; codecs="avc1.4D401E"'),MSE_H265:i('video/mp4; codecs="hevc"'),MSE_WebM_VP8:i('video/webm; codecs="vp8, vorbis"'),MSE_WebM_VP9:i('video/webm; codecs="vp9"'),MSE_AV1:i('video/mp4; codecs="av01.0.05M.08"'),WebSocket:!!window.WebSocket})}static async createInstance(e,t,i){try{J(void 0!==e.debug&&e.debug);let{scheduleOption:i}=e;if(fe(e)===B.Hls&&g.isSupported()){let{peer5Option:t}=e,i=(null==t?void 0:t.enable)?t.customerId:"";if(i)try{await b("script-peer5",`https://api.peer5.com/peer5.js?id=${i}`),await b("script-peer5-hls","https://api.peer5.com/peer5.hlsjs.loader.js")}catch(s){Z.error("VhPlayer.createInstance - peer5 sdk load error: "+s.message)}}let r=new Le(e);return window.vp=r,t&&t(r),r}catch(s){Z.warn("VhPlayer.createInstance error",s),i&&i({code:500,message:s.message})}}};let Te=Le;Te.plugins=[],Te.Events=Q;const Se=Te;class be{constructor(e=36e5){this.oldToken="",this.newToken="",this.expireThreshold=e,this.expireTime=0}create(e){this.oldToken=e;let t=e.split("_")[0],i=e.split("_")[1],s=t.split("").reverse().join(""),r=`${(m.str(s)>>>0).toString(16).toUpperCase()}_${i}`;return this.newToken=r,this.expireTime=Date.now()+this.expireThreshold,r}get isExpired(){return Date.now()>this.expireTime}static refreshToken(e){if(!e.token||e.token.isExpired){let t=new be;e.token=t,e.tokenStr=t.create(e.tokenStr)}}}function we(e,t,i){var s,r;let{scheduleOption:n}=t,a="live"===t.type,{live_type:o,live_subtitle:l}=n.playerData,h=a?(null==(s=t.liveOption)?void 0:s.defaultDefinition)||F.PSame:(null==(r=t.vodOption)?void 0:r.defaultDefinition)||F.PSame,d=1===l,c=a?function(e,t,i){var s,r;return t===B.Flv?{key:"httpflv_url",allQuality:e.httpflv_urls,allQualitySubtitles:e.httpflv_subtitle_urls,tokenStr:e.token}:t===B.Hls||t===B.HlsNative?i?{key:"hls_url",allQuality:null==(s=e.timeshift)?void 0:s.hls_urls,allQualitySubtitles:null==(r=e.timeshift_subtitle)?void 0:r.hls_urls,tokenStr:e.token}:{key:"hls_url",allQuality:e.hls_urls,allQualitySubtitles:e.hls_subtitle_urls,tokenStr:e.token}:{key:"rtmp_url",allQuality:e.rtmp_urls,allQualitySubtitles:e.rtmp_subtitle_urls,tokenStr:e.token}}(e,i,1===o):function(e,t){return t===B.Hls||t===B.HlsNative?{key:"hls_domainname",allQuality:e.hls_domainnames,tokenStr:e.token}:{key:"mp4_domainname",allQuality:e.mp4_domainnames,tokenStr:e.token}}(e,i),u=d?c.allQualitySubtitles:c.allQuality,p=Object.keys(u);if(!p.length)throw Error("无可用清晰度");p.includes(h)||(h=p[0]);let y=u[h],m=function(e,t){let{debugCDN:i}=t;return i&&e.find((e=>e.cdn_name===i))||e[0]}(y,n),v=y.map((e=>e.cdn_name||e.line));return{allQuality:c.allQuality,allQualitySubtitles:c.allQualitySubtitles,qualities:p,lines:v,currentQuality:h,currentQualityUrl:m[c.key],currentQualityCdnName:m.cdn_name,currentQualityLineName:m.line,currentQualityLines:y,key:c.key,tokenStr:c.tokenStr}}class Pe{constructor(e){this.player=e}fetch(){let e=this.buildURL();const t=new Ee;t.fire(e,{},"GET"),t.onError=e=>Z.error("Schedule fetch error",e),t.onLoad=e=>this.resolveData(e)}buildURL(){return""}getRandom(){return 1e8+(899999999*Math.random()>>0)}resolveData(e){let{options:t,playerType:i}=this.player;if(this.def=we(e,t,i),Z.info("Schedule get def",this.def),"live"===t.type){let e=new be;this.def.token=e,this.def.tokenStr=e.create(this.def.tokenStr)}this.player.def=this.def,this.player.emit(Q.SCHEDULER_COMPLETE,{url:this.def.currentQualityUrl+"?token="+this.def.tokenStr,timeShift:"live"===t.type&&1===t.scheduleOption.playerData.live_type})}}class Re extends Pe{constructor(e){super(e),this.fetch()}buildURL(){let{scheduleOption:e,vodOption:t}=this.player.options,{dispatch_server:i,default_server:s,safe_server:r,log_info:n}=e.playerData;const a="m3u8"===s.uri.split(".").pop();const o="ie"===I.browser,l=I.supportMSE&&!("android"===I.os&&"qqbrowser"===I.browser),h=!(!(null==r?void 0:r.uri)||!a||o||!l);let d={};d.webinar_id=t.recordId,d.rand=this.getRandom(),d.uid=n.uid,d.uri=this.getUri(h),d.bu=1;let c=this.getQuality(h);return d.quality=0===c.length?'["same"]':`["${c.join('","')}"]`,`${i}/api/dispatch_replay?${p.stringify(d)}`}getUri(e){let{playerType:t}=this.player,{scheduleOption:i}=this.player.options,{dispatch_server:s,default_server:r,safe_server:n}=i.playerData,a=s+r.uri,o=e?s+n.uri:a,l=document.createElement("a");return l.href="hls"===t?o:a,l.pathname}getQuality(e){let{scheduleOption:t}=this.player.options,{safe_definition:i,definition:s}=t.playerData;return(e?i:s)||["same"]}}class Ce extends Pe{constructor(e){super(e),this.fetch()}buildURL(){let{scheduleOption:e,liveOption:t}=this.player.options,{dispatch_server:i,log_info:s,app_type:r,live_subtitle:n,live_delay:a}=e.playerData,o={};return o.webinar_id=t.roomId,o.uid=s.uid,o.bu=1,o.rand=this.getRandom(),o.app_type=r,o.is_subtitle=n,o.is_delay_stream=a,`${i}/api/dispatch_play?${p.stringify(o)}`}}class ke{constructor(e){this.player=e;let{scheduleOption:t}=this.player.options;t.enable&&this.init()}init(){"live"===this.player.options.type?new Ce(this.player):new Re(this.player),this.player.setQuality=this.setQuality.bind(this)}setQuality(e){let{def:t}=this.player;if(!t.qualities)return void Z.warn("Scheduler setQuality - 没有获取到可用清晰度");if(!t.qualities.includes(e))return void Z.warn(`Scheduler setQuality - 清晰度参数不可用-${e}；可设置清晰度：${t.qualities.join()}`);t.currentQuality=e,t.currentQualityLines=t.allQuality[e];let i=t.currentQualityLines.find((e=>e.line===t.currentQualityLineName));t.currentQualityUrl=i[t.key],be.refreshToken(t),this.player.emit(Q.DEFINITION_CHANGE,{url:t.currentQualityUrl+"?token="+t.tokenStr,quality:e})}destroy(){}}ke.pluginName="schedule";const Ie=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],_e=(()=>{let e={};for(let t of Ie)if(t[1]in document){let i=0,s=t.length;for(;i<s;i++)e[Ie[0][i]]=t[i];return e}return e})(),Me={eventNameMap:{change:_e.fullscreenchange,error:_e.fullscreenerror},async request(e,t={navigationUI:"auto"}){if(e=e||document.documentElement,this.isEnabled)return await e[_e.requestFullscreen](t)},exit:async()=>await document[_e.exitFullscreen](),async toggle(e,t={navigationUI:"auto"}){return this.isFullscreen?await this.exit():await this.request(e,t)},onchange(e){this.on("change",e)},onerror(e){this.on("error",e)},on(e,t){this.eventNameMap[e]&&document.addEventListener(this.eventNameMap[e],t,!1)},off(e,t){this.eventNameMap[e]&&document.removeEventListener(this.eventNameMap[e],t,!1)},get isFullscreen(){return Boolean(document[_e.fullscreenElement])},get element(){return document[_e.fullscreenElement]},get isEnabled(){return Boolean(document[_e.fullscreenEnabled])}},De={async request(e){if(this.isEnabled(e))return await e.webkitEnterFullscreen()},exit:async e=>await e.webkitExitFullscreen(),async toggle(e){return this.isFullscreen?await this.exit(e):await this.request(e)},get isFullscreen(){return document.fullScreen||document.webkitIsFullScreen||!1},isEnabled:e=>!!e.webkitEnterFullscreen};class xe{constructor(e){this.player=e,this.fsChangeHandler=()=>{this.player.emit(Q.FULLSCREEN_CHANGED,null!==Me.element)},this.init()}init(){Me.isEnabled?(this.player.enterFullscreen=Me.request.bind(Me,this.player.root),this.player.exitFullscreen=Me.exit,this.defineProperty(Me),this.player.toggleFullscreen=Me.toggle.bind(Me,this.player.root)):De.isEnabled(this.player.video)&&(this.player.enterFullscreen=De.request.bind(De,this.player.video),this.player.exitFullscreen=De.exit.bind(De,this.player.video),this.defineProperty(De),this.player.toggleFullscreen=De.toggle.bind(De,this.player.video)),Me.on("change",this.fsChangeHandler)}defineProperty(e){Object.defineProperty(this.player,"isFullscreen",{get:()=>e.isFullscreen})}destroy(){Me.off("change",this.fsChangeHandler)}}xe.pluginName="fullscreen";class Oe{constructor(e){this.player=e,this.lagTimes=0,this.init()}init(){let{switchOption:e,type:t}=this.player.options;e.enable?(this.player.switch=this.switch.bind(this),"vod"!==t?this.registerListeners():Z.warn("Switcher 点播不运行卡顿切线")):Z.warn("Switcher 未开启切线功能")}registerListeners(){this.player.on(Q.LAG_REPORT,this.lag,this),this.player.on(Q.LAG_RECOVER,this.lagRecover,this)}lag(e){Z.warn("Switcher LAG_REPORT",e),this.lagTimes+=1,this.lagTimes>=3&&(Z.info("Switcher 开始卡顿切线"),this.lagTimes=0,this.switch())}lagRecover(e){Z.info("Switcher LAG_RECOVER",e),this.lagTimes=0}switch(e){let{def:t}=this.player,i=t.currentQualityCdnName||t.currentQualityLineName;if(e&&e===i)return void Z.warn("Switcher switch - 切线被忽略, 切换到了相同线路");let s=e?this.findLine(t.currentQualityLines,e):this.getNextLine(t.currentQualityLines,i);s?(t.currentQualityUrl=s[t.key],t.currentQualityCdnName=s.cdn_name,t.currentQualityLineName=s.line,be.refreshToken(t),this.player.emit(Q.LINE_CHANGE,{url:t.currentQualityUrl+"?token="+t.tokenStr,line:s.cdn_name||s.line,isReload:(s.cdn_name||s.line)===i})):Z.warn("Switcher switch - 切线被忽略, 线路未找到")}openLiveSubtitle(){}closeLiveSubtitle(){}getNextLine(e,t){let i=e.findIndex((e=>e.line===t))+1;return i>=e.length&&(i=0),e[i]}findLine(e,t){return e.find((e=>(e.cdn_name||e.line)===t))}destroy(){this.player.off(Q.LAG_REPORT),this.player.off(Q.LAG_RECOVER)}}Oe.pluginName="switcher";class Ae{constructor(e){this.player=e,this.isPursuing=!1,this.init()}init(){let{scheduleOption:e,pursueOption:t,type:i}=this.player.options;if(!t.enable)return void Z.warn("Pursue - 未开启追播功能");if("vod"===i)return void Z.warn("Pursue - 点播不运行追播策略");let{playerType:s}=this.player;1!=+e.playerData.live_type||s!==B.Hls?s!==B.Flash?s!==B.HlsNative?(this.pursueConfig=t[s],Z.info("Pursue 开启追播策略",this.pursueConfig),this.registerListeners()):Z.warn("Pursue - 播放原生m3u8时，不运行追播策略"):Z.warn("Pursue - flash不运行追播策略"):Z.warn("Pursue - 时移直播不运行追播策略")}registerListeners(){this._onTimeupdate=_(this.onTimeupdate.bind(this),1e3),this.player.video.addEventListener("timeupdate",this._onTimeupdate)}unRegisterListeners(){this.player.video.removeEventListener("timeupdate",this._onTimeupdate)}onTimeupdate(){let e=this.player.bufferedMax,t=e-this.player.currentTime,{bufferPursue:i,bufferSeek:s,bufferStop:r,pursueSpeed:n,mode:a}=this.pursueConfig;if(t>i||this.isPursuing&&t>r)switch(a){case"pursue":t>s?this.jumpTo(e-r):this.run(n);break;case"seek":this.jumpTo(e-r);break;default:Z.warn(`Pursue 追播类型配置错误，只支持 pursue、seek，配置为 ${a}`)}else this.walk()}jumpTo(e){e<=0||(Z.info("Pursue jumpTo",e),this.player.currentTime=e,this.player.playbackRate=1,this.isPursuing=!1)}run(e){this.isPursuing||e<1||(Z.info("Pursue run speed",e),this.player.playbackRate=e,this.isPursuing=!0)}walk(){this.player.playbackRate=1,this.isPursuing=!1}destroy(){this.unRegisterListeners()}}Ae.pluginName="pursue";class Ne{constructor(e){this.player=e,this.pauseTime=0,this.firstTime=0,this.init()}init(){let{type:e}=this.player.options;"vod"!==e?this.registerListeners():Z.warn("Replay - 点播不运行暂停恢复逻辑")}registerListeners(){this.player.on(Q.Play,this.onPlay,this),this.player.on(Q.Pause,this.onPause,this),this.player.on(Q.Loaded,this.onLoaded,this),this.player.on(Q.LINE_CHANGE,this.onLineChange,this)}onLineChange(){this.pauseTime=0,this.firstTime=0}onPlay(){this.pauseTime?this.handleReplay((performance.now()-this.pauseTime)/1e3):this.onFirstPlay()}handleReplay(e){Z.info("Replay 暂停时长",e);let t=this.player.bufferedMax,{scheduleOption:i,liveOption:s}=this.player.options,r=1==+i.playerData.live_type;if(s.type===B.Hls&&r&&this.player.cdnName===H.TX)isFinite(t)&&t>=this.player.currentTime+e?Z.info("Replay - 时移直播暂停恢复(短暂停)，从暂停处接着播放"):Z.info("Replay - 时移直播暂停恢复(长暂停)，定位到最新进度");else{if(s.type===B.Flash)return void this.player.reload();Z.info("Replay - 直播暂停恢复，跳到最新"),this.player.currentTime=this.player.currentTime+e}}onFirstPlay(){if(Z.info("Replay - 直播开始时，定位到最新进度"),this.firstTime)this.handleReplay((performance.now()-this.firstTime)/1e3);else{let{pursueOption:e}=this.player.options,t=e[this.player.playerType],i=this.player.bufferedMax-t.bufferStop;i>0&&(this.player.currentTime=this.player.currentTime+i)}}onLoaded(){this.player.playerType===B.Hls&&(this.firstTime=performance.now())}onPause(){this.pauseTime=performance.now()}destroy(){}}Ne.pluginName="replay";class Be{constructor(e){this.player=e,this.lastCurrentTime=0,this.lagTimes=0,this.lagBeginTime=0,this.detectInterval=0,this.gapDetectTime=500,this.gapEmitTime=3e3,this.init(),this.gapEmitLagTimes=this.gapEmitTime/this.gapDetectTime}init(){this.registerListeners()}registerListeners(){this.player.on(Q.Play,this.startDetect,this),this.player.on(Q.Pause,this.stopDetect,this),this.player.on(Q.Ended,this.stopDetect,this),this.player.on(Q.Error,this.onError,this),this.player.on(Q.Stalled,this.onError,this),this.player.on(Q.LINE_CHANGE,this.stopDetect,this),this.player.on(Q.PULL_STREAM_FAILED,this.stopDetect,this)}onError(e){e&&e.target&&"stalled"===e.type||this.startDetect()}startDetect(){this.detectInterval||(Z.info("Lag - 开始卡顿检测..."),this.detectInterval=window.setInterval((()=>{this.checkLag(this.player.currentTime),this.lagTimes&&this.lagTimes%this.gapEmitLagTimes==0?this.player.emit(Q.LAG_REPORT,{times:this.lagTimes,beginTime:this.lagBeginTime}):!this.lagTimes&&this.lagBeginTime&&(this.player.emit(Q.LAG_RECOVER,{lastTime:Date.now()-this.lagBeginTime}),this.lagBeginTime=0)}),this.gapDetectTime))}stopDetect(){Z.info("Lag - 停止卡顿检测"),clearInterval(this.detectInterval),this.detectInterval=0,this.lagTimes=0,this.lagBeginTime=0,this.lastCurrentTime=0}checkLag(e){this.lastCurrentTime===e?(this.lagTimes+=1,this.lagBeginTime||(this.lagBeginTime=Date.now()-this.gapDetectTime)):(this.lastCurrentTime=e,this.lagTimes=0)}destroy(){clearInterval(this.detectInterval),this.detectInterval=0,this.lagTimes=0,this.lagBeginTime=0,this.lastCurrentTime=0}}Be.pluginName="lag";class Ue{static create(){return Ue.S4()+Ue.S4()+"-"+Ue.S4()+"-"+Ue.S4()+"-"+Ue.S4()+"-"+Ue.S4()+Ue.S4()+Ue.S4()}static S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}}class Fe{constructor(e){this.player=e,this.rootWidth=0,this.rootHeight=0,this.tracksSize=30,this.renderTopPosition=0,this.renderBottomPosition=0,this.tracker=[],this.renderQueue=[],this.renderTimer=0,this.renderSuccessCount=0,this.renderAborted=!1,this.renderDelay=150,this.opened=!0,this.init()}init(){var e;let{videoNode:t,barrageOption:i}=this.player.options;if(!i.enable)return void Z.warn("Barrage - 未开启弹幕功能");this.opened=null==(e=i.defaultOpen)||e;let s=w();!1!==s?(this.cssTransition=s,this.elRoot=L("#"+t),this.elBarrageRoot=T("div",{},{class:"barrage-root"}),this.elRoot.appendChild(this.elBarrageRoot),this.registerListeners(),this.player.addBarrage=this.addBarrage.bind(this),this.player.clearBarrage=this.clearBarrage.bind(this),this.player.openBarrage=this.open.bind(this),this.player.closeBarrage=this.close.bind(this)):Z.warn("Barrage - not support css3 transition")}registerListeners(){this.player.on(Q.Ended,this.clearBarrage,this),this.player.on(Q.UIResize,this.resize,this),C(null,(()=>{this.clearBarrage()}))}open(){this.opened=!0,this.player.emit(Q.OPEN_BARRAGE)}close(){this.opened=!1,this.player.emit(Q.CLOSE_BARRAGE),this.clearBarrage()}addBarrage(e,t={}){this.opened?this.tracker.length?(this.renderQueue.push({id:Ue.create(),msg:this.filterContent(e),style:o(o({},this.player.options.barrageOption.style),t),width:0,totalDistance:0,rollSpeed:this.player.options.barrageOption.speed,rollTime:0,useTracks:0,tracks:[]}),this.renderTimer||this.render()):Z.warn("Barrage addBarrage - 添加弹幕失败，轨道数量为0"):Z.warn("Barrage addBarrage - 添加弹幕失败，弹幕未开启")}render(){try{this.renderToDom()}finally{this.renderEnd()}}renderToDom(){if(this.renderQueue.length){const e=this.renderQueue[0];let t=e.node;if(!t){e.node=t=T("div",{},{class:"barrage-item"}),t.innerHTML=e.msg;for(let i of Object.keys(e.style))t.style[i]=e.style[i]}if(this.elBarrageRoot.appendChild(t),e.useTracks=Math.ceil(t.offsetHeight/this.tracksSize),e.useTracks>this.tracker.length)return Z.warn("Barrage renderToDom - 弹幕占用高度过高，丢弃"),this.renderQueue.shift(),void this.elBarrageRoot.removeChild(t);e.width=t.offsetWidth,e.totalDistance=t.offsetWidth+this.rootWidth,e.rollTime=e.totalDistance/e.rollSpeed,this.addToTracks(e),e.tracks.length?(this.renderSuccessCount++,this.renderAborted=!1,this.renderQueue.shift(),t.setAttribute("data-y",e.tracks[0]+""),t.setAttribute("data-id",e.id),t.style.top=`${e.tracks[0]*this.tracksSize+this.renderTopPosition}px`,t.style[this.cssTransition.css]=`transform ${e.rollTime}s linear`,t.style.transform=`translate3d(-${e.totalDistance}px, 0, 0)`,t.addEventListener(this.cssTransition.event,(()=>{this.removeFromTracker(e.tracks,e.id),this.elBarrageRoot.removeChild(t)}),!1)):(this.renderAborted=!0,this.elBarrageRoot.removeChild(t))}}renderEnd(){this.renderQueue.length?(this.adaptRenderDelay(),this.renderTimer=window.setTimeout((()=>{this.render()}),this.renderDelay)):this.renderTimer=0}adaptRenderDelay(){this.renderAborted?(this.renderDelay+=40,this.renderSuccessCount=0):this.renderSuccessCount>10&&(this.renderDelay-=50,this.renderSuccessCount=0)}addToTracks(e){let t,i,s=[];for(let r=0;r<this.tracker.length;r++)if(t=this.tracker[r],t.length?(i=t[t.length-1],-R(i.node)>i.width?s.push(r):s=[]):s.push(r),s.length>=e.useTracks){e.tracks=s,s.forEach((t=>{this.tracker[t].push(e)}));break}}removeFromTracker(e,t){for(let i of e){const e=this.tracker[i];if(!e)continue;let s=0,r=e.length;for(;s<r;s++)if(e[s].id===t){e.splice(s,1);break}}}filterContent(e){return e&&e.replace(/<(?!img).*?>/gi,"")}clearBarrage(){this.eachNode((e=>{e.remove()})),this.tracker.forEach((e=>[])),this.renderQueue=[],this.player.emit(Q.CLEAR_BARRAGE)}computedTracks(){let{positionRange:e}=this.player.options.barrageOption;this.player.isFullscreen?(this.renderTopPosition=window.innerHeight*e[0],this.renderBottomPosition=window.innerHeight*e[1]):(this.renderTopPosition=this.rootHeight*e[0],this.renderBottomPosition=this.rootHeight*e[1]);let t=this.renderBottomPosition-this.renderTopPosition;const i=Math.floor(t/this.tracksSize);this.tracker=new Array(i);for(let s=0;s<i;s++)this.tracker[s]=[];Z.info("Barrage computedTracks",i)}resize(){Z.info("Barrage resize"),this.rootWidth=this.elRoot.clientWidth,this.rootHeight=this.elRoot.clientHeight,this.clearBarrage(),this.computedTracks()}eachNode(e){let t,i,s=this.elBarrageRoot.firstChild;for(;s;)1===s.nodeType&&(i=s.getAttribute("data-y"),t=s.getAttribute("data-id"),i&&t&&e(s,+i,t)),s=s.nextSibling}destroy(){var e;this.clearBarrage(),null==(e=this.elBarrageRoot)||e.remove()}}Fe.pluginName="barrage";var qe,He;class Ve{constructor(e){this.player=e,this.timer=0,this.createMarqueeItem=e=>{if(1===e){const e=this.elMarqueeRoot.querySelector(".marquee");e&&e.remove()}else if(!this.checkPosition())return!1;let{text:t,position:i=1,duration:s=6,alpha:r,fontSize:n,fontColor:a,height:o}=this.player.options.marqueeOption;if(!t)return void Z.warn("Marquee - 未提供配置：text");let l=T("div",{innerHTML:t},{class:"marquee",style:(r?`opacity: ${r/100};`:"")+(n?`font-size: ${n}px;`:"")+(a?`color: ${a};`:"")+(o?`line-height: ${o}px;`:"")});this.elMarqueeRoot.appendChild(l);const h=this.elMarqueeRoot.offsetWidth,d=this.elMarqueeRoot.offsetHeight,c=l.offsetWidth,u=l.offsetHeight,p={1:1,2:"20%",3:"50%",4:"80%"};switch(i){case 1:if(0===e){const e=.2*d,t=Math.floor(.6*d/u);let i=[e];for(let r=1;r<=t;r+=1)i.push(i[r-1]+u);let s=Math.floor(Math.random()*i.length);l.style.top=`${i[s]}px`}else.2*d>=u/2?(l.style.top=60*Math.random()+20+"%",l.style.transform="translateY(-50%)"):l.style.top=Math.random()*(d-u)+"px";break;case 2:.2*d>=u/2?(l.style.top=p[i],l.style.transform="translateY(-50%)"):l.style.top="0%";break;case 3:l.style.top=p[i],l.style.transform="translateY(-50%)";break;case 4:.2*d>=u/2?(l.style.top=p[i],l.style.transform="translateY(-50%)"):l.style.bottom="0%"}if(0===e)l.style.left="100%",l.style[this.cssTransition.css]=`transform ${s}s linear`,this._stepMoveCss3({label:l,textWidth:c,rootWidth:h});else{const e=h&&c&&(h-c)/h*100,t=e&&Math.random()*e;l.style.left=`${t}%`}},this.init()}init(){let{videoNode:e,marqueeOption:t}=this.player.options;if(!t.enable)return void Z.warn("Marquee - 未开启跑马灯功能");let i=w();!1!==i?(this.cssTransition=i,this.elRoot=L("#"+e),this.elMarqueeRoot=T("div",{},{class:"marquee-root"}),this.elRoot.appendChild(this.elMarqueeRoot),this.registerListeners(),this.createMarquee()):Z.warn("Marquee - not support css3 transition")}registerListeners(){C((()=>{this.timer||this.createMarquee()}),(()=>{this.destroy()}))}createMarquee(){let{type:e=0,interval:t=5}=this.player.options.marqueeOption;this.timer=window.setInterval(this.createMarqueeItem,1e3*t,e),this.createMarqueeItem(e)}_stepMoveCss3(e){e.label.addEventListener(this.cssTransition.event,(()=>{e.label.remove()})),e.label.style.transform=`translate(-${e.textWidth+e.rootWidth}px, -50%)`}checkPosition(){const e=this.elMarqueeRoot.querySelectorAll(".marquee");for(let t=0;t<e.length;t+=1){if(0===R(e[t]))return!1}return!0}destroy(){var e;clearInterval(this.timer),this.timer=0;const t=this.elMarqueeRoot.querySelectorAll(".marquee");let i=0,s=t.length;for(;i<s;i++)t[i].remove();null==(e=this.elMarqueeRoot)||e.remove()}}Ve.pluginName="marquee";class Qe{constructor(e){this.player=e,this.init()}init(){this.player.capture=this.capture.bind(this)}capture(){this.elCanvas||(this.elCanvas=document.createElement("canvas"));let e=this.player.video;this.elCanvas.width=e.videoWidth,this.elCanvas.height=e.videoHeight;let t=this.elCanvas.getContext("2d");return null==t||t.drawImage(e,0,0),this.elCanvas.toDataURL("image/jpeg")}destroy(){}}Qe.pluginName="capture";class We{constructor(e,t){this.elRoot=e,this.vhPlayer=t,this.elMedia=t.video}}class $e extends We{constructor(e,t){super(e,t),this.width=0,this.cacheLayerX=0,this.cacheX=-1,this.cachePercent=-1,this.isSeeking=!1,this.onMouseDown=(e,t)=>{this.isSeeking=!0,this.cacheX=e.clientX;let i=e.clientX-t;e.target===this.elPos&&(i=e.clientX-t/2),this.cacheLayerX=e.target===this.elPos?i-8:i,this.percentMove(this.cacheLayerX/this.width*100)},this.onMouseMove=e=>{-1!==this.cacheX&&this.percentMove((this.cacheLayerX+e.clientX-this.cacheX)/this.width*100)},this.mouseUp=e=>{-1!==this.cacheX&&(this.isSeeking=!1,this.elMedia.currentTime=(this.cacheLayerX+e.clientX-this.cacheX)/this.width*this.elMedia.duration,this.cacheX=-1)},this.onEnded=()=>{this.isSeeking||(this.elBarCurrent.style.transform="translateX(0%)",this.elBarBuffered.style.transform="translateX(0%)",this.elPos.style.transform=`translate(${this.width}px, -50%)`)},this.init(),this.registerListeners()}init(){this.elBarRoot=T("div",{},{class:"bar-root"}),this.elBarRoot.innerHTML='\n<div class="bar bar-current"></div>\n<div class="bar bar-buffered"></div>\n<div class="pos"></div>\n',this.elRoot.appendChild(this.elBarRoot),this.elBarCurrent=this.elBarRoot.querySelector(".bar-current"),this.elBarBuffered=this.elBarRoot.querySelector(".bar-buffered"),this.elPos=this.elBarRoot.querySelector(".pos"),setTimeout((()=>{this.width=this.elBarRoot.clientWidth}),100)}registerListeners(){k(this.elBarRoot,"down",this.onMouseDown),k(this.elRoot,"move",this.onMouseMove),k(this.elBarRoot,"up",this.mouseUp),this.elRoot.addEventListener("mouseleave",this.mouseUp),this._onTimeupdate=_(this.onTimeupdate.bind(this),500),this._onProgress=_(this.onProgress.bind(this),500),this.elMedia.addEventListener("timeupdate",this._onTimeupdate),this.elMedia.addEventListener("progress",this._onProgress),this.elMedia.addEventListener("ended",this.onEnded),this.vhPlayer.on(Q.UIResize,this.onResize,this)}onResize(){this.width=this.elBarRoot.clientWidth,-1!==this.cachePercent&&this.percentMove(this.cachePercent)}onTimeupdate(){this.isSeeking||this.percentMove(this.elMedia.currentTime/this.elMedia.duration*100)}onProgress(){let e=le(this.elMedia)/this.elMedia.duration*100;this.elBarBuffered.style.transform=`translateX(${-100+e}%)`}percentMove(e){e>100||e<0||(this.cachePercent=e,this.elBarCurrent.style.transform=`translateX(${-100+e}%)`,this.elPos.style.transform=`translate(${e*this.width/100}px, -50%)`)}unRegisterListeners(){this.elMedia.removeEventListener("timeupdate",this._onTimeupdate),this.elMedia.removeEventListener("progress",this._onProgress),this.elMedia.removeEventListener("ended",this.onEnded)}destroy(){this.unRegisterListeners()}}class Xe extends We{constructor(e,t){super(e,t),this.width=0,this.cacheLayerX=0,this.cacheX=-1,this.cachePercent=-1,this.timeShiftMax=7200,this.timeShiftDuration=7110,this.onMouseDown=e=>{this.cacheX=e.clientX,this.cacheLayerX=e.target===this.elPos?e.layerX-8:e.layerX,this.percentMove(this.cacheLayerX/this.width*100)},this.onMouseMove=e=>{-1!==this.cacheX&&this.percentMove((this.cacheLayerX+e.clientX-this.cacheX)/this.width*100)},this.mouseUp=e=>{if(-1===this.cacheX)return;let t=(this.cacheLayerX+e.clientX-this.cacheX)/this.width*this.timeShiftDuration;t=this.timeShiftDuration-t+90,t=t>this.timeShiftMax?this.timeShiftMax:t,this.vhPlayer.handleTimeShift(t),this.cacheX=-1},this.init(),this.registerListeners()}init(){this.elTsBarRoot=T("div",{},{class:"bar-root"}),this.elTsBarRoot.innerHTML='\n<div class="bar bar-current"></div>\n<div class="pos hide"></div>\n',this.elRoot.appendChild(this.elTsBarRoot),this.elBarCurrent=this.elTsBarRoot.querySelector(".bar-current"),this.elPos=this.elTsBarRoot.querySelector(".pos"),setTimeout((()=>{this.width=this.elTsBarRoot.clientWidth,this.percentMove(100),this.elPos.classList.remove("hide")}),100)}registerListeners(){this.elTsBarRoot.addEventListener("mousedown",this.onMouseDown),this.elRoot.addEventListener("mousemove",this.onMouseMove),this.elRoot.addEventListener("mouseleave",this.mouseUp),this.elTsBarRoot.addEventListener("mouseup",this.mouseUp),this.vhPlayer.on(Q.UIResize,this.onResize,this)}onResize(){this.width=this.elTsBarRoot.clientWidth,-1!==this.cachePercent&&this.percentMove(this.cachePercent)}percentMove(e){e>100||e<0||(this.cachePercent=e,this.elBarCurrent.style.transform=`translateX(${-100+e}%)`,this.elPos.style.transform=`translate(${e*this.width/100}px, -50%)`)}destroy(){}}class Ge extends We{constructor(e,t){super(e,t),this.onPlay=()=>{this.elIcon.classList.remove("icon-player-bofang"),this.elIcon.classList.add("icon-player-bofangzanting")},this.onPause=()=>{this.elIcon.classList.remove("icon-player-bofangzanting"),this.elIcon.classList.add("icon-player-bofang")},this.togglePlay=()=>{this.elMedia.paused?this.elMedia.play():this.elMedia.pause()},this.init(),this.registerListeners()}init(){this.elPlayRoot=T("div",{},{class:"ui-play-root"}),this.elPlayRoot.innerHTML='\n<i class="iconfont-player" title="播放/暂停"></i>\n',this.elRoot.appendChild(this.elPlayRoot),this.elIcon=this.elPlayRoot.querySelector(".iconfont-player"),this.elMedia.paused?this.onPause():this.onPlay()}registerListeners(){this.elIcon.addEventListener("click",this.togglePlay),this.elMedia.addEventListener("play",this.onPlay),this.elMedia.addEventListener("pause",this.onPause)}unRegisterListeners(){this.elMedia.removeEventListener("play",this.onPlay),this.elMedia.removeEventListener("pause",this.onPause)}destroy(){this.unRegisterListeners()}}class je extends We{constructor(e,t){super(e,t),this.reload=()=>{this.vhPlayer.emit(Q.LINE_CHANGE,{isReload:!0})},this.init(),this.registerListeners()}init(){this.elReloadRoot=T("div",{},{class:"ui-reload-root"}),this.elReloadRoot.innerHTML='\n<i class="iconfont-player icon-player-reload" title="刷新"></i>\n',this.elRoot.appendChild(this.elReloadRoot),this.elIcon=this.elReloadRoot.querySelector(".iconfont-player")}registerListeners(){this.elIcon.addEventListener("click",this.reload)}destroy(){this.elIcon.removeEventListener("click",this.reload)}}class ze extends We{constructor(e,t){super(e,t),this.onTimeupdate=()=>{this.elDurationCurrent.textContent=this.timeFormat(this.elMedia.currentTime)},this.onDurationChange=()=>{this.elDurationTotal.textContent=this.timeFormat(this.elMedia.duration)},this.onEnd=()=>{this.elDurationCurrent.textContent=this.timeFormat(this.elMedia.duration)},this.init(),this.registerListeners()}init(){this.elDurationRoot=T("div",{},{class:"ui-duration-root"}),this.elDurationRoot.innerHTML='\n<span class="duration duration-current">00</span> / <span class="duration duration-total"></span>\n',this.elRoot.appendChild(this.elDurationRoot),this.elDurationCurrent=this.elDurationRoot.querySelector(".duration-current"),this.elDurationTotal=this.elDurationRoot.querySelector(".duration-total"),this.elDurationCurrent.textContent=this.timeFormat(0)}registerListeners(){this.elMedia.addEventListener("timeupdate",this.onTimeupdate),this.elMedia.addEventListener("durationchange",this.onDurationChange),this.elMedia.addEventListener("ended",this.onEnd)}timeFormat(e){let t=Math.floor(e/3600),i=Math.floor(e/60%60),s=Math.floor(e%60);return`${t>0?this.fillZero(t,!1)+":":""}${this.fillZero(i,!0)}:${this.fillZero(s,!0)}`}fillZero(e,t){return e>0?e<10?"0"+e:e+"":t?"00":""}unRegisterListeners(){this.elMedia.removeEventListener("timeupdate",this.onTimeupdate),this.elMedia.removeEventListener("durationchange",this.onDurationChange),this.elMedia.removeEventListener("ended",this.onEnd)}destroy(){this.unRegisterListeners()}}class Ye extends We{constructor(e,t){super(e,t),this.opened=!0,this.onClick=()=>{this.opened?(this.elIcon.classList.replace("icon-player-danmukaiqi","icon-player-danmuguanbi"),this.vhPlayer.closeBarrage()):(this.elIcon.classList.replace("icon-player-danmuguanbi","icon-player-danmukaiqi"),this.vhPlayer.openBarrage()),this.opened=!this.opened},this.init(),this.registerListeners()}init(){let{barrageOption:e}=this.vhPlayer.options;e.enable&&(this.elBarrageRoot=T("div",{},{class:"ui-barrage-root"}),this.elBarrageRoot.innerHTML='\n      <i class="iconfont-player icon-player-danmukaiqi"></i>\n    ',this.elRoot.appendChild(this.elBarrageRoot),this.elIcon=this.elBarrageRoot.querySelector(".iconfont-player"))}registerListeners(){this.elIcon.addEventListener("click",this.onClick)}destroy(){this.elIcon.removeEventListener("click",this.onClick)}}class Ke extends We{constructor(e,t){super(e,t),this.timer=0,this.onClick=e=>{this.changeVolume(e.layerY-this.height)},this.onMouseOverIcon=()=>{this.mouseOverShowSlider(),this.height||(this.height=this.elSliderRoot.clientHeight)},this.mouseOverShowSlider=()=>{this.vhPlayer.emit(Q.UISingleDisplay,this.constructor.name),this.elSlider.classList.add("active"),this.timer&&clearTimeout(this.timer)},this.mouseLeaveHideSlider=()=>{this.timer&&clearTimeout(this.timer),this.timer=window.setTimeout((()=>{this.elSlider.classList.remove("active")}),1e3)},this.toggleMuted=()=>{this.vhPlayer.video.muted=!this.vhPlayer.video.muted},this.onDrag=e=>{e.preventDefault(),0!==e.clientY&&this.changeLayout(e.layerY-2)},this.onDragEnd=e=>{e.preventDefault(),this.changeVolume(e.layerY-2)},this.init(),this.registerListeners()}init(){this.elVolRoot=T("div",{},{class:"ui-volume-root"}),this.elVolRoot.innerHTML='\n<i class="iconfont-player iconfont-player-vol"></i>\n<div class="volume-slider">\n  <div class="slider-root">\n    <div class="slider"></div>\n  </div>\n  <div class="pos" draggable="true"></div>\n</div>\n',this.elRoot.appendChild(this.elVolRoot),this.elIcon=this.elVolRoot.querySelector(".iconfont-player"),this.elSlider=this.elVolRoot.querySelector(".volume-slider"),this.elSliderRoot=this.elVolRoot.querySelector(".slider-root"),this.elSliderVol=this.elVolRoot.querySelector(".slider"),this.elSliderPos=this.elVolRoot.querySelector(".pos"),this.onVolumechange()}registerListeners(){this.elIcon.addEventListener("click",this.toggleMuted),this.elIcon.addEventListener("mouseenter",this.onMouseOverIcon),this.elIcon.addEventListener("mouseleave",this.mouseLeaveHideSlider),this.elSlider.addEventListener("mouseenter",this.mouseOverShowSlider),this.elSlider.addEventListener("mouseleave",this.mouseLeaveHideSlider),this.elSliderRoot.addEventListener("click",this.onClick),this.elSliderPos.addEventListener("drag",this.onDrag),this.elSliderPos.addEventListener("dragend",this.onDragEnd),this.vhPlayer.on(Q.Volumechange,this.onVolumechange,this)}onVolumechange(){let e=this.vhPlayer.video.muted?0:this.vhPlayer.video.volume;this.elSliderVol.style.transform=`translateY(${100*(1-e)}%)`,this.elSliderPos.style.transform=`translateY(${70*-e}px)`,this.vhPlayer.video.muted?(this.elIcon.classList.add("icon-player-jingyin"),this.elIcon.classList.remove("icon-player-shengyin")):(this.elIcon.classList.remove("icon-player-jingyin"),this.elIcon.classList.add("icon-player-shengyin"))}changeVolume(e){let t=this.height;e>0?e=0:e<-t&&(e=-t);let i=(t+e)/t;this.vhPlayer.video.volume=1-i,this.vhPlayer.video.muted=1===i}changeLayout(e){let t=this.height;e>0?e=0:e<-t&&(e=-t),this.elSliderVol.style.transform=`translateY(${(t+e)/t*100}%)`,this.elSliderPos.style.transform=`translateY(${e}px)`}destroy(){}}class Je extends We{constructor(e,t){super(e,t),this.toggleFs=()=>{this.vhPlayer.toggleFullscreen()},this.init(),this.registerListeners()}init(){this.elFsRoot=T("div",{},{class:"ui-fullscreen-root"}),this.elFsRoot.innerHTML='\n<i class="iconfont-player icon-player-quanping1" title="全屏"></i>\n',this.elRoot.appendChild(this.elFsRoot),this.elIcon=this.elFsRoot.querySelector(".iconfont-player")}registerListeners(){this.elIcon.addEventListener("click",this.toggleFs),this.vhPlayer.on(Q.FULLSCREEN_CHANGED,this.onFsChange,this)}onFsChange(e){e?this.elIcon.classList.replace("icon-player-quanping1","icon-player-quanping"):this.elIcon.classList.replace("icon-player-quanping","icon-player-quanping1")}unRegisterListeners(){this.elIcon.removeEventListener("click",this.toggleFs),this.vhPlayer.off(Q.FULLSCREEN_CHANGED)}destroy(){this.unRegisterListeners()}}(He=qe||(qe={})).Vtt="vtt",He.Line="line",He.Quality="quality";class Ze extends We{constructor(e,t){super(e,t),this.mapping={[qe.Vtt]:this.elContentVtt,[qe.Line]:this.elContentLine,[qe.Quality]:this.elContentQuality},this.timer1=-1,this.onContentMouseLeave=()=>{this.timer1=window.setTimeout((()=>{this.hide()}),1e3)},this.onClick=()=>{this.elSettingContent.classList.contains("active")?this.hide():(this.vhPlayer.emit(Q.UISingleDisplay,this.constructor.name),this.elSettingContent.classList.add("active"))},this.init(),this.registerListeners()}init(){this.elSettingRoot=T("div",{},{class:"ui-setting-root"}),this.elSettingRoot.innerHTML='\n<i class="iconfont-player icon-player-diandiandian" title="设置"></i>\n<ul class="setting-content"></ul>\n',this.elRoot.appendChild(this.elSettingRoot),this.elIcon=this.elSettingRoot.querySelector(".iconfont-player"),this.elSettingContent=this.elSettingRoot.querySelector(".setting-content")}registerListeners(){this.vhPlayer.on(Q.SCHEDULER_COMPLETE,this.onScheduleComplete,this),this.vhPlayer.on(Q.VTT_ADDED,this.addVttUI,this),this.vhPlayer.on(Q.UISingleDisplay,this.onSingleDisplay,this),this.vhPlayer.on(Q.DEFINITION_CHANGE,this.onQualityChange,this),this.vhPlayer.on(Q.LINE_CHANGE,this.onLineChange,this),this.vhPlayer.on(Q.VTT_SELECTED,this.onVttSelected,this),this.vhPlayer.on(Q.VTT_CLOSED,this.onVttClosed,this),this.elIcon.addEventListener("click",this.onClick),this.elSettingContent.addEventListener("mouseleave",this.onContentMouseLeave)}bindMouseEvent(e){this.mapping[e].addEventListener("mouseenter",(()=>{this.timer1&&window.clearTimeout(this.timer1)})),this.mapping[e].addEventListener("mouseleave",(e=>{e.currentTarget.classList.remove("active")}))}showSelectedUI(e){for(let t of Object.keys(this.mapping))t===e?this.mapping[t].classList.add("active"):this.mapping[t]&&this.mapping[t].classList.remove("active")}showSelectedUI2(e,t){let i=this.mapping[e].querySelectorAll("li");for(let s of i)s.dataset.val===t?s.classList.add("active"):s.classList.remove("active")}onQualityChange(e){this.showSelectedUI2(qe.Quality,e.quality)}onLineChange(e){this.showSelectedUI2(qe.Line,e.line)}onVttSelected(e){this.showSelectedUI2(qe.Vtt,e.vtt)}onVttClosed(){this.showSelectedUI2(qe.Vtt,"")}onScheduleComplete(){let{scheduleOption:e}=this.vhPlayer.options;if(e.enable){let e=document.createElement("li"),t=document.createElement("li");e.textContent="线路",t.textContent="清晰度",e.addEventListener("click",(()=>{this.showSelectedUI(qe.Line)})),t.addEventListener("click",(()=>{this.showSelectedUI(qe.Quality)})),this.elSettingContent.appendChild(e),this.elSettingContent.appendChild(t),this.addLineUI(),this.addQualityUI()}}addLineUI(){this.elContentLine=T("ul",{},{class:"setting-content2 setting-content-line"}),this.elSettingRoot.appendChild(this.elContentLine),this.mapping.line=this.elContentLine,this.elSettingContent2=this.elSettingRoot.querySelectorAll(".setting-content2"),this.bindMouseEvent(qe.Line);let{lines:e,currentQualityCdnName:t,currentQualityLineName:i}=this.vhPlayer.def,{uiOptions:s}=this.vhPlayer.options;const r=!!(null==s?void 0:s.line)&&s.line;let n=document.createDocumentFragment();for(let a of e){let e=document.createElement("li");e.textContent=r&&r[a]?r[a]:a,e.dataset.val=a,a===(t||i)&&e.classList.add("active"),e.addEventListener("click",(e=>{this.vhPlayer.switch(e.currentTarget.dataset.val),this.hide()})),n.appendChild(e)}this.elContentLine.appendChild(n)}addQualityUI(){this.elContentQuality=T("ul",{},{class:"setting-content2 setting-content-quality"}),this.elSettingRoot.appendChild(this.elContentQuality),this.mapping.quality=this.elContentQuality,this.elSettingContent2=this.elSettingRoot.querySelectorAll(".setting-content2"),this.bindMouseEvent(qe.Quality);let{qualities:e,currentQuality:t}=this.vhPlayer.def,{uiOptions:i}=this.vhPlayer.options;const s=!!(null==i?void 0:i.quality)&&i.quality;let r=document.createDocumentFragment();for(let n of e){let e=document.createElement("li");e.textContent=s&&s[n]?s[n]:n,e.dataset.val=n,n===t&&e.classList.add("active"),e.addEventListener("click",(e=>{this.vhPlayer.setQuality(e.currentTarget.dataset.val),this.hide()})),r.appendChild(e)}this.elContentQuality.appendChild(r)}addVttUI(){let{vttOptions:e,type:t}=this.vhPlayer.options;if(e.enable&&"vod"===t){this.elContentVtt=T("ul",{},{class:"setting-content2 setting-content-vtt"}),this.elSettingRoot.appendChild(this.elContentVtt),this.mapping.vtt=this.elContentVtt,this.elSettingContent2=this.elSettingRoot.querySelectorAll(".setting-content2"),this.bindMouseEvent(qe.Vtt);let t=document.createElement("li");t.textContent="字幕",t.addEventListener("click",(()=>{this.showSelectedUI(qe.Vtt)})),this.elSettingContent.appendChild(t);let i=document.createElement("li");i.textContent="关闭",i.dataset.val="",i.addEventListener("click",(()=>{this.vhPlayer.closeVtt(),this.hide()})),this.elContentVtt.appendChild(i);let s=document.createDocumentFragment();for(let r of e.tracks){let e=document.createElement("li");e.textContent=r.label||r.srclang,e.dataset.val=r.srclang,r.default&&e.classList.add("active"),e.addEventListener("click",(()=>{this.vhPlayer.selectVtt(r.srclang),this.hide()})),s.appendChild(e)}this.elContentVtt.appendChild(s)}}onSingleDisplay(e){e!==this.constructor.name&&this.hide()}hide(){this.elSettingContent.classList.remove("active"),this.elSettingContent2.forEach((e=>e.classList.remove("active")))}destroy(){}}class et{constructor(e){this.player=e,this.toggleShow=e=>{if(this.elControlWrapper.classList.contains("active")){let t=0,i=e.target;for(;t<6&&i&&i!==this.elControlWrapper;)i=i.parentNode,t+=1;i!==this.elControlWrapper&&this.elControlWrapper.classList.remove("active")}else this.elControlWrapper.classList.add("active")},this.init()}init(){let{videoNode:e,scheduleOption:t,vttOptions:i,type:s,controls:r}=this.player.options;if("custom"!==r)return void Z.warn("UI - 未开启自定义控制栏");this.elRoot=L("#"+e),this.elControlWrapper=T("div",{},{class:"player-control-wrapper active "+("live"===s?"is-live":"")}),this.elLoadingWrapper=T("div",{},{class:"player-loading-wrapper hide"}),this.elLoadingWrapper.innerHTML='\n      <i class="iconfont-player icon-player-Loading"></i>\n    ',this.elControlWrapper.innerHTML='\n      <div class="bar-wrapper"></div>\n      <div class="tools-wrapper">\n        <div class="tools-wrapper-left"></div>\n        <div class="tools-wrapper-right"></div>\n      </div>',this.elRoot.appendChild(this.elLoadingWrapper),this.elRoot.appendChild(this.elControlWrapper);let n=this.elRoot.querySelector(".tools-wrapper-left"),a=this.elRoot.querySelector(".tools-wrapper-right"),o=this.elRoot.querySelector(".bar-wrapper");new Ge(n,this.player),"live"===s&&new je(n,this.player),"vod"===s?(new $e(o,this.player),new ze(n,this.player)):1===t.playerData.live_type?new Xe(o,this.player):o.remove(),new Ye(a,this.player),"pc"===I.platform&&new Ke(a,this.player),new Je(a,this.player),(t.enable||i.enable&&"vod"===s)&&new Ze(a,this.player),this.player.openUI=this.openUI.bind(this),this.player.hideUI=this.hideUI.bind(this),this.registerListeners()}registerListeners(){this.elRoot.addEventListener("click",this.toggleShow),this.player.on(Q.Waiting,(()=>{this.elLoadingWrapper.classList.remove("hide")})),this.player.on(Q.Canplay,(()=>{this.elLoadingWrapper.classList.add("hide")}))}openUI(){this.elControlWrapper.classList.add("active")}hideUI(){this.elControlWrapper.classList.remove("active")}destroy(){var e;null==(e=this.elControlWrapper)||e.remove()}}et.pluginName="UI";class tt{constructor(e){this.player=e,this.init()}init(){var e;let{vttOptions:t,type:i}=this.player.options;"live"!==i?t.enable?(null==(e=t.tracks)?void 0:e.length)?(this.loadTracks(),this.player.selectVtt=this.selectVtt.bind(this),this.player.closeVtt=this.closeVtt.bind(this)):Z.warn("Vtt - 字幕列表为空"):Z.warn("Vtt - 未开启字幕"):Z.warn("Vtt - 暂不支持对直播添加字幕")}loadTracks(){for(let e of this.player.options.vttOptions.tracks)this.addTracks(e);this.player.emit(Q.VTT_ADDED)}selectVtt(e){for(let t of this.player.video.textTracks)t.language===e?(t.mode="showing",this.player.emit(Q.VTT_SELECTED,{vtt:e})):t.mode="hidden"}closeVtt(){for(let e of this.player.video.textTracks)e.mode="hidden";this.player.emit(Q.VTT_CLOSED)}addTracks(e){let t=T("track",{},{label:e.label||e.srclang,kind:e.kind,srclang:e.srclang,src:e.src});t.default=!0===e.default,this.player.video.appendChild(t)}destroy(){}}tt.pluginName="Vtt";const it=class{constructor(e){this.player=e,this.init()}init(){let{type:e}=this.player.options;"vod"!==e?this.player.playerType===B.Hls?(this.player.handleTimeShift=this.handleTimeShift.bind(this),this.registerListeners()):Z.warn(`TimeShift - 直播时移只支持hls，当前播放器类型：${this.player.playerType}`):Z.warn("TimeShift - 点播活动不运行直播时移")}registerListeners(){this.player.on(Q.SCHEDULER_COMPLETE,this.onScheduleComplete,this)}handleTimeShift(e=0){if(this.player.cdnName!==H.TX)return void Z.warn(`TimeShift - 直播时移只支持腾讯线路，当前线路：${this.player.cdnName}`);e=e<it.TENCENT_DELAY?it.TENCENT_DELAY:Math.round(e);let t=(this.player.vPlayer.url||this.player.vPlayer.cacheUrl).split("?")[0]+this.creatTencentTimeShiftUrl(e);this.player.load(t),this.player.emit(Q.LIVE_TIMESHIFT,{delay:e,url:t})}onScheduleComplete(e){e.timeShift&&this.player.load(`${e.url}&delay=${it.TENCENT_DELAY}`)}creatAliyunTimeShiftUrl(e){return`?aliyunols=on&lhs_start_human_s_8=${e}`}creatTencentTimeShiftUrl(e){let{def:t}=this.player;return be.refreshToken(t),`?delay=${e}&token=${t.tokenStr}`}destroy(){}};let st=it;st.pluginName="timeShift",st.TENCENT_DELAY=90,Se.use(ke),Se.use(xe),Se.use(Oe),Se.use(Ae),Se.use(Ne),Se.use(Be),Se.use(Fe),Se.use(Ve),Se.use(Qe),Se.use(et),Se.use(tt),Se.use(st);const rt=document.querySelector.bind(document);function nt(e,t,i="click"){"string"==typeof e&&(e=rt(e)),e&&e.addEventListener(i,t)}function at(){let e={};return new window.URL(location.href).searchParams.forEach(((t,i,s)=>{e[i]=t})),e}let ot;const lt={dispatch_server:"https://gslb.e.vhall.com",log_info:{uid:"10000127"}},ht=l(o({},lt),{safe_definition:["same","a","360p"],definition:["same","a","360p"],default_server:{uri:"/vhallyun/vhallcoop/02290ce8c85e49463092cb860d455983/58faa1f6/02290ce8c85e49463092cb860d455983.m3u8",mp4_domainnames:""},subtitle_info:{}}),dt=l(o({},lt),{app_type:0,live_type:0,live_subtitle:0,live_delay:0,live_duration:0});let ct=[location.pathname+"out.flv",location.pathname+"qhh.flv"],ut=[location.pathname+"hls1/out.m3u8",location.pathname+"hls2/qhh.m3u8"];function pt(e="flv",t=0){let i="flv"===e?ct:ut;if(2===i.length){let e=at();console.log("ana querystring",e),e.url&&i.unshift(e.url)}return{index:t=t>=i.length?0:t,url:i[t]+"?token=alibaba"}}const yt={videoNode:"vh-player",type:"vod",autoplay:!0,controls:"custom",muted:!1,debug:!0};function mt(){let e;function t(){const t=function(){let e=at();console.log("ana querystring",e);const t=e.type;return"vod"===t&&"true"===e.schedule&&e.scheduleUri&&(ht.default_server.uri=e.scheduleUri),"live"===t&&"true"===e.timeshift&&(dt.live_type=1),l(o({},yt),{type:t||"vod",appId:e.appId,accountId:405,token:"vhall",liveOption:{roomId:e.roomId,type:e.playerType||B.Flv},vodOption:{recordId:e.recordId},scheduleOption:{enable:"true"===e.schedule,playerData:"live"===t?dt:ht,debugUrl:e.url?e.url+(-1!==e.url.indexOf("?token")?"":"?token=alibaba"):"",debugCDN:e.cdn||H.TX,debugPlayer:e.playerType},peer5Option:{enable:"true"===e.peer5,customerId:e.peer5CustomerId,fallback:!0},switchOption:{enable:!0},pursueOption:{enable:!0},marqueeOption:{enable:!0,type:1,text:"test marquee"},vttOptions:{enable:!0,tracks:[{label:"英文",kind:"subtitles",srclang:"en",src:location.pathname+"vtt/subtitles_en.vtt"},{label:"中文",kind:"subtitles",srclang:"zh",src:location.pathname+"vtt/subtitles_zh.vtt",default:!0}]},uiOptions:{line:{[H.TX]:"腾讯线路",[H.ALI]:"备用线路1",[H.HW]:"备用线路2",[H.CY]:"备用线路3"},quality:{[F.PSame]:"原画",[F.P720]:"高清",[F.P480]:"标清",[F.P360]:"流畅",[F.Pa]:"音频"}}})}();Se.createInstance(t,(i=>{if(e=i,function(e){e.on(Se.Events.FULLSCREEN_CHANGED,(e=>{console.log("Events.FULLSCREEN_CHANGED",e)}))}(i),function(e){const t=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","ratechange","seeked","seeking","stalled","suspend","waiting"];for(let i of t)e.video.addEventListener(i,(()=>{console.log(`[vlog - origin event: ${i}]`)}))}(i),!t.scheduleOption.enable)if(t.scheduleOption.debugUrl)e.load(t.scheduleOption.debugUrl);else{const t={flv:"out.flv",hls:"hls1/out.m3u8",native:"hls1/out.m3u8",flash:"",dash:"dash/qhh.mpd"};e.load(location.pathname+t[e.playerType])}}),(e=>{console.error(e)}))}!function(e){let t;ot||(ot=rt("#log")),"object"==typeof e?(t=document.createElement("pre"),t.textContent=JSON.stringify(e,null,2)):(t=document.createElement("p"),t.textContent=e),ot.appendChild(t)}(Se.probe());const i=L(".mask-info"),s=L("#bandwidth"),r=L("#cdn"),n=L("#quality"),a=L("#bufferedTime"),h=L("#playedTime"),d=L("#canSeekTime"),c=L(".mask-capture"),u=L(".mask-capture > img");let p=0,y=0;nt(L("#btn-init-player"),(()=>{t()})),nt(L("#btn-toggle-play"),(()=>{e.video.paused?e.play():e.pause()})),nt(L("#btn-seek"),(()=>{e.currentTime=70})),nt(L("#btn-destroy"),(()=>{e.destroy()})),nt(L("#btn-capture"),(()=>{c.style.display="block",u.src=e.capture(),window.clearTimeout(y),y=window.setTimeout((()=>{c.style.display="none"}),3e3)})),nt(L("#btn-add-barrage"),(()=>{let t=new Array(100);for(let i of t)e.addBarrage("test barrage 测试弹幕",{color:"red"})})),nt(L("#btn-clear-barrage"),(()=>{e.clearBarrage()})),nt(L("#btn-browser-hank"),(()=>{L("#mask-all").style.display="block"}));const m=()=>{r.textContent=null==e?void 0:e.cdnName,n.textContent=null==e?void 0:e.quality,s.textContent=(null==e?void 0:e.getEstimateNetSpeed())+"",a.textContent=(null==e?void 0:e.bufferedMax)+"",h.textContent=(null==e?void 0:e.currentTime)+"",d.textContent=(null==e?void 0:e.bufferedMax)-(null==e?void 0:e.currentTime)+""};nt(L("#btn-mask-info"),(()=>{"block"===i.style.display?(i.style.display="none",clearInterval(p)):(i.style.display="block",m(),p=window.setInterval(m,5e3))}))}function vt(){let e,t;nt(L("#btn-flv-init"),(()=>{yt.videoNode="flv-player",console.log("Flv Player Params:",yt),window.vp=e=new te(yt),t=pt("flv"),e.load(t.url).then((()=>{!function(e){e.nPlayer.on(te.Events.ERROR,((e,t,i)=>{console.log("FlvPlayer.Events.ERROR"),console.log("errorType: ",e),console.log("errorDetail: ",t),console.log("errorInfo: ",i)})),e.nPlayer.on(te.Events.LOADING_COMPLETE,(e=>{console.log("FlvPlayer.Events.LOADING_COMPLETE",e)})),e.nPlayer.on(te.Events.MEDIA_INFO,(e=>{console.log("FlvPlayer.Events.MEDIA_INFO",e)})),e.nPlayer.on(te.Events.METADATA_ARRIVED,(e=>{console.log("FlvPlayer.Events.METADATA_ARRIVED",e)})),e.nPlayer.on(te.Events.RECOVERED_EARLY_EOF,(e=>{console.log("FlvPlayer.Events.RECOVERED_EARLY_EOF",e)})),e.nPlayer.on(te.Events.SCRIPTDATA_ARRIVED,(e=>{console.log("FlvPlayer.Events.SCRIPTDATA_ARRIVED",e)})),e.nPlayer.on(te.Events.STATISTICS_INFO,(e=>{}))}(e)}))})),nt(L("#btn-flv-toggle-play"),(()=>{e.video.paused?e.video.play():e.video.pause()})),nt(L("#btn-flv-switch"),(()=>{t=pt("flv",t.index+1),e.load(t.url)}))}window.onload=function(){mt(),vt(),function(){let e,t;nt(L("#btn-hls-init"),(()=>{yt.videoNode="hls-player",console.log("Hls Player Params:",yt),J(yt.debug),window.vp=e=new ie(yt),t=pt("hls"),e.load(t.url)})),nt(L("#btn-hls-toggle-play"),(()=>{e.video.paused?e.video.play():e.video.pause()})),nt(L("#btn-hls-switch"),(()=>{t=pt("hls",t.index+1),e.load(t.url)})),nt(L("#btn-hls-seek"),(()=>{e.video.currentTime=1440}))}(),function(){let e,t;nt(L("#btn-hlslite-init"),(()=>{yt.videoNode="hls-lite-player",console.log("HlsLite Player Params:",yt),J(yt.debug),window.vp=e=new ge(yt),t=pt("hls"),e.load(t.url)})),nt(L("#btn-hlslite-toggle-play"),(()=>{e.video.paused?e.video.play():e.video.pause()})),nt(L("#btn-hlslite-switch"),(()=>{t=pt("hls",t.index+1),e.load(t.url)}))}()};
